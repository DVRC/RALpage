%!PS-
% This file has been run through pshalf; it should not be run
% through any other PostScript post-processors.
/real$showpage/showpage load def/showpage/newpath load def
%!PS-Adobe-1.0
%%Creator: hal-2000:opus (David C. Jedlinsky,opus,11-205M,7788,2534261)
%%Title: X11.c
%%CreationDate: Fri Apr  7 04:49:08 1989
%%DocumentFonts: Courier-Bold Courier Times-Roman Times-Bold Helvetica-Bold

% included prolog for enscript files
% last edit: shore Sat Nov  9 13:28:41 1985
% Copyright (c) 1983, 1984 Adobe Systems Incorporated
% RCSID: $Header: enscript.pro,v 2.1 85/11/24 12:19:23 shore Rel $
save/EnscriptJob exch def
/StartEnscriptDoc{$enscript begin}def
/$enscript 50 dict def $enscript begin
/EndEnscriptDoc{end}def
/S/show load def
/X{exch 0 rmoveto S}def
/Y{exch 0 exch rmoveto S}def
/B{3 1 roll moveto S}def
/F{$fd exch get setfont}def
/StartPage{/svpg save def .05 dup scale}def
/EndPage{svpg restore showpage}def
/DoPreFeed{/statusdict where{pop
 statusdict/prefeed known{statusdict exch/prefeed exch put 0}if}if pop}def
/Landscape{90 rotate 0 -15840 translate}def
/SetUpFonts
 {dup/$fd exch array def{findfont exch scalefont $fd 3 1 roll put}repeat}def
/InitGaudy{/TwoColumn exch def /BarLength exch def
 /ftD /Times-Bold findfont 12 UP scalefont def
 /ftF /Times-Roman findfont 14 UP scalefont def
 /ftP /Helvetica-Bold findfont 30 UP scalefont def}def
/U{1440 mul}def
/UP{U 72 div}def
/LB{/pts exch UP def /charcolor exch def /boxcolor exch def /font exch def
 /label exch def /dy exch def /dx exch def /lly exch def /llx exch def
 gsave boxcolor setgray
 llx lly moveto dx 0 rlineto 0 dy rlineto dx neg 0 rlineto closepath fill
 /lines label length def
 /yp lly dy add dy lines pts mul sub 2 div sub pts .85 mul sub def
 font setfont charcolor setgray
 label {dup stringwidth pop 2 div llx dx 2 div add exch sub yp moveto show
   /yp yp pts sub def}forall grestore}def
/Gaudy{/Page exch def /Date exch def /File exch def /Comment exch def
 .25 U 10.2 U BarLength .1 sub U .25 U [File] ftF .97 0 14 LB
 .25 U 10.45 U BarLength .1 sub U .25 U [Comment] ftF 1 0 14 LB
 .25 U 10.2 U 1 U .5 U Date ftD .7 0 12 LB
 BarLength .75 sub U 10.2 U 1 U .5 U [Page] ftP .7 1 30 LB
 TwoColumn{BarLength 2 div .19 add U 10.2 U moveto 0 -10 U rlineto stroke}if
}def
end
StartEnscriptDoc % end fixed prolog
1 200 /Courier-Bold
0 140 /Courier
2 SetUpFonts
10.55 true InitGaudy
% --Pshalf, by Denise Draper--
/HfDict 20 dict def HfDict begin gsave/T matrix currentmatrix matrix
defaultmatrix matrix invertmatrix matrix concatmatrix def initgraphics
clippath pathbbox/y2 exch def/x2 exch def/y1 exch def/x1 exch def/X x2
x1 sub def/Y y2 y1 sub def 90 rotate/XY X Y div def/Y2X Y X 2 mul div
def/Tx y1 x1 Y2X mul sub def/Ty x2 y1 XY mul add neg def[Y2X 0 0 XY Tx
Ty]concat matrix currentmatrix/O1D exch def X 0 translate matrix
currentmatrix/O2D exch def grestore/nclip{initclip newpath x1 y1
moveto x1 y2 lineto x2 y2 lineto x2 y1 lineto closepath clip newpath}
def/bp{gsave O1D setmatrix nclip T concat}def/hp{grestore gsave O2D
setmatrix nclip T concat}def/ep{real$showpage grestore}bind def end
save
% --End Pshalf--
%%Pages: (atend)
%%EndProlog
%%Page: ? 1
HfDict begin bp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(/* X11R2 modifications and fixes made from sources by Crispin Goswell,)B
444 12230(* Barry Shein of BU, and Jean Marie Diaz of MIT.  The resulting)B
444 12070(* melange, along with other fixes for color workstations, is entirely)B
444 11910(* my fault.)B
444 11750(*)B
444 11590(* David Jedlinsky)B
444 11430(* MIT Project Athena Watchmaker)B
444 11270(* opus@athena.mit.edu)B
444 11110(* )B
444 10950(*/)B
360 10790(#include "main.h")B
360 10630(#include "graphics.h")B
360 10470(#include <X11/Xlib.h>)B
360 10310(#include <X11/Xutil.h>)B
360 10150(#include <X11/Xatom.h>)B
360 9990(#include <stdio.h>)B
360 9670(#define ISWIN)B
252(1)X
360 9510(#define ISBITMAP 2)B
360 9190(typedef int ColorType;)B
360 9030(#define ISPIXEL)B
756(1)X
360 8870(#define ISHALFTONE)B
504(2)X
360 8550(/* Also change #define in font.c */)B
360 8390(#define UpdateControl\(h, on\) {})B
360 8070(struct screen)B
360 7910({)B
528 7750(float val;)B
528 7590(int sx, sy;)B
528 7430(struct hardware *shade;)B
360 7270(} *screen = NULL;)B
360 6950(static int screen_size;)B
360 6630(#define TRANSFER_SIZE)B
252(256)X
360 6310(static int transfer [TRANSFER_SIZE];)B
360 5990(extern int RUNSYNC, TESTING;)B
360 5670(int pixels_per_inch;)B
360 5350(float hppp, vppp;)B
360 5030(int single_rop [] =)B
360 4870({)B
528 4710(ROP_FALSE, ROP_DEST, ROP_NOTDEST, ROP_TRUE,)B
528 4550(ROP_FALSE, ROP_DEST, ROP_NOTDEST, ROP_TRUE,)B
528 4390(ROP_FALSE, ROP_DEST, ROP_NOTDEST, ROP_TRUE,)B
8088 14470(ROP_FALSE, ROP_DEST, ROP_NOTDEST, ROP_TRUE)B
8088 14310(};)B
7920 13990(void InitTransfer \(ppi\))B
8340 13830(int ppi;)B
7920 13670({)B
8088 13510(int i;)B
8088 13190(pixels_per_inch = ppi;)B
8088 13030(for \(i = 0; i < TRANSFER_SIZE; i++\))B
8256 12870(transfer [i] = i;)B
7920 12710(})B
7920 12390(static void Punt\(str\))B
8340 12230(char *str;)B
7920 12070({)B
8088 11910(fprintf\(stderr, "%s\\n", str\);)B
8088 11750(exit\(1\);)B
7920 11590(})B
7920 11270(static Display *dpy;)B
7920 11110(static int SCREEN;)B
7920 10950(static struct hardware *NewHardware \(\);)B
7920 10790(struct hardware *GraySync \(\);)B
7920 10470(extern HardPoint DeviceToHard \(\);)B
7920 10150(typedef struct _HardwareRec {)B
8088 9990(Drawable w;)B
8088 9830(GC gc;)B
8088 9670(union last_color {)B
8256 9510(unsigned long pix;)B
8256 9350(Pixmap halftone;)B
8088 9190(} last_color;)B
8088 9030(int last_used;)B
7920 8870(} HardwareRec, *Hardware;)B
7920 8550(/*)B
8004 8390(* This file describes the interface that PostScript requires to the graphics)B
8004 8230(* system at Version 1.4.)B
8004 8070(* )B
8004 7910(* ''Hardware'' in this context refers to a pointer to windows and/or bitmaps)B
8004 7750(* and is the lowest level of access that PostScript is interested in. Any)B
8004 7590(* Hardware parameter may be expected to be NULL.)B
8004 7430(*/)B
7920 7110(/********************* CREATION OF WINDOWS AND BITMAPS *******************/)B
7920 6790(#define MIN\(x, y\))B
588(\(\(\(x\) < \(y\)\) ? \(x\) : \(y\)\))X
7920 6470(static GC GlobalGC = NULL;)B
7920 6310(static int GlobalMask = 0;)B
7920 6150(static GC fillgc[16];)B
7920 5990(static GC BitmapGC[16];)B
7920 5830(static GC whitegc;)B
7920 5670(void ModifyGC \(\);)B
7920 5350(/*)B
8004 5190(* InitHardware \(\) returns a default device which PostScript may use)B
8004 5030(* immediately \(or NULL if not appropriate\).  Its size and shape are)B
8004 4870(* not defined. Most typically the user will want to start up another)B
8004 4710(* device before it is used anyway. No attempt will be made by)B
8004 4550(* PostScript to Destroy the resulting device.)B
8004 4390(*/)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](2)Gaudy
0 F
360 14470(struct hardware *InitHardware \(\))B
360 14310({)B
528 14150(XGCValues values;)B
528 13990(int i;)B
528 13830(DevicePoint p;)B
528 13510(if \(\(dpy = XOpenDisplay\(""\)\) == NULL\))B
696 13350(Punt\("Could not open display"\);)B
528 13190(SCREEN = DefaultScreen\(dpy\);)B
528 12870(/* DCJ:)B
612 12710(* This is the real ppi.  However, we might be using a screen that)B
612 12550(* is less than 11 inches tall, which makes life difficult.  So we)B
612 12390(* cheat a bit.)B
612 12230(*/)B
528 11910(if \(DisplayHeightMM\(dpy, SCREEN\) < 280\) {)B
696 11750(hppp = \(float\) DisplayWidth\(dpy,SCREEN\) / \(\(279.4 / \(float\) DisplayHeightMM\(dpy, SCRE)B
696 11590(vppp = \(float\) DisplayHeight\(dpy, SCREEN\) / 792.0;)B
696 11430(InitTransfer\(DisplayHeight\(dpy, SCREEN\) / 11\);)B
528 11270(} else {)B
696 11110(hppp = \(float\) DisplayWidth\(dpy, SCREEN\) / \(\(float\) DisplayWidthMM\(dpy, SCREEN\) * 2.8)B
696 10950(vppp = \(float\) DisplayHeight\(dpy, SCREEN\) / \(\(float\) DisplayHeightMM\(dpy, SCREEN\) * 2)B
696 10790(InitTransfer\(\(int\) \(\(float\) DisplayHeight\(dpy, SCREEN\) * \(float\) 25.4 / \(float\) Displ)B
528 10630(})B
528 10310(values.foreground = BlackPixel\(dpy, SCREEN\);)B
528 10150(values.background = WhitePixel\(dpy, SCREEN\);)B
528 9830(for \(i=0 ; i<16 ; i++\) {)B
696 9670(BitmapGC[i] = NULL;)B
696 9510(values.function = i;)B
696 9350(fillgc[i] = XCreateGC\(dpy, RootWindow\(dpy, SCREEN\),)B
2544 9190(GCFunction | GCForeground | GCBackground,)B
2544 9030(&values\);)B
528 8870(})B
528 8550(p.dx = DisplayWidth\(dpy, SCREEN\);)B
528 8390(p.dy = DisplayHeight\(dpy, SCREEN\);)B
528 8230(return NewHardware\(p\);)B
360 8070(})B
360 7750(static struct hardware *NewHardware\(width, height\))B
780 7590(int width, height;)B
360 7430({)B
528 7270(struct hardware *to;)B
528 7110(Hardware hard;)B
528 6790(to = \(struct hardware *\) malloc\(sizeof\(struct hardware\)\);)B
528 6630(hard = \(Hardware\) malloc\(sizeof\(HardwareRec\)\);)B
528 6470(to->hard.addr = \(char *\) hard;)B
528 6310(to->flags = 0;)B
528 6150(to->aux = to->clip = \(struct hardware *\) NULL;)B
528 5990(to->extent = NewDevicePoint\(width, height\);)B
528 5830(hard->w = \(Drawable\) NULL;)B
528 5670(hard->gc = \(GC\) NULL;)B
528 5510(to->touched = FALSE;)B
528 5350(to->changed = TRUE;)B
528 5190(hard->last_used = 0;)B
528 5030(return to;)B
360 4870(})B
360 4550(/*)B
444 4390(* NewBitmapHardware \(\) is expected to create a new bitmap. Only one plane)B
8004 14470(* will be needed.)B
8004 14310(* )B
8004 14150(* NewWindowHardware \(\) is expected to create a window on the screen. On a)B
8004 13990(* colour system this will be expected to support full colour.)B
8004 13830(*/)B
7920 13670(struct hardware *NewBitmapHardware \(width, height\))B
8340 13510(int width, height;)B
7920 13350({)B
8088 13190(XGCValues values;)B
8088 13030(struct hardware *to = NewHardware\(width, height\);)B
8088 12870(Hardware hard = \(Hardware\) to->hard.addr;)B
8088 12710(int i;)B
8088 12390(to->flags = ISBITMAP;)B
8088 12070(if \(width == 0 || height == 0\) {)B
8256 11910(return NULL;)B
8088 11750(})B
8088 11590(hard->w = XCreatePixmap\(dpy, RootWindow\(dpy, SCREEN\), width,)B
10104 11430(height, 1\);)B
8088 11110(if \(! BitmapGC[GXcopy]\) {)B
8256 10950(values.foreground = 1;)B
8256 10790(values.background = 0;)B
8256 10470(for \(i=0; i<16; i++\) {)B
8424 10310(values.function = i;)B
8424 10150(BitmapGC[i] = XCreateGC\(dpy, hard->w,)B
10440 9990(GCFunction|GCForeground|GCBackground,)B
10440 9830(&values\);)B
8256 9670(})B
8088 9510(})B
8088 9350(XFillRectangle\(dpy, hard->w, BitmapGC[GXclear], 0, 0,)B
9348 9190(width, height\);)B
8088 8870(return to;)B
7920 8710(})B
7920 8390(struct hardware *NewWindowHardware \(width, height\))B
8340 8230(int width, height;)B
7920 8070({)B
8088 7910(struct hardware *to = NewHardware\(width, height\);)B
8088 7750(Hardware hard = \(Hardware\) to->hard.addr;)B
8088 7590(XEvent event;)B
8088 7430(unsigned long vmask;)B
8088 7270(XSetWindowAttributes xswa;)B
8088 7110(XSizeHints xshints;)B
8088 6790(to->flags = ISWIN;)B
8088 6630(vmask = CWBackPixel|CWBorderPixel|CWBackingStore|)B
8256 6470(CWBackingPlanes;)B
8088 6310(xswa.background_pixel = WhitePixel\(dpy,SCREEN\);)B
8088 6150(xswa.border_pixel = BlackPixel\(dpy,SCREEN\);)B
8088 5990(xswa.backing_store = Always;)B
8088 5830(xswa.backing_planes = AllPlanes;)B
8088 5670(xshints.x = DisplayWidth\(dpy, SCREEN\) - width;)B
8088 5510(xshints.y = 0;)B
8088 5350(xshints.width = width;)B
8088 5190(xshints.height = height;)B
8088 5030(xshints.flags = USPosition|USSize;)B
8088 4710(if \(RUNSYNC\) {)B
8256 4550(fprintf\(stderr, "Running synchronized.\\n"\); fflush\(stderr\);)B
8256 4390(XSynchronize\(dpy, TRUE\);)B
EndPage
HfDict begin ep end
%%Page: ? 2
HfDict begin bp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](3)Gaudy
0 F
528 14470(})B
528 14310(hard->w = XCreateWindow\(dpy, RootWindow\(dpy,SCREEN\),)B
2544 14150(xshints.x, xshints.y, width, height,)B
2544 13990(1, DefaultDepth\(dpy,SCREEN\),)B
2544 13830(InputOutput, DefaultVisual\(dpy,SCREEN\),)B
2544 13670(vmask, &xswa\);)B
528 13350(XChangeProperty\(dpy,hard->w,XA_WM_NAME,XA_STRING,8,)B
1872 13190(PropModeReplace,"POSTSCRIPT",10\);)B
528 13030(if \(TESTING\))B
696 12870(XSetNormalHints\(dpy, hard->w, &xshints\);)B
528 12550(XSelectInput\(dpy, hard->w, ExposureMask\);)B
528 12390(XMapWindow\(dpy, hard->w\);)B
528 12230(XSync\(dpy, FALSE\);)B
528 12070(XNextEvent\(dpy, &event\);)B
528 11910(XSelectInput\(dpy, hard->w, 0\);)B
528 11750(return to;)B
360 11590(})B
360 11270(/*)B
444 11110(* IsWindowHardware \(\) should return TRUE if the hardware is a window, FALSE)B
444 10950(* otherwise.)B
444 10790(*)B
444 10630(* IsBitmapHardware \(\) should return TRUE if the hardware is a bitmap,)B
444 10470(* FALSE otherwise.)B
444 10310(*/)B
360 9990(int IsWindowHardware \(h\))B
780 9830(struct hardware *h;)B
360 9670({)B
528 9510(return h->flags & ISWIN;)B
360 9350(})B
360 9030(#define IsWindowHardware\(h\) \(\(h\)->flags & ISWIN\))B
360 8710(#define IsBitmapHardware\(h\) \(\(h\)->flags & ISBITMAP\))B
360 8390(/*)B
444 8230(* )B
444 8070(* DestroyHardware \(\) should release the resources required by the hardware,)B
444 7910(* bitmap or window.  This should cause a window device to vanish. NULL is not)B
444 7750(* an error \(does nothing\).)B
444 7590(*/)B
360 7270(void DestroyHardware \(h\))B
780 7110(struct hardware *h;)B
360 6950({)B
528 6790(if \(h\) {)B
696 6630(Hardware hard = \(Hardware\) h->hard.addr;)B
696 6470(if \(IsWindowHardware\(h\)\))B
864 6310(XDestroyWindow\(dpy, hard->w\);)B
696 6150(else)B
864 5990(if \(IsBitmapHardware\(h\)\))B
1032 5830(XFreePixmap\(dpy, hard->w\);)B
696 5670(Free\(h\);)B
528 5510(})B
360 5350(})B
360 5030(/*)B
444 4870(*)B
444 4710(* DeviceMatrix \(\) should return a matrix appropriate to a device of the given)B
444 4550(* height and width.  For a typical display with a graphics origin at the top)B
444 4390(* left of a window, an appropriate definition would be:)B
8004 14470(* )B
8004 14310(* Matrix DeviceMatrix \(width, height\))B
8004 14150(* int width, height;)B
8004 13990(* {)B
8004 13830(*     Matrix m;)B
8004 13670(*     NewMatrix \(m, PIXELS_PER_INCH / 72.0, 0.0, 0.0,)B
8004 13510(* )B
1848(-PIXELS_PER_INCH / 72.0, 0.0, \(float\) height\);)X
8004 13350(*     return m;)B
8004 13190(* })B
8004 13030(*/)B
7920 12710(Matrix DeviceMatrix \(width, height\))B
8340 12550(int width, height;)B
7920 12390({)B
8088 12230(Matrix m;)B
8088 12070(NewMatrix\(m, pixels_per_inch / 72.0, 0.0, 0.0,)B
8928 11910(-pixels_per_inch / 72.0, 0.0, \(float\) height\);)B
8088 11750(return m;)B
7920 11590(})B
7920 11270(/*)B
8004 11110(* HardwareExtent \(\) returns a DevicePoint describing the width and height of)B
8004 10950(* the argument.  NULL has extent NewDevicePoint \(0, 0\).)B
8004 10790(*/)B
7920 10470(DevicePoint HardwareExtent \(h\))B
8340 10310(struct hardware *h;)B
7920 10150({)B
8088 9990(if \(h\))B
8256 9830(return h->extent;)B
8088 9670(else)B
8256 9510(return NewDevicePoint \(0, 0\);)B
7920 9350(})B
7920 9030(static NeedAux \(h\))B
8340 8870(struct hardware *h;)B
7920 8710({)B
8088 8550(DevicePoint p;)B
8088 8230(if \(h->aux\))B
8256 8070(return;)B
8088 7910(p = HardwareExtent\(h\);)B
8088 7750(h->aux = NewBitmapHardware \(p.dx, p.dy\);)B
7920 7590(})B
7920 7270(/*************************** OUTPUT PRIMITIVES ******************************/)B
7920 7110(/*)B
8004 6950(* )B
8004 6790(* BitBlt \(\) is a full function RasterOp. The 'rop' argument will have values)B
8004 6630(* as described in the header file hard.h. If the from argument is NULL it is)B
8004 6470(* taken to be a bitmap full of ones the shape of the fromPoint and extent. If)B
8004 6310(* the to argument is NULL, this is a no-op.)B
8004 6150(*)B
8004 5990(* Paint \(\) is an addition to BitBlt. Bits that are set in the source are)B
8004 5830(* Painted into the destination in the given colour with a copying rasterop so)B
8004 5670(* that they replace pixels previously there. If the machine does not support)B
8004 5510(* colour windows, half-toning should be performed.  Colour values have hue,)B
8004 5350(* saturation and brightness components. On a black and white or greyscale)B
8004 5190(* system the brightness value will be a FP value between 0.0 \(black\) and 1.0)B
8004 5030(* \(white\), which can be used as a grey level.)B
8004 4870(* )B
8004 4710(* Paint is expected to mask with the clip mask. BitBlt is not,)B
8004 4550(*/)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](4)Gaudy
0 F
360 14470(void BitBlt \(from, to, fromPoint, toPoint, extent, rop\))B
780 14310(struct hardware *from, *to;)B
780 14150(DevicePoint toPoint, fromPoint, extent;)B
780 13990(int rop;)B
360 13830({)B
528 13670(Hardware fromhard, tohard;)B
528 13510(static int count = 0;)B
528 13350(GC gc = NULL;)B
528 13030(if \(to == NULL\) return;)B
528 12870(/*)B
612 12710(* Copying from full color window to monochrome bitmap is the)B
612 12550(* wrong idea.)B
612 12390(*/)B
528 12230(if \(IsWindowHardware\(from\) && !IsWindowHardware\(to\)\) return;)B
528 11910(tohard = \(Hardware\) to->hard.addr;)B
528 11750(if \(IsWindowHardware\(to\)\) {)B
696 11590(if \(from == NULL\) {)B
864 11430(XFillRectangle\(dpy, tohard->w, fillgc[rop], toPoint.dx,)B
2124 11270(toPoint.dy, extent.dx, extent.dy\);)B
696 11110(} else {)B
864 10950(fromhard = \(Hardware\) from->hard.addr;)B
864 10790(if \(IsWindowHardware\(from\)\) {)B
1032 10630(XCopyArea\(dpy, fromhard->w, tohard->w, fillgc[rop],)B
1872 10470(fromPoint.dx, fromPoint.dy,)B
1872 10310(extent.dx, extent.dy,)B
1872 10150(toPoint.dx, toPoint.dy\);)B
864 9990(} else)B
1032 9830(if \(IsBitmapHardware \(from\)\) {)B
1200 9670(XCopyPlane\(dpy, fromhard->w, tohard->w, fillgc[15-rop],)B
2124 9510(fromPoint.dx, fromPoint.dy,)B
2124 9350(extent.dx, extent.dy,)B
2124 9190(toPoint.dx, toPoint.dy, 1\);)B
1032 9030(})B
696 8870(})B
528 8710(} else)B
696 8550(if \(IsBitmapHardware\(to\)\) {)B
864 8390(if \(from == NULL\) {)B
1032 8230(XFillRectangle\(dpy, tohard->w, BitmapGC[rop], toPoint.dx,)B
2292 8070(toPoint.dy, extent.dx, extent.dy\);)B
864 7910(} else {)B
1032 7750(if \(IsBitmapHardware\(from\)\) {)B
1200 7590(fromhard = \(Hardware\) from->hard.addr;)B
1200 7430(XCopyArea\(dpy, fromhard->w, tohard->w, BitmapGC[rop],)B
2040 7270(fromPoint.dx, fromPoint.dy,)B
2040 7110(extent.dx, extent.dy,)B
2040 6950(toPoint.dx, toPoint.dy\);)B
1032 6790(})B
864 6630(})B
696 6470(})B
528 6150(to->touched = TRUE;)B
528 5990(to->changed = TRUE;)B
528 5670(if \(gc != NULL\))B
696 5510(XFreeGC\(dpy, gc\);)B
528 5350(if \(count++ % 50 == 0\) XSync\(dpy, FALSE\);)B
360 5190(})B
360 4870(void Paint \(from, to, fromPoint, toPoint, extent, colour\))B
780 4710(struct hardware *from, *to;)B
780 4550(DevicePoint fromPoint, toPoint, extent;)B
780 4390(Colour colour;)B
7920 14470({)B
8088 14310(Hardware hard, grayhard, tohard;)B
8088 14150(static int count = 0;)B
8088 13830(if \(!IsBitmapHardware\(from\) && from != NULL\))B
8256 13670(Punt\("Paint\(\) called with non-bitmap source.\\n"\);)B
8088 13190(if \(to == NULL\))B
8256 13030(return;)B
8088 12710(if \(!from->touched\))B
8256 12550(return;)B
8088 12230(ModifyGC \(colour, from, to, fromPoint, toPoint, extent\);)B
8088 11910(tohard = \(Hardware\) to->hard.addr;)B
8088 11590(XFillRectangle\(dpy, tohard->w, GlobalGC, toPoint.dx, toPoint.dy,)B
9348 11430(extent.dx, extent.dy\);)B
8088 11110(to->touched = TRUE;)B
8088 10950(to->changed = TRUE;)B
8088 10630(if \(++count % 100 == 0\) {)B
8256 10470(XSync\(dpy, FALSE\);)B
8088 10310(})B
7920 10150(})B
7920 9830(int FillPath\(to, path, rule\))B
8340 9670(struct hardware *to;)B
8340 9510(Path path;)B
8340 9350(int rule;)B
7920 9190({)B
8088 9030(register Path p;)B
8088 8870(static XPoint *vertices = NULL;)B
8088 8710(int i = 0;)B
8088 8550(Hardware hard;)B
8088 8230(if \(!vertices\) {)B
8256 8070(if \(\(vertices = \(XPoint *\) malloc\(MAXPATHELEMENTS * sizeof\(XPoint\)\)\))B
8592 7910(== NULL\))B
8424 7750(Punt\("Not enough memory for filling.\\n"\);)B
8088 7590(})B
8088 7270(if \(EmptyPath \(path\)\))B
8256 7110(return TRUE;)B
8088 6790(path = FlattenPath \(path\);)B
8088 6470(if \(!CloseAll \(path\)\) {)B
8256 6310(PathFree \(path\);)B
8256 5990(return FALSE;)B
8088 5830(})B
8088 5510(ModifyGC \(gstate->colour, \(struct hardware *\)NULL, to,)B
8928 5350(NewDevicePoint\(0,0\), NewDevicePoint\(0,0\),)B
8928 5190(NewDevicePoint\(0,0\)\);)B
8088 4870(hard = \(Hardware\) to->hard.addr;)B
8088 4550(for \(p = path->next; p != path; p = p->next\))B
8256 4390(switch \(p->ptype\) {)B
EndPage
HfDict begin ep end
%%Page: ? 3
HfDict begin bp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](5)Gaudy
0 F
696 14470(case EMove:)B
864 14310(if \(i > 1\))B
1032 14150(XFillPolygon\(dpy, hard->w, GlobalGC, vertices, i,)B
2124 13990(Complex, CoordModeOrigin\);)B
864 13830(vertices[0].x = \(short\) p->pe.point.hx;)B
864 13670(vertices[0].y = \(short\) p->pe.point.hy;)B
864 13510(i = 1;)B
864 13350(break;)B
696 13190(case ELine:)B
864 13030(vertices[i].x = \(short\) p->pe.point.hx;)B
864 12870(vertices[i++].y = \(short\) p->pe.point.hy;)B
864 12710(break;)B
696 12550(case EClose:)B
864 12390(XFillPolygon\(dpy, hard->w, GlobalGC, vertices, i,)B
1956 12230(Complex, CoordModeOrigin\);)B
864 12070(i = 0;)B
864 11910(break;)B
696 11750(})B
528 11430(PathFree \(path\);)B
528 11110(to->touched = TRUE;)B
528 10950(to->changed = TRUE;)B
528 10630(return TRUE;)B
360 10470(})B
360 10150(static short Xvalue \(ax, ay, bx, by, cy\))B
780 9990(int ax, ay, bx, by, cy;)B
360 9830({)B
528 9670(if \(ay - by == 0\) {)B
696 9510(printf\("Xvalue: ax=%d, ay=%d, bx=%d, by=%d, cy=%d\\n",)B
1284 9350(ax, ay, bx, by, cy\);)B
696 9190(return bx + \(cy - by\) * \(ax - bx\);)B
528 9030(})B
528 8870(return bx + \(cy - by\) * \(ax - bx\) / \(float\) \(ay - by\);)B
360 8710(})B
360 8390(/*)B
444 8230(* BitBltTrapezoid \(\) and PaintTrapezoid \(\) render a complete trapezoidal)B
444 8070(* shape.  The corners of the trapezoid may lie far outside the range of)B
444 7910(* interesting scan-lines, but the slope of the line should be clipped by the)B
444 7750(* top and bottom. The coordinates are half-open.)B
444 7590(*/)B
360 7270(void BitBltTrapezoid \(to, lefttop, leftbottom, righttop, rightbottom,)B
2208 7110(top, bottom, rop\))B
780 6950(struct hardware *to;)B
780 6790(DevicePoint lefttop, leftbottom, righttop, rightbottom;)B
780 6630(int top, bottom, rop;)B
360 6470({)B
528 6310(int i, j, temp;)B
528 6150(static int left [1024], right [1024];)B
528 5830(int)B
696 5670(ltx = Xvalue \(lefttop.dx, lefttop.dy, leftbottom.dx,)B
1872 5510(leftbottom.dy, top\),)B
696 5350(rtx = Xvalue \(righttop.dx, righttop.dy, rightbottom.dx,)B
1872 5190(rightbottom.dy, top\),)B
696 5030(lbx = Xvalue \(lefttop.dx, lefttop.dy, leftbottom.dx,)B
1872 4870(leftbottom.dy, bottom\),)B
696 4710(rbx = Xvalue \(righttop.dx, righttop.dy, rightbottom.dx,)B
1872 4550(rightbottom.dy, bottom\);)B
8088 14470(if \(ltx == lbx && rtx == rbx\) {)B
8256 14310(if \(rtx < ltx\))B
8424 14150(temp = rtx, rtx = ltx, ltx = temp;)B
8256 13830(BitBlt \(\(struct hardware *\) NULL, to,)B
8928 13670(NewDevicePoint \(0, 0\), NewDevicePoint \(ltx, top\),)B
8928 13510(NewDevicePoint \(rtx - ltx + 1, bottom - top + 1\), rop\);)B
8256 13190(return;)B
8088 13030(})B
8088 12710(for \(i = top, j = 0; i <= bottom; i++, j++\) {)B
8256 12550(int)B
8424 12390(lx = Xvalue \(lefttop.dx, lefttop.dy, leftbottom.dx,)B
9516 12230(leftbottom.dy, i\),)B
8424 12070(rx = Xvalue \(righttop.dx, righttop.dy, rightbottom.dx,)B
9516 11910(rightbottom.dy, i\);)B
8256 11590(if \(rx < lx\))B
8424 11430(temp = rx, rx = lx, lx = temp;)B
8256 11110(left [j] = lx; right [j] = rx;)B
8088 10950(})B
8088 10790(BitBltBlob \(to, top, bottom - top, left, right, single_rop [rop]\);)B
8088 10470(to->touched = TRUE;)B
8088 10310(to->changed = TRUE;)B
7920 10150(})B
7920 9830(void PaintTrapezoid \(to, lefttop, leftbottom, righttop, rightbottom,)B
9684 9670(top, bottom, colour\))B
8340 9510(struct hardware *to;)B
8340 9350(DevicePoint lefttop, leftbottom, righttop, rightbottom;)B
8340 9190(int top, bottom;)B
8340 9030(Colour colour;)B
7920 8870({)B
8088 8710(struct hardware *gray = NULL;)B
8088 8550(Hardware hard, grayhard, tohard;)B
8088 8390(int valuemask = 0, ok = FALSE;)B
8088 8230(XGCValues values;)B
8088 8070(GC gc = NULL;)B
8088 7910(unsigned long pix;)B
8088 7750(ColorType ret;)B
8088 7590(XPoint coord[4];)B
8088 7270(ret = RealColor\(colour, &pix, &gray\);)B
8088 6950(/* This should be done better: Halftones aren't handled... */)B
8088 6790(if \(IsBitmapHardware\(to\)\) {)B
8256 6630(BitBltTrapezoid\(to, lefttop, leftbottom, righttop, rightbottom,)B
9600 6470(top, bottom, \(pix == WhitePixel\(dpy, SCREEN\)\) ? ROP_FALSE : ROP_TRUE\))B
8256 6310(return;)B
8088 6150(})B
8088 5830(if \(to == NULL\))B
8256 5670(return;)B
8088 5350(coord[0].x = Xvalue \(lefttop.dx, lefttop.dy, leftbottom.dx,)B
9852 5190(leftbottom.dy, bottom\);)B
8088 5030(coord[0].y = bottom;)B
8088 4870(coord[1].x = Xvalue \(lefttop.dx, lefttop.dy, leftbottom.dx,)B
9852 4710(leftbottom.dy, top\);)B
8088 4550(coord[1].y = top;)B
8088 4390(coord[2].x = Xvalue \(righttop.dx, righttop.dy, rightbottom.dx,)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](6)Gaudy
0 F
2292 14470(rightbottom.dy, top\);)B
528 14310(coord[2].y = top;)B
528 14150(coord[3].x = Xvalue \(righttop.dx, righttop.dy, rightbottom.dx,)B
2292 13990(rightbottom.dy, bottom\);)B
528 13830(coord[3].y = bottom;)B
528 13510(UpdateControl \(to, FALSE\);)B
528 13190(if \(ret == ISPIXEL\) {)B
696 13030(values.function = GXcopy;)B
696 12870(values.foreground = pix;)B
696 12710(valuemask = valuemask|GCFunction|GCForeground;)B
696 12550(if \(pix == BlackPixel\(dpy, SCREEN\)\))B
864 12390(gc = fillgc[GXcopy];)B
696 12230(if \(pix == WhitePixel\(dpy, SCREEN\)\))B
864 12070(gc = whitegc;)B
696 11910(hard = \(Hardware\) to->hard.addr;)B
696 11750(if \(hard->last_used == ISPIXEL && hard->last_color.pix == pix\))B
864 11590(ok = TRUE;)B
528 11430(} else if \(ret == ISHALFTONE\) {)B
696 11270(values.function = GXcopy;)B
696 11110(values.foreground = BlackPixel\(dpy, SCREEN\);)B
696 10950(values.background = WhitePixel\(dpy, SCREEN\);)B
696 10790(values.fill_style = FillOpaqueStippled;)B
696 10630(grayhard = \(Hardware\) gray->hard.addr;)B
696 10470(values.stipple = grayhard->w;)B
696 10310(valuemask = valuemask|GCFunction|GCForeground|GCBackground|GCFillStyle|GCStipple;)B
696 10150(gc = grayhard->gc;)B
696 9830(hard = \(Hardware\) to->hard.addr;)B
696 9670(if \(hard->last_used == ISHALFTONE &&)B
1032 9510(hard->last_color.halftone == grayhard->w\))B
864 9350(ok = TRUE;)B
696 9030(if \(!gc\))B
864 8870(printf\("HalfTone GC not set!\\n"\);)B
528 8550(} else return;)B
528 8230(if \(to->clip\) {)B
696 8070(hard = \(Hardware\) to->clip->hard.addr;)B
696 7910(values.clip_mask = hard->w;)B
696 7750(valuemask = valuemask|GCClipMask;)B
696 7430(if \(ok\))B
864 7270(gc = \(\(Hardware\) to->hard.addr\)->gc;)B
360 6950(/*)B
672(if \(to->clip->changed\) {)X
1620 6790(to->clip->changed = FALSE;)B
1620 6630(printf\("Clip changed.\\n"\);)B
1620 6470(gc = NULL;)B
1200 6310(})B
360 6150(*/)B
696 5990(gc = NULL;)B
528 5830(})B
528 5510(if \(!gc\) {)B
696 5350(gc = XCreateGC\(dpy, RootWindow\(dpy, SCREEN\), valuemask, &values\);)B
528 5190(})B
528 5030(tohard = \(Hardware\) to->hard.addr;)B
528 4710(XFillPolygon\(dpy, tohard->w, gc, coord, 4, Complex, CoordModeOrigin\);)B
528 4390(hard = \(Hardware\) to->hard.addr;)B
8088 14470(hard->last_used = ret;)B
8088 14310(hard->gc = gc;)B
7920 13990(/*     if \(created\))B
8760 13830(XFreeGC\(dpy, gc\);)B
8760 13670(*/)B
8088 13350(UpdateControl \(to, TRUE\);)B
8088 13030(to->touched = TRUE;)B
8088 12870(to->changed = TRUE;)B
7920 12710(})B
7920 12390(/*)B
8004 12230(* )B
8004 12070(* )B
420(BitBltLine \(\) is expected to draw a line between the given points)X
8004 11910(* )B
420(with the given RasterOp and colour masking.)X
8004 11750(* )B
420(The line should be one pixel wide and half-open.)X
8004 11590(* )B
420([Thicker lines are done with BitBlt.])X
8004 11430(* )B
8004 11270(* )B
420(PaintLine \(\) is expected to Paint a line by analogy with Paint)X
8004 11110(* )B
420(and BitBlt.)X
8004 10950(*/)B
7920 10630(void BitBltLine \(h, fromPoint, toPoint, rop\))B
8340 10470(struct hardware *h;)B
8340 10310(DevicePoint fromPoint, toPoint;)B
8340 10150(int rop;)B
7920 9990({)B
8088 9830(if \(h\) {)B
8256 9670(Hardware hard = \(Hardware\) h->hard.addr;)B
8256 9510(if \(IsWindowHardware\(h\)\) {)B
8424 9350(XDrawLine\(dpy, hard->w, fillgc[rop], fromPoint.dx, fromPoint.dy,)B
9264 9190(toPoint.dx, toPoint.dy\);)B
8256 9030(} else)B
8424 8870(if \(IsBitmapHardware\(h\)\) {)B
8592 8710(XDrawLine\(dpy, hard->w, BitmapGC[rop], fromPoint.dx, fromPoint.dy,)B
9432 8550(toPoint.dx, toPoint.dy\);)B
8424 8390(})B
8256 8070(h->touched = TRUE;)B
8256 7910(h->changed = TRUE;)B
8088 7750(})B
7920 7590(})B
7920 7270(void PaintLine \(h, fromPoint, toPoint, colour\))B
8340 7110(struct hardware *h;)B
8340 6950(DevicePoint fromPoint, toPoint;)B
8340 6790(Colour colour;)B
7920 6630({)B
8088 6470(int col;)B
8088 6150(if \(h == NULL\))B
8256 5990(return;)B
8088 5670(col = IsWindowHardware \(h\) ? HardColour \(colour\) : 0;)B
8088 5350(UpdateControl \(h, FALSE\);)B
8088 5030(if \(h->clip == NULL && \(col == 0 || col == TransferSize \(\) - 1\)\))B
8256 4870(BitBltLine \(h, fromPoint, toPoint,)B
9264 4710(\(col == 0 ? ROP_TRUE : ROP_FALSE\)\);)B
8088 4550(else {)B
8256 4390(int mx = Min \(fromPoint.dx, toPoint.dx\), my = Min \(fromPoint.dy,)B
EndPage
HfDict begin ep end
%%Page: ? 4
HfDict begin bp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](7)Gaudy
0 F
4980 14470(toPoint.dy\),)B
696 14310(Mx = Max \(fromPoint.dx, toPoint.dx\), My = Max \(fromPoint.dy,)B
4644 14150(toPoint.dy\);)B
696 13990(DevicePoint orig, ex;)B
696 13670(orig = NewDevicePoint \(mx, my\);)B
696 13510(ex = NewDevicePoint \(Mx - mx + 1, My - my + 1\);)B
696 13190(NeedAux \(h\);)B
696 13030(BitBlt \(\(struct hardware *\) NULL, h->aux, orig, orig, ex, ROP_FALSE\);)B
696 12710(BitBltLine \(h->aux, fromPoint, toPoint, ROP_TRUE\);)B
696 12390(BitBlt \(h->clip, h->aux, orig, orig, ex, ROP_AND\);)B
696 12230(BitBlt \(h->aux, h, orig, orig, ex, ROP_NOTAND\);)B
696 11910(if \(col != 0 && col != TransferSize \(\) - 1\) {)B
864 11750(struct hardware *gray = GraySync \(col\);)B
864 11590(RasterTile \(gray, h->aux, orig, ex, ROP_AND\);)B
696 11430(})B
696 11270(BitBlt \(h->aux, h, orig, orig, ex, ROP_OR\);)B
528 11110(})B
528 10950(UpdateControl \(h, TRUE\);)B
528 10630(h->touched = TRUE;)B
528 10470(h->changed = TRUE;)B
360 10310(})B
360 9990(/*)B
444 9830(* BitBltBlob \(\) takes a set of pixel coordinates and fills the trapezon)B
444 9670(* figure half open.)B
444 9510(*/)B
360 9190(void BitBltBlob \(to, top, height, left, right, rop\))B
780 9030(struct hardware *to;)B
780 8870(int top, height, *left, *right, rop;)B
360 8710({)B
528 8550(int i;)B
528 8390(DevicePoint p1, p2;)B
528 8230(for \(i=0 ; i<height ; i++\) {)B
696 8070(p1 = NewDevicePoint \(left[i], top + i\);)B
696 7910(p2 = NewDevicePoint \(right[i], top + i\);)B
696 7750(BitBltLine\(to, p1, p2, rop\);)B
528 7590(})B
360 7430(})B
360 7110(/*)B
444 6950(* RasterTile \(\) replicates the whole of ``from'' over ``to'', but clipped by)B
444 6790(* the rectangle bounded by ``toPoint'' and ``extent''.)B
444 6630(*/)B
360 6470(void RasterTile \(from, to, toPoint, extent, rop\))B
780 6310(struct hardware *from, *to;)B
780 6150(DevicePoint toPoint, extent;)B
780 5990(int rop;)B
360 5830({)B
528 5670(Hardware fromhard, tohard;)B
528 5510(static GC wgc = NULL, bgc = NULL;)B
528 5350(XGCValues values;)B
528 5190(int valuemask;)B
528 5030(if \(to == NULL\) return;)B
528 4870(if \(from == NULL || IsWindowHardware\(from\)\))B
696 4710(Punt\("Can only RasterTile from Bitmap."\);)B
528 4390(fromhard = \(Hardware\) from->hard.addr;)B
8088 14470(tohard = \(Hardware\) to->hard.addr;)B
8088 14310(values.tile = fromhard->w;)B
8088 14150(values.fill_style = FillTiled;)B
8088 13990(values.function = rop;)B
8088 13830(valuemask = GCFunction | GCTile | GCFillStyle;)B
8088 13670(if \(IsWindowHardware \(to\)\) {)B
8256 13510(if \(wgc == NULL\) {)B
8424 13350(wgc = XCreateGC\(dpy, RootWindow\(dpy, SCREEN\),)B
9768 13190(valuemask, &values\);)B
8256 13030(} else {)B
8424 12870(XChangeGC\(dpy, wgc, valuemask, &values\);)B
8256 12710(})B
8256 12550(XFillRectangle\(dpy, tohard->w, wgc, toPoint.dx, toPoint.dy,)B
9516 12390(extent.dx, extent.dy\);)B
8088 12230(} else)B
8256 12070(if \(IsBitmapHardware\(to\)\){)B
8424 11910(if \(bgc == NULL\) {)B
8592 11750(bgc = XCreateGC\(dpy, tohard->w, valuemask, &values\);)B
8424 11590(} else {)B
8592 11430(XChangeGC\(dpy, bgc, valuemask, &values\);)B
8424 11270(})B
8424 11110(XFillRectangle\(dpy, tohard->w, bgc, toPoint.dx, toPoint.dy,)B
9684 10950(extent.dx, extent.dy\);)B
8256 10790(})B
8088 10630(to->touched = TRUE;)B
8088 10470(to->changed = TRUE;)B
7920 10310(})B
7920 9990(/******************* BRIGHTNESS TRANSFER FUNCTION ************************/)B
7920 9830(/*)B
8004 9670(* )B
8004 9510(* TransferSize \(\) and SetTransfer \(\) control the mapping function between)B
8004 9350(* user brightnesses and device brightnesses. The interface is expected to)B
8004 9190(* perform this mapping of brightnesses to a sufficient resolution.)B
8004 9030(* SetTransfer takes a table of floating point numbers between 0 and 1. User)B
8004 8870(* brightnesses are scaled to the size of this table and mapped through it.)B
8004 8710(* The argument table given to SetTransfer \(\) will be deleted after use.)B
8004 8550(* TransferSize \(\) simply enquires the required size of the table.)B
8004 8390(* )B
8004 8230(* It may be appropriate to half-tone on a grayscale or colour device to)B
8004 8070(* improve rendering if it is not too expensive. TransferSize \(\) returns the)B
8004 7910(* size of the pattern table.)B
8004 7750(*/)B
7920 7430(void ModifyGC \(color, src, dest, fromPoint, toPoint, extent\))B
8340 7270(Colour color;)B
8340 7110(struct hardware *src, *dest;)B
8340 6950(DevicePoint fromPoint, toPoint, extent;)B
7920 6790({)B
8088 6630(int bright, ret;)B
8088 6470(Hardware hard, grayhard, cliphard, temphard;)B
8088 6310(struct hardware *halftone;)B
8088 6150(unsigned long pixelvalue = BlackPixel\(dpy, SCREEN\);)B
8088 5990(Pixmap gray;)B
8088 5830(XGCValues values;)B
8088 5670(int valuemask = 0;)B
8088 5510(Drawable root = RootWindow\(dpy, SCREEN\);)B
8088 5190(/* Handles only monochrome for now.  Fix for color later. */)B
8088 4870(/*)B
8172 4710(* This routine should take a color, a destination, and a source)B
8172 4550(* hardware.  Simplest case:)B
8172 4390(* Solid color, No clip, No from.)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](8)Gaudy
0 F
612 14470(*)B
612 14310(* Worst case:)B
612 14150(* Halftone, to clip, from non-null.)B
612 13990(*/)B
528 13670(bright = transfer[\(int\)\(\(TRANSFER_SIZE - 1\) * color.brightness + .5\)];)B
528 13350(if \(bright == 0\) {)B
696 13190(pixelvalue = BlackPixel\(dpy, SCREEN\);)B
696 13030(ret = ISPIXEL;)B
528 12870(} else if \(bright == TRANSFER_SIZE - 1\) {)B
696 12710(pixelvalue = WhitePixel\(dpy, SCREEN\);)B
696 12550(ret = ISPIXEL;)B
528 12390(} else {)B
696 12230(halftone = GraySync\(bright\);)B
696 12070(grayhard = \(Hardware\) halftone->hard.addr;)B
696 11910(ret = ISHALFTONE;)B
528 11750(})B
528 11430(if \(IsBitmapHardware\(dest\)\) {)B
696 11270(root = \(\(Hardware\) dest->hard.addr\)->w;)B
696 11110(values.function = GXcopy;)B
696 10950(values.foreground = 1;)B
696 10790(values.background = 0;)B
696 10630(values.fill_style = FillSolid;)B
696 10470(values.clip_mask = None;)B
696 10310(valuemask = GCFunction|GCForeground|GCBackground|GCFillStyle|GCClipMask;)B
696 10150(if \(ret == ISHALFTONE\) {)B
864 9990(values.fill_style = FillTiled;)B
864 9830(values.tile = grayhard->w;)B
864 9670(values.ts_x_origin = 0;)B
864 9510(values.ts_y_origin = 0;)B
864 9350(valuemask = valuemask|GCFillStyle|GCTile|GCTileStipXOrigin|GCTileStipYOrigin;)B
696 9190(})B
696 8870(if \(src\) {)B
864 8710(hard = \(Hardware\) src->hard.addr;)B
864 8550(if \(dest->clip\) {)B
1032 8390(cliphard = \(Hardware\) dest->clip->hard.addr;)B
1032 8230(if \(ret == ISHALFTONE\) {)B
1200 8070(NeedAux\(dest\);)B
1200 7910(BitBlt\(dest->clip, dest->aux, toPoint,)B
1788 7750(NewDevicePoint\(0, 0\), extent, ROP_SOURCE\);)B
1200 7590(BitBlt\(src, dest->aux, fromPoint,)B
1788 7430(NewDevicePoint\(0, 0\), extent, ROP_AND\);)B
1200 7110(hard = \(Hardware\) dest->aux->hard.addr;)B
1200 6950(values.clip_mask = hard->w;)B
1200 6790(values.clip_x_origin = toPoint.dx;)B
1200 6630(values.clip_y_origin = toPoint.dy;)B
1200 6470(valuemask = valuemask|GCClipMask|GCClipXOrigin|GCClipYOrigin;)B
1032 6310(} else {)B
1200 6150(values.clip_mask = cliphard->w;)B
1200 5990(values.clip_x_origin = 0;)B
1200 5830(values.clip_y_origin = 0;)B
1200 5670(values.fill_style = FillStippled;)B
1200 5510(values.stipple = hard->w;)B
1200 5350(values.ts_x_origin = 0;)B
1200 5190(values.ts_y_origin = 0;)B
1200 5030(valuemask = valuemask|GCClipMask|GCClipXOrigin|GCClipYOrigin|GCFillStyle|GCStip)B
1032 4870(})B
864 4710(} else {)B
1032 4550(if \(ret == ISHALFTONE\) {)B
1200 4390(values.clip_mask = hard->w;)B
8760 14470(values.clip_x_origin = toPoint.dx;)B
8760 14310(values.clip_y_origin = toPoint.dy;)B
8760 14150(valuemask = valuemask|GCClipMask|GCClipXOrigin|GCClipYOrigin;)B
8592 13990(} else {)B
8760 13830(/*)B
8844 13670(* This should be fixed to use stipple, not)B
8844 13510(* clip.)B
8844 13350(*)B
8844 13190(* values.fill_style = FillStippled;)B
8844 13030(* values.stipple = hard->w;)B
8844 12870(* valuemask = valuemask|GCFillStyle|GCStipple;)B
8844 12710(* gc = MakeGC;)B
8844 12550(*/)B
8760 12390(NeedAux\(dest\);)B
8760 12230(BitBlt\(src, dest->aux, fromPoint,)B
9348 12070(NewDevicePoint\(0, 0\),)B
9348 11910(extent, ROP_SOURCE\);)B
8760 11750(hard = \(Hardware\) dest->aux->hard.addr;)B
8760 11590(values.clip_mask = hard->w;)B
8760 11430(values.clip_x_origin = toPoint.dx;)B
8760 11270(values.clip_y_origin = toPoint.dy;)B
8760 11110(valuemask = valuemask|GCClipMask|GCClipXOrigin|GCClipYOrigin;)B
8592 10950(})B
8424 10790(})B
8256 10630(} else { /* \(!src\) */)B
8424 10470(if \(dest->clip\) {)B
8592 10310(cliphard = \(Hardware\) dest->clip->hard.addr;)B
8592 10150(values.clip_mask = cliphard->w;)B
8592 9990(values.clip_x_origin = 0;)B
8592 9830(values.clip_y_origin = 0;)B
8592 9670(valuemask = valuemask|GCClipMask|GCClipXOrigin|GCClipYOrigin;)B
8424 9510(})B
8256 9350(})B
8088 9190(} else { /* \(IsWindowHardware\(dest\)\) */)B
8256 9030(root = RootWindow \(dpy, SCREEN\);)B
8256 8870(values.function = GXcopy;)B
8256 8710(values.foreground = pixelvalue;)B
8256 8550(values.background = WhitePixel \(dpy, SCREEN\);)B
8256 8390(values.fill_style = FillSolid;)B
8256 8230(values.clip_mask = None;)B
8256 8070(valuemask = GCFunction|GCForeground|GCBackground|GCFillStyle|GCClipMask;)B
8256 7910(if \(ret == ISHALFTONE\) {)B
8424 7750(values.fill_style = FillOpaqueStippled;)B
8424 7590(values.stipple = grayhard->w;)B
8424 7430(values.ts_x_origin = 0;)B
8424 7270(values.ts_y_origin = 0;)B
8424 7110(valuemask = valuemask|GCFillStyle|GCStipple|GCTileStipXOrigin|GCTileStipYOrigin;)B
8256 6950(})B
8256 6630(if \(src\) {)B
8424 6470(hard = \(Hardware\) src->hard.addr;)B
8424 6310(if \(dest->clip\) {)B
8592 6150(cliphard = \(Hardware\) dest->clip->hard.addr;)B
8592 5990(if \(ret == ISHALFTONE\) {)B
8760 5830(NeedAux\(dest\);)B
8760 5670(BitBlt\(dest->clip, dest->aux, toPoint,)B
9348 5510(NewDevicePoint\(0, 0\), extent, ROP_SOURCE\);)B
8760 5350(BitBlt\(src, dest->aux, fromPoint,)B
9348 5190(NewDevicePoint\(0,0\), extent, ROP_AND\);)B
8760 4870(hard = \(Hardware\) dest->aux->hard.addr;)B
8760 4710(values.clip_mask = hard->w;)B
8760 4550(values.clip_x_origin = toPoint.dx;)B
8760 4390(values.clip_y_origin = toPoint.dy;)B
EndPage
HfDict begin ep end
%%Page: ? 5
HfDict begin bp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](9)Gaudy
0 F
1200 14470(values.fill_style = FillOpaqueStippled;)B
1200 14310(values.stipple = grayhard->w;)B
1200 14150(valuemask = valuemask|GCClipMask|GCClipXOrigin|GCClipYOrigin|GCFillStyle|GCStip)B
1032 13990(} else { /* ISPIXEL */)B
1200 13830(if \(IsWindowHardware\(src\)\) {)B
1368 13670(values.clip_mask = cliphard->w;)B
1368 13510(values.fill_style = FillTiled;)B
1368 13350(values.tile = hard->w;)B
1368 13190(valuemask = valuemask|GCClipMask|GCFillStyle|GCTile;)B
1200 13030(} else {)B
1368 12870(/* should also handle fromPoint here,)B
1452 12710(* but this would have to be saved in)B
1452 12550(* order for the cache to work properly.)B
1452 12390(*/)B
1368 12230(values.clip_mask = cliphard->w;)B
1368 12070(values.fill_style = FillStippled;)B
1368 11910(values.stipple = hard->w;)B
1368 11750(valuemask = valuemask|GCClipMask|GCFillStyle|GCStipple;)B
1200 11590(})B
1032 11430(})B
864 11270(} else { /* \(!dest->clip\) */)B
1032 11110(if \(ret == ISHALFTONE\) {)B
1200 10950(values.clip_mask = hard->w;)B
1200 10790(values.clip_x_origin = 0;)B
1200 10630(values.clip_y_origin = 0;)B
1200 10470(valuemask = valuemask|GCClipMask|GCClipXOrigin|GCClipYOrigin;)B
1032 10310(} else { /* ISPIXEL */)B
1200 10150(if \(IsWindowHardware\(src\)\) {)B
1368 9990(hard = \(Hardware\) src->hard.addr;)B
1368 9830(values.fill_style = FillTiled;)B
1368 9670(values.tile = hard->w;)B
1368 9510(values.ts_x_origin = 0;)B
1368 9350(values.ts_y_origin = 0;)B
1368 9190(valuemask = valuemask|GCFillStyle|GCTile|GCTileStipXOrigin|GCTileStipYOrigin;)B
1200 9030(} else {)B
1368 8870(values.fill_style = FillStippled;)B
1368 8710(values.stipple = hard->w;)B
1368 8550(values.ts_x_origin = toPoint.dx-fromPoint.dx;)B
1368 8390(values.ts_y_origin = toPoint.dy-fromPoint.dy;)B
1368 8230(valuemask = valuemask|GCFillStyle|GCStipple|GCTileStipXOrigin|GCTileStipYOrig)B
1200 8070(})B
1032 7910(})B
864 7750(})B
696 7590(} else { /* \(!src\) */)B
864 7430(hard = \(Hardware\) dest->hard.addr;)B
864 7270(if \(dest->clip\) {)B
1032 7110(cliphard = \(Hardware\) dest->clip->hard.addr;)B
1032 6950(if \(ret == ISHALFTONE\) {)B
360 6790(/*)B
1932(if \(\(hard->last_used != ISHALFTONE\) ||)X
2796 6630(\(hard->last_color.halftone != grayhard->w\)\) {*/)B
1200 6470(values.clip_mask = cliphard->w;)B
1200 6310(values.fill_style = FillOpaqueStippled;)B
1200 6150(values.stipple = grayhard->w;)B
1200 5990(valuemask = valuemask|GCClipMask|GCFillStyle|GCStipple;)B
360 5830(/*)B
2352(hard->gc = MakeGC;)X
2880 5670(hard->last_used = ISHALFTONE;)B
2880 5510(hard->last_color.halftone = grayhard->w;)B
2460 5350(})B
2460 5190(gc = hard->gc;)B
360 5030(*/)B
1032 4870(} else { /* ISPIXEL */)B
1200 4710(values.clip_mask = cliphard->w;)B
1200 4550(valuemask = valuemask|GCClipMask;)B
1032 4390(})B
8424 14470(} else { /* \(!dest->clip\) */)B
8592 14310(if \(ret == ISHALFTONE\) {)B
8760 14150(values.fill_style = FillOpaqueStippled;)B
8760 13990(values.stipple = grayhard->w;)B
8760 13830(valuemask = valuemask|GCFillStyle|GCStipple;)B
7920 13670(/*)B
1512(} else {)X
10020 13510(if \(pixelvalue == BlackPixel\(dpy, SCREEN\)\))B
10440 13350(gc = fillgc[GXcopy];)B
10020 13190(else if \(pixelvalue == WhitePixel\(dpy, SCREEN\)\))B
10440 13030(gc = whitegc;)B
10020 12870(else {)B
10440 12710(gc = MakeGC;)B
10020 12550(})B
7920 12390(*/)B
8592 12230(})B
8424 12070(})B
8256 11910(})B
8088 11750(})B
8088 11430(if \(!GlobalGC\) {)B
8256 11270(GlobalGC = XCreateGC\(dpy, root, valuemask, &values\);)B
8256 11110(GlobalMask = valuemask;)B
8088 10950(} else {)B
8256 10790(XChangeGC\(dpy, GlobalGC, valuemask, &values\);)B
8256 10630(GlobalMask = valuemask;)B
8088 10470(})B
7920 10310(})B
7920 9990(ColorType RealColor \(color, pixelvalue, halftone\))B
8340 9830(Colour color;)B
8340 9670(unsigned long *pixelvalue;)B
8340 9510(struct hardware **halftone;)B
7920 9350({)B
8088 9190(int bright;)B
8088 9030(XGCValues values;)B
8088 8710(bright = transfer[\(int\)\(\(TRANSFER_SIZE - 1\) * color.brightness + .5\)];)B
8088 8390(if \(bright == 0\) {)B
8256 8230(*pixelvalue = BlackPixel\(dpy, SCREEN\);)B
8256 8070(return ISPIXEL;)B
8088 7910(} else if \(bright == TRANSFER_SIZE - 1\) {)B
8256 7750(*pixelvalue = WhitePixel\(dpy, SCREEN\);)B
8256 7590(if \(!whitegc\) {)B
8424 7430(values.function = GXcopy;)B
8424 7270(values.foreground = WhitePixel\(dpy, SCREEN\);)B
8424 7110(values.background = BlackPixel\(dpy, SCREEN\);)B
8424 6950(whitegc = XCreateGC\(dpy, RootWindow\(dpy, SCREEN\),)B
10104 6790(GCFunction|GCForeground|GCBackground,)B
10104 6630(&values\);)B
8256 6470(})B
8256 6310(return ISPIXEL;)B
8088 6150(})B
8088 5830(*halftone = GraySync\(bright\);)B
8088 5670(return ISHALFTONE;)B
7920 5510(})B
7920 5190(struct hardware *GraySync \(col\))B
8340 5030(int col;)B
7920 4870({)B
8088 4710(col = col * \(float\) screen_size / TRANSFER_SIZE + 0.5;)B
8088 4390(return screen[col].shade;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](10)Gaudy
0 F
360 14470(})B
360 14150(int HardColour \(colour\))B
780 13990(Colour colour;)B
360 13830({)B
528 13670(/* DCJ:)B
612 13510(* This is a hack.  This is only a hack.  If this had been real)B
612 13350(* code, you would have been notified of it through email.)B
612 13190(*/)B
528 13030(if \(BlackPixel\(dpy, SCREEN\) == 0\))B
696 12870(return \(TRANSFER_SIZE - 1 - transfer [\(int\) \(\(TRANSFER_SIZE - 1\) * colour.brightness )B
528 12710(else)B
696 12550(return transfer [\(int\) \(\(TRANSFER_SIZE - 1\) * colour.brightness + .5\)];)B
360 12390(})B
360 12070(int TransferSize \(\))B
360 11910({)B
528 11750(return TRANSFER_SIZE;)B
360 11590(})B
360 11270(#define TransferSize\(\) TRANSFER_SIZE)B
360 10950(void SetTransfer \(tran\))B
780 10790(float *tran;)B
360 10630({)B
528 10470(int i;)B
528 10150(for \(i = 0; i < TRANSFER_SIZE; i++\))B
696 9990(transfer [i] = \(TRANSFER_SIZE - 1\) * tran[i] + .5;)B
360 9830(})B
360 9510(/********************** BITMAP CONVERSION ********************************/)B
360 9350(/*)B
444 9190(* )B
444 9030(* StringFromHardware \(\) produces a string from its argument which describes)B
444 8870(* the bitmap.  The bitmap is returned in row-major order with the leftmost)B
444 8710(* bit of each byte in the most significant position. Rows are padded to byte)B
444 8550(* boundaries. Only single plane bitmaps are used.)B
444 8390(* )B
444 8230(* HardwareFromString \(\) performs the inverse mapping, generating a bitmap)B
444 8070(* from a set of bits, given a width and height. Only single plane bitmaps are)B
444 7910(* used.)B
444 7750(*/)B
360 7430(/*char *StringFromHardware \(h\))B
360 7270(struct hardware *h;)B
360 7110({)B
696 6950(XImage *image;)B
696 6790(Hardware hard;)B
696 6630(char *result, *ptr, c;)B
696 6470(int x, y, i, hdx, hdy;)B
696 6310(if \(h == NULL\) return NULL;)B
696 6150(hard = \(Hardware\) h->hard.addr;)B
696 5990(hdx = h->extent.dx;)B
696 5830(hdy = h->extent.dy;)B
696 5670(image = XGetImage\(dpy, hard->w, 0, 0, hdx, hdy, AllPlanes, ZPixmap\);)B
696 5510(result = Malloc\(\(\(hdx + 7\) / 8\) * hdy\);)B
696 5350(ptr = result;)B
696 5190(for \(y=0 ; y<hdy ; y++\) {)B
1032 5030(for \(x=0 ; x<hdx ; x+=8\) {)B
1368 4870(c = 0;)B
1368 4710(for \(i=0 ; i<8 ; i++\) {)B
1704 4550(c = c << 1;)B
1704 4390(if \(x+i < hdx\))B
9600 14470(c |= XGetPixel\(image, x+i, y\);)B
8928 14310(})B
8592 14150(})B
8592 13990(*ptr++ = c;)B
8256 13830(})B
8256 13670(Free\(\(char *\) image\);)B
8256 13510(return \(char *\) result;)B
7920 13350(})B
7920 13030(struct hardware *HardwareFromString \(s, width, height\))B
7920 12870(char *s;)B
7920 12710(int width, height;)B
7920 12550({)B
8256 12390(struct hardware *h = NewBitmapHardware\(width, height\);)B
8256 12230(Hardware hard = \(Hardware\) h->hard.addr;)B
8256 12070(XImage *image;)B
8256 11910(if \(s == NULL\) Punt\("HardwareFromString called with NULL string!"\);)B
8256 11750(image = XCreateImage\(dpy, DefaultVisual\(dpy, SCREEN\),)B
10020 11590(DefaultDepth\(dpy, SCREEN\), ZPixmap, 0, s,)B
10020 11430(h->extent.dx, h->extent.dy, 8, 0\);)B
8256 11270(image->bitmap_bit_order = MSBFirst;)B
8256 11110(XPutImage\(dpy, hard->w, fillgc[GXcopy], image, 0, 0, 0, 0,)B
9096 10950(h->extent.dx, h->extent.dy\);)B
8256 10790(free\(\(char *\) image\);)B
8256 10630(return h;)B
7920 10470(})B
7920 10310(*/)B
7920 10150(unsigned char *StringFromHardware \(h\))B
8340 9990(struct hardware *h;)B
7920 9830({)B
8088 9670(XImage *image;)B
8088 9510(Hardware hard;)B
8088 9350(unsigned char *result, *ptr, c;)B
8088 9190(int x, y, i, hdx, hdy;)B
8088 8870(printf\("StringFromHardware called.\\n"\);)B
8088 8550(if \(h == NULL || !IsBitmapHardware\(h\)\) return NULL;)B
8088 8230(printf\("and is getting the image.\\n"\);)B
8088 7910(hard = \(Hardware\) h->hard.addr;)B
8088 7750(hdx = h->extent.dx;)B
8088 7590(hdy = h->extent.dy;)B
8088 7430(image = XGetImage\(dpy, hard->w, 0, 0, hdx, hdy, AllPlanes, XYPixmap\);)B
8088 7270(result = \(unsigned char *\) Malloc\(\(\(hdx + 7\) / 8\) * hdy\);)B
8088 7110(ptr = result;)B
8088 6950(for \(y=0 ; y<hdy ; y++\) {)B
8256 6790(for \(x=0 ; x<hdx ; x+=8\) {)B
8424 6630(c = 0;)B
8424 6470(for \(i=0 ; i<8 ; i++\) {)B
8592 6310(c = c << 1;)B
8592 6150(if \(x+i < hdx\))B
8760 5990(c |= XGetPixel\(image, x+i, y\);)B
8424 5830(})B
8256 5670(})B
8256 5510(*ptr++ = c;)B
8088 5350(})B
8088 5190(Free\(\(char *\) image\);)B
8088 5030(return result;)B
7920 4870(})B
7920 4550(struct hardware *HardwareFromString \(s, width, height\))B
8340 4390(unsigned char *s;)B
EndPage
HfDict begin ep end
%%Page: ? 6
HfDict begin bp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](11)Gaudy
0 F
780 14470(int width, height;)B
360 14310({)B
528 14150(struct hardware *h = NewBitmapHardware\(width, height\);)B
528 13990(Hardware hard = \(Hardware\) h->hard.addr;)B
528 13830(XImage *image;)B
528 13510(printf\("HardwareFromString called.\\n"\);)B
528 13190(if \(s == NULL\) Punt\("HardwareFromString called with NULL string!"\);)B
528 13030(image = XCreateImage\(dpy, DefaultVisual\(dpy, SCREEN\),)B
2292 12870(1, XYBitmap, 0, s,)B
2292 12710(h->extent.dx, h->extent.dy, 8, 0\);)B
528 12550(image->bitmap_bit_order = MSBFirst;)B
528 12390(XPutImage\(dpy, hard->w, BitmapGC[GXcopy], image, 0, 0, 0, 0,)B
1368 12230(h->extent.dx, h->extent.dy\);)B
528 12070(free\(\(char *\) image\);)B
528 11910(h->touched = TRUE;)B
528 11750(h->changed = TRUE;)B
528 11590(return h;)B
360 11430(})B
360 11110(/************************* HALF-TONE SCREEN *******************************/)B
360 10950(/*)B
444 10790(* ScreenSize \(\) allows PostScript to determine how large an array of sample)B
444 10630(* points to expect.  It should return the length of the side of the sample)B
444 10470(* square.)B
444 10310(* )B
444 10150(* BuildScreen \(\) returns a set of sampling coordinates to PostScript to hand)B
444 9990(* to the users spot-function)B
444 9830(* )B
444 9670(* SetScreen \(\) allows PostScript to set the thresholds for each sample point)B
444 9510(* so that half-tone bitmaps can be made.)B
444 9350(*/)B
360 9030(static int FreqSize \(freq\))B
780 8870(float freq;)B
360 8710({)B
528 8550(int i = pixels_per_inch / freq + 0.5;)B
528 8230(if \(i < 2\))B
696 8070(return 2;)B
528 7910(return i;)B
360 7750(})B
360 7430(int ScreenSize \(freq, rot\))B
780 7270(float freq, rot;)B
360 7110({)B
528 6950(int size = FreqSize \(freq\);)B
528 6630(return size * size;)B
360 6470(})B
360 6150(void BuildScreen \(freq, rotation, x, y\))B
780 5990(float freq, rotation, *x, *y;)B
360 5830({)B
528 5670(int size = FreqSize \(freq\);)B
528 5510(int i, j;)B
528 5190(for \(i = 0; i < size; i++\))B
696 5030(for \(j = 0; j < size; j++\))B
864 4870(*x++ = \(2 * i - size + 1\) / \(float\) size,)B
864 4710(*y++ = \(2 * j - size + 1\) / \(float\) size;)B
360 4550(})B
7920 14470(#ifdef notdef)B
7920 14310(static int sgn \(a\))B
8340 14150(float a;)B
7920 13990({)B
8088 13830(if \(a == 0\))B
8256 13670(return 0;)B
8088 13510(else if \(a < 0\))B
8256 13350(return -1;)B
8088 13190(else)B
8256 13030(return 1;)B
7920 12870(})B
7920 12550(static int screen_cmp \(a, b\))B
8340 12390(char *a, *b;)B
7920 12230({)B
8088 12070(struct screen *aa = \(struct screen *\) a, *bb = \(struct screen *\) b;)B
8088 11910(static int count = 0;)B
8088 11590(return sgn \(aa->val - bb->val\);)B
7920 11430(})B
7920 11270(#endif)B
7920 10950(static int screen_cmp \(a, b\))B
8340 10790(struct screen *a, *b;)B
7920 10630({)B
8088 10470(float diff = a->val - b->val;)B
8088 10310(if\(diff > 0.0\) return 1;)B
8088 10150(if\(diff < 0.0\) return -1;)B
8088 9990(return 0;)B
7920 9830(})B
7920 9510(void SetScreen \(freq, rotation, thresh\))B
8340 9350(float freq, rotation, *thresh;)B
7920 9190({)B
8088 9030(struct hardware *temp;)B
8088 8870(int i, j, size = FreqSize \(freq\);)B
8088 8710(struct screen *p;)B
8088 8550(int valuemask;)B
8088 8390(XGCValues values;)B
8088 8230(Hardware hard;)B
8088 7910(if \(screen\) {)B
8256 7750(for \(i = 0; i < screen_size; i++\))B
8424 7590(DestroyHardware \(screen [i].shade\);)B
8256 7430(free \(\(char *\) screen\);)B
8088 7270(})B
8088 7110(p = screen = \(struct screen *\) Malloc \(\(unsigned\) \(\(\(screen_size = size * size\) + 1\) * )B
7920 6950(/*     screen_side = size;*/)B
8088 6790(for \(i = 0; i < size; i++\))B
8256 6630(for \(j = 0; j < size; j++\) {)B
8424 6470(p->val = *thresh++;)B
8424 6310(p->sx = i;)B
8424 6150(p->sy = j;)B
8424 5990(++p;)B
8256 5830(})B
8088 5670(qsort \(\(char *\) screen, screen_size, sizeof \(struct screen\), screen_cmp\);)B
8088 5510(temp = NewBitmapHardware \(size, size\);)B
8088 5350(BitBlt \(\(struct hardware *\) NULL, temp, NewDevicePoint \(0, 0\),)B
8760 5190(NewDevicePoint \(0, 0\), NewDevicePoint \(size, size\), ROP_TRUE\);)B
8088 4870(for \(i = 0; i < screen_size; i++\) {)B
8256 4710(screen [i].shade = NewBitmapHardware \(size, size\);)B
8256 4550(BitBlt \(temp, screen[i].shade,)B
8928 4390(NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\),)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(X11.c)[(89/04/06)(11:54:05)](12)Gaudy
0 F
1368 14470(NewDevicePoint \(size, size\), ROP_SOURCE\);)B
696 14310(BitBlt \(\(struct hardware *\) NULL, temp,)B
1368 14150(NewDevicePoint \(0, 0\),)B
1368 13990(NewDevicePoint \(screen[i].sx, screen[i].sy\),)B
1368 13830(NewDevicePoint \(1, 1\), ROP_FALSE\);)B
696 13670(values.function = GXcopy;)B
696 13510(values.foreground = BlackPixel\(dpy, SCREEN\);)B
696 13350(values.background = WhitePixel\(dpy, SCREEN\);)B
696 13190(values.fill_style = FillOpaqueStippled;)B
696 13030(hard = \(Hardware\) screen[i].shade->hard.addr;)B
696 12870(values.stipple = hard->w;)B
696 12710(valuemask = GCFunction|GCForeground|GCBackground|GCFillStyle|GCStipple;)B
696 12550(hard->gc = XCreateGC\(dpy, RootWindow\(dpy, SCREEN\), valuemask,)B
2460 12390(&values\);)B
696 12230(screen[i].shade->touched = TRUE;)B
696 12070(screen[i].shade->changed = TRUE;)B
528 11910(})B
528 11750(screen[screen_size].shade = temp;)B
528 11590(values.function = GXcopy;)B
528 11430(values.foreground = BlackPixel\(dpy, SCREEN\);)B
528 11270(values.background = WhitePixel\(dpy, SCREEN\);)B
528 11110(values.fill_style = FillOpaqueStippled;)B
528 10950(hard = \(Hardware\) temp->hard.addr;)B
528 10790(values.stipple = hard->w;)B
528 10630(valuemask = GCFunction|GCForeground|GCBackground|GCFillStyle|GCStipple;)B
528 10470(hard->gc = XCreateGC\(dpy, RootWindow\(dpy, SCREEN\), valuemask,)B
2292 10310(&values\);)B
528 10150(screen[screen_size].shade->touched = TRUE;)B
528 9990(screen[screen_size].shade->changed = TRUE;)B
360 9830(})B
360 9510(/************************* CLIPPING ******************************************/)B
360 9350(/*)B
444 9190(* )B
444 9030(* SetClipHardware sets hardware which is a clip mask for BitBlt. This mask)B
444 8870(* should be ANDed with any output operation. If clip is NULL, masking will)B
444 8710(* not be needed.)B
444 8550(*/)B
360 8230(void SetClipHardware \(h, clip\))B
780 8070(struct hardware *h, *clip;)B
360 7910({)B
528 7750(if \(h\) {)B
696 7590(h->clip = clip;)B
696 7430(if \(h->clip\))B
864 7270(h->clip->changed = TRUE;)B
528 7110(})B
360 6950(})B
360 6630(/************************ UPDATE CONTROLS **********************************/)B
360 6470(/*)B
444 6310(* HardUpdate is a hook to allow devices which do output buffering to flush)B
444 6150(* that buffering when appropriate.  This allows an interactive user to see)B
444 5990(* completed graphics between prompts \(it is called as a side-effect of the)B
444 5830(* PostScript flush operator\). Typically is is a no-op.)B
444 5670(*/)B
360 5350(void HardUpdate \(\))B
360 5190({)B
528 5030(XFlush\(dpy, 0\);)B
360 4870(})B
360 4550(/*)B
444 4390(* This call can be used to enable batching of output operations.)B
8004 14470(* UpdateControl \(h, FALSE\) means ``start of batching'' UpdateControl \(h,)B
8004 14310(* TRUE\) means ``end of batching''. It is used to improve performance on)B
8004 14150(* machines where screen updates have a high locking overhead. It may be a)B
8004 13990(* no-op.  The operation should nest if batching is already in progress: FALSE)B
8004 13830(* increments a counter, TRUE decrements a counter. Display changes are)B
8004 13670(* allowed when the counter is non-zero.)B
8004 13510(*/)B
7920 13190(#ifndef UpdateControl)B
7920 13030(void UpdateControl \(h, on\))B
8340 12870(struct hardware *h;)B
8340 12710(int on;)B
7920 12550({})B
7920 12390(#endif)B
7920 12070(DevicePoint ConvertToDevicePoint \(x, y\))B
8340 11910(int x, y;)B
7920 11750({)B
8088 11590(DevicePoint res;)B
8088 11270(res.dx = \(int\) \(\(float\) x * \(float\) pixels_per_inch / 72.0\);)B
8088 11110(res.dy = \(int\) \(\(float\) y * \(float\) pixels_per_inch / 72.0\);)B
8088 10790(return res;)B
7920 10630(})B
EndPage
HfDict begin ep end
%%Page: ? 7
HfDict begin bp end
StartPage
Landscape
()(array.c)[(89/03/24)(06:27:26)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(static Object OpForAll;)B
360 11750(static int PLength \(\), PArray \(\), PRBracket \(\), PAload \(\), PAstore \(\);)B
360 11430(static int forAll \(\), ForAll \(\), PReadOnly \(\), PExecOnly \(\), PrCheck \(\);)B
360 11270(static int PwCheck \(\), PutInterval \(\), GetInterval \(\), Put \(\), Get \(\);)B
360 11110(static int Length \(\), Copy \(\), Eq \(\);)B
360 10790(int ExecArray \(\);)B
360 10630(Object Marker;)B
360 10310(static int autobind = 0;)B
360 9990(static int PSetAutoBind \(\), PGetAutoBind \(\);)B
360 9670(InitArray \(\))B
360 9510({)B
528 9350(TypeInstallOp \(Mark, )B
84("eq", EqTrue, 2, 1, 0, 0, Mark, Mark\);)X
528 9030(MakeObject \(Marker, Mark\);)B
528 8710(OpForAll = MakeOp \("\(forallarray\)", forAll, 0, 0, 3, 5\);)B
528 8390(Install \("[",)B
756(Marker\);)X
528 8230(Install \("null",)B
504(Nil\);)X
528 7910(InstallOp \("array", )B
168(PArray,)X
756(1, 1, 0, 0, Integer\);)X
528 7750(InstallOp \("]", )B
504(PRBracket,)X
504(0, 1, 0, 0\);)X
528 7590(InstallOp \("aload", )B
168(PAload,)X
756(1, 0, 0, 0, Array\);)X
528 7430(InstallOp \("astore",)B
168(PAstore,)X
672(1, 1, 0, 0, Array\);)X
528 7110(InstallOp \("setautobind",)B
420(PSetAutoBind,)X
252(1, 0, 0, 0, Bool\);)X
528 6950(InstallOp \("getautobind",)B
420(PGetAutoBind,)X
252(0, 1, 0, 0\);)X
528 6630(TypeInstallOp \(Array, "exec",)B
756(ExecArray,)X
504(1, 1, 0, 2, Array\);)X
528 6470(TypeInstallOp \(Array, "eq", )B
840(Eq,)X
1092(2, 1, 0, 0, Array,)X
1788 6310(Array\);)B
528 6150(TypeInstallOp \(Array, "put", )B
756(Put,)X
1008(3, 0, 0, 0, Array,)X
1788 5990(Integer, Poly\);)B
528 5830(TypeInstallOp \(Array, "get", )B
756(Get,)X
1008(2, 1, 0, 0, Array,)X
1788 5670(Integer\);)B
528 5510(TypeInstallOp \(Array, "putinterval", )B
84(PutInterval,)X
336(3, 0, 0, 0, Array,)X
1788 5350(Integer, Array\);)B
528 5190(TypeInstallOp \(Array, "getinterval", )B
84(GetInterval,)X
336(3, 1, 0, 0, Array,)X
1788 5030(Integer, Integer\);)B
528 4870(TypeInstallOp \(Array, "length", )B
504(PLength,)X
672(1, 1, 0, 0, Array\);)X
528 4710(TypeInstallOp \(Array, "copy", )B
672(Copy,)X
924(2, 0, 0, 0, Array,)X
1788 4550(Array\);)B
528 4390(TypeInstallOp \(Array, "forall", )B
504(ForAll,)X
756(2, 0, 0, 4, Array,)X
9348 14470(Array\);)B
8088 14310(TypeInstallOp \(Array, "executeonly", )B
84(PExecOnly,)X
504(1, 1, 0, 0, Array\);)X
8088 14150(TypeInstallOp \(Array, "readonly", )B
336(PReadOnly,)X
504(1, 1, 0, 0, Array\);)X
8088 13990(TypeInstallOp \(Array, "rcheck", )B
504(PrCheck,)X
672(1, 1, 0, 0, Array\);)X
8088 13830(TypeInstallOp \(Array, "wcheck", )B
504(PwCheck,)X
672(1, 1, 0, 0, Array\);)X
7920 13670(})B
7920 13190(Object MakeArray \(p, length\))B
8340 13030(Object *p;)B
8340 12870(int length;)B
7920 12710({)B
8088 12550(Object res;)B
8088 12230(MakeObject \(res, Array\);)B
8088 12070(res.u.Array = p;)B
8088 11910(res.Length = length;)B
8088 11590(return res;)B
7920 11430(})B
7920 10950(static Object Make \(p, length\))B
8340 10790(Object *p;)B
8340 10630(int length;)B
7920 10470({)B
8088 10310(Object res;)B
8088 9990(MakeObject \(res, Array\);)B
8088 9830(res.u.Array = p;)B
8088 9670(res.Length = length;)B
8088 9350(return res;)B
7920 9190(})B
7920 8870(#define Body\(a\) \(\(a\).u.Array\))B
7920 8550(#ifndef Body)B
7920 8390(static Object *Body \(item\))B
8340 8230(Object item;)B
7920 8070({)B
8088 7910(return item.u.Array;)B
7920 7750(})B
7920 7590(#endif)B
7920 7270(static Object ArrayStore \(n\))B
8340 7110(int n;)B
7920 6950({)B
8088 6790(Object *body = \(Object *\) Malloc \(\(unsigned\) sizeof \(Object\) * n\);)B
8088 6630(int i, h = Height \(OpStack\);)B
8088 6310(for \(i = h - n; i < h; i++\))B
8256 6150(body[i-h+n] = OpStack->stack_body[i];)B
8088 5990(OpStack->stack_fill -= n;)B
8088 5830(return Make \(body, n\);)B
7920 5670(})B
7920 5350(/*VARARGS)B
7920 5190(Object ArrayFrom \(length, args\))B
8004 5030(int length; Object args;)B
8004 4870({)B
8592 4710(Object *argv = &args, *array = \(Object *\) Malloc \(\(unsigned\) \(sizeof \(Object\) * l)B
8592 4550(int i;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(array.c)[(89/03/24)(06:27:26)](2)Gaudy
0 F
1032 14470(for \(i = 0; i < length; i++\))B
1704 14310(array[i] = argv[i];)B
1032 14150(return Cvx \(Make \(array, length\)\);)B
444 13990(})B
360 13830(*/)B
360 13510(static int PLength \(object\))B
780 13350(Object object;)B
360 13190({)B
528 13030(return Push \(OpStack, MakeInteger \(lengthArray\(object\)\)\);)B
360 12870(})B
360 12550(int ExecArray \(item\))B
780 12390(Object item;)B
360 12230({)B
528 12070(int l = lengthArray \(item\);)B
528 11910(register Object *rp;)B
528 11750(Type t;)B
528 11430(if \(l == 0\) return TRUE;)B
528 11110(/*)B
612 10950(* BZS - try some open-coding here)B
612 10790(* TMD - try some real open-coding here...)B
612 10630(Push \(ExecStack, SameFlags \(item, Make \(Body \(item\) + 1, l - 1\)\)\);)B
612 10470(*/)B
528 10310(if\(ExecStack->stack_fill != ExecStack->stack_size\) {)B
696 10150(rp = &ExecStack->stack_body[ExecStack->stack_fill++];)B
696 9990(rp->type = Array;)B
696 9830(rp->u.Integer = 0;)B
696 9670(rp->u.Array = item.u.Array + 1;)B
696 9510(rp->Length = l - 1;)B
696 9350(rp->flags = item.flags;)B
528 9190(})B
528 8870(rp = Body\(item\);)B
528 8710(t = TypeOf\(*rp\);)B
528 8550(if\(t == Name || t == Operator\) Push \(ExecStack, *rp\);)B
528 8390(else                           Push \(OpStack, *rp\);)B
528 8070(return TRUE;)B
360 7910(})B
360 7590(static int Get \(object, key\))B
780 7430(Object object, key;)B
360 7270({)B
528 7110(int index;)B
528 6790(if \(TypeOf \(key\) == Integer\))B
696 6630(index = BodyInteger \(key\);)B
528 6470(else if \(TypeOf \(key\) == Real\))B
696 6310(index = \(int\) BodyReal \(key\);)B
528 6150(else)B
696 5990(return Error \(PTypeCheck\);)B
528 5830(if \(index >= 0 && index < lengthArray\(object\)\) {)B
696 5670(Object t;)B
696 5350(t = Body \(object\) [index]; /* VAX Compiler Broken */)B
696 5190(return Push \(OpStack, t\);)B
528 5030(} else)B
696 4870(return Error \(PRangeCheck\);)B
360 4710(})B
360 4390(Object getArray \(o, index\))B
8340 14470(Object o;)B
8340 14310(int index;)B
7920 14150({)B
8088 13990(return Body \(o\)[index];)B
7920 13830(})B
7920 13510(static int GetInterval \(object, begin, length\))B
8340 13350(Object object, begin, length;)B
7920 13190({)B
8088 13030(int b = BodyInteger \(begin\), l = BodyInteger \(length\);)B
8088 12710(if \(l < 0 || b < 0 || b + l > lengthArray\(object\)\))B
8256 12550(return Error \(PRangeCheck\);)B
8088 12390(return Push \(OpStack, Make \(Body \(object\) + b, l\)\);)B
7920 12230(})B
7920 11910(Object getIArray \(object, begin, length\))B
8340 11750(Object object;)B
8340 11590(int begin, length;)B
7920 11430({)B
8088 11270(return Make \(Body \(object\) + begin, length\);)B
7920 11110(})B
7920 10790(static int Put \(object, key, value\))B
8340 10630(Object object, key, value;)B
7920 10470({)B
8088 10310(int index = BodyInteger \(key\);)B
8088 9990(if \(index < 0 || index >= lengthArray\(object\)\))B
8256 9830(return Error \(PRangeCheck\);)B
8088 9670(Body \(object\) [index] = value;)B
8088 9510(return TRUE;)B
7920 9350(})B
7920 9030(int putArray \(object, index, value\))B
8340 8870(Object object, value;)B
8340 8710(int index;)B
7920 8550({)B
8088 8390(if \(index < 0 || index >= lengthArray\(object\)\))B
8256 8230(return Error \(PRangeCheck\);)B
8088 8070(Body \(object\) [index] = value;)B
8088 7910(return TRUE;)B
7920 7750(})B
7920 7430(static int PutInterval \(object1, begin, object2\))B
8340 7270(Object object1, begin, object2;)B
7920 7110({)B
8088 6950(int i, l1 = lengthArray\(object1\), l2 = lengthArray \(object2\),)B
8088 6790(b = BodyInteger \(begin\);)B
8088 6470(if \(b < 0 || l2 + b > l1\))B
8256 6310(return Error \(PRangeCheck\);)B
8088 6150(for \(i = b; i < b + l2; i++\))B
8256 5990(Body \(object1\) [i] = Body \(object2\) [i - b];)B
8088 5830(return TRUE;)B
7920 5670(})B
7920 5350(static int Copy \(object1, object2\))B
8340 5190(Object object1, object2;)B
7920 5030({)B
8088 4870(if \(lengthArray \(object1\) <= lengthArray \(object2\)\))B
8256 4710(return PutInterval \(object2, MakeInteger \(0\), object1\))B
8424 4550(&& Push \(OpStack, Make \(Body \(object2\),)B
10440 4390(lengthArray \(object1\)\)\);)B
EndPage
HfDict begin ep end
%%Page: ? 8
HfDict begin bp end
StartPage
Landscape
()(array.c)[(89/03/24)(06:27:26)](3)Gaudy
0 F
528 14470(else)B
696 14310(return Error \(PRangeCheck\);)B
360 14150(})B
360 13830(static Eq \(a, b\))B
780 13670(Object a, b;)B
360 13510({)B
528 13350(return Push \(OpStack,)B
1620 13190(MakeBool \(lengthArray \(a\) == lengthArray \(b\) &&)B
2712 13030(\(lengthArray \(a\) == 0 || Body \(a\) == Body \(b\)\)\)\);)B
360 12870(})B
360 12550(static int ForAll \(array, proc\))B
780 12390(Object array, proc;)B
360 12230({)B
528 12070(return Push \(ExecStack, array\))B
696 11910(&& Push \(ExecStack, MakeInteger \(0\)\))B
864 11750(&& Push \(ExecStack, proc\))B
1032 11590(&& Push \(ExecStack, OpForAll\);)B
360 11430(})B
360 11110(static forAll \(\))B
360 10950({)B
528 10790(Object array, index, proc;)B
528 10470(proc  = Pop \(ExecStack\);)B
528 10310(index = Pop \(ExecStack\);)B
528 10150(array = Pop \(ExecStack\);)B
528 9830(if \(BodyInteger \(index\) >= lengthArray \(array\)\))B
696 9670(return TRUE;)B
528 9510(return Push \(ExecStack, array\))B
696 9350(&& Push \(ExecStack, MakeInteger \(BodyInteger \(index\) + 1\)\))B
864 9190(&& Push \(ExecStack, proc\))B
1032 9030(&& Push \(ExecStack, OpForAll\))B
1200 8870(&& Push \(ExecStack, proc\))B
1368 8710(&& Push \(OpStack, Body \(array\) [BodyInteger \(index\)]\);)B
360 8550(})B
360 8230(static int PSetAutoBind \(bool\))B
780 8070(Object bool;)B
360 7910({)B
528 7750(autobind = BodyBool \(bool\);)B
528 7430(return TRUE;)B
360 7270(})B
360 6950(static int PGetAutoBind \(\))B
360 6790({)B
528 6630(return Push \(OpStack, MakeBool \(autobind\)\);)B
360 6470(})B
360 6150(Object ParseArray \(o\))B
780 5990(Object o;)B
360 5830({)B
528 5670(Object res, *array;)B
528 5510(int i, length = 0;)B
528 5350(struct acc)B
696 5190({)B
864 5030(Object item;)B
864 4870(struct acc *prev;)B
696 4710(} *p = NULL;)B
528 4390(for \(;;\) {)B
8256 14470(struct acc *item = \(struct acc *\) Malloc \(sizeof \(struct acc\)\);)B
8256 14310(res = Parse \(o\);)B
8256 13990(if \(TypeOf \(res\) == Condition\))B
8424 13830(return Absent;)B
8256 13670(if \(TypeOf \(res\) == Bool\))B
8424 13510(if \(BodyBool \(res\)\))B
8592 13350(break;)B
8424 13190(else)B
8592 13030(return Absent;)B
8256 12870(else if \(TypeOf \(res\) == Null\))B
8424 12710(return res;)B
8256 12390(if \(autobind && TypeOf \(res\) == Name && xCheck \(res\)\) {)B
8424 12230(Object binding;)B
8424 11910(binding = Load \(res\);)B
8424 11590(if \(TypeOf \(binding\) == Operator\))B
8592 11430(res = binding;)B
8256 11270(})B
8256 11110(item->item = res;)B
8256 10950(item->prev = p;)B
8256 10790(p = item;)B
8256 10630(++length;)B
8088 10470(})B
8088 10310(array = \(Object *\) Malloc \(\(unsigned\) sizeof \(Object\) * length\);)B
8088 9990(for \(i = length - 1; i >= 0; i--\) {)B
8256 9830(struct acc *prev = p->prev;)B
8256 9510(array[i] = p->item;)B
8256 9350(Free \(\(char *\)p\);)B
8256 9190(p = prev;)B
8088 9030(})B
8088 8870(PanicIf \(p != NULL, "Something badly wrong in Array literal parser\\n"\);)B
8088 8710(return Make \(array, length\);)B
7920 8550(})B
7920 8230(static int PArray \(size\))B
8340 8070(Object size;)B
7920 7910({)B
8088 7750(if \(BodyInteger \(size\) < 0\))B
8256 7590(return Error \(PRangeCheck\);)B
8088 7430(else)B
8256 7270({)B
8424 7110(int i, s = BodyInteger \(size\);)B
8424 6950(Object *body = \(Object *\) Malloc \(\(unsigned\) sizeof \(Object\) * s\);)B
8424 6630(for \(i = 0; i < s; i++\))B
8592 6470(body[i] = Nil;)B
8424 6310(return Push \(OpStack, Make \(body, s\)\);)B
8256 6150(})B
7920 5990(})B
7920 5670(static int PRBracket \(\))B
84(/* [ a1 ... an --- array */)X
7920 5510({)B
8088 5350(int n = CountTo \(Mark, OpStack\);)B
8088 5030(if \(n < 0\))B
8256 4870(return Error \(PUnMatched\);)B
8088 4710(else {)B
8256 4550(Object res;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(array.c)[(89/03/24)(06:27:26)](4)Gaudy
0 F
696 14470(res = ArrayStore \(n\);)B
696 14310(VOID Pop \(OpStack\);)B
696 14150(return Push \(OpStack, res\);)B
528 13990(})B
360 13830(})B
360 13510(static int PAload \(array\))B
780 13350(Object array;)B
360 13190({)B
528 13030(Object *body = Body \(array\);)B
528 12870(int i, l = lengthArray \(array\);)B
528 12550(if \(MaxStack \(OpStack\) - Height \(OpStack\) < l + 1\))B
696 12390(return Error \(POpOverflow\);)B
528 12230(else {)B
696 12070(for \(i = 0; i < l; i++\))B
864 11910(if \(!Push \(OpStack, body[i]\)\))B
1032 11750(break;)B
696 11590(return Push \(OpStack, array\);)B
528 11430(})B
360 11270(})B
360 10950(static int PAstore \(array\))B
780 10790(Object array;)B
360 10630({)B
528 10470(if \(lengthArray \(array\) > Height \(OpStack\)\))B
696 10310(return Error \(POpUnderflow\);)B
528 10150(else {)B
696 9990(Object *body = Body \(array\);)B
696 9830(int i, l = lengthArray \(array\);)B
696 9510(for \(i = l-1; i >= 0; i--\))B
864 9350(body[i] = Pop \(OpStack\);)B
696 9190(return Push \(OpStack, array\);)B
528 9030(})B
360 8870(})B
360 8550(static int PExecOnly \(item\))B
780 8390(Object item;)B
360 8230({)B
528 8070(return Push \(OpStack, ExecOnly \(item\)\);)B
360 7910(})B
360 7590(static int PReadOnly \(item\))B
780 7430(Object item;)B
360 7270({)B
528 7110(return Push \(OpStack, ReadOnly \(item\)\);)B
360 6950(})B
360 6630(static int PrCheck \(v\))B
780 6470(Object v;)B
360 6310({)B
528 6150(return Push \(OpStack, MakeBool \(rCheck \(v\)\)\);)B
360 5990(})B
360 5670(static int PwCheck \(v\))B
780 5510(Object v;)B
360 5350({)B
528 5190(return Push \(OpStack, MakeBool \(wCheck \(v\)\)\);)B
360 5030(})B
EndPage
HfDict begin ep end
%%Page: ? 9
HfDict begin bp end
StartPage
Landscape
()(boolean.c)[(89/03/25)(05:06:58)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(Object True, False;)B
360 11910(static Object OpNot;)B
360 11750(static int Cvs \(\), And \(\), Or \(\), Not \(\), Xor \(\);)B
360 11590(static int PEq \(\), PNeq \(\), EqBool \(\);)B
360 11270(InitBool \(\))B
360 11110({)B
528 10950(MakeObject \(True, Bool\);)B
528 10790(MakeObject \(False, Bool\);)B
528 10470(True.u.Bool = TRUE;)B
528 10310(False.u.Bool = FALSE;)B
528 9990(Install \("true",)B
504(True\);)X
528 9830(Install \("false",)B
420(False\);)X
528 9510(TypeInstallOp \(Bool, "cvs", )B
168(Cvs,  )X
840(2, 1, 0, 0, Bool, String\);)X
528 9350(TypeInstallOp \(Bool, "and", )B
168(And,  )X
840(2, 1, 0, 0, Bool, Bool\);)X
528 9190(TypeInstallOp \(Bool, "or", )B
252(Or,  )X
924(2, 1, 0, 0, Bool, Bool\);)X
528 9030(TypeInstallOp \(Bool, "xor", )B
168(Xor,  )X
840(2, 1, 0, 0, Bool, Bool\);)X
528 8870(TypeInstallOp \(Bool, "not", )B
168(Not,  )X
840(1, 1, 0, 0, Bool\);)X
528 8710(TypeInstallOp \(Bool, "eq", )B
252(EqBool,  )X
588(2, 1, 0, 0, Bool, Bool\);)X
528 8390(OpNot = Lookup \(Bool, NameFrom \("not"\)\);)B
528 8070(InstallOp \("eq",)B
504(PEq,  )X
840(2, 1, 0, 0, Poly, Poly\);)X
528 7910(InstallOp \("ne",)B
504(PNeq, )X
840(2, 1, 0, 0, Poly, Poly\);)X
528 7750(InstallOp \("ge", )B
420(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
528 7590(InstallOp \("gt", )B
420(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
528 7430(InstallOp \("le", )B
420(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
528 7270(InstallOp \("lt", )B
420(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
528 7110(InstallOp \("not", )B
336(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
528 6950(InstallOp \("and", )B
336(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
528 6790(InstallOp \("or", )B
420(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
528 6630(InstallOp \("xor", )B
336(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
528 6470(InstallOp \("bitshift", )B
588(PolyPair, )X
504(2, 2, 0, 0, Poly, Poly\);)X
360 6310(})B
360 5990(Object MakeBool \(b\))B
780 5830(int b;)B
360 5670({)B
528 5510(if \(b\))B
696 5350(return True;)B
528 5190(else)B
696 5030(return False;)B
360 4870(})B
360 4550(int BodyBool \(b\))B
780 4390(Object b;)B
7920 14470({)B
8088 14310(return b.u.Bool;)B
7920 14150(})B
7920 13830(static int Cvs \(v, string\))B
8340 13670(Object v, string;)B
7920 13510({)B
8088 13350(char *choice = BodyBool \(v\) ? "true" : "false";)B
8088 13190(int length = strlen \(choice\);)B
8088 12870(if \(lengthString \(string\) < length\))B
8256 12710(return Error \(PRangeCheck\);)B
8088 12550(VOID Bcopy \(BodyString \(string\), choice, length\);)B
8088 12390(return Push \(OpStack, getIString \(string, 0, length\)\);)B
7920 12230(})B
7920 11910(static int PEq \(a, b\))B
8340 11750(Object a, b;)B
588(/* any any --- Bool */)X
7920 11590({)B
8088 11430(if \(!rCheck \(a\) || !rCheck \(b\)\))B
8256 11270(return Error \(PInvAccess\);)B
8088 11110(if \(TypeOf \(a\) == Name && TypeOf \(b\) == String\))B
8256 10950(a = StringName \(a\);)B
8088 10790(else if \(TypeOf \(b\) == Name && TypeOf \(a\) == String\))B
8256 10630(b = StringName \(b\);)B
8088 10470(else if \(TypeOf \(a\) == Real && TypeOf \(b\) == Integer\))B
8256 10310(b = RealInteger \(b\);)B
8088 10150(else if \(TypeOf \(a\) == Integer && TypeOf \(b\) == Real\))B
8256 9990(a = RealInteger \(a\);)B
8088 9830(if \(TypeOf \(a\) == TypeOf \(b\)\) {)B
8256 9670(VOID Push \(OpStack, a\);)B
8256 9510(VOID Push \(OpStack, b\);)B
8256 9350(return Apply \(TypeOf \(a\)\);)B
8088 9190(})B
8088 9030(else)B
8256 8870(return Push \(OpStack, False\);)B
7920 8710(})B
7920 8390(static int PNeq \(a, b\))B
8340 8230(Object a, b;)B
1260(/* any any --- Bool */)X
7920 8070({)B
8088 7910(if \(!rCheck \(a\) || !rCheck \(b\)\))B
8256 7750(return Error \(PInvAccess\);)B
8088 7590(if \(TypeOf \(a\) == Name && TypeOf \(b\) == String\))B
8256 7430(a = StringName \(a\);)B
8088 7270(else if \(TypeOf \(b\) == Name && TypeOf \(a\) == String\))B
8256 7110(b = StringName \(b\);)B
8088 6950(else if \(TypeOf \(a\) == Real && TypeOf \(b\) == Integer\))B
8256 6790(b = RealInteger \(b\);)B
8088 6630(else if \(TypeOf \(a\) == Integer && TypeOf \(b\) == Real\))B
8256 6470(a = RealInteger \(a\);)B
8088 6310(if \(TypeOf \(a\) == TypeOf \(b\)\) {)B
8256 6150(VOID Push \(OpStack, a\);)B
8256 5990(VOID Push \(OpStack, b\);)B
8256 5830(VOID Push \(ExecStack, OpNot\);)B
8256 5670(Self = NameFrom \("eq"\);)B
8256 5510(return Apply \(TypeOf \(a\)\);)B
8088 5350(} else)B
8256 5190(return Push \(OpStack, True\);)B
7920 5030(})B
7920 4710(static int EqBool \(a, b\))B
8340 4550(Object a, b;)B
7920 4390({)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(boolean.c)[(89/03/25)(05:06:58)](2)Gaudy
0 F
528 14470(return Push \(OpStack, MakeBool \(BodyBool \(a\) == BodyBool \(b\)\)\);)B
360 14310(})B
360 13990(static int Not \(bool\))B
780 13830(Object bool;)B
360 13670({)B
528 13510(return Push \(OpStack, MakeBool \(!BodyBool \(bool\)\)\);)B
360 13350(})B
360 13030(static int And \(a, b\))B
780 12870(Object a, b;)B
360 12710({)B
528 12550(return Push \(OpStack, MakeBool \(BodyBool \(a\) && BodyBool \(b\)\)\);)B
360 12390(})B
360 12070(static int Or \(a, b\))B
780 11910(Object a, b;)B
360 11750({)B
528 11590(return Push \(OpStack, MakeBool \(BodyBool \(a\) || BodyBool \(b\)\)\);)B
360 11430(})B
360 11110(static int Xor \(a, b\))B
780 10950(Object a, b;)B
360 10790({)B
528 10630(return Push \(OpStack, MakeBool \(BodyBool \(a\) != BodyBool \(b\)\)\);)B
360 10470(})B
EndPage
HfDict begin ep end
%%Page: ? 10
HfDict begin bp end
StartPage
Landscape
()(cache.c)[(89/04/06)(11:58:04)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(static struct cache)B
360 11750({)B
528 11590(struct cache *cache_next, *cache_prev;)B
528 11430(int fid;)B
528 11270(Matrix mat;)B
2268(/* character -> device */)X
528 11110(int width, height, swidth, sheight; )B
168(/* device coords */)X
360 10950(} cache_header = { &cache_header, &cache_header },)B
528 10790(*cache_ring = &cache_header;)B
360 10470(static struct char_table {)B
528 10310(Object )B
1260(char_key;)X
528 10150(struct cache )B
84(*char_cache;)X
528 9830(struct device )B
672(*char_device;)X
528 9670(UserPoint )B
1008(char_width;)X
1428(/* character coords */)X
360 9510(} *CharTable;)B
360 9190(static int bsize = 0, bmax = 0;)B
360 9030(static int msize = 0, mmax = 0;)B
360 8870(static int csize = 0, cmax = 0;)B
360 8550(static int maxbits = 0;)B
360 8230(static int CacheStatus \(\);)B
360 8070(static int PSetCharWidth \(\);)B
360 7910(static int SetCacheLimit \(\);)B
360 7750(static int PCurrentCharWidth \(\);)B
360 7590(static int PSetCacheDevice \(\);)B
360 7430(static int SetCache \(\);)B
360 7270(static int SaveCurrentFont \(\);)B
360 7110(static DestroyCache \(\);)B
360 6950(static CacheInsert \(\);)B
360 6470(int SetCacheDevice \(\);)B
360 6310(static struct cache *NewCache \(\), *CacheRemove \(\);)B
360 5990(InitCache \(\))B
360 5830({)B
528 5670(InstallOp \("cachestatus",)B
420(CacheStatus,)X
1008(0, 7, 0, 0\);)X
528 5510(InstallOp \("setcachedevice",)B
168(PSetCacheDevice,)X
672(6, 0, 0, 0,)X
1452 5350(Float, Float, Float, Float, Float, Float\);)B
528 5190(InstallOp \("setcharwidth",)B
336(PSetCharWidth,)X
840(2, 0, 0, 0,)X
1452 5030(Float, Float\);)B
528 4870(InstallOp \(".currentcharwidth",)B
588(PCurrentCharWidth,)X
504(0, 2, 0, 0\);)X
528 4710(InstallOp \("setcachelimit",)B
252(SetCacheLimit,)X
840(1, 0, 0, 0,)X
1452 4550(Integer\);)B
528 4390(InstallOp \("setcache",)B
1344(SetCache,)X
1260(3, 0, 0, 0,)X
9012 14470(Integer, Integer, Integer\);)B
8088 14310(InstallOp \("savecurrentfont",)B
84(SaveCurrentFont,)X
672(0, 0, 0, 0\);)X
7920 14150(})B
7920 13830(static InitCharTable \(\))B
7920 13670({)B
8088 13510(int i;)B
8088 13190(CharTable = \(struct char_table *\) Malloc \(\(unsigned\) \(sizeof \(struct char_table\) * cmax)B
8088 13030(for \(i = 0; i < cmax; i++\))B
8256 12870(CharTable[i].char_cache = NULL;)B
7920 12710(})B
7920 12390(static struct char_table *CharAddition \(table, cache, key, size\))B
8340 12230(struct char_table *table;)B
8340 12070(struct cache *cache;)B
8340 11910(Object key;)B
8340 11750(int size;)B
7920 11590({)B
8088 11430(int i, h = \(BodyInteger \(key\) + \(int\) cache\) % size;)B
8088 11110(for \(i = h;;\) {)B
8256 10950(if \(table[i].char_cache == NULL\) {)B
8424 10790(table[i].char_key = key;)B
8424 10630(table[i].char_cache = cache;)B
8424 10310(return &table[i];)B
8256 10150(})B
8256 9990(if \(++i == size\))B
8424 9830(i = 0;)B
8256 9670(if \(i == h\))B
8424 9510(return NULL;)B
8088 9350(})B
7920 9190(})B
7920 8870(CharStore \(key, width, dev\))B
8340 8710(Object key;)B
8340 8550(UserPoint width;)B
8340 8390(struct device *dev;)B
7920 8230({)B
8088 8070(struct char_table *p;)B
8088 7750(while \(csize == cmax\))B
8256 7590(DestroyCache \(CacheRemove \(cache_ring->cache_prev\)\);)B
8088 7270(if \(p = CharAddition \(CharTable, gstate->show->ccache, key, cmax\)\) {)B
8256 7110(p->char_width = width;)B
8256 6950(p->char_device = dev;)B
8256 6790(++csize;)B
8088 6630(} else)B
8256 6470(Panic \("dictionary full in CharStore"\);)B
7920 6310(})B
7920 5990(static struct char_table *CharFind \(table, cache, key, size\))B
8340 5830(struct char_table *table;)B
8340 5670(struct cache *cache;)B
8340 5510(Object key;)B
8340 5350(int size;)B
7920 5190({)B
8088 5030(int i, h = \(BodyInteger \(key\) + \(int\) cache\) % size;)B
8088 4710(for \(i = h;;\) {)B
8256 4550(if \(table[i].char_cache == NULL\) return NULL;)B
8256 4390(if \(table[i].char_cache == cache && DictEqual \(key, table[i].char_key\)\))B
EndPage
HfDict begin hp end
StartPage
Landscape
()(cache.c)[(89/04/06)(11:58:04)](2)Gaudy
0 F
864 14470(return &table[i];)B
696 14310(if \(++i == size\) i = 0;)B
696 14150(if \(i == h\)  break;)B
528 13990(})B
528 13830(return NULL;)B
360 13670(})B
360 13350(static FlushChars \(p\))B
780 13190(struct cache *p;)B
360 13030({)B
528 12870(int i;)B
528 12550(for \(i = 0; i < cmax; i++\))B
696 12390(if \(CharTable[i].char_cache == p\) {)B
864 12230(CharTable[i].char_cache = NULL;)B
864 12070(--csize;)B
696 11910(})B
360 11750(})B
360 11430(#ifdef notdef)B
360 11270(/*)B
444 11110(* Converts a bounding box to equivalent one in device coordinates.)B
444 10950(*/)B
360 10790(DeviceBBox \(left, right, top, bottom, llx, urx, ury, lly\))B
780 10630(float *left, *right, *top, *bottom, llx, urx, ury, lly;)B
360 10470({)B
528 10310(HardPoint ll;)B
528 9990(ll = ExtToInt \(NewUserPoint \(llx, lly\)\);)B
528 9670(*left = *right = ll.hx; *top = *bottom = ll.hy;)B
528 9350(Bound \(left, right, top, bottom, ExtToInt \(NewUserPoint \(urx, lly\)\)\);)B
528 9190(Bound \(left, right, top, bottom, ExtToInt \(NewUserPoint \(llx, ury\)\)\);)B
528 9030(Bound \(left, right, top, bottom, ExtToInt \(NewUserPoint \(urx, ury\)\)\);)B
360 8870(})B
360 8710(#endif)B
360 8390(/*)B
444 8230(* Efficiently converts a bounding box to equivalent one in device coordinates.)B
444 8070(*/)B
360 7910(DeviceBBox \(left, right, top, bottom, llx, urx, ury, lly\))B
780 7750(float *left, *right, *top, *bottom, llx, urx, ury, lly;)B
360 7590({)B
528 7430(register float a,b,c,d,x1,y1,x2,y2;)B
528 7110(/* Compute left and right from x values of transformed points */)B
528 6950(a = gstate->CTM.A; c = gstate->CTM.C;)B
528 6790(x1 = llx*a + lly*c;)B
528 6630(x2 = urx*a + lly*c;)B
528 6470(if\(x1 < x2\) { *left = x1; *right = x2; })B
528 6310(else        { *left = x2; *right = x1; })B
528 5990(x1 = llx*a + ury*c;)B
528 5830(x2 = urx*a + ury*c;)B
528 5670(if\(x2 < x1\) { y1 = x1; x1 = x2; x2 = y1; })B
528 5510(if\(*left > x1\) *left = x1;)B
528 5350(if\(*right < x2\) *right = x2;)B
528 5030(/* Compute top and bottom from y values of transformed points */)B
528 4870(b = gstate->CTM.B; d = gstate->CTM.D;)B
528 4710(y1 = llx*b + lly*d;)B
528 4550(y2 = urx*b + lly*d;)B
528 4390(if\(y1 < y2\) { *bottom = y1; *top = y2; })B
8088 14470(else        { *bottom = y2; *top = y1; }  )B
8088 14150(y1 = llx*b + ury*d;)B
8088 13990(y2 = urx*b + ury*d;)B
8088 13830(if\(y2 < y1\) { x1 = y1; y1 = y2; y2 = x1; })B
8088 13670(if\(*bottom > y1\) *bottom = y1;)B
8088 13510(if\(*top < y2\) *top = y2;)B
8088 13190(/* Translate to get final bounding box location */)B
8088 13030(x1 = gstate->CTM.tx;  y1 = gstate->CTM.ty;)B
8088 12870(*left += x1;   *right += x1;   *bottom += y1;   *top += y1;)B
7920 12710(})B
7920 12390(int EqVector \(a, b\))B
8340 12230(Vector a, b;)B
7920 12070({)B
8088 11910(return \(int\) a.vx == \(int\) b.vx && \(int\) a.vy == \(int\) b.vy;)B
7920 11750(})B
7920 11430(static int PCurrentCharWidth \(\))B
7920 11270({)B
8088 11110(VOID Push \(OpStack, MakeReal \(gstate->show->Width.x\)\);)B
8088 10950(VOID Push \(OpStack, MakeReal \(gstate->show->Width.y\)\);)B
8088 10790(return TRUE;)B
7920 10630(})B
7920 10310(static int PSetCharWidth \(wx, wy\))B
8340 10150(Object wx, wy;)B
7920 9990({)B
8088 9830(if \(!gstate->show->InShow\) return Error \(PUndefined\);)B
8088 9670(gstate->show->Width.x = BodyReal\(wx\);)B
8088 9510(gstate->show->Width.y = BodyReal\(wy\);)B
8088 9350(return TRUE;)B
7920 9190(})B
7920 8870(static int PSetCacheDevice \(wx, wy, llx, lly, urx, ury\))B
8340 8710(Object wx, wy, llx, lly, urx, ury;)B
7920 8550({)B
8088 8390(if \(!gstate->show->InShow\))B
8256 8230(return Error \(PUndefined\);)B
8088 8070(return SetCacheDevice \(gstate->show->CharName,)B
10020 7910(NewUserPoint \(BodyReal \(wx\), BodyReal \(wy\)\),)B
10020 7750(BodyReal \(llx\), BodyReal \(lly\),)B
10020 7590(BodyReal \(urx\), BodyReal \(ury\)\);)B
7920 7430(})B
7920 7110(int SetCacheDevice \(name, char_width, llx, lly, urx, ury\))B
8340 6950(Object name;)B
8340 6790(UserPoint char_width;)B
8340 6630(float llx, lly, urx, ury;)B
7920 6470({)B
8088 6310(float left, right, top, bottom, width, height;)B
8088 6150(struct device *new_char;)B
8088 5990(struct cache *ccache;)B
8088 5830(HardPoint P;)B
8088 5510(gstate->show->Width = char_width;)B
8088 5350(if \(!\(ccache = gstate->show->ccache\)\) return TRUE;)B
8088 5030(DeviceBBox \(&left, &right, &top, &bottom, llx, urx, ury, lly\);)B
8088 4870(width = right - left; height = top - bottom;)B
8088 4550(/* Check if character is too big */)B
8088 4390(if \(\(int\) \(width * height\) > maxbits * 8\) return TRUE;)B
EndPage
HfDict begin ep end
%%Page: ? 11
HfDict begin bp end
StartPage
Landscape
()(cache.c)[(89/04/06)(11:58:04)](3)Gaudy
0 F
528 14310(new_char = NewCacheDevice \(ccache->mat, ccache->width, ccache->height,)B
2796 14150(ccache->swidth, ccache->sheight\);)B
528 13990(CharStore \(name, char_width, LinkDevice \(new_char\)\);)B
528 13830(SetDevice \(new_char\);)B
528 13510(PathFree \(gstate->clip\);)B
528 13350(gstate->clip = NewClipPath \(0.0, width, height, 0.0\);)B
528 13190(P.hx = gstate->CTM.tx = ccache->swidth;)B
528 13030(P.hy = gstate->CTM.ty = ccache->sheight;)B
528 12870(VOID MoveTo \(gstate->path, P\);)B
528 12550(return TRUE;)B
360 12390(})B
360 12070(printMatrix \(m\))B
780 11910(Matrix m;)B
360 11750({)B
528 11590(printf \("[%g %g]\\n", m.A, m.B\);)B
528 11430(printf \("[%g %g]\\n", m.C, m.D\);)B
528 11270(printf \("[%g %g]\\n", m.tx, m.ty\);)B
360 11110(})B
360 10790(extern float fontbboxCache[];)B
360 10630(extern int fidCache;)B
360 10310(struct cache *SearchCache \(m, fid\))B
780 10150(Matrix m;)B
780 9990(int fid;)B
360 9830({)B
528 9670(struct cache *p;)B
528 9510(register float a,b,c,d;)B
528 9190(a = m.A;  b = m.B;  c = m.C;  d = m.D;)B
528 9030(for \(p = cache_ring->cache_next; p != cache_ring; p = p->cache_next\))B
696 8870(if \(p->fid == fid && p->mat.A == a && p->mat.B == b &&)B
1032 8710(p->mat.C == c && p->mat.D == d\) {)B
864 8550(if \(cache_ring->cache_next != p\))B
1032 8390(CacheInsert \(cache_ring->cache_next,CacheRemove \(p\)\);)B
864 8230(return cache_ring->cache_next;)B
696 8070(})B
528 7750(return NULL;)B
360 7590(})B
360 7270(int FindCache \(\))B
360 7110({)B
528 6950(float left, right, top, bottom;)B
528 6790(int width, height, swidth, sheight;)B
528 6470(if \(\(gstate->show->ccache = SearchCache \(gstate->CTM,)B
3972 6310(fidCache\)\) != NULL\))B
696 6150(return TRUE;)B
528 5990(Message \("building a new cache"\);)B
528 5830(DeviceBBox \(&left, &right, &top, &bottom,)B
1536 5670(fontbboxCache[BBOX_LEFT], fontbboxCache[BBOX_RIGHT],)B
1536 5510(fontbboxCache[BBOX_BOTTOM], fontbboxCache[BBOX_TOP]\);)B
528 5190(width = \(int\) \(right - left\); height = \(int\) \(top - bottom\);)B
528 5030(if \(width*height > maxbits * 8\) {)B
696 4870(Message \("character too big to cache"\);)B
696 4710(return TRUE;)B
528 4550(})B
8088 14470(if \(msize == mmax\))B
8256 14310(DestroyCache \(CacheRemove \(cache_ring->cache_prev\)\);)B
8088 13990(swidth = \(int\) \(gstate->CTM.tx - left\);)B
8088 13830(sheight = \(int\) \(gstate->CTM.ty - bottom\);)B
8088 13510(CacheInsert \(cache_ring->cache_next,)B
9180 13350(NewCache \(fidCache,)B
10020 13190(gstate->CTM,)B
10020 13030(width, height,)B
10020 12870(swidth, sheight\)\);)B
8088 12710(gstate->show->ccache = cache_ring->cache_next;)B
8088 12390(/* It takes longer to load them from the disk than to create them! */)B
7920 12230(#ifdef notdef)B
8088 12070(LoadDiskCache \(gstate->CTM, fontbboxCache\);)B
7920 11910(#endif)B
8088 11590(return TRUE;)B
7920 11430(})B
7920 11110(int CacheShow \(name, cp\))B
8340 10950(Object name;)B
8340 10790(HardPoint cp;)B
7920 10630({)B
8088 10470(struct char_table *b;)B
8088 10310(struct cache *ccache = gstate->show->ccache;)B
8088 10150(DevicePoint from, to, extent;)B
8088 9830(if \(!ccache\) return FALSE;)B
8088 9670(gstate->show->CharName = name;)B
8088 9350(if\(\(b = CharFind \(CharTable, ccache, name, cmax\)\) == NULL\) return FALSE;)B
8088 9030(gstate->show->Width = b->char_width;)B
8088 8710(from = NewDevicePoint\(0, 0\);)B
8088 8550(to = NewDevicePoint\(\(\(int\) cp.hx - ccache->swidth\),)B
9768 8390(\(\(int\) cp.hy - ccache->sheight\)\);)B
8088 8230(extent = NewDevicePoint\(\(int\) ccache->width, ccache->height\);)B
8088 7910(Paint \(b->char_device->dev, gstate->device->dev, from, to, extent,)B
8676 7750(gstate->colour\);)B
8088 7430(return TRUE;)B
7920 7270(})B
7920 6950(static struct cache *NewCache \(fid, m, width, height, swidth, sheight\))B
8340 6790(int fid;)B
8340 6630(Matrix m;)B
8340 6470(int width, height, swidth, sheight;)B
7920 6310({)B
8088 6150(struct cache *res = \(struct cache *\) Malloc \(sizeof \(struct cache\)\);)B
8088 5830(m.tx = m.ty = 0.0;)B
8088 5670(res->fid)B
504(= fid;)X
8088 5510(res->mat)B
504(= m;)X
8088 5350(res->width)B
336(= width;)X
8088 5190(res->height)B
252(= height;)X
8088 5030(res->swidth)B
252(= swidth;)X
8088 4870(res->sheight)B
168(= sheight;)X
8088 4550(return res;)B
7920 4390(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(cache.c)[(89/04/06)(11:58:04)](4)Gaudy
0 F
360 14310(static DestroyCache \(p\))B
780 14150(struct cache *p;)B
360 13990({)B
528 13830(FlushChars \(p\);)B
528 13670(Free \(\(char *\) p\);)B
360 13510(})B
360 13190(static CacheInsert \(where, cache\))B
780 13030(struct cache *where, *cache;)B
360 12870({)B
528 12710(cache->cache_next = where; cache->cache_prev = where->cache_prev;)B
528 12550(where->cache_prev->cache_next = cache;)B
528 12390(where->cache_prev = cache;)B
528 12230(++msize;)B
360 12070(})B
360 11750(static struct cache *CacheRemove \(item\))B
780 11590(struct cache *item;)B
360 11430({)B
528 11270(item->cache_prev->cache_next = item->cache_next;)B
528 11110(item->cache_next->cache_prev = item->cache_prev;)B
528 10950(--msize;)B
528 10630(return item;)B
360 10470(})B
360 10150(static int SetCacheLimit \(mb\))B
780 9990(Object mb;)B
360 9830({)B
528 9670(int b = BodyInteger \(mb\);)B
528 9510(if \(b < 0\))B
696 9350(return Error \(PRangeCheck\);)B
528 9190(maxbits = b;)B
528 9030(return TRUE;)B
360 8870(})B
360 8550(static int SetCache \(bitmap, fonts, chars\))B
780 8390(Object bitmap, fonts, chars;)B
360 8230({)B
528 8070(int b = BodyInteger \(bitmap\);)B
528 7910(int f = BodyInteger \(fonts\);)B
528 7750(int c = BodyInteger \(chars\);)B
528 7430(if \(b < 0 || f < 0 || c < 0\))B
696 7270(return Error \(PRangeCheck\);)B
528 7110(bmax = b; mmax = f; cmax = c;)B
528 6950(InitCharTable \(\);)B
528 6790(return TRUE;)B
360 6630(})B
360 6310(static int CacheStatus \(\))B
360 6150({)B
528 5990(VOID Push \(OpStack, MakeInteger \(bsize\)\);)B
528 5830(VOID Push \(OpStack, MakeInteger \(bmax\)\);)B
528 5670(VOID Push \(OpStack, MakeInteger \(msize\)\);)B
528 5510(VOID Push \(OpStack, MakeInteger \(mmax\)\);)B
528 5350(VOID Push \(OpStack, MakeInteger \(csize\)\);)B
528 5190(VOID Push \(OpStack, MakeInteger \(cmax\)\);)B
528 5030(VOID Push \(OpStack, MakeInteger \(maxbits\)\);)B
528 4710(return TRUE;)B
360 4550(})B
7920 14470(LoadDiskCache \(m, bbox\))B
8340 14310(Matrix m;)B
8340 14150(float *bbox;)B
7920 13990({)B
8088 13830(Object font_name;)B
8088 13670(FILE *fp;)B
8088 13510(Vector origin, right, bottom;)B
8088 13350(char disk_name [BUFSIZE], *bits, mess[BUFSIZ];)B
8088 13190(/* )B
252(struct hardware *screen = gstate->device->dev; */)X
8088 12870(Message \("Attempting to find a cache on disk"\);)B
8088 12710(font_name = DictLoad \(gstate->font, FontName\);)B
8088 12550(if \(TypeOf \(font_name\) != Name\))B
8256 12390(return;)B
8088 12230(origin = Transform \(NewVector \(bbox [BBOX_LEFT], bbox [BBOX_TOP], 1.0\),)B
9768 12070(m\);)B
8088 11910(right  = DiffVector \(Transform \(NewVector \(bbox [BBOX_RIGHT],)B
11700 11750(bbox [BBOX_TOP], 1.0\), m\),)B
9852 11590(origin\);)B
8088 11430(bottom = DiffVector \(Transform \(NewVector \(bbox [BBOX_LEFT],)B
11700 11270(bbox [BBOX_BOTTOM], 1.0\),)B
10776 11110(m\), origin\);)B
8088 10950(VOID sprintf \(disk_name,)B
9264 10790("%s/cache/%.*s/%3d%3d%3d%3d",)B
9264 10630(library,)B
9264 10470(lengthName \(font_name\), BodyName \(font_name\),)B
9264 10310(\(int\) right.vx, \(int\) right.vy, \(int\) bottom.vx,)B
9264 10150(\(int\) bottom.vy\);)B
8088 9990(Message \(disk_name\);)B
8088 9830(puts \(disk_name\);)B
8088 9670(if \(\(fp = fopen \(disk_name, "r"\)\) == NULL\))B
8256 9510(return;)B
8088 9350(Message \("found a disk cache"\);)B
8088 9190(VOID GSave \(\);)B
8088 9030(bits = Malloc \(\(unsigned\) maxbits\);)B
8088 8710(sprintf \(mess, "width = %d, height = %d\\n",)B
8844 8550(gstate->show->ccache->width, gstate->show->ccache->height\);)B
8088 8390(Message \(mess\);)B
8088 8230(sprintf \(mess, "computed length = %d",)B
8844 8070(gstate->show->ccache->height * \(\(gstate->show->ccache->width + 7\) / 8\)\);)B
8088 7910(Message \(mess\);)B
8088 7590(while \(!feof \(fp\)\) {)B
8256 7430(char char_name [BUFSIZE];)B
8256 7270(struct hardware *newdev;)B
8256 7110(int width, height, length;)B
8256 6790(if \(fscanf \(fp, "%s %d %d %d\\n",)B
9264 6630(char_name,)B
9264 6470(&width, &height,)B
9264 6310(&length\) == EOF\))B
8424 6150(break;)B
8256 5990(VOID fread \(bits, \(unsigned\) length, 1, fp\);)B
8256 5830(VOID getc \(fp\);)B
8256 5670(newdev = HardwareFromString \(bits, gstate->show->ccache->width,)B
10692 5510(gstate->show->ccache->height\);)B
8256 5350(/*)B
840(VOID BitBlt \(newdev, screen,)X
8340 5190(* NewDevicePoint \(0, 0\), NewDevicePoint \(200, 200\),)B
8340 5030(* NewDevicePoint \(gstate->show->ccache->width,)B
8340 4870(* gstate->show->ccache->height\),)B
8340 4710(* ROP_SOURCE\);)B
8340 4550(*/)B
8256 4390(VOID SetCacheDevice \(NameFrom \(char_name\),)B
EndPage
HfDict begin ep end
%%Page: ? 12
HfDict begin bp end
StartPage
Landscape
()(cache.c)[(89/04/06)(11:58:04)](5)Gaudy
0 F
2460 14470(NewUserPoint \(\(float\) width, \(float\) height\),)B
2460 14310(bbox [BBOX_LEFT],  bbox [BBOX_TOP],)B
2460 14150(bbox [BBOX_RIGHT], bbox [BBOX_BOTTOM]\);)B
696 13830(VOID BitBlt \(newdev, gstate->device->dev,)B
1788 13670(NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\),)B
1788 13510(NewDevicePoint \(gstate->show->ccache->width,)B
3132 13350(gstate->show->ccache->height\),)B
1788 13190(ROP_SOURCE\);)B
696 13030(DestroyHardware \(newdev\);)B
528 12870(})B
528 12710(Free \(bits\);)B
528 12550(VOID GRestore \(\);)B
528 12390(VOID fclose \(fp\);)B
528 12230(Message \("load completed"\);)B
360 12070(})B
360 11750(static int SaveCurrentFont \(\))B
360 11590({)B
528 11430(Matrix fm, m;)B
528 11270(Vector origin, right, bottom;)B
528 11110(Object font_name;)B
528 10950(FILE *fp;)B
528 10790(char disk_name [BUFSIZE];)B
528 10630(int i;)B
528 10470(float bbox[4];)B
528 10310(struct cache *ccache;)B
528 9990(ExtractMatrix \(&fm, DictLoad \(gstate->font, FontMatrix\)\);)B
528 9830(m = MatMult \(fm, gstate->CTM\);)B
528 9670(ExtractBBox \(bbox, DictLoad \(gstate->font, FontBBox\)\);)B
528 9510(font_name = DictLoad \(gstate->font, FontName\);)B
528 9190(origin = Transform \(NewVector \(bbox [BBOX_LEFT], bbox [BBOX_TOP], 1.0\),)B
2208 9030(m\);)B
528 8870(right  = DiffVector \(Transform \(NewVector \(bbox [BBOX_RIGHT],)B
4140 8710(bbox [BBOX_TOP], 1.0\), m\),)B
2292 8550(origin\);)B
528 8390(bottom = DiffVector \(Transform \(NewVector \(bbox [BBOX_LEFT],)B
4140 8230(bbox [BBOX_BOTTOM], 1.0\),)B
3216 8070(m\), origin\);)B
528 7750(if \(\(ccache = SearchCache \(m, BodyFontID \(DictLoad \(gstate->font,)B
4896 7590(Fid\)\)\)\) == NULL\))B
696 7430(return Error \(PInvFont\);)B
528 7110(Message \(disk_name\);)B
528 6950(VOID sprintf \(disk_name,)B
1704 6790("%s/cache/%.*s/%3d%3d%3d%3d",)B
1704 6630(library,)B
1704 6470(lengthName \(font_name\), BodyName \(font_name\),)B
1704 6310(\(int\) right.vx, \(int\) right.vy, \(int\) bottom.vx,)B
1704 6150(\(int\) bottom.vy\);)B
528 5830(if \(\(fp = fopen \(disk_name, "w"\)\) == NULL\))B
696 5670(return Error \(PInvFileAccess\);)B
528 5350(/* DCJ:)B
612 5190(* Do we want to set a length based on real coordinates or virtual?)B
612 5030(*/)B
528 4870(for \(i = 0; i < cmax; i++\))B
696 4710(if \(CharTable[i].char_cache == ccache\) {)B
864 4550(Object char_name;)B
864 4390(unsigned char *bits;)B
8424 14470(DevicePoint extent;)B
8424 14310(int length;)B
8424 13990(char_name = CharTable[i].char_key;)B
8424 13830(extent = HardwareExtent \(CharTable[i].char_device->dev\);)B
8424 13670(length = \(extent.dx + 7\) / 8 * extent.dy;)B
8424 13510(bits = StringFromHardware \(CharTable[i].char_device->dev\);)B
8424 13350(VOID fprintf \(fp,)B
9600 13190("%.*s %d %d %d\\n",)B
9600 13030(lengthName \(char_name\), BodyName \(char_name\),)B
9600 12870(\(int\) CharTable [i].char_width.x,)B
9600 12710(\(int\) CharTable [i].char_width.y,)B
9600 12550(length\);)B
8424 12390(VOID fwrite \(bits, \(unsigned\) length, 1, fp\);)B
8424 12230(putc \('\\n', fp\);)B
8424 12070(/*  )B
1176(Free \(bits\);*/)X
8256 11750(})B
8088 11430(VOID fclose \(fp\);)B
8088 11110(return TRUE;)B
7920 10950(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(colour.c)[(89/03/24)(04:52:16)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11750(Colour NewGray \(level\))B
780 11590(float level;)B
360 11430({)B
528 11270(return NewHSBColour \(0.0, 0.0, level\);)B
360 11110(})B
360 10790(Colour NewColour \(h, s, b\))B
780 10630(float h, s, b;)B
360 10470({)B
528 10310(return NewHSBColour \(h, s, b\);)B
360 10150(})B
360 9830(Colour NewHSBColour \(h, s, b\))B
780 9670(float h, s, b;)B
360 9510({)B
528 9350(Colour res;)B
528 9030(res.hue = h;)B
528 8870(res.saturation = s;)B
528 8710(res.brightness = b;)B
528 8390(return res;)B
360 8230(})B
360 7910(Colour NewRGBColour \(R, G, B\))B
780 7750(float R, G, B;)B
360 7590({)B
528 7430(float H, S, L, m, M, r, g, b;)B
528 7110(M = R > G ? R : G; M = M > B ? M : B;)B
528 6950(m = R < G ? R : G; m = m < B ? m : B;)B
528 6790(if \(M != m\) {)B
696 6630(r = \(M - R\) / \(M - m\);)B
696 6470(g = \(M - G\) / \(M - m\);)B
696 6310(b = \(M - B\) / \(M - m\);)B
528 6150(})B
528 5990(L = \(M + m\) / 2;)B
528 5670(if \(M == m\))B
696 5510(S = 0;)B
528 5350(else if \(L <= 0.5\))B
696 5190(S = \(M - m\) / \(M + m\);)B
528 5030(else)B
696 4870(S = \(M - m\) / \(2 - M - m\);)B
528 4550(if \(S == 0\))B
696 4390(H = 0;)B
8088 14470(else if \(R == M\))B
8256 14310(H = 2 + b - g;)B
8088 14150(else if \(G == M\))B
8256 13990(H = 4 + r - b;)B
8088 13830(else)B
8256 13670(H = 6 + g - r;)B
8088 13350(H /= 6;)B
8088 13030(return NewHSBColour \(H, S, L\);)B
7920 12870(})B
7920 12550(void ColourHSB \(colour, h, s, b\))B
8340 12390(Colour colour;)B
8340 12230(float *h, *s, *b;)B
7920 12070({)B
8088 11910(*h = colour.hue;)B
8088 11750(*s = colour.saturation;)B
8088 11590(*b = colour.brightness;)B
7920 11430(})B
7920 11110(float Value \(m, M, hue\))B
8340 10950(float m, M, hue;)B
7920 10790({)B
8088 10630(if \(hue < 0.0\))B
8256 10470(hue += 2 * PI;)B
8088 10310(if \(hue < PI / 3\))B
8256 10150(return m + \(M - m\) * hue / \(PI / 3\);)B
8088 9990(else if \(hue < PI\))B
8256 9830(return M;)B
8088 9670(else if \(hue < 4 * PI / 3\))B
8256 9510(return m + \(M - m\) * \(4 * PI / 3 - hue\) / \(PI / 3\);)B
8088 9350(else)B
8256 9190(return m;)B
7920 9030(})B
7920 8710(void ColourRGB \(colour, r, g, b\))B
8340 8550(Colour colour;)B
8340 8390(float *r, *g, *b;)B
7920 8230({)B
8088 8070(float H = colour.hue, S = colour.saturation, L = colour.brightness;)B
8088 7910(float m, M;)B
8088 7590(if \(L <= .5\))B
8256 7430(M = L * \(1 + S\);)B
8088 7270(else)B
8256 7110(M = \(L + S\) - \(L * S\);)B
8088 6950(m = 2 * L - M;)B
8088 6790(H *= 2 * PI;)B
8088 6630(*r = Value \(m, M, H\);)B
8088 6470(*g = Value \(m, M, H - 2 * PI / 3\);)B
8088 6310(*b = Value \(m, M, H - 4 * PI / 3\);)B
7920 6150(})B
7920 5830(float Brightness \(colour\))B
8340 5670(Colour colour;)B
7920 5510({)B
8088 5350(return colour.brightness;)B
7920 5190(})B
7920 4710(/* )B
8004 4550(* The RGB colour model and Hue Saturation Brightness/Lightness model)B
8004 4390(* are derived from the paper:)B
EndPage
HfDict begin ep end
%%Page: ? 13
HfDict begin bp end
StartPage
Landscape
()(colour.c)[(89/03/24)(04:52:16)](2)Gaudy
0 F
444 14470(* )B
444 14310(* )B
420("Colour Gamut Transform Pairs")X
444 14150(*)B
504(by Alvy Ray Smith in Computer Graphics Volume 12 #3. August 1978)X
444 13990(* )B
444 13830(* PostScript uses the NTSC video colour weights.)B
444 13670(*/)B
360 13350(#define RED_WEIGHT)B
504(0.3333)X
168(/* .3)X
252(*/)X
360 13190(#define GREEN_WEIGHT)B
336(0.3333)X
168(/* .59)X
168(*/)X
360 13030(#define BLUE_WEIGHT)B
420(0.3333)X
168(/* .11)X
168(*/)X
360 12710(#define a0)B
504(120.0 * PI / 180)X
1344(/* 156.58 * PI / 180 */)X
360 12550(#define a1)B
504(120.0 * PI / 180)X
1344(/* 115.68 * PI / 180 */)X
360 12230(#define A0)B
504(0.0)X
1092(/* -21.60 * PI / 180 */)X
360 12070(#define A1)B
504(0.0)X
1092(/* 14.98 * PI / 180 */)X
360 11910(#define A2)B
504(0.0)X
1092(/* 10.65 * PI / 180 */)X
360 11430(/*)B
360 11270(static int SetRGB \(red, green, blue\) Object red, green, blue;)B
444 11110({)B
1032 10950(float R = BodyReal \(red\), G = BodyReal \(green\), B = BodyReal \(blue\);)B
1032 10790(float r, g, b, r_, g_, b_, d, x, rr, gg, bb, wr_, k0, k1, min, H, S, L;)B
1032 10470(if \(R < 0 || R > 1 || G < 0 || G > 1 || B < 0 || B > 1\))B
1704 10310(return Error \(PRangeCheck\);)B
1032 10150(L = R * RED_WEIGHT + G * GREEN_WEIGHT + B * BLUE_WEIGHT;)B
1032 9990(r_ = R/L; g_ = G/L; b_ = B/L;)B
1032 9830(r = RED_WEIGHT * r_; g = GREEN_WEIGHT * g_; b = BLUE_WEIGHT * b_;)B
1032 9670(rr = r - RED_WEIGHT; gg = g - GREEN_WEIGHT; bb = b - BLUE_WEIGHT;)B
1032 9510(min = \(r_ < g_ ? r_ : g_\); min = min < b_ ? min : b_;)B
1032 9350(S = 1 - min;)B
1032 9190(if \(S != 0\))B
1116 9030({)B
1704 8870(k0 = sqrt \(rr*rr + gg*gg + bb*bb\);)B
1704 8710(wr_ = 1 - RED_WEIGHT;)B
1704 8550(d = wr_ * rr - GREEN_WEIGHT * gg + BLUE_WEIGHT * bb;)B
1704 8390(k1 = sqrt \(wr_ * wr_ + GREEN_WEIGHT * GREEN_WEIGHT - BLUE_WEIGHT * BLUE_W)B
1704 8230(x = d / \(k0 * k1\);)B
1704 8070(H = PI / 2 - atan2 \(x, sqrt \(1 - x*x\)\);)B
1704 7910(if \(b_ > g_\))B
2376 7750(H = 2 * PI - H;)B
1704 7590(H /= 2 * PI;)B
1116 7430(})B
1032 7270(if \(H < 0 || H > 1 || S < 0 || S > 1 || L < 0 || L > 1\))B
1704 7110(return Error \(PRangeCheck\);)B
1032 6950(gstate->colour = NewHSLColour \(H, S, L\);)B
1032 6790(return TRUE;)B
444 6630(})B
360 6310(static int GetRGB \(\))B
444 6150({)B
1032 5990(float H = gstate->colour.hue, S = gstate->colour.saturation, L = gstate->colour.b)B
1032 5830(float r, g, b, Wr = RED_WEIGHT, Wg = GREEN_WEIGHT, Wb = BLUE_WEIGHT;)B
1032 5510(H *= 2 * PI;)B
1032 5350(if \(0 <= H && H <= a0\))B
1116 5190({)B
1704 5030(H -= A0;)B
1704 4870(b = Wb * \(1 - S\);)B
1704 4710(r = Wr + Wb * S * cos \(H\) / cos \(PI / 3 - H\);)B
1704 4550(g = 1 - \(r + b\);)B
1116 4390(})B
8592 14470(else if \(a0 <= H  && H <= \(a0 + a1\)\))B
8676 14310({)B
9264 14150(H -= a0 + A1;)B
9264 13990(r = Wr * \(1 - S\);)B
9264 13830(g = Wg + Wr * S * cos \(H\) / cos \(PI / 3 - H\);)B
9264 13670(b = 1 - \(r + g\);)B
8676 13510(})B
8592 13350(else)B
8676 13190({)B
9264 13030(H -= a0 + a1 + A2;)B
9264 12870(g = Wg * \(1 - S\);)B
9264 12710(b = Wb + Wg * S * cos \(H\) / cos \(PI / 3 - H\);)B
9264 12550(r = 1 - \(g + b\);)B
8676 12390(})B
8592 12070(VOID Push \(OpStack, MakeReal \(L* r / Wr\)\);)B
8592 11910(VOID Push \(OpStack, MakeReal \(L* g / Wg\)\);)B
8592 11750(VOID Push \(OpStack, MakeReal \(L* b / Wb\)\);)B
8592 11590(return TRUE;)B
8004 11430(})B
7920 11270(*/)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(colour.h)[(89/03/24)(04:53:21)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(typedef struct { float hue, saturation, brightness; } Colour;)B
360 13510(extern Colour Black, White;)B
360 13190(extern Colour NewColour \(\), NewHSBColour \(\), NewRGBColour \(\), NewGray \(\);)B
360 13030(extern void ColourHSB \(\), ColourRGB \(\);)B
360 12870(extern float Gray \(\), Brightness \(\);)B
EndPage
HfDict begin ep end
%%Page: ? 14
HfDict begin bp end
StartPage
Landscape
()(config.c)[(89/03/29)(13:05:02)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(static int SizeArray = 53, SizeMark = 19, SizeBool = 53, SizeNull = 19;)B
360 11910(static int SizeCondition = 19, SizeFile = 41, SizeString = 71, SizePoly = 19;)B
360 11750(static int SizeInteger = 71, SizeReal = 71, SizeName = 19, SizeOperator = 19;)B
360 11590(int SizeSysDict = 1001, SizeDictionary = 53, SizeFloat = 0, SizeFontID = 19;)B
360 11270(Type Array, Mark, Bool, Dictionary, Condition, Null, File, Integer;)B
360 11110(Type Real, Name, Operator, String, Poly, Float, FontID;)B
360 10790(extern Object Absent, SysDict;)B
360 10630(Object Nil;)B
360 10310(#ifdef MACINTOSH)B
360 10150(char default_library[] = "";)B
360 9990(#else)B
360 9830(char default_library[] = "/mit/sipb/lib/postscript";)B
360 9670(#endif)B
360 9350(Init \(\))B
360 9190({)B
528 9030(MakeObject \(Nil, \(Type\) 0\);)B
528 8870(Null)B
840(= Nil.type = MakeType \(SizeNull\);)X
528 8710(EmptyDict \(\(Type\) Null\);)B
504(/* needed because of this recursion */)X
528 8390(Dictionary)B
336(= MakeType \(SizeDictionary\);)X
528 8230(Condition)B
420(= MakeType \(SizeCondition\);)X
528 8070(Name )B
756(= MakeType \(SizeName\);)X
528 7910(Operator)B
504(= MakeType \(SizeOperator\);)X
528 7750(Array)B
756(= MakeType \(SizeArray\);)X
528 7590(Mark )B
756(= MakeType \(SizeMark\);)X
528 7430(Bool)B
840(= MakeType \(SizeBool\);)X
528 7270(File )B
756(= MakeType \(SizeFile\);)X
528 7110(Integer )B
504(= MakeType \(SizeInteger\);)X
528 6950(Real )B
756(= MakeType \(SizeReal\);)X
528 6790(String)B
672(= MakeType \(SizeString\);)X
528 6630(Poly )B
756(= MakeType \(SizePoly\);)X
528 6470(Float)B
756(= MakeType \(SizeFloat\);)X
528 6310(FontID)B
672(= MakeType \(SizeFontID\);)X
528 5990(Message \("InitDictionary"\);)B
252(InitDictionary \(\);)X
528 5830(Message \("InitOperator"\);)B
420(InitOperator \(\);)X
528 5670(Message \("InitName"\);)B
756(InitName \(\);)X
528 5510(Message \("InitPoly"\);)B
756(InitPoly \(\);)X
528 5350(Message \("InitArray"\);)B
672(InitArray \(\);)X
528 5190(Message \("InitStack"\);)B
672(InitStack \(\);)X
528 5030(Message \("InitFile"\);)B
756(InitFile \(\);)X
528 4870(Message \("InitMisc"\);)B
756(InitMisc \(\);)X
528 4710(Message \("InitBool"\);)B
756(InitBool \(\);)X
528 4550(Message \("InitInteger"\);)B
504(InitInteger \(\);)X
528 4390(Message \("InitReal"\);)B
756(InitReal \(\);)X
8088 14470(Message \("InitMath"\);)B
756(InitMath \(\);)X
8088 14310(Message \("InitString"\);)B
588(InitString \(\);)X
8088 14150(Message \("InitProperty"\);)B
420(InitProperty \(\);)X
8088 13990(Message \("InitControl"\);)B
504(InitControl \(\);)X
8088 13670(Message \("InitMatrix"\);)B
588(InitMatrix \(\);)X
8088 13510(Message \("InitPath"\);)B
756(InitPath \(\);)X
8088 13350(Message \("InitFill"\);)B
756(InitFill \(\);)X
8088 13190(Message \("InitStroke"\);)B
588(InitStroke \(\);)X
8088 13030(Message \("InitGSave"\);)B
672(InitGSave \(\);)X
8088 12870(Message \("InitDevices"\);)B
504(InitDevices \(\);)X
8088 12710(Message \("InitCache"\);)B
672(InitCache \(\);)X
8088 12550(Message \("InitImage"\);)B
672(InitImage \(\);)X
8088 12390(Message \("InitState"\);)B
672(InitState \(\);)X
8088 12230(Message \("InitFont"\);)B
756(InitFont \(\);)X
8088 12070(Message \("InitUnix"\);)B
756(InitUnix \(\);)X
8088 11750(Install \("nulltype",)B
840(DictFrom \(Null\)\);)X
8088 11590(Install \("dicttype",)B
840(DictFrom \(Dictionary\)\);)X
8088 11430(Install \("conditiontype",)B
420(DictFrom \(Condition\)\);)X
8088 11270(Install \("nametype",)B
840(DictFrom \(Name\)\);)X
8088 11110(Install \("operatortype",)B
504(DictFrom \(Operator\)\);)X
8088 10950(Install \("arraytype",)B
756(DictFrom \(Array\)\);)X
8088 10790(Install \("marktype",)B
840(DictFrom \(Mark\)\);)X
8088 10630(Install \("booleantype",)B
588(DictFrom \(Bool\)\);)X
8088 10470(Install \("filetype",)B
840(DictFrom \(File\)\);)X
8088 10310(Install \("integertype",)B
588(DictFrom \(Integer\)\);)X
8088 10150(Install \("realtype",)B
840(DictFrom \(Real\)\);)X
8088 9990(Install \("stringtype",)B
672(DictFrom \(String\)\);)X
8088 9830(Install \("polytype",)B
840(DictFrom \(Poly\)\);)X
8088 9670(Install \("fonttype",)B
840(DictFrom \(FontID\)\);)X
8088 9350(Install \("version",)B
924(StringFrom \("Version 1.4"\)\);)X
7920 9190(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(control.c)[(89/04/02)(23:06:02)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.  It is not in the public domain.)B
444 13510(* This notice should remain in the source unaltered, and any changes)B
444 13350(* to the source made by persons other than the author should be)B
444 13190(* marked as such. )B
444 13030(* )B
444 12870(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12710(*/)B
360 12550(#include <signal.h>)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(/*)B
444 11750(* This file implements the flow control operators of PostScript)B
444 11590(*)B
444 11430(* All operations are implemented using the ExecStack and without recursion.)B
444 11270(* This is to allow error recovery to operate cleanly.)B
444 11110(*)B
444 10950(* Actual control is acheived by stacking continuation operators for)B
444 10790(* the looping operators, declared thus:)B
444 10630(*)B
444 10470(*/)B
360 10150(static Object OpLoop, OpRepeat, OpStopped;)B
360 9830(/*)B
444 9670(* "loop", for example, stacks the following:)B
444 9510(*)B
504(proc)X
444 9350(*)B
504(OpLoop)X
444 9190(*)B
504(proc)X
444 9030(*)B
504(Nil)X
444 8870(*)B
444 8710(* OpLoop is the continuer, proc is the body code, passed as a parameter.)B
444 8550(*)B
444 8390(* Nil is placed at the bottom by each of the looping constructs,)B
444 8230(* which are 'exit'able.)B
444 8070(* "exit" pops the exec stack until it encounters a Nil.)B
444 7910(*)B
444 7750(* A Marker is placed on the ExecStack to enclose a Stopped context.)B
444 7590(* A File is placed on the ExecStack to enclose a Run context.)B
444 7430(* A Nil is placed on the ExecStack to enclose a Looping construct.)B
444 7270(* "stop" will unwind the stack down to the Marker, ignoring any Nil)B
444 7110(* or File it might find.)B
444 6950(* "exit" will baulk if it finds a Marker or File before a Nil.)B
444 6790(*)B
444 6630(*/)B
360 6310(static int PExec \(\), PIf \(\), PIfElse \(\), PRepeat \(\), PFor \(\), PLoop \(\);)B
360 6150(static int PExit \(\), PCountExecStack \(\);)B
360 5990(static int PQuit \(\), PStart \(\);)B
360 5830(int PStop \(\), PStopped \(\);)B
360 5670(static int Repeat \(\), Loop \(\), Stopped \(\);)B
360 5350(InitControl \(\))B
360 5190({)B
528 5030(OpRepeat )B
420(= MakeOp \("\(repeat\)",)X
252(Repeat,)X
84(0, 0, 3, 2\);)X
528 4870(OpLoop )B
588(= MakeOp \("\(loop\)",)X
420(Loop,)X
252(0, 0, 1, 2\);)X
528 4710(OpStopped)B
420(= MakeOp \("\(stopped\)",)X
168(Stopped,0, 1, 1, 0\);)X
528 4390(InstallOp \("exec",)B
336(PExec,)X
840(1, 1, 0, 1, Poly\);)X
8088 14470(InstallOp \("if",)B
504(PIf,)X
1008(2, 0, 0, 1, Bool, Array\);)X
8088 14310(InstallOp \("ifelse",)B
168(PIfElse,)X
672(3, 0, 0, 1, Bool, Array, Array\);)X
8088 14150(InstallOp \("repeat",)B
168(PRepeat,)X
672(2, 0, 0, 4, Integer, Array\);)X
8088 13990(InstallOp \("for",)B
420(PFor,)X
924(4, 0, 0, 6, Poly, Poly, Poly, Array\);)X
8088 13830(InstallOp \("loop",)B
336(PLoop,)X
840(1, 0, 0, 4, Array\);)X
8088 13670(InstallOp \("exit",)B
336(PExit,)X
840(0, 0, 0, 0\);)X
8088 13510(InstallOp \("stop",)B
336(PStop,)X
840(0, 1, 0, 0\);)X
8088 13350(InstallOp \("stopped",)B
84(PStopped,)X
588(1, 1, 0, 3, Array\);)X
8088 13190(InstallOp \("quit",)B
336(PQuit, )X
756(0, 0, 0, 0\);)X
8088 13030(InstallOp \("start",)B
252(PStart, )X
672(0, 0, 0, 0\);)X
8088 12870(InstallOp \("countexecstack",)B
9012 12710(PCountExecStack,0, 1, 0, 0\);)B
7920 12550(})B
7920 12230(static int PExec \(item\))B
8340 12070(Object item;)B
7920 11910({)B
8088 11750(VOID Push \(OpStack, item\);)B
8088 11590(if \(xCheck \(item\)\) {)B
8256 11430(Object fn;)B
8256 11110(fn = Lookup \(TypeOf \(item\), Self\);)B
8256 10950(if \(TypeOf \(fn\) != Condition\))B
8424 10790(VOID Push \(ExecStack, fn\);)B
8088 10630(})B
8088 10470(return TRUE;)B
7920 10310(})B
7920 9990(static int PIf \(bool, proc\))B
8340 9830(Object bool, proc;)B
7920 9670({)B
8088 9510(if \(!xCheck \(proc\)\))B
8256 9350(return Error \(PTypeCheck\);)B
8088 9190(if \(BodyBool \(bool\)\))B
8256 9030(VOID Push \(ExecStack, proc\);)B
8088 8870(return TRUE;)B
7920 8710(})B
7920 8390(static int PIfElse \(bool, proc1, proc2\))B
8340 8230(Object bool, proc1, proc2;)B
7920 8070({)B
8088 7910(if \(!xCheck \(proc1\) || !xCheck \(proc2\)\))B
8256 7750(return Error \(PTypeCheck\);)B
8088 7590(if \(BodyBool \(bool\)\))B
8256 7430(VOID Push \(ExecStack, proc1\);)B
8088 7270(else)B
8256 7110(VOID Push \(ExecStack, proc2\);)B
8088 6950(return TRUE;)B
7920 6790(})B
7920 6470(static int PRepeat \(count, proc\))B
8340 6310(Object count, proc;)B
7920 6150({)B
8088 5990(if \(!xCheck \(proc\)\))B
8256 5830(return Error \(PTypeCheck\);)B
8088 5670(else if \(BodyInteger \(count\) < 0\))B
8256 5510(return Error \(PRangeCheck\);)B
8088 5190(VOID Push \(ExecStack, Nil\);)B
8088 5030(VOID Push \(ExecStack, proc\);)B
8088 4870(VOID Push \(ExecStack, count\);)B
8088 4710(VOID Push \(ExecStack, OpRepeat\);)B
8088 4390(return TRUE;)B
EndPage
HfDict begin ep end
%%Page: ? 15
HfDict begin bp end
StartPage
Landscape
()(control.c)[(89/04/02)(23:06:02)](2)Gaudy
0 F
360 14470(})B
360 14150(static int Repeat \(\))B
360 13990({)B
528 13830(int count;)B
528 13510(count = BodyInteger \(Pop \(ExecStack\)\);)B
528 13190(if \(count != 0\) {)B
696 13030(Object proc;)B
696 12710(proc = Top \(ExecStack\);)B
696 12550(VOID Push \(ExecStack, MakeInteger \(count - 1\)\);)B
696 12390(VOID Push \(ExecStack, OpRepeat\);)B
696 12230(VOID Push \(ExecStack, proc\);)B
528 12070(} else {)B
696 11910(VOID Pop \(ExecStack\);)B
696 11750(VOID Pop \(ExecStack\);)B
528 11590(})B
528 11430(return TRUE;)B
360 11270(})B
360 10950(static int PFor \(initial, increment, limit, proc\))B
780 10790(Object initial, increment, limit, proc;)B
360 10630({)B
528 10470(int integers = 0, reals = 0, res;)B
528 10150(if \(!xCheck \(proc\)\))B
696 9990(return Error \(PTypeCheck\);)B
528 9670(if \(TypeOf \(initial\) == Integer || TypeOf \(initial\) == Real\))B
696 9510(integers += TypeOf \(initial\) == Integer,)B
696 9350(reals += TypeOf \(initial\) == Real;)B
528 9030(if \(TypeOf \(increment\) == Integer || TypeOf \(increment\) == Real\))B
696 8870(integers += TypeOf \(increment\) == Integer,)B
696 8710(reals += TypeOf \(increment\) == Real;)B
528 8390(if \(TypeOf \(limit\) == Integer || TypeOf \(limit\) == Real\))B
696 8230(integers += TypeOf \(limit\) == Integer,)B
696 8070(reals += TypeOf \(limit\) == Real;)B
528 7750(if \(integers + reals == 3 && integers != 3 && reals != 3\) {)B
696 7590(if \(TypeOf \(initial\) == Integer\))B
864 7430(initial = RealInteger \(initial\);)B
696 7270(if \(TypeOf \(increment\) == Integer\))B
864 7110(increment = RealInteger \(increment\);)B
696 6950(if \(TypeOf \(limit\) == Integer\))B
864 6790(limit = RealInteger \(limit\);)B
528 6630(})B
528 6470(if \(res = Apply \(TypeOf \(initial\)\)\) {)B
696 6310(VOID Push \(OpStack, initial\);)B
696 6150(VOID Push \(OpStack, increment\);)B
696 5990(VOID Push \(OpStack, limit\);)B
696 5830(VOID Push \(OpStack, proc\);)B
528 5670(})B
528 5510(return res;)B
360 5350(})B
360 5030(static int PLoop \(proc\))B
780 4870(Object proc;)B
360 4710({)B
528 4550(if \(!xCheck \(proc\)\))B
696 4390(return Error \(PTypeCheck\);)B
8088 14310(VOID Push \(ExecStack, Nil\);)B
8088 14150(VOID Push \(ExecStack, proc\);)B
8088 13990(VOID Push \(ExecStack, OpLoop\);)B
8088 13830(VOID Push \(ExecStack, proc\);)B
8088 13510(return TRUE;)B
7920 13350(})B
7920 13030(static int Loop \(\))B
588(/* proc --- */)X
7920 12870({)B
8088 12710(Object proc;)B
8088 12390(proc = Top \(ExecStack\);)B
8088 12230(VOID Push \(ExecStack, OpLoop\);)B
8088 12070(VOID Push \(ExecStack, proc\);)B
8088 11910(return TRUE;)B
7920 11750(})B
7920 11430(static int PExit \(\))B
7920 11270({)B
8088 11110(int n, m, p;)B
8088 10790(if \(\(n = CountTo \(Null, ExecStack\)\) < 0)B
8424 10630(|| \(m = CountTo \(Mark, ExecStack\)\) >= 0 && m < n)B
8424 10470(/* don't cross Stopped Context */)B
8424 10310(|| \(p = CountTo \(File, ExecStack\)\) >= 0 && p < n\))B
8256 10150(/* don't cross Run context */)B
8256 9990(return Error \(PInvExit\);)B
8088 9830(VOID ClearTo \(Null, ExecStack\);)B
8088 9670(return TRUE;)B
7920 9510(})B
7920 9190(int PStop \(\))B
336(/* --- */)X
7920 9030({)B
8088 8870(Object item;)B
8088 8550(for \(;;\) {)B
8256 8390(if \(Height \(ExecStack\) == 0\) {)B
8424 8230(if \(interactive\))B
8592 8070(return Push \(ExecStack, Cvx \(NameFrom \("executive"\)\)\);)B
8424 7910(else)B
8592 7750(return TRUE;)B
8256 7590(})B
8256 7430(item = Pop \(ExecStack\);)B
8256 7270(if \(item.type == Mark\))B
8424 7110(return Push \(OpStack, True\);)B
8088 6950(})B
7920 6790(})B
7920 6470(static int Stopped \(\))B
7920 6310({)B
8088 6150(VOID Pop \(ExecStack\);)B
8088 5990(VOID Push \(OpStack, False\);)B
8088 5830(return TRUE;)B
7920 5670(})B
7920 5350(int PStopped \(proc\))B
8340 5190(Object proc;)B
7920 5030({)B
8088 4870(VOID Push \(ExecStack, Marker\);)B
8088 4710(VOID Push \(ExecStack, OpStopped\);)B
8088 4550(VOID Push \(ExecStack, proc\);)B
8088 4390(return TRUE;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(control.c)[(89/04/02)(23:06:02)](3)Gaudy
0 F
360 14470(})B
360 14150(static int PCountExecStack \(\))B
360 13990({)B
528 13830(VOID Push \(OpStack, MakeInteger \(Height \(ExecStack\)\)\);)B
528 13670(return TRUE;)B
360 13510(})B
360 13190(/*)B
444 13030(* PExecStack \(\))B
444 12870(*)B
444 12710(* This routine is in stack.c)B
444 12550(*)B
444 12390(*/)B
360 12070(static int PQuit \(\))B
360 11910({)B
528 11750(UnlinkDevice \(gstate->device\);)B
528 11590(Cleanup \(\);)B
528 11430(exit \(0\);)B
528 11110(return TRUE; /* never will */)B
360 10950(})B
360 10630(static int PStart \(\))B
360 10470({)B
528 10310(return TRUE;)B
360 10150(})B
EndPage
HfDict begin ep end
%%Page: ? 16
HfDict begin bp end
StartPage
Landscape
()(copyright.h)[(88/08/23)(13:30:56)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not sold for profit)B
444 13830(* or incorporated into a product except under licence from the author.)B
444 13670(* It is not in the public domain.)B
444 13510(* This notice should remain in the source unaltered, and any changes to the source)B
444 13350(* made by persons other than the author should be marked as such.)B
444 13190(* )B
444 13030(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12870(*/)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(device.c)[(89/04/06)(11:58:43)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(static int NullDevice \(\);)B
360 11750(static int FrameDevice \(\);)B
360 11590(static int GrabBits \(\);)B
360 11430(static int PWindow \(\);)B
360 11110(Colour Black = { 0.0, 0.0, 0.0 }, White = { 0.0, 0.0, 1.0 };)B
360 10790(struct device *NewWindowDevice \(\), *NewBitmapDevice \(\), *NewCacheDevice \(\);)B
360 10630(DevicePoint HardToDevice \(\);)B
360 10470(HardPoint DeviceToHard \(\);)B
360 10310(extern DevicePoint ConvertToDevicePoint \(\);)B
360 10150(extern float hppp, vppp;)B
360 9830(InitDevices \(\))B
360 9670({)B
528 9510(struct hardware *h;)B
528 9350(DevicePoint extent;)B
528 9030(InstallOp \("framedevice",)B
420(FrameDevice, )X
924(4, 0, 0, 0,)X
1452 8870(Array, Integer, Integer, Array\);)B
528 8710(InstallOp \("nulldevice",)B
504(NullDevice,)X
1092(0, 0, 0, 0\);)X
528 8550(InstallOp \("grabbits",)B
672(GrabBits,)X
1260(4, 0, 0, 0,)X
1452 8390(Float, Float, Float, Float\);)B
528 8230(InstallOp \("window",)B
840(PWindow,)X
1344(5, 0, 0, 0,)X
1452 8070(Float, Float, Float, Float, Integer\);)B
528 7750(extent = HardwareExtent \(h = InitHardware \(\)\);)B
528 7590(gstate->device = NULL; gstate->clipdevice = NULL;)B
528 7430(SetDevice \(LinkDevice \(DeviceFrom \(h, DeviceMatrix \(extent.dx,)B
4896 7270(extent.dy\)\)\)\);)B
360 7110(})B
360 6790(static int GrabBits \(x, y, w, h\))B
780 6630(Object x, y, w, h;)B
360 6470({)B
528 6310(DevicePoint or,ul,lr;)B
528 6150(HardPoint origin, corner;)B
528 5990(int width, height, size;)B
528 5830(unsigned char *s;)B
528 5670(struct hardware *dev;)B
528 5350(origin = ExtToInt \(NewUserPoint \(BodyReal \(x\), BodyReal \(y\)\)\);)B
528 5190(corner = ExtToInt \(NewUserPoint \(BodyReal \(x\) + BodyReal \(w\),)B
2964 5030(BodyReal \(y\) + BodyReal \(h\)\)\);)B
528 4870(width = \(int\) \(corner.hx - origin.hx\);)B
528 4710(height = \(int\) \(corner.hy - origin.hy\);)B
528 4390(fprintf \(stderr, "width = %d, height = %d\\n", width, height\);)B
8088 14310(dev = NewBitmapHardware \(width, height\);)B
8088 14150(or.dx = \(int\) origin.hx; or.dy = \(int\) origin.hy;)B
8088 13990(ul.dx = 0;               ul.dy = 0;)B
8088 13830(lr.dx = width;           lr.dy = height;)B
8088 13510(BitBlt \(gstate->device->dev, dev, or, ul, lr, ROP_SOURCE\);)B
8088 13350(s = StringFromHardware \(dev\);)B
8088 13190(DestroyHardware \(dev\);)B
8088 13030(size = \(width + 7\) / 8 * height;)B
8088 12710(Push \(OpStack, MakeString \(s, size\)\);)B
8088 12550(Free \(s\);)B
8088 12390(Push \(OpStack, MakeInteger \(width\)\);)B
8088 12230(Push \(OpStack, MakeInteger \(height\)\);)B
8088 11910(return TRUE;)B
7920 11750(})B
7920 11430(static int NullDevice \(\))B
7920 11270({)B
8088 11110(extern Matrix identity;)B
8088 10790(SetDevice \(NewDevice \()B
-160(NewClipPath \(0.0, 0.0, 0.0, 0.0\),)Y
9936 10470(identity,)B
9936 10310(\(struct hardware *\) NULL\)\);)B
8088 10150(return TRUE;)B
7920 9990(})B
7920 9670(/*ARGSUSED*/)B
7920 9510(static int FrameDevice \(mat, width, height, proc\))B
8340 9350(Object mat, width, height, proc;)B
7920 9190({)B
8088 9030(Matrix m;)B
8088 8710(if \(lengthArray \(mat\) != 6 || !ExtractMatrix \(&m, mat\)\))B
8256 8550(return Error \(PTypeCheck\);)B
8088 8390(if \(BodyInteger \(width\) < 0 || BodyInteger \(height\) < 0\))B
8256 8230(return Error \(PRangeCheck\);)B
8088 8070(SetDevice \(NewWindowDevice \(BodyInteger \(width\) * 8, BodyInteger \(height\),)B
10440 7910(m\)\);)B
8088 7750(ErasePage \(\);)B
8088 7430(return TRUE;)B
7920 7270(})B
7920 6950(/*ARGSUSED*/)B
7920 6790(static int PWindow \(x, y, wid, hgt, typ\))B
8340 6630(Object x, y, wid, hgt, typ;)B
7920 6470({)B
8088 6310(int wd, ht;)B
8088 6150(Matrix m;)B
8088 5990(struct device *w;)B
8088 5670(wd = \(int\) \(BodyReal \(wid\) * hppp\);)B
8088 5510(ht = \(int\) \(BodyReal \(hgt\) * vppp\);)B
8088 5190(NewMatrix\(m, hppp, 0, 0, -vppp, 0, ht\);)B
8088 5030(w = NewWindowDevice \(wd, ht, m\);)B
8088 4870(SetDevice \(w\);)B
8088 4710(ErasePage \(\);)B
8088 4390(return Push \(OpStack, MakeInteger \(w\)\);)B
EndPage
HfDict begin ep end
%%Page: ? 17
HfDict begin bp end
StartPage
Landscape
()(device.c)[(89/04/06)(11:58:43)](2)Gaudy
0 F
360 14470(})B
360 14150(struct device *DeviceFrom \(h, m\))B
780 13990(struct hardware *h; Matrix m;)B
360 13830({)B
528 13670(DevicePoint extent;)B
528 13350(extent = HardwareExtent \(h\);)B
528 13190(return NewDevice \(NewClipPath \(0.0,)B
3132 13030(\(float\) extent.dx,)B
3132 12870(\(float\) extent.dy, 0.0\),)B
2040 12710(m, h\);)B
360 12550(})B
360 12230(struct device *NewWindowDevice \(width, height, m\))B
780 12070(int width, height;)B
780 11910(Matrix m;)B
360 11750({)B
528 11590(return DeviceFrom \(NewWindowHardware \(width, height\),)B
2124 11430(m\);)B
360 11270(})B
360 10950(struct device *NewBitmapDevice \(width, height, m\))B
780 10790(int width, height;)B
780 10630(Matrix m;)B
360 10470({)B
528 10310(return DeviceFrom \(NewBitmapHardware \(width, height\),)B
2124 10150(m\);)B
360 9990(})B
360 9670(struct device *NewCacheDevice \(m, width, height, swidth, sheight\))B
780 9510(Matrix m; int width, height, swidth, sheight;)B
360 9350({)B
528 9190(m.tx = \(float\) swidth;)B
528 9030(m.ty = \(float\) \(height - sheight\);)B
528 8870(return NewDevice \(NewClipPath \(0.0, \(float\) width,)B
3132 8710(\(float\) height, 0.0\),)B
2040 8550(m,)B
2040 8390(NewBitmapHardware \(width, height\)\);)B
360 8230(})B
360 7910(Path NewClipPath \(left, right, top, bottom\))B
780 7750(float left, right, top, bottom;)B
360 7590({)B
528 7430(Path p = NewPath \(\);)B
528 7270(HardPoint cp;)B
528 7110(int cp_def = gstate->cp_defined;)B
528 6790(cp = gstate->cp;)B
528 6630(VOID MoveTo \(p, NewHardPoint \(left,  bottom\)\);)B
528 6470(VOID LineTo \(p, NewHardPoint \(right, bottom\)\);)B
528 6310(VOID LineTo \(p, NewHardPoint \(right, top\)\);)B
528 6150(VOID LineTo \(p, NewHardPoint \(left,  top\)\);)B
528 5990(ClosePath \(p\);)B
528 5670(gstate->cp = cp; gstate->cp_defined = cp_def;)B
528 5350(return p;)B
360 5190(})B
360 4870(struct device *NewDevice \(clip, m, dev\))B
780 4710(Path clip;)B
780 4550(Matrix m;)B
780 4390(struct hardware *dev;)B
7920 14470({)B
8088 14310(struct device *res = \(struct device *\) Malloc \(sizeof \(struct device\)\);)B
8088 13990(res->link_count = 0;)B
8088 13830(res->default_clip = clip;)B
8088 13670(res->default_matrix = m;)B
8088 13510(res->dev = dev;)B
8088 13190(return res;)B
7920 13030(})B
7920 12710(SetDevice \(d\))B
8340 12550(struct device *d;)B
7920 12390({)B
8088 12230(UnlinkDevice \(gstate->device\);)B
8088 12070(gstate->device = LinkDevice \(d\);)B
8088 11910(gstate->CTM = d->default_matrix;)B
8088 11750(InitClip \(\);)B
7920 11590(})B
7920 11270(int IsCache \(d\))B
8340 11110(struct device *d;)B
7920 10950({)B
8088 10790(return !IsWindowHardware \(d->dev\);)B
7920 10630(})B
7920 10310(struct device *LinkDevice \(d\))B
8340 10150(struct device *d;)B
7920 9990({)B
8088 9830(if \(d\))B
8256 9670(++d->link_count;)B
8088 9350(return d;)B
7920 9190(})B
7920 8870(UnlinkDevice \(d\))B
8340 8710(struct device *d;)B
7920 8550({)B
8088 8390(if \(d == NULL\))B
8256 8230(return;)B
8088 8070(if \(--d->link_count != 0\))B
8256 7910(return;)B
8088 7750(if \(d->dev != NULL\))B
8256 7590(DestroyHardware \(d->dev\);)B
8088 7430(Free \(\(char *\) d\);)B
7920 7270(})B
7920 6950(struct device *UniqueDevice \(d\))B
8340 6790(struct device *d;)B
7920 6630({)B
8088 6470(struct device *res;)B
8088 6310(DevicePoint ex;)B
8088 5990(if \(d && d->link_count == 1\))B
8256 5830(return d;)B
8088 5670(ex = HardwareExtent \(gstate->device->dev\);)B
8088 5510(res = LinkDevice \(NewBitmapDevice \(ex.dx, ex.dy, gstate->CTM\)\);)B
8088 5350(/*if \(d\))B
8172 5190(* {)B
8172 5030(* BitBlt \(d->dev, res->dev, NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\),)B
8172 4870(*         ex, ROP_SOURCE\);)B
8172 4710(* UnlinkDevice \(d\);)B
8172 4550(* })B
8172 4390(* else)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(device.c)[(89/04/06)(11:58:43)](3)Gaudy
0 F
612 14470(*/)B
528 14310(BitBlt \(\(struct hardware *\)NULL, res->dev,)B
1200 14150(NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\),)B
1200 13990(ex, ROP_FALSE\);)B
528 13670(return res;)B
360 13510(})B
360 13190(HardPoint DeviceToHard \(p\))B
780 13030(DevicePoint p;)B
360 12870({)B
528 12710(HardPoint res;)B
528 12390(res.hx = \(float\) p.dx;)B
528 12230(res.hy = \(float\) p.dy;)B
528 11910(return res;)B
360 11750(})B
360 11430(DevicePoint NewDevicePoint \(x, y\))B
780 11270(int x, y;)B
360 11110({)B
528 10950(DevicePoint res;)B
528 10630(res.dx = x;)B
528 10470(res.dy = y;)B
528 10150(return res;)B
360 9990(})B
360 9670(/*)B
444 9510(* DevicePaintLine\(\) gets called when a thin line \(linewidth 0\) is to)B
444 9350(* be drawn.)B
444 9190(*/)B
360 9030(DevicePaintLine \(d, fromPoint, toPoint, colour\))B
780 8870(struct device *d;)B
780 8710(HardPoint fromPoint, toPoint;)B
780 8550(Colour colour;)B
360 8390({)B
528 8230(DevicePoint fp,tp;)B
528 8070(fp.dx = \(int\) fromPoint.hx;  fp.dy = \(int\) fromPoint.hy;)B
528 7910(tp.dx = \(int\) toPoint.hx;    tp.dy = \(int\) toPoint.hy;)B
528 7750(PaintLine \(d->dev, fp, tp, colour\);)B
360 7590(})B
360 7110(#ifdef notdef)B
360 6950(void ColourLine \(h, fromPoint, toPoint, rop, colour\) )B
780 6790(struct hardware *h;)B
780 6630(DevicePoint fromPoint, toPoint;)B
780 6470(int rop;)B
780 6310(Colour colour;)B
360 6150({)B
528 5990(int x1 = fromPoint.dx, y1 = fromPoint.dy, x2 = toPoint.dx, y2 = toPoint.dy;)B
528 5830(int col = IsWindowHardware \(h\) ? HardColour \(colour\) : HardBlack;)B
528 5510(if \(col == HardBlack\) {)B
696 5350(ddbm = h->bm;)B
696 5190(dd->d_line = rop_map [rop];)B
696 5030(line \(x1, y1, LNMOVEABS\);)B
696 4870(line \(x2, y2, LNDRAWABS\);)B
528 4710(})B
528 4550(else {)B
696 4390(box b;)B
8256 14310(b = boxbuild \(Min \(x1, x2\), Min \(y1, y2\), Max \(x1, x2\), Max \(y1, y2\)\);)B
8256 13990(NeedAux \(h\);)B
8256 13830(GraySync \(h, col\);)B
8256 13670(bmxcopy \(h->bm, b, h->bm, b, WWXOR\);)B
8256 13350(ddbm = h->aux;)B
8256 13190(dd->d_line = WWOR;)B
8256 13030(line \(x1, y1, LNMOVEABS\);)B
8256 12870(line \(x2, y2, LNDRAWABS\);)B
8256 12550(bmxcopy \(h->aux,  b, h->bm,  b, WWAND | WWNOT\);)B
8256 12390(bmxcopy \(h->gray, b, h->aux, b, WWAND\);)B
8256 12230(bmxcopy \(h->aux,  b, h->bm,  b, rop_map [rop]\);)B
8088 12070(})B
7920 11910(})B
7920 11590(void ColourBitBlt \(from, to, fromPoint, toPoint, extent, rop, colour\))B
8592 11430(struct hardware *from, *to;)B
8592 11270(DevicePoint fromPoint, toPoint, extent;)B
8592 11110(int rop;)B
8592 10950(Colour colour;)B
8004 10790({)B
8592 10630(box frombox, tobox;)B
8592 10470(int col = IsWindowHardware \(to\) ? HardColour \(colour\) : HardBlack;)B
8592 10310(int op = rop_map [rop];)B
8592 9830(frombox = boxbuild \(fromPoint.dx, fromPoint.dy,)B
9264 9670(fromPoint.dx + extent.dx - 1, fromPoint.dy + extent.dy - 1\);)B
8592 9510(tobox = boxbuild \(toPoint.dx, toPoint.dy,)B
9264 9350(toPoint.dx + extent.dx - 1, toPoint.dy + extent.dy - 1\);)B
8592 9030(if \(to == NULL\))B
9264 8870(return;)B
8592 8550(if \(rop == ROP_FALSE\))B
9264 8390(bmxcopy \(to->bm, tobox, to->bm, tobox, WWXOR\);)B
8592 8230(else if \(rop == ROP_TRUE\))B
9264 8070(if \(col == HardBlack\))B
9936 7910(bmxcopy \(to->bm, tobox, to->bm, tobox, WWXOR | WWNOT\);)B
9264 7750(else)B
9348 7590({)B
9936 7430(GraySync \(to, col\);)B
9936 7270(bmxcopy \(to->gray, tobox, to->bm, tobox, WWCOPY\);)B
9348 7110(})B
8592 6950(else if \(col == HardBlack\))B
9264 6790(bmxcopy \(from->bm, frombox, to->bm, tobox, op\);)B
8592 6630(else)B
8676 6470({)B
9264 6310(GraySync \(to, col\);)B
9264 6150(NeedAux \(to\);)B
9264 5990(bmxcopy \(to->gray, tobox, to->aux, tobox, WWCOPY\);)B
9264 5830(bmxcopy \(from->bm, frombox, to->aux, tobox, WWAND\);)B
9264 5670(bmxcopy \(to->aux, tobox, to->bm, tobox, op\);)B
8676 5510(})B
8004 5350(})B
7920 5190(#endif)B
EndPage
HfDict begin ep end
%%Page: ? 18
HfDict begin bp end
StartPage
Landscape
()(device.h)[(89/03/24)(05:06:21)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(#include "hard.h")B
360 13510(struct device)B
360 13350({)B
528 13190(Matrix default_matrix;)B
528 13030(Path default_clip;)B
528 12870(int link_count;)B
528 12710(struct hardware *dev;)B
360 12550(};)B
360 12230(extern struct device *NewDevice \(\), *NewCacheDevice \(\), *LinkDevice \(\);)B
360 12070(extern struct device *DeviceFrom \(\), *UniqueDevice \(\), *NewBitmapDevice \(\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(dictionary.c)[(89/04/06)(11:59:30)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(extern int SizeUserDict, SizeSysDict;)B
360 11750(static Object OpForDict;)B
360 11430(Object Absent, SysDict;)B
360 11270(extern Object Nil;)B
360 10950(Object DictLookup \(\), MakeDict \(\);)B
360 10630(static int LengthDict \(\), CopyDict \(\), forDict \(\), ForDict \(\), PutDict \(\);)B
360 10470(static int GetDict \(\), PDict \(\), PBegin \(\), PEnd \(\), PDef \(\), PStore \(\);)B
360 10310(static int PKnown \(\), PLoad \(\), PrCheck \(\), PwCheck \(\), PReadOnly \(\);)B
360 10150(static int EqDict \(\), PWhere \(\), PMaxLength \(\), PCurrentDict \(\); )B
360 9830(int hash_tries = 0, hash_collisions = 0, hash_attempts = 0;)B
360 9670(static int PHashStats \(\), PDictHash \(\);)B
360 9350(InitDictionary \(\))B
360 9190({)B
528 9030(SysDict )B
504(= MakeDict \(SizeSysDict\);)X
528 8710(MakeObject \(Absent, Condition\);)B
528 8390(OpForDict)B
420(= MakeOp \("\(foralldict\)", forDict, 0, 2, 3, 5\);)X
528 8070(Install \("systemdict",)B
672(SysDict\);)X
528 7750(InstallOp \("dict",)B
336(PDict,)X
840(1, 1, 0, 0, Integer\);)X
528 7590(InstallOp \("begin",)B
252(PBegin,)X
756(1, 0, 0, 0, Dictionary\);)X
528 7430(InstallOp \("end",)B
420(PEnd,)X
924(0, 0, 0, 0\);)X
528 7270(InstallOp \("def",)B
420(PDef,)X
924(2, 0, 0, 0, Poly, Poly\);)X
528 7110(InstallOp \("store",)B
252(PStore,)X
756(2, 0, 0, 0, Poly, Poly\);)X
528 6950(InstallOp \("known",)B
252(PKnown,)X
756(2, 1, 0, 0, Dictionary, Poly\);)X
528 6790(InstallOp \("load",)B
336(PLoad,)X
840(1, 1, 0, 0, Poly\);)X
528 6630(InstallOp \("where",)B
252(PWhere,)X
756(1, 2, 0, 0, Poly\);)X
528 6470(InstallOp \("maxlength",)B
588(PMaxLength,)X
420(1, 1, 0, 0, Dictionary\);)X
528 6310(InstallOp \("currentdict",PCurrentDict,)B
672(0, 1, 0, 0\);)X
528 6150(InstallOp \("hashstats", PHashStats,)B
252(0, 0, 0, 0\);)X
528 5990(InstallOp \("dicthash", )B
588(PDictHash,)X
504(1, 0, 0, 0, Dictionary\);)X
528 5670(TypeInstallOp \(Dictionary, "eq", )B
420(EqDict,)X
756(2, 1, 0, 0,)X
1788 5510(Dictionary, Dictionary\);)B
528 5350(TypeInstallOp \(Dictionary, "put", )B
336(PutDict,)X
672(3, 0, 0, 0,)X
1788 5190(Dictionary, Poly, Poly\);)B
528 5030(TypeInstallOp \(Dictionary, "get", )B
336(GetDict,)X
672(2, 1, 0, 0,)X
1788 4870(Dictionary, Poly\);)B
528 4710(TypeInstallOp \(Dictionary, "length", )B
84(LengthDict,)X
420(1, 1, 0, 0,)X
1788 4550(Dictionary\);)B
528 4390(TypeInstallOp \(Dictionary, "copy", )B
252(CopyDict,)X
588(2, 0, 0, 0,)X
9348 14470(Dictionary, Dictionary\);)B
8088 14310(TypeInstallOp \(Dictionary, "forall", )B
84(ForDict,)X
672(2, 0, 0, 4,)X
9348 14150(Dictionary, Array\);)B
8088 13990(TypeInstallOp \(Dictionary, "readonly", )B
588(PReadOnly,)X
504(1, 1, 0, 0,)X
9348 13830(Dictionary\);)B
8088 13670(TypeInstallOp \(Dictionary, "rcheck", )B
84(PrCheck,)X
672(1, 1, 0, 0,)X
9348 13510(Dictionary\);)B
8088 13350(TypeInstallOp \(Dictionary, "wcheck", )B
84(PwCheck,)X
672(1, 1, 0, 0,)X
9348 13190(Dictionary\);)B
8088 12870(TypeInstallOp \(Null, "eq", EqTrue, 2, 1, 0, 0, Null, Null\);)B
7920 12710(})B
7920 12390(Type MakeType \(size\))B
8340 12230(int size;)B
7920 12070({)B
8088 11910(Type dict;)B
8088 11750(int i;)B
8088 11590(struct dict_entry *hash;)B
8088 11270(dict = \(struct dict_struct *\) Malloc \(\(unsigned\) sizeof \(struct dict_struct\)\);)B
8088 11110(dict->dict_size = size;)B
8088 10950(dict->dict_fill = 0;)B
8088 10790(dict->dict_flags = READABLE | WRITEABLE;)B
8088 10630(dict->dict_body = hash = \(struct dict_entry *\) Malloc \(\(unsigned\) sizeof \(struct dict_e)B
8088 10310(for \(i = 0; i < size; i++\))B
8256 10150(hash[i].entry_key = Nil;)B
8088 9990(return dict;)B
7920 9830(})B
7920 9510(void EmptyDict \(dict\))B
8340 9350(Type dict;)B
7920 9190({)B
8088 9030(int i, size = dict->dict_size;)B
8088 8870(struct dict_entry *hash = dict->dict_body;)B
8088 8550(for \(i = 0; i < size; i++\))B
8256 8390(hash[i].entry_key = Nil;)B
7920 8230(})B
7920 7910(#ifdef notdef)B
7920 7750(Type TypeOf \(item\))B
8340 7590(Object item;)B
7920 7430({)B
8088 7270(return item.type;)B
7920 7110(})B
7920 6950(#endif)B
7920 6630(Object MakeDict \(size\))B
8340 6470(int size;)B
7920 6310({)B
8088 6150(Object res;)B
8088 5830(MakeObject \(res, Dictionary\);)B
8088 5670(res.u.Dictionary = MakeType \(size\);)B
8088 5510(return res;)B
7920 5350(})B
7920 5030(Object DictFrom \(dict\))B
8340 4870(Type dict;)B
7920 4710({)B
8088 4550(Object res;)B
EndPage
HfDict begin ep end
%%Page: ? 19
HfDict begin bp end
StartPage
Landscape
()(dictionary.c)[(89/04/06)(11:59:30)](2)Gaudy
0 F
528 14470(MakeObject \(res, Dictionary\);)B
528 14310(res.u.Dictionary = dict;)B
528 14150(return res;)B
360 13990(})B
360 13670(/*ARGSUSED*/)B
360 13510(int EqTrue \(a, b\))B
780 13350(Object a, b;)B
360 13190({)B
528 13030(return Push \(OpStack, True\);)B
360 12870(})B
360 12550(#define Body\(I\) \(\(I\).u.Dictionary\))B
360 12230(#ifndef Body)B
360 12070(static Type Body \(item\))B
780 11910(Object item;)B
360 11750({)B
528 11590(return item.u.Dictionary;)B
360 11430(})B
360 11270(#endif)B
360 10950(static int PHashStats \(\))B
360 10790({)B
528 10630(extern int name_tries, name_hits;)B
528 10310(printf \("Attempts = %d, Successs = %d, Collisions = %d\\n",)B
1200 10150(hash_attempts, hash_tries, hash_collisions\);)B
528 9990(printf \("Name tries = %d, Name hits = %d\\n", name_tries, name_hits\);)B
528 9830(return TRUE;)B
360 9670(})B
360 9350(static int PDictHash \(dict\))B
780 9190(Object dict;)B
360 9030({)B
528 8870(struct dict_entry *hash = Body \(dict\)->dict_body;)B
528 8710(int i, l = Body \(dict\)->dict_size;)B
528 8390(for \(i = 0; i < l; i++\))B
696 8230(if \(TypeOf \(hash[i].entry_key\) == Null\))B
864 8070(putchar \(' '\);)B
696 7910(else)B
864 7750(putchar \('@'\);)B
528 7590(putchar \('\\n'\);)B
528 7430(return TRUE;)B
360 7270(})B
360 6950(static int EqDict \(a, b\))B
780 6790(Object a, b;)B
360 6630({)B
528 6470(return Push \(OpStack, MakeBool \(Body \(a\) == Body \(b\)\)\);)B
360 6310(})B
360 5990(static DictReplace \(hash, key, value, size, h\))B
780 5830(struct dict_entry *hash;)B
780 5670(Object key, value;)B
780 5510(int size, h;)B
360 5350({)B
528 5190(int i;)B
528 4870(for \(i = h;;\) {)B
696 4710(if \(TypeOf \(hash[i].entry_key\) == Null\))B
864 4550(return FALSE;)B
696 4390(if \(DictEqual \(key, hash[i].entry_key\)\) {)B
8424 14470(hash[i].entry_value = value;)B
8424 14310(return TRUE;)B
8256 14150(})B
8256 13990(if \(++i == size\))B
8424 13830(i = 0;)B
8256 13670(if \(i == h\))B
8424 13510(return FALSE;)B
8088 13350(})B
7920 13190(})B
7920 12870(static DictAddition \(dict, hash, key, value, size, h\))B
8340 12710(struct dict_struct *dict;)B
8340 12550(struct dict_entry *hash;)B
8340 12390(Object key, value;)B
8340 12230(int size, h;)B
7920 12070({)B
8088 11910(int i;)B
8088 11590(for \(i = h;;\) {)B
8256 11430(if \(TypeOf \(hash[i].entry_key\) == Null\) {)B
8424 11270(hash[i].entry_value = value;)B
8424 11110(hash[i].entry_key = key;)B
8424 10950(if \(TypeOf \(key\) != Null\))B
8592 10790(++dict->dict_fill;)B
8424 10630(return TRUE;)B
8256 10470(})B
8256 10310(if \(++i == size\))B
8424 10150(i = 0;)B
8256 9990(if \(i == h\))B
8424 9830(return FALSE;)B
8088 9670(})B
7920 9510(})B
7920 9190(TypeInstall \(dict, name, value\))B
8340 9030(Type dict;)B
8340 8870(char *name;)B
8340 8710(Object value;)B
7920 8550({)B
8088 8390(struct dict_entry *hash = dict->dict_body;)B
8088 8230(int h, size = dict->dict_size;)B
8088 8070(Object key;)B
8088 7750(key = NameFrom \(name\);)B
8088 7430(PanicIf \(size == 0, "dictionary full in Install"\);)B
8088 7270(/*)B
336(h = BodyInteger \(key\) % size;)X
252(*/)X
8088 7110(h = \(key.Length + BodyInteger \(key\) + \(int\) TypeOf \(key\)\) % size;)B
8088 6950(if \(TypeOf \(key\) == String\))B
8256 6790(key = Cvn \(key\);)B
8088 6630(if \(DictReplace \(hash, key, value, size, h\)\))B
8256 6470(return;)B
8088 6310(if \(DictAddition \(dict, hash, key, value, size, h\)\))B
8256 6150(return;)B
8088 5990(Panic \("dictionary full in Install"\);)B
7920 5830(})B
7920 5510(DictStore \(dict, key, value\))B
8340 5350(Object dict, key, value;)B
7920 5190({)B
8088 5030(struct dict_entry *hash = Body \(dict\)->dict_body;)B
8088 4870(int h, size = Body \(dict\)->dict_size;)B
8088 4550(PanicIf \(size == 0, "dictionary full in DictStore"\);)B
8088 4390(/*)B
336(h = BodyInteger \(key\) % size;)X
252(*/)X
EndPage
HfDict begin hp end
StartPage
Landscape
()(dictionary.c)[(89/04/06)(11:59:30)](3)Gaudy
0 F
528 14470(h = \(key.Length + BodyInteger \(key\) + \(int\) TypeOf \(key\)\) % size;)B
528 14310(if \(TypeOf \(key\) == String\))B
696 14150(key = Cvn \(key\);)B
528 13990(if \(DictReplace \(hash, key, value, size, h\)\))B
696 13830(return;)B
528 13670(if \(DictAddition \(Body \(dict\), hash, key, value, size, h\)\))B
696 13510(return;)B
528 13350(Panic \("dictionary full in DictStore"\);)B
360 13190(})B
360 12870(Install \(key, value\))B
780 12710(char *key;)B
780 12550(Object value;)B
360 12390({)B
528 12230(DictStore \(SysDict, NameFrom \(key\), value\);)B
360 12070(})B
360 11750(/*)B
444 11590(* BZS - add some register decls, make global for macrification \(remove static\))B
444 11430(*/)B
360 11270(Object DictFind \(hash, key, size\))B
780 11110(struct dict_entry *hash;)B
780 10950(Object key;)B
780 10790(int size;)B
360 10630({)B
528 10470(register int i, h;)B
528 10150(++hash_attempts;)B
528 9830(if \(size == 0\) return Absent;)B
528 9510(if \(TypeOf \(key\) == String\) key = Cvn \(key\);)B
528 9190(h = \(key.Length + BodyInteger \(key\) + \(int\) TypeOf \(key\)\) % size;)B
528 8870(for \(i = h;;\) {)B
696 8710(if \(TypeOf \(hash[i].entry_key\) == Null\)  return Absent;)B
696 8550(if \(DictEqual \(key, hash[i].entry_key\)\) {)B
864 8390(++hash_tries;)B
864 8230(return hash[i].entry_value;)B
696 8070(})B
696 7910(if \(++i == size\) i = 0;)B
696 7750(else if \(i == h\) return Absent;)B
696 7590(++hash_collisions;)B
528 7430(})B
360 7270(})B
360 6950(/* BZS - macro-ified */)B
360 6790(#ifndef DictLoad)B
360 6630(Object DictLoad \(dict, key\))B
780 6470(Object dict, key;)B
360 6310({)B
528 6150(return DictFind \(Body \(dict\)->dict_body, key, Body \(dict\)->dict_size\);)B
360 5990(})B
360 5830(#endif)B
360 5510(Object Lookup \(dict, key\))B
780 5350(Type dict;)B
780 5190(Object key;)B
360 5030({)B
528 4870(return DictFind \(dict->dict_body, key, dict->dict_size\);)B
360 4710(})B
360 4390(Object Load \(key\))B
8340 14470(Object key;)B
7920 14310({)B
8088 14150(Type dict;)B
8088 13990(struct dict_entry *hash;)B
8088 13830(int level,i,h,size,hashval;)B
8088 13510(/* Initialize information based solely on the key */)B
8088 13350(if \(TypeOf \(key\) == String\) key = Cvn \(key\);)B
8088 13190(hashval = key.Length + BodyInteger\(key\) + \(int\) TypeOf\(key\);)B
8088 12870(/* Search through the levels of the dict stack from the top down */)B
8088 12710(for \(level = Height \(DictStack\) - 1; level >= 0; level--\) {)B
8256 12550(dict = Body\(DictStack->stack_body[level]\);)B
8256 12390(if \(\(size=dict->dict_size\) != 0\) {)B
8424 12230(hash = dict->dict_body;)B
8424 12070(++hash_attempts;)B
8424 11910(i = h = hashval % size;)B
8424 11590(for\(;;\) {)B
8592 11430(if \(TypeOf \(hash[i].entry_key\) == Null\) break;)B
8592 11270(if \(DictEqual \(key, hash[i].entry_key\)\) {)B
8760 11110(++hash_tries;)B
8760 10950(return hash[i].entry_value;)B
8592 10790(})B
8592 10630(if \(++i == size\) i = 0;)B
8592 10470(if \(i == h\) break;)B
8592 10310(++hash_collisions;)B
8424 10150(})B
8256 9990(})B
8088 9830(})B
8088 9670(return Absent;)B
7920 9510(})B
7920 9190(static int ForDict \(dict, proc\))B
8340 9030(Object dict, proc;)B
7920 8870({)B
8088 8710(VOID Push \(ExecStack, dict\);)B
8088 8550(VOID Push \(ExecStack, MakeInteger \(0\)\);)B
8088 8390(VOID Push \(ExecStack, proc\);)B
8088 8230(VOID Push \(ExecStack, OpForDict\);)B
8088 7910(return TRUE;)B
7920 7750(})B
7920 7430(static int forDict \(\) )B
7920 7270({)B
8088 7110(Object dict, index, proc, t; /* VAX Compiler Broken. SUN optimiser broken */)B
8088 6950(int i;)B
8088 6630(proc =)B
672(Pop \(ExecStack\);)X
8088 6470(index =)B
588(Pop \(ExecStack\);)X
8088 6310(dict =)B
672(Pop \(ExecStack\);)X
8088 5990(for \(i = BodyInteger \(index\); ; i++\) {)B
8256 5830(if \(i >= maxDict \(dict\)\))B
8424 5670(return TRUE;)B
8256 5510(t = Body \(dict\)->dict_body[i].entry_key;)B
8256 5350(if \(TypeOf \(t\) != Null\))B
8424 5190(break;)B
8088 5030(})B
8088 4870(VOID Push \(ExecStack, dict\);)B
8088 4710(VOID Push \(ExecStack, MakeInteger \(i + 1\)\);)B
8088 4550(VOID Push \(ExecStack, proc\);)B
8088 4390(VOID Push \(ExecStack, OpForDict\);)B
EndPage
HfDict begin ep end
%%Page: ? 20
HfDict begin bp end
StartPage
Landscape
()(dictionary.c)[(89/04/06)(11:59:30)](4)Gaudy
0 F
528 14470(VOID Push \(ExecStack, proc\);)B
528 14150(VOID Push \(OpStack, t = Body \(dict\)->dict_body[i].entry_key\);)B
528 13990(VOID Push \(OpStack, t = Body \(dict\)->dict_body[i].entry_value\);)B
528 13830(return TRUE;)B
360 13670(})B
360 13350(static int GetDict \(object, key\))B
780 13190(Object object, key;)B
360 13030({)B
528 12870(Object res;)B
528 12550(res = DictLoad \(object, key\);)B
528 12390(if \(TypeOf \(res\) != Condition\))B
696 12230(return Push \(OpStack, res\);)B
528 12070(else)B
696 11910(return Error \(PUndefined\);)B
360 11750(})B
360 11430(static int PutDict \(object, key, value\))B
780 11270(Object object, key, value;)B
360 11110({)B
528 10950(if \(lengthDict \(object\) == maxDict \(object\)\) {)B
696 10790(Object t;)B
252(/* SUN optimiser broken */)X
696 10470(t = DictLoad \(object, key\);)B
696 10310(if \(TypeOf \(t\) == Condition\))B
864 10150(return Error \(PDictFull\);)B
528 9990(})B
528 9830(DictStore \(object, key, value\);)B
528 9670(return TRUE;)B
360 9510(})B
360 9190(static int CopyDict \(object1, object2\))B
780 9030(Object object1, object2;)B
360 8870({)B
528 8710(if \(lengthDict \(object1\) <= maxDict \(object2\) && lengthDict \(object2\) == 0\) {)B
696 8550(copyDict \(object1, object2\);)B
696 8390(VOID Push \(OpStack, object2\);)B
696 8230(return TRUE;)B
528 8070(})B
528 7910(return Error \(PRangeCheck\);)B
360 7750(})B
360 7430(copyDict \(from, to\))B
780 7270(Object from, to;)B
360 7110({)B
528 6950(int i, l = maxDict \(from\);)B
528 6790(struct dict_entry *body = Body \(from\)->dict_body;)B
528 6470(for \(i = 0; i < l; i++\))B
696 6310(if \(TypeOf \(body[i].entry_key\) != Null\))B
864 6150(DictStore \(to, body[i].entry_key, body[i].entry_value\);)B
360 5990(})B
360 5670(static int PDict \(size\))B
780 5510(Object size;)B
360 5350({)B
528 5190(if \(BodyInteger \(size\) < 0\))B
696 5030(return Error \(PRangeCheck\);)B
528 4870(else)B
696 4710(return Push \(OpStack, MakeDict \(BodyInteger \(size\)\)\);)B
360 4550(})B
7920 14470(static int PBegin \(dict\))B
8340 14310(Object dict;)B
7920 14150({)B
8088 13990(if \(Height \(DictStack\) == MaxStack \(DictStack\)\))B
8256 13830(return Error \(PDictOverflow\);)B
8088 13670(else {)B
8256 13510(VOID Push \(DictStack, dict\);)B
8256 13350(return TRUE;)B
8088 13190(})B
7920 13030(})B
7920 12710(static int PEnd \(\))B
7920 12550({)B
8088 12390(if \(Height \(DictStack\) == 2\))B
8256 12230(return Error \(PDictUnderflow\);)B
8088 12070(else)B
8256 11910(VOID Pop \(DictStack\);)B
8088 11750(return TRUE;)B
7920 11590(})B
7920 11270(static int PDef \(key, value\))B
8340 11110(Object key, value;)B
7920 10950({)B
8088 10790(Object dict,t ;)B
588(/* SUN optimiser broken */)X
8088 10470(dict = Top \(DictStack\);)B
8088 10310(if \(!wCheck \(dict\)\))B
8256 10150(return Error \(PInvAccess\);)B
8088 9990(else if \(maxDict \(dict\) == lengthDict \(dict\) && \(t = DictLoad \(dict, key\), TypeOf \(t\)\) )B
8256 9830(return Error \(PDictFull\);)B
8088 9670(else {)B
8256 9510(DictStore \(dict, key, value\);)B
8256 9350(return TRUE;)B
8088 9190(})B
7920 9030(})B
7920 8710(static int PStore \(key, value\))B
8340 8550(Object key, value;)B
7920 8390({)B
8088 8230(Object dict, t;)B
588(/* SUN optimiser broken */)X
8088 7910(dict = Where \(key\);)B
252(/* SUN optimiser broken */)X
8088 7750(if \(TypeOf \(dict\) == Condition\))B
8256 7590(dict = Top \(DictStack\);)B
8088 7430(if \(TypeOf \(key\) == Null\))B
8256 7270(return Error \(PTypeCheck\);)B
8088 7110(else if \(!wCheck \(dict\)\))B
8256 6950(return Error \(PInvAccess\);)B
8088 6790(else if \(maxDict \(dict\) == lengthDict \(dict\) && \(t = DictLoad \(dict, key\), TypeOf \(t\)\) )B
8256 6630(return Error \(PDictFull\);)B
8088 6470(else {)B
8256 6310(DictStore \(dict, key, value\);)B
8256 6150(return TRUE;)B
8088 5990(})B
7920 5830(})B
7920 5510(static int PKnown \(dict, key\))B
8340 5350(Object dict, key;)B
7920 5190({)B
8088 5030(Object t;)B
8088 4710(t = DictLoad \(dict, key\);)B
8088 4550(return Push \(OpStack, MakeBool \(TypeOf \(t\) != Condition\)\);)B
7920 4390(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(dictionary.c)[(89/04/06)(11:59:30)](5)Gaudy
0 F
360 14310(static int PLoad \(key\))B
780 14150(Object key;)B
360 13990({)B
528 13830(Object res;)B
528 13510(res = Load \(key\);)B
528 13350(if \(TypeOf \(res\) == Condition\))B
696 13190(return Error \(PUndefined\);)B
528 13030(else if \(TypeOf \(key\) == Null\))B
696 12870(return Error \(PTypeCheck\);)B
528 12710(else)B
696 12550(return Push \(OpStack, res\);)B
360 12390(})B
360 12070(static int PWhere \(key\))B
780 11910(Object key;)B
672(/* key --- dict true */)X
780 11750(/* key --- false */)B
360 11590({)B
528 11430(Object where;)B
528 11110(if \(TypeOf \(key\) == Null\))B
696 10950(return Error \(PTypeCheck\);)B
528 10790(where = Where \(key\);)B
528 10630(if \(TypeOf \(where\) == Condition\))B
696 10470(return Push \(OpStack, False\);)B
528 10310(else if \(!rCheck \(where\)\))B
696 10150(return Error \(PInvAccess\);)B
528 9990(else)B
696 9830(return Push \(OpStack, where\), Push \(OpStack, True\);)B
360 9670(})B
360 9350(static int PMaxLength \(dict\))B
780 9190(Object dict;)B
360 9030({)B
528 8870(return Push \(OpStack, MakeInteger \(maxDict \(dict\)\)\);)B
360 8710(})B
360 8390(static int LengthDict \(dict\))B
780 8230(Object dict;)B
360 8070({)B
528 7910(return Push \(OpStack, MakeInteger \(lengthDict \(dict\)\)\);)B
360 7750(})B
360 7430(static int PCurrentDict \(\))B
360 7270({)B
528 7110(return Push \(OpStack, Top \(DictStack\)\);)B
360 6950(})B
360 6630(static int PReadOnly \(item\))B
780 6470(Object item;)B
360 6310({)B
528 6150(return Push \(OpStack, ReadOnly \(item\)\);)B
360 5990(})B
360 5670(static int PrCheck \(v\))B
780 5510(Object v;)B
360 5350({)B
528 5190(return Push \(OpStack, MakeBool \(rCheck \(v\)\)\);)B
360 5030(})B
360 4710(static int PwCheck \(v\))B
780 4550(Object v;)B
360 4390({)B
8088 14470(return Push \(OpStack, MakeBool \(wCheck \(v\)\)\);)B
7920 14310(})B
EndPage
HfDict begin ep end
%%Page: ? 21
HfDict begin bp end
StartPage
Landscape
()(file.c)[(89/04/06)(12:00:46)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(#ifndef AUX)B
360 11910(#ifndef MACINTOSH)B
360 11750(#include <sgtty.h>)B
360 11590(#endif)B
360 11430(#endif)B
360 11270(#ifdef AUX)B
360 11110(#include <sys/termio.h>)B
360 10950(#include <sys/ttold.h>)B
360 10790(#endif)B
360 10470(#define MAXFILENAME)B
420(1000)X
360 10150(/*)B
444 9990(* This file implements the input/output calls in PostScript.)B
444 9830(*)B
444 9670(* A PostScript file corresponds reasonably closely to a Unix file, so)B
444 9510(* this is not too hard.)B
444 9350(*)B
444 9190(* The file operator itself can generate three major file types:)B
444 9030(*)B
444 8870(*)B
504(Regular filing system files)X
444 8710(*)B
504(Standard I/O channels \(called %stdin, %stdout and %stderr\))X
444 8550(*)B
504(Peculiar temporary files called %lineedit and %statementedit)X
444 8390(*)B
444 8230(* %lineedit and %statementedit are files generated by the file)B
444 8070(* operator, rather than merely opened for reading or writing.)B
444 7910(* )B
444 7750(* %lineedit generates a temporary file containing the text that the)B
444 7590(* user types in on the %stdin stream for one line only.)B
444 7430(* The %stdin is required to be edited while this is going on, which)B
444 7270(* means that it must be in cooked mode \(-cbreak\). %stdin is normally)B
444 7110(* in cbreak mode. )B
444 6950(*)B
444 6790(* %statementedit is similar to %lineedit \(in that it generates a)B
444 6630(* temporary file\), but the input process continues until PostScript)B
444 6470(* sees a complete expression, with "\(" matching "\)" and "{" matching)B
444 6310(* "}". "[" is not required to match "]", as these are not actually)B
444 6150(* parsed differently from operators \(except for their delimiting)B
444 5990(* properties\). )B
444 5830(*)B
444 5670(* There are essentially two ways of implementing these temporary files:)B
444 5510(*)B
444 5350(*)B
504(o)X
588(We could use real files, and copy user input into)X
444 5190(*)B
1176(them, allowing the PostScript interpreter to just read)X
444 5030(*)B
1176(from them. )X
444 4870(*)B
504(o)X
588(We could provide some kind of cache using a buffer in)X
444 4710(*)B
1176(main memory. )X
444 4550(*)B
444 4390(* The second alternative is likely to reduce certain overheads and,)B
8004 14470(* since the code for parsing from strings is needed anyway \(token is)B
8004 14310(* defined to parse from strings\), there is little extra effort in)B
8004 14150(* doing things this way. )B
8004 13990(*)B
8004 13830(* For this reason, files under this implementation are typed. We have:)B
8004 13670(*)B
8004 13510(*)B
504(StreamFiles)X
420(which are conventional stdio FILE *s.)X
8004 13350(*)B
504(StringFiles)X
420(which are pointers in strings.)X
8004 13190(*)B
8004 13030(* StringFiles are used internally by token to parse from strings, to)B
8004 12870(* avoid duplicating the entire parser. These file types are defined)B
8004 12710(* with an enumerated type. )B
8004 12550(*)B
8004 12390(* It is defined that closing the %stdin file have no effect other)B
8004 12230(* than resetting an end-of-file flag. It is not defined whether the)B
8004 12070(* output files are required to be similarly permanent. We assume they)B
8004 11910(* are, and introduce a feature of files which is that they may be)B
8004 11750(* PERMANENT. This is a flag. It is also not clear if Readable and)B
8004 11590(* Writeable access to files is an Access Restriction, as such. We)B
8004 11430(* assume so.)B
8004 11270(*)B
8004 11110(*/)B
7920 10790(extern int errno;)B
7920 10630(extern void HardUpdate \(\);)B
7920 10310(static Object StdIn, Terminal, StdOut, StdErr, LineEdit;)B
7920 10150(Object StatementEdit, Fstdin, Fterminal, Fstdout, Fstderr;)B
7920 9830(FILE *popen \(\);)B
7920 9510(static int Token \(\), Eq \(\);)B
7920 9190(static int PFile \(\), PCloseFile \(\), PRead \(\), PReadHexString \(\), PReadLine \(\);)B
7920 9030(static int PReadString \(\), PBytesAvailable \(\), PWrite \(\), PWriteHexString \(\);)B
7920 8870(static int PWriteString \(\), PFlush \(\);)B
7920 8710(static int PFlushFile \(\), PStatus \(\), PCurFile \(\), PPrint \(\), PEcho \(\);)B
7920 8390(static Echo \(\);)B
7920 8230(static int PseudoFile \(\), EditLine \(\), EditStatement \(\);)B
7920 7910(int ExecFile \(\);)B
7920 7590(InitFile \(\))B
7920 7430({)B
8088 7270(TypeInstallOp \(File, "token",)B
84(Token, )X
84(1, 2, 0, 0, File\);)X
8088 7110(TypeInstallOp \(File, "exec", )B
84(ExecFile, )X
504(1, 0, 0, 0, File\);)X
8088 6950(TypeInstallOp \(File, "eq", )B
252(Eq, )X
336(2, 1, 0, 0, File, File\);)X
8088 6630(Fstdin  = ReadOnly \(FileFrom \(stdin\)\);   Fstdin.flags |= PERMANENT;)B
8088 6470(Fterminal  = FileFrom \(fopen \("/dev/tty", "r"\)\);   Fterminal.flags |= PERMANENT;)B
8088 6310(Fstdout = WriteOnly \(FileFrom \(stdout\)\); Fstdout.flags |= PERMANENT;)B
8088 6150(Fstderr = WriteOnly \(FileFrom \(stderr\)\); Fstderr.flags |= PERMANENT;)B
8088 5830(StdIn )B
1344(= StringFrom \("%stdin"\);)X
8088 5670(StdOut )B
1260(= StringFrom \("%stdout"\);)X
8088 5510(StdErr )B
1260(= StringFrom \("%stderr"\);)X
8088 5350(Terminal)B
1176(= StringFrom \("%terminal"\);)X
8088 5190(StatementEdit )B
672(= StringFrom \("%statementedit"\);)X
8088 5030(LineEdit)B
1176(= StringFrom \("%lineedit"\);)X
8088 4710(InstallOp \("file",)B
1008(PFile,)X
840(2, 1, 0, 0, String, String\);)X
8088 4550(InstallOp \("closefile",)B
588(PCloseFile,)X
420(1, 0, 0, 0, File\);)X
8088 4390(InstallOp \("read",)B
1008(PRead,)X
840(1, 1, 0, 0, File\);)X
EndPage
HfDict begin hp end
StartPage
Landscape
()(file.c)[(89/04/06)(12:00:46)](2)Gaudy
0 F
528 14470(InstallOp \("readhexstring",)B
252(PReadHexString,)X
84(2, 1, 0, 0, File, String\);)X
528 14310(InstallOp \("readline",)B
672(PReadLine,)X
504(2, 1, 0, 0, File, String\);)X
528 14150(InstallOp \("readstring",)B
504(PReadString,)X
336(2, 1, 0, 0, File, String\);)X
528 13990(InstallOp \("bytesavailable",)B
168(PBytesAvailable,1, 1, 0, 0, File\);)X
528 13830(InstallOp \("write",)B
924(PWrite,)X
756(2, 0, 0, 0, File, Integer\);)X
528 13670(InstallOp \("writehexstring",)B
168(PWriteHexString,2, 0, 0, 0, File, String\);)X
528 13510(InstallOp \("writestring",)B
420(PWriteString,)X
252(2, 0, 0, 0, File, String\);)X
528 13350(InstallOp \("flush",)B
924(PFlush,)X
756(0, 0, 0, 0\);)X
528 13190(InstallOp \("flushfile",)B
588(PFlushFile,)X
420(1, 0, 0, 0, File\);)X
528 13030(InstallOp \("status",)B
840(PStatus,)X
672(1, 1, 0, 0, File\);)X
528 12870(InstallOp \("currentfile",)B
420(PCurFile,)X
588(0, 1, 0, 0\);)X
528 12710(InstallOp \("print",)B
924(PPrint,)X
756(1, 0, 0, 0, String\);)X
528 12550(InstallOp \("echo",)B
1008(PEcho,)X
840(1, 0, 0, 0, Bool\);)X
528 12230(Cbreak \(TRUE\);)B
360 12070(})B
360 11750(static int Token \(f\))B
780 11590(Object f;)B
360 11430({)B
528 11270(Object res;)B
528 11110(res = Parse \(f\);)B
528 10950(if \(TypeOf \(res\) == Condition\))B
696 10790(return Error \(PSyntaxError\);)B
528 10630(else if \(TypeOf \(res\) == Bool\))B
696 10470(VOID Push \(OpStack, False\);)B
528 10310(else if \(TypeOf \(res\) != Null\) {)B
696 10150(VOID Push \(OpStack, res\);)B
696 9990(VOID Push \(OpStack, True\);)B
528 9830(})B
528 9670(else)B
696 9510(return Error \(PUnResult\);)B
528 9350(return TRUE;)B
360 9190(})B
360 8870(#define Body\(I\) \(\(I\).u.File\))B
360 8550(#ifndef Body)B
360 8390(static struct file_struct *Body \(item\))B
780 8230(Object item;)B
360 8070({)B
528 7910(return item.u.File;)B
360 7750(})B
360 7590(#endif)B
360 7270(int getchbuf;)B
360 6950(#ifdef notdef)B
360 6790(struct file_struct *BodyFile \(item\))B
780 6630(Object item;)B
360 6470({)B
528 6310(return item.u.File;)B
360 6150(})B
360 5830(static int Getc \(fp\))B
780 5670(FILE *fp;)B
360 5510({)B
528 5350(int c;)B
528 5030(for \(;;\) {)B
696 4870(errno = 0;)B
696 4710(if \(\(c = getc \(fp\)\) != EOF\))B
864 4550(return c;)B
696 4390(/* )B
756(if \(errno == 0 || Interrupted \(\)\)*/)X
8256 14470(return EOF;)B
8088 14310(})B
7920 14150(})B
7920 13990(#endif)B
7920 13670(#define Getc\(a\) getc\(a\))B
7920 13350(/* DCJ: This function not needed with #define right below.)B
7920 13190(static int Getchar \(\))B
8004 13030({)B
8592 12870(return Getc \(stdin\);)B
8004 12710(})B
7920 12550(*/)B
7920 12230(#define Getchar getchar)B
7920 11910(/* DCJ: This function not needed with #define right below.)B
7920 11750(static int Status \(file\) Object file;)B
8004 11590({)B
8592 11430(return Body \(file\)->available;)B
8004 11270(})B
7920 11110(*/)B
7920 10790(#define Status\(f\) \(Body\(f\)->available\))B
7920 10470(static int Eq \(a, b\))B
8340 10310(Object a, b;)B
7920 10150({)B
8088 9990(return Push \(OpStack, MakeBool \(Body \(a\) == Body \(b\)\)\);)B
7920 9830(})B
7920 9510(/*)B
8004 9350(*)B
504(FileFrom generates a file object from an existing file pointer)X
8004 9190(*/)B
7920 9030(Object FileFrom \(fp\))B
8340 8870(FILE *fp;)B
7920 8710({)B
8088 8550(Object res;)B
8088 8390(struct file_struct *f;)B
8088 8070(MakeObject \(res, File\);)B
8088 7910(f = res.u.File = \(struct file_struct *\) Malloc \(sizeof \(struct file_struct\)\);)B
8088 7750(f->file_type = StreamFile;)B
8088 7590(f->f.f_ptr = fp;)B
8088 7430(f->available = 1;)B
8088 7110(return res;)B
7920 6950(})B
7920 6630(/*)B
8004 6470(*)B
504(FileString is used to generate a file-like object which actually)X
8004 6310(*)B
504(reads from a string. This is used by "file" and "token" when parsing)X
8004 6150(*)B
504(strings.)X
8004 5990(*/)B
7920 5830(Object FileString \(o\))B
8340 5670(Object o;)B
7920 5510({)B
8088 5350(Object res;)B
8088 5190(struct file_struct *f;)B
8088 4870(MakeObject \(res, File\);)B
8088 4710(f = res.u.File = \(struct file_struct *\) Malloc \(sizeof \(struct file_struct\)\);)B
8088 4550(f->file_type)B
168(= StringFile;)X
8088 4390(f->f.c_ptr)B
336(= BodyString \(o\);)X
EndPage
HfDict begin ep end
%%Page: ? 22
HfDict begin bp end
StartPage
Landscape
()(file.c)[(89/04/06)(12:00:46)](3)Gaudy
0 F
528 14470(f->available)B
168(= lengthString \(o\);)X
528 14150(return res;)B
360 13990(})B
360 13670(int GeneralGetch \(file\))B
780 13510(Object file;)B
360 13350({)B
528 13190(int c;)B
528 12870(if \(!Status \(file\)\))B
696 12710(return EOF;)B
528 12550(switch \(Body \(file\)->file_type\) {)B
528 12390(default:)B
696 12230(PanicIf \(TRUE, "unknown file type in Getch\\n"\);)B
696 12070(return 0; /* shuts lint up */)B
528 11750(case StreamFile:)B
696 11590(c = Getc \(Body \(file\)->f.f_ptr\);)B
696 11430(if \(c == EOF\) {)B
864 11270(Body \(file\)->available = 0;)B
864 11110(Close \(file\);)B
696 10950(})B
696 10790(return c;)B
528 10470(case StringFile:)B
696 10310(if \(Body \(file\)->available == 0\))B
864 10150(return EOF;)B
696 9990(--Body \(file\)->available;)B
696 9830(c = *Body \(file\)->f.c_ptr++;)B
696 9670(return c;)B
528 9510(})B
360 9350(})B
360 9030(Ungetch \(o, c\))B
780 8870(Object o;)B
780 8710(unsigned char c;)B
360 8550({)B
528 8390(struct file_struct *f = Body \(o\);)B
528 8070(++f->available;)B
528 7910(switch \(f->file_type\) {)B
528 7750(case StringFile: f->f.c_ptr--; break;)B
528 7590(case StreamFile: VOID ungetc \(c, f->f.f_ptr\); break;)B
528 7270(default:)B
696 7110(Panic \("Don't know how to Ungetch to this file\\n"\);)B
528 6950(})B
360 6790(})B
360 6470(int ExecFile \(item\))B
780 6310(Object item;)B
360 6150({)B
528 5990(Object res;)B
528 5830(res = Parse \(item\);)B
528 5670(if \(TypeOf \(res\) == Bool\) {)B
696 5510(if \(BodyBool \(res\)\))B
864 5350(return Error \(PSyntaxError\);)B
528 5190(})B
528 5030(else if \(TypeOf \(res\) == Condition\))B
696 4870(return Error \(PSyntaxError\);)B
528 4710(else if \(TypeOf \(res\) == Null\))B
696 4550(return Error \(PUnResult\);)B
528 4390(else if \(TypeOf \(res\) == Name && xCheck \(res\)\) {)B
8256 14470(/*Object binding;)B
8340 14310(* )B
8340 14150(* binding = Load \(res\);)B
8340 13990(* )B
8340 13830(* if \(TypeOf \(binding\) == Operator\))B
8340 13670(* res = binding;*/)B
8256 13510(VOID Push \(ExecStack, item\);)B
8256 13350(VOID Push \(ExecStack, res\);)B
8088 13190(})B
8088 13030(else {)B
8256 12870(VOID Push \(ExecStack, item\);)B
8256 12710(VOID Push \(OpStack, res\);)B
8088 12550(})B
8088 12390(return TRUE;)B
7920 12230(})B
7920 11910(Cleanup \(\))B
7920 11750({)B
8088 11590(Echo \(TRUE\);)B
8088 11430(Cbreak \(FALSE\);)B
7920 11270(})B
7920 10950(/*static cbreak = FALSE;*/)B
7920 10790(static  echoing = TRUE;)B
7920 10470(/*ARGSUSED*/)B
7920 10310(Cbreak \(cond\))B
8340 10150(int cond;)B
7920 9990({)B
7920 9830(/*)B
504(struct sgttyb s;)X
8592 9510(if \(cond == cbreak\))B
9264 9350(return;)B
8592 9190(ioctl \(0, TIOCGETP, &s\);)B
8592 9030(cbreak = cond;)B
8592 8870(if \(cbreak\))B
9264 8710(s.sg_flags |= CBREAK;)B
8592 8550(else)B
9264 8390(s.sg_flags &= ~CBREAK;)B
8592 8230(ioctl \(0, TIOCSETP, &s\);)B
7920 8070(*/ })B
7920 7750(static Echo \(cond\))B
8340 7590(int cond;)B
7920 7430({)B
7920 7270(#ifndef MACINTOSH)B
8088 7110(struct sgttyb s;)B
8088 6790(if \(cond == echoing\))B
8256 6630(return;)B
8088 6470(ioctl \(0, TIOCGETP, &s\);)B
8088 6310(echoing = cond;)B
8088 6150(if \(echoing\))B
8256 5990(s.sg_flags |= ECHO;)B
8088 5830(else)B
8256 5670(s.sg_flags &= ~ECHO;)B
8088 5510(ioctl \(0, TIOCSETP, &s\);)B
7920 5350(#endif)B
7920 5190(})B
7920 4870(static FILE *open_pipes [32];/* ICK! */)B
7920 4710(static int n_open_pipes = 0;)B
7920 4390(FILE *Fopen \(name, mode\))B
EndPage
HfDict begin hp end
StartPage
Landscape
()(file.c)[(89/04/06)(12:00:46)](4)Gaudy
0 F
780 14470(unsigned char *name, *mode;)B
360 14310({)B
360 14150(#ifndef MACINTOSH)B
528 13990(if \(name[0] == '|'\) {)B
696 13830(FILE *fp = popen \(name + 1, mode\);)B
696 13670(int i;)B
696 13350(for \(i = 0; i < n_open_pipes && open_pipes [i] != NULL; i++\))B
864 13190(;)B
696 13030(open_pipes [i] = fp;)B
696 12870(if \(i == n_open_pipes\))B
864 12710(++n_open_pipes;)B
696 12550(return fp;)B
528 12390(})B
528 12230(else)B
360 12070(#endif)B
696 11910(return fopen \(name, mode\);)B
360 11750(})B
360 11430(void Fclose \(fp\))B
780 11270(FILE *fp;)B
360 11110({)B
528 10950(int i;)B
360 10630(#ifndef MACINTOSH)B
528 10470(for \(i = 0; i < n_open_pipes; i++\))B
696 10310(if \(open_pipes [i] == fp\) {)B
864 10150(pclose \(fp\);)B
864 9990(open_pipes [i] = NULL;)B
696 9830(})B
360 9670(#endif)B
528 9510(fclose \(fp\);)B
360 9350(})B
360 9030(static int PFile \(string1, string2\))B
780 8870(Object string1, string2;)B
360 8710({)B
528 8550(int mode;)B
528 8230(if \(lengthString \(string1\) == 0)B
864 8070(|| lengthString \(string2\) != 1)B
864 7910(|| \(mode = getString \(string2, 0\)\) != 'r' && mode != 'w'\))B
696 7750(return Error \(PInvFileAccess\);)B
528 7590(else if \(getString \(string1, 0\) == '%'\))B
696 7430(return PseudoFile \(string1, mode\);)B
528 7270(else if \(lengthString \(string1\) > MAXFILENAME\))B
696 7110(return Error \(PUnFilename\);)B
528 6950(else {)B
696 6790(unsigned char name[MAXFILENAME+1], modes[2];)B
696 6630(FILE *fp;)B
696 6310(modes [0] = mode; modes [1] = '\\0';)B
696 6150(VOID Bcopy \(name, BodyString \(string1\), lengthString \(string1\)\);)B
696 5990(name [lengthString \(string1\)] = '\\0';)B
696 5830(if \(fp = Fopen \(name, modes\)\))B
864 5670(if \(mode == 'r'\))B
1032 5510(return Push \(OpStack, ReadOnly \(FileFrom \(fp\)\)\);)B
864 5350(else)B
1032 5190(return Push \(OpStack, WriteOnly \(FileFrom \(fp\)\)\);)B
696 4870(return Error \(PUnFilename\);)B
528 4710(})B
360 4550(})B
7920 14470(static int PseudoFile \(string1, mode\))B
8340 14310(Object string1;)B
8340 14150(int mode;)B
7920 13990({)B
8088 13830(if \(EqString \(string1, StdIn\)\))B
8256 13670(return mode == 'r' ? Push \(OpStack, Fstdin\):Error \(PInvFileAccess\);)B
8088 13510(else if \(EqString \(string1, Terminal\)\))B
8256 13350(return Push \(OpStack, Fterminal\);)B
8088 13190(else if \(EqString \(string1, StdOut\)\))B
8256 13030(return mode == 'w' ? Push \(OpStack, Fstdout\):Error \(PInvFileAccess\);)B
8088 12870(else if \(EqString \(string1, StdErr\)\))B
8256 12710(return mode == 'w' ? Push \(OpStack, Fstderr\):Error \(PInvFileAccess\);)B
8088 12550(else if \(EqString \(string1, StatementEdit\)\))B
8256 12390(return mode == 'r' ? EditStatement \(\) : Error \(PInvFileAccess\);)B
8088 12230(else if \(EqString \(string1, LineEdit\)\))B
8256 12070(return mode == 'r' ? EditLine \(\) : Error \(PInvFileAccess\);)B
8088 11910(else)B
8256 11750(return Error \(PUnFilename\);)B
7920 11590(})B
7920 11270(static int EditLine \(\))B
7920 11110({)B
8088 10950(unsigned char buf [BUFSIZE],*t;)B
8088 10790(int c, length = 0;)B
8088 10470(Cbreak \(FALSE\);)B
8088 10310(do {)B
8256 10150(if \(length >= BUFSIZE\) {)B
8424 9990(Cbreak \(TRUE\);)B
8424 9830(return Error \(PLimitCheck\);)B
8256 9670(})B
8256 9510(if \(\(c = Getchar \(\)\) == EOF\))B
8424 9350(break;)B
8256 9190(buf [length++] = c;)B
8256 9030(if \(Interrupted \(\)\) {)B
8424 8870(Cbreak \(TRUE\);)B
8424 8710(return FALSE;)B
8256 8550(})B
8088 8390(} while \(buf [length - 1] != '\\n'\);)B
8088 8230(Cbreak \(TRUE\);)B
8088 8070(Bcopy\(t = \(unsigned char *\) Malloc \(\(unsigned\) length\),buf,length\);)B
8088 7910(return Push \(OpStack,ReadOnly \(FileString \(MakeString \(t,length\)\)\)\);)B
7920 7750(})B
7920 7430(static int EditStatement \(\))B
7920 7270({)B
8088 7110(unsigned char buf[BUFSIZE],*t;)B
8088 6950(int c, length = 0, slevel = 0, blevel = 0, escaped = FALSE;)B
8088 6630(Cbreak \(FALSE\);)B
8088 6470(do {)B
8256 6310(if \(length >= BUFSIZE\) {)B
8424 6150(Cbreak \(TRUE\);)B
8424 5990(return Error \(PLimitCheck\);)B
8256 5830(})B
8256 5670(if \(\(c = Getchar \(\)\) == EOF\))B
8424 5510(break;)B
8256 5350(buf [length++] = c;)B
8256 5190(if \(Interrupted \(\)\) {)B
8424 5030(Cbreak \(TRUE\);)B
8424 4870(return FALSE;)B
8256 4710(})B
8256 4550(if \(slevel != 0\))B
8424 4390(if \(escaped\))B
EndPage
HfDict begin ep end
%%Page: ? 23
HfDict begin bp end
StartPage
Landscape
()(file.c)[(89/04/06)(12:00:46)](5)Gaudy
0 F
1032 14470(escaped = FALSE;)B
864 14310(else if \(c == '\('\))B
1032 14150(++slevel;)B
864 13990(else if \(c == '\)'\))B
1032 13830(--slevel;)B
864 13670(else if \(c == '\\\\'\))B
1032 13510(escaped = TRUE;)B
864 13350(else)B
1032 13190(;)B
696 13030(else {)B
864 12870(if \(blevel == 0 && c == '}' || c == '\)'\) {)B
1032 12710(Cbreak \(TRUE\);)B
1032 12550(return Error \(PSyntaxError\);)B
864 12390(})B
864 12230(else if \(c == '{'\))B
1032 12070(++blevel;)B
864 11910(else if \(c == '}'\))B
1032 11750(--blevel;)B
864 11590(else if \(c == '\('\))B
1032 11430(++slevel;)B
696 11270(})B
528 11110(} while \(!\(slevel == 0 && blevel == 0 && buf [length - 1] == '\\n'\)\);)B
528 10950(Cbreak \(TRUE\);)B
528 10790(Bcopy\(t = \(unsigned char *\) Malloc \(\(unsigned\) length\),buf,length\);)B
528 10630(return Push \(OpStack,ReadOnly \(FileString \(MakeString \(t,length\)\)\)\);)B
360 10470(})B
360 10150(static int PCloseFile \(file\))B
780 9990(Object file;)B
360 9830({)B
528 9670(if \(Status \(file\)\))B
696 9510(Close \(file\);)B
528 9350(return TRUE;)B
360 9190(})B
360 8870(int Close \(file\))B
780 8710(Object file;)B
360 8550({)B
528 8390(if \(file.flags & PERMANENT\))B
696 8230(return TRUE;)B
528 8070(switch \(Body \(file\)->file_type\) {)B
528 7910(default:)B
696 7750(Panic \("Unknown file type in closefile\\n"\);)B
528 7430(case StringFile:)B
696 7270(Body \(file\)->available = 0;)B
696 7110(Body \(file\)->f.c_ptr = NULL;)B
696 6950(return TRUE;)B
528 6630(case StreamFile:)B
696 6470(Body \(file\)->available = 0;)B
696 6310(if \(Body \(file\)->f.f_ptr\))B
864 6150(Fclose \(Body \(file\)->f.f_ptr\),)B
864 5990(Body \(file\)->f.f_ptr = NULL;)B
696 5830(return TRUE;)B
528 5670(})B
360 5510(})B
360 5190(static int PRead \(file\))B
780 5030(Object file;)B
360 4870({)B
528 4710(int c = Getch \(file\);)B
528 4390(if \(c != EOF\))B
8256 14470(return Push \(OpStack, MakeInteger \(c\)\), Push \(OpStack, True\);)B
8088 14310(else)B
8256 14150(return Push \(OpStack, False\);)B
7920 13990(})B
7920 13670(static int PReadHexString \(file, string\))B
8340 13510(Object file, string;)B
7920 13350({)B
8088 13190(int cc = 0, i, odd = FALSE, l = lengthString \(string\);)B
8088 12870(for \(i = 0; i < l; \) {)B
8256 12710(int c = Getch \(file\);)B
8256 12390(if \(c == EOF\))B
8424 12230(break;)B
8256 12070(else if \(c >= '0' && c <= '9'\))B
8424 11910(c -= '0';)B
8256 11750(else if \(c >= 'a' && c <= 'f'\))B
8424 11590(c -= 'a' - 10;)B
8256 11430(else if \(c >= 'A' && c <= 'F'\))B
8424 11270(c -= 'A' - 10;)B
8256 11110(else)B
8424 10950(continue;)B
8256 10790(if \(odd\))B
8424 10630(putString \(string, i++, \(cc << 4\) | c\);)B
8256 10470(else)B
8424 10310(cc =  c;)B
8256 10150(odd = !odd;)B
8088 9990(})B
8088 9830(VOID Push \(OpStack, getIString \(string, 0, i\)\);)B
8088 9670(VOID Push \(OpStack, MakeBool \(Status \(file\)\)\);)B
8088 9350(return TRUE;)B
7920 9190(})B
7920 8870(static int PReadLine \(file, string\))B
8340 8710(Object file, string;)B
7920 8550({)B
8088 8390(int i, c = 0, l = lengthString \(string\);)B
8088 8070(for \(i = 0; \(c = Getch \(file\)\) != EOF && i < l && c != '\\n'; i++\))B
8256 7910(putString \(string, i, c\);)B
8088 7750(if \(c != '\\n' && c != EOF\))B
8256 7590(return Error \(PRangeCheck\);)B
8088 7430(VOID Push \(OpStack, getIString \(string, 0, i\)\);)B
8088 7270(VOID Push \(OpStack, MakeBool \(c != EOF\)\);)B
8088 6950(return TRUE;)B
7920 6790(})B
7920 6470(static int PReadString \(file, string\))B
8340 6310(Object file, string;)B
7920 6150({)B
8088 5990(int i, c, l = lengthString \(string\);)B
8088 5670(for \(i = 0; i < l && \(c = Getch \(file\)\) != EOF; i++\))B
8256 5510(putString \(string, i, c\);)B
8088 5350(VOID Push \(OpStack, getIString \(string, 0, i\)\);)B
8088 5190(VOID Push \(OpStack, MakeBool \(c != EOF\)\);)B
8088 4870(return TRUE;)B
7920 4710(})B
7920 4390(/*ARGSUSED*/)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(file.c)[(89/04/06)(12:00:46)](6)Gaudy
0 F
360 14470(static int PBytesAvailable \(file\))B
780 14310(Object file;)B
360 14150({)B
528 13990(return Push \(OpStack, MakeInteger \(-1\)\);)B
360 13830(})B
360 13510(static int PWrite \(file, integer\))B
780 13350(Object file, integer;)B
360 13190({)B
528 13030(if \(!Status \(file\)\))B
696 12870(return Error \(PIOError\);)B
528 12710(switch \(Body \(file\)->file_type\) {)B
528 12550(default:)B
696 12390(Panic \("unknown file type in write\\n"\);)B
528 12070(case StringFile:)B
696 11910(return Error \(PInvFileAccess\);)B
528 11590(case StreamFile:)B
696 11430(if \(Body \(file\)->f.f_ptr\) {)B
864 11270(VOID fputc \(BodyInteger \(integer\), Body \(file\)->f.f_ptr\);)B
864 11110(return TRUE;)B
696 10950(})B
696 10790(return Error \(PIOError\);)B
528 10630(})B
360 10470(})B
360 10150(static int PWriteHexString \(file, string\))B
780 9990(Object file, string;)B
360 9830({)B
528 9670(FILE *fp;)B
528 9510(unsigned char *p = BodyString \(string\);)B
528 9350(int l = lengthString \(string\);)B
528 9030(if \(!Status \(file\)\))B
696 8870(return Error \(PIOError\);)B
528 8710(switch \(Body \(file\)->file_type\) {)B
528 8550(default:)B
696 8390(Panic \("unknown file type in writestring\\n"\);)B
528 8070(case StringFile:)B
696 7910(return Error \(PInvFileAccess\);)B
528 7590(case StreamFile:)B
696 7430(fp = Body \(file\)->f.f_ptr;)B
696 7270(while \(l--\) {)B
864 7110(int c = *p++;)B
864 6950(static unsigned char hex[] = "0123456789abcdef";)B
864 6630(fprintf \(fp, "%c%c", hex[c >> 4], hex[c & 0xF]\);)B
696 6470(})B
696 6310(return TRUE;)B
528 6150(})B
360 5990(})B
360 5670(static int PWriteString \(file, string\))B
780 5510(Object file, string;)B
360 5350({)B
528 5190(if \(!Status \(file\) || !wCheck \(file\)\))B
696 5030(return Error \(PIOError\);)B
528 4870(switch \(Body \(file\)->file_type\) {)B
528 4710(default:)B
696 4550(Panic \("unknown file type in writestring\\n"\);)B
8088 14470(case StringFile:)B
8256 14310(return Error \(PInvFileAccess\);)B
8088 13990(case StreamFile:)B
8256 13830(fprintf \(Body \(file\)->f.f_ptr,)B
9012 13670("%.*s",)B
9012 13510(lengthString \(string\),)B
9012 13350(BodyString \(string\)\);)B
8256 13190(return TRUE;)B
8088 13030(})B
7920 12870(})B
7920 12550(static int PFlush \(\))B
1008(/* --- */)X
7920 12390({)B
8088 12230(VOID fflush \(stdout\);)B
8088 12070(HardUpdate \(\);)B
672(/* yes, well ... you didn't see this... */)X
8088 11910(return TRUE;)B
7920 11750(})B
7920 11430(static int PFlushFile \(file\))B
8340 11270(Object file;)B
7920 11110({)B
8088 10950(if \(!Status \(file\)\))B
8256 10790(return Error \(PIOError\);)B
8088 10630(else if \(wCheck \(file\)\))B
8256 10470(switch \(Body \(file\)->file_type\) {)B
8256 10310(default:)B
8424 10150(Panic \("unknown file type in flushfile\\n"\);)B
8424 9990(return FALSE; /* shuts lint up */)B
8256 9670(case StringFile:)B
336(break;)X
8256 9350(case StreamFile:)B
8424 9190(if \(Body \(file\)->f.f_ptr\))B
8592 9030(VOID fflush \(Body \(file\)->f.f_ptr\);)B
8424 8870(break;)B
8256 8710(})B
8088 8550(else if \(rCheck \(file\)\))B
8256 8390(while \(Getch \(file\) != EOF\))B
8424 8230(;)B
8088 8070(return TRUE;)B
7920 7910(})B
7920 7590(static int PStatus \(file\))B
8340 7430(Object file;)B
7920 7270({)B
8088 7110(return Push \(OpStack, MakeBool \(Status \(file\)\)\);)B
7920 6950(})B
7920 6630(static int PCurFile \(\))B
840(/* --- file */)X
7920 6470({)B
8088 6310(int c = CountTo \(File, ExecStack\);)B
8088 6150(Object f;)B
8088 5830(PanicIf \(c < 0, "currentfile finds no run context"\);)B
8088 5670(f = ExecStack->stack_body[Height \(ExecStack\) - c - 1];)B
8088 5510(return Push \(OpStack, Cvlit \(f\)\);)B
7920 5350(})B
7920 5030(static int PPrint \(string\))B
8340 4870(Object string;)B
7920 4710({)B
8088 4550(int i, l = lengthString \(string\);)B
8088 4390(unsigned char *s = BodyString \(string\);)B
EndPage
HfDict begin ep end
%%Page: ? 24
HfDict begin bp end
StartPage
Landscape
()(file.c)[(89/04/06)(12:00:46)](7)Gaudy
0 F
528 14310(for \(i = 0; i < l; i++\))B
696 14150(putchar \(*s++\);)B
528 13990(/* PRINTF BUG: printf \("%.*s", lengthString \(string\), BodyString \(string\)\);*/)B
528 13830(return TRUE;)B
360 13670(})B
360 13350(static int PEcho \(res\))B
780 13190(Object res;)B
360 13030({)B
528 12870(Echo \(BodyBool \(res\)\);)B
528 12710(return TRUE;)B
360 12550(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(fill.c)[(89/04/06)(12:01:35)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(/*)B
444 11750(* Trapezoid decomposition algorithm:)B
444 11590(* )B
444 11430(*)B
504(Edges are characterised by a line description, with topY,)X
444 11270(*)B
504(bottomY, topX, bottomX, startingY)X
444 11110(* )B
420(Build edge lists from path.)X
444 10950(*)B
504(Sort edges on top Y value.)X
444 10790(*)B
504(find topmost interestingY value, which will be the minimum)X
444 10630(*)B
504(topY. This becomes interestingY. )X
444 10470(*)B
504(loop)X
444 10310(*)B
1176(examine edge list from here to end. Move edges with)X
444 10150(*)B
1176(topY value less than interestingY into interesting)X
444 9990(*)B
1176(edge set, computing intersections for each as you go.)X
444 9830(*)B
1176(This should establish next interestingY value, nextY.)X
444 9670(*)B
1176(form the pairings for all edges in the interesting)X
444 9510(*)B
1176(set, according to the fill rule at interestingY.)X
444 9350(*)B
1848(to do this, while inside, keep a pointer to)X
444 9190(*)B
1848(the last up-transition edge, and pair it with)X
444 9030(*)B
1848(the next down-transition edge.)X
444 8870(*)B
1848(for any edges which have changed pairing, emit)X
444 8710(*)B
1848(a trapezoid from their startingY to)X
444 8550(*)B
1848(interestingY, \(if they were paired\) and set)X
444 8390(*)B
1848(their startingY to interestingY )X
444 8230(*)B
1176(break if \(ninteresting == 0 && nedges_left == 0\))X
444 8070(*)B
1176(interestingY := nextY)X
444 7910(*)B
504(pool)X
444 7750(*/)B
360 7430(struct edge)B
360 7270({)B
528 7110(int topX, topY, bottomX, bottomY; short dir;)B
528 6950(struct edge *pair;)B
528 6790(int startingY, where, up, clip;)B
528 6630(int name;)B
360 6470(};)B
360 5990(#define EoRule 1)B
360 5830(#define NwRule \(~0\))B
360 5510(int names = 0;)B
360 5190(extern int in_stroke;)B
360 5030(extern void SetClipHardware \(\);)B
360 4710(int InitClip \(\);)B
360 4550(static int Clip \(\);)B
360 4390(static int EOClip \(\);)B
7920 14470(int Fill \(\);)B
7920 14310(static int EOFill \(\);)B
7920 14150(static int PClipPath \(\);)B
7920 13990(static int NextLowest \(\);)B
7920 13670(static struct edge *edge;)B
7920 13350(InitFill \(\))B
7920 13190({)B
8088 13030(InstallOp \("initclip",)B
672(InitClip,)X
588(0, 0, 0, 0\);)X
8088 12870(InstallOp \("clip",)B
1008(Clip,)X
924(0, 0, 0, 0\);)X
8088 12710(InstallOp \("eoclip",)B
840(EOClip,)X
756(0, 0, 0, 0\);)X
8088 12550(InstallOp \("fill",)B
1008(Fill,)X
924(0, 0, 0, 0\);)X
8088 12390(InstallOp \("eofill",)B
840(EOFill,)X
756(0, 0, 0, 0\);)X
8088 12230(InstallOp \("clippath",)B
672(PClipPath,)X
504(0, 0, 0, 0\);)X
8088 12070(PanicIf \(\(\(edge = \(struct edge *\) malloc\(MAXPATHELEMENTS * sizeof\(struct edge\)\)\) == NUL)B
7920 11910(})B
7920 11590(static struct hardware *output_device;)B
7920 11430(static Colour output_colour;)B
7920 11110(static int FillIt \(\);)B
7920 10790(/*)B
8004 10630(* BZS - Open Code)B
8004 10470(*/)B
7920 10310(#define NotThisBit\(EDGE,WHERE,EMITFN\) { \\)B
8088 10150(if\(\(EDGE\)->pair != NULL\) { \\)B
8340 9990(\(*EMITFN\)\(\(EDGE\),\(EDGE\)->pair,\(EDGE\)->startingY,WHERE\); \\)B
8340 9830(\(EDGE\)->pair->startingY = WHERE; \\)B
8340 9670(\(EDGE\)->pair->where = WHERE; \\)B
8340 9510(\(EDGE\)->pair->pair = NULL; \\)B
8340 9350(\(EDGE\)->pair = NULL; \\)B
8172 9190(} \\)B
8088 9030(\(EDGE\)->startingY = WHERE; \\)B
8088 8870(\(EDGE\)->where = WHERE; \\)B
7920 8710(})B
7920 8390(#define ThisBit\(LEFT,RIGHT,WHERE,EMITFN\) { \\)B
8172 8230(if\(\(LEFT\)->pair != \(RIGHT\) || \(RIGHT\)->up\) { \\)B
8340 8070(if\(\(LEFT\)->pair != NULL\) { \\)B
8592 7910(\(*EMITFN\)\(LEFT,\(LEFT\)->pair,\(LEFT\)->startingY,\(LEFT\)->where\); \\)B
8592 7750(\(LEFT\)->pair->startingY = \(LEFT\)->pair->where; \\)B
8592 7590(\(LEFT\)->pair->pair->startingY = \(LEFT\)->pair->pair->where; \\)B
8592 7430(\(LEFT\)->pair->pair = NULL; \\)B
8340 7270(} \\)B
8340 7110(if \(\(RIGHT\)->pair != NULL\) { \\)B
8592 6950(\(*EMITFN\) \(RIGHT, \(RIGHT\)->pair, \(RIGHT\)->startingY, \(RIGHT\)->where\); \\)B
8592 6790(\(RIGHT\)->pair->startingY = \(RIGHT\)->pair->where; \\)B
8592 6630(\(RIGHT\)->pair->pair->startingY = \(RIGHT\)->pair->pair->where; \\)B
8592 6470(\(RIGHT\)->pair->pair = NULL; \\)B
8340 6310(}  \\)B
8340 6150(\(LEFT\)->pair = RIGHT; \\)B
8340 5990(\(RIGHT\)->pair = LEFT; \\)B
8340 5830(\(LEFT\)->startingY = \(RIGHT\)->startingY = WHERE; \\)B
8172 5670(} \\)B
8172 5510(\(LEFT\)->where = \(RIGHT\)->where = WHERE; \\)B
8172 5350(\(LEFT\)->up = TRUE; \\)B
8172 5190(\(RIGHT\)->up = FALSE; \\)B
7920 5030(})B
7920 4710(#define UpEdge\(COUNT_A,COUNT_B,INC_A,INC_B,RULE_A,RULE_B\) \\)B
8088 4550(\(\(\(COUNT_B+INC_B\)&RULE_A\) && !\(\(COUNT_A\)&RULE_A\) && \\)B
8172 4390(\(\(COUNT_A+INC_A\)&RULE_A\)||\(\(COUNT_A+INC_A\)&RULE_A\) && \\)B
EndPage
HfDict begin ep end
%%Page: ? 25
HfDict begin bp end
StartPage
Landscape
()(fill.c)[(89/04/06)(12:01:35)](2)Gaudy
0 F
612 14470(!\(\(COUNT_B\)&RULE_B\) && \(\(COUNT_B+INC_B\)&RULE_B\)\))B
360 14150(#define DownEdge\(COUNT_A,COUNT_B,INC_A,INC_B,RULE_A,RULE_B\) \\)B
528 13990(\(\(\(COUNT_B+INC_B\)&RULE_B\) && \(\(COUNT_A\)&RULE_A\) && \\)B
612 13830(!\(\(COUNT_A+INC_A\)&RULE_A\)||\(\(COUNT_A+INC_A\)&RULE_A\) && \\)B
612 13670(\(\(COUNT_B\)&RULE_B\) && !\(\(COUNT_B+INC_B\)&RULE_B\)\))B
360 13350(#define Xvalue\(AX,AY,BX,BY,CY\) \\)B
528 13190(\(\(BX\)+\(\(CY\)-\(BY\)\)*\(\(AX\)-\(BX\)\)/\(float\)\(\(AY\)-\(BY\)\)\))B
360 12870(static void EmitTrapezoid \(left, right, top, bottom\))B
780 12710(struct edge *left, *right; int top, bottom;)B
360 12550({)B
528 12390(struct edge *temp;)B
528 12070(if \(left->topX > right->topX || left->bottomX > right->bottomX\))B
696 11910(temp = left, left = right, right = temp;)B
528 11750(PaintTrapezoid \(output_device,)B
1872 11590(NewDevicePoint \(left->topX, left->topY\),)B
1872 11430(NewDevicePoint \(left->bottomX, left->bottomY\),)B
1872 11270(NewDevicePoint \(right->topX, right->topY\),)B
1872 11110(NewDevicePoint \(right->bottomX, right->bottomY\),)B
1872 10950(top, bottom,)B
1872 10790(output_colour\);)B
360 10630(})B
360 10310(int Fill \(\))B
360 10150({)B
528 9990(int res;)B
528 9670(if \(gstate->device->dev == NULL\))B
696 9510(return PNewPath \(\);)B
528 9190(res = FillPath\(gstate->device->dev, gstate->path, 1\);)B
528 8870(VOID PNewPath \(\);)B
528 8550(return res;)B
360 8390(})B
360 8070(static int EOFill \(\))B
360 7910({)B
528 7750(int res;)B
528 7430(if \(gstate->device->dev == NULL\))B
696 7270(return PNewPath \(\);)B
528 6950(output_device = gstate->device->dev;)B
528 6790(output_colour = gstate->colour;)B
528 6630(res = FillIt \(gstate->path, EoRule, gstate->clip, NwRule, EmitTrapezoid\);)B
528 6470(/* XXX needs optimising */)B
528 6150(VOID PNewPath \(\);)B
528 5830(return res;)B
360 5670(})B
360 5350(static Path output_path;)B
360 5030(static void PathTrapezoid \(left, right, top, bottom\))B
780 4870(struct edge *left, *right; int top, bottom;)B
360 4710({)B
528 4550(int ll, ul, lr, ur;)B
528 4390(struct edge *temp;)B
8088 14310(if \(left->topX > right->topX || left->bottomX > right->bottomX\))B
8256 14150(temp = left, left = right, right = temp;)B
8088 13830(ll = Xvalue \(left->topX, left->topY, left->bottomX, left->bottomY,)B
9180 13670(bottom\);)B
8088 13510(ul = Xvalue \(left->topX, left->topY, left->bottomX, left->bottomY, top\);)B
8088 13350(lr = Xvalue \(right->topX, right->topY, right->bottomX, right->bottomY,)B
9180 13190(bottom\);)B
8088 13030(ur = Xvalue \(right->topX, right->topY, right->bottomX, right->bottomY,)B
9180 12870(top\);)B
8088 12550(MoveTo \(output_path, NewHardPoint \(\(float\) ll, \(float\) bottom\)\);)B
8088 12390(LineTo \(output_path, NewHardPoint \(\(float\) lr, \(float\) bottom\)\);)B
8088 12230(LineTo \(output_path, NewHardPoint \(\(float\) ur, \(float\) top\)\);)B
8088 12070(LineTo \(output_path, NewHardPoint \(\(float\) ul, \(float\) top\)\);)B
8088 11910(ClosePath \(output_path\);)B
7920 11750(})B
7920 11430(int InitClip \(\))B
7920 11270({)B
8088 11110(PathFree \(gstate->clip\);)B
8088 10950(gstate->clip = PathCopy \(gstate->device->default_clip\);)B
8088 10630(UnlinkDevice \(gstate->clipdevice\);)B
8088 10470(gstate->clipdevice = NULL;)B
8088 10150(SetClipHardware \(gstate->device->dev, \(struct hardware *\) NULL\);)B
8088 9830(return TRUE;)B
7920 9670(})B
7920 9350(static int Clip \(\))B
7920 9190({)B
8088 9030(int res;)B
8088 8710(output_path = NewPath \(\);)B
8088 8550(res = FillIt \(gstate->path, NwRule, gstate->clip, NwRule, PathTrapezoid\);)B
8088 8390(/* XXX - needs optimising */)B
8088 8070(PathFree \(gstate->clip\);)B
8088 7910(gstate->clip = output_path;)B
8088 7590(if \(res\) {)B
8256 7430(gstate->clipdevice = UniqueDevice \(gstate->clipdevice\);)B
8256 7270(SetClipHardware \(gstate->device->dev, gstate->clipdevice->dev\);)B
8256 6950(/*)B
420(output_colour = gstate->colour;)X
8340 6790(* gstate->colour = NewColour \(0.0, 0.0, 0.0\);)B
8340 6630(* res = FillPath\(gstate->clipdevice->dev, gstate->clip, 1\);)B
8340 6470(*/)B
8256 6310(output_device = gstate->clipdevice->dev;)B
8256 6150(output_colour = NewColour \(0.0, 0.0, 0.0\);)B
8256 5990(res = FillIt \(gstate->clip, NwRule, gstate->device->default_clip,)B
9432 5830(NwRule, EmitTrapezoid\);)B
8088 5670(})B
8088 5510(return res;)B
7920 5350(})B
7920 5030(static int EOClip \(\))B
7920 4870({)B
8088 4710(int res;)B
8088 4390(output_path = NewPath \(\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(fill.c)[(89/04/06)(12:01:35)](3)Gaudy
0 F
528 14470(res = FillIt \(gstate->path, EoRule, gstate->clip, NwRule, PathTrapezoid\);)B
528 14310(/* XXX - needs optimising */)B
528 13990(PathFree \(gstate->clip\);)B
528 13830(gstate->clip = output_path;)B
528 13510(if \(res\) {)B
696 13350(gstate->clipdevice = UniqueDevice \(gstate->clipdevice\);)B
696 13190(SetClipHardware \(gstate->device->dev, gstate->clipdevice->dev\);)B
696 12870(output_device = gstate->clipdevice->dev;)B
696 12710(output_colour = NewColour \(0.0, 0.0, 0.0\);)B
696 12550(res = FillIt \(gstate->clip, NwRule, gstate->device->default_clip,)B
1872 12390(NwRule, EmitTrapezoid\);)B
528 12230(})B
528 12070(return res;)B
360 11910(})B
360 11590(static int PClipPath \(\))B
360 11430({)B
528 11270(PathFree \(gstate->path\);)B
528 11110(gstate->path = PathCopy \(gstate->clip\);)B
528 10950(gstate->cp_defined = TRUE;)B
528 10790(gstate->cp = gstate->path->last->pe.point;)B
528 10470(return TRUE;)B
360 10310(})B
360 9990(/****************************/)B
360 9670(static struct edge *interesting [MAXPATHELEMENTS];)B
360 9350(static int nedges, here, ninteresting;)B
360 9030(static int interestingY, nextY;)B
360 8710(static int infinity;)B
360 8390(static int FillIt \(path_a, rule_a, path_b, rule_b, emitfn\))B
780 8230(Path path_a, path_b;)B
780 8070(int rule_a, rule_b;)B
780 7910(void \(*emitfn\)\(\);)B
360 7750({)B
528 7590(static int edgecmp \(\);)B
528 7430(static void Trapezoids \(\), BuildEdgeList \(\);)B
528 7110(if \(EmptyPath \(path_a\) || EmptyPath \(path_b\)\))B
696 6950(return TRUE;)B
528 6630(path_a = FlattenPath \(path_a\);)B
528 6470(path_b = FlattenPath \(path_b\);)B
528 6150(if \(!CloseAll \(path_a\) || !CloseAll \(path_b\)\) {)B
696 5990(PathFree \(path_a\);)B
696 5830(PathFree \(path_b\);)B
696 5510(return FALSE;)B
528 5350(})B
528 5030(nedges = 0;)B
528 4870(BuildEdgeList \(path_a, TRUE\);)B
528 4710(BuildEdgeList \(path_b, FALSE\);)B
528 4550(qsort \(\(char *\) edge, \(unsigned\) nedges, sizeof \(struct edge\), edgecmp\);)B
528 4390(PathFree \(path_a\);)B
8088 14470(PathFree \(path_b\);)B
8088 14310(Trapezoids \(rule_a, rule_b, emitfn\);)B
8088 13990(return TRUE;)B
7920 13830(})B
7920 13510(static void AddLowest \(\);)B
7920 13190(static void Trapezoids \(rule_a, rule_b, emitfn\))B
8340 13030(int rule_a, rule_b;)B
8340 12870(void \(*emitfn\)\(\);)B
7920 12710({)B
8088 12550(static void FindInfinity \(\), AddInteresting \(\);)B
8088 12230(nextY = edge[0].topY;)B
8088 12070(AddLowest \(nextY\);)B
8088 11910(FindInfinity \(\);)B
8088 11590(here = 0;)B
8088 11430(ninteresting = 0;)B
8088 11270(names = 0;)B
8088 10950(while \(here != nedges || ninteresting\) {)B
8256 10790(static void RemoveEdges \(\);)B
8256 10470(interestingY = nextY;)B
8256 10310(ProcessEdges \(rule_a, rule_b, emitfn\);)B
8256 9990(AddInteresting \(\);)B
8256 9670(RemoveEdges \(interestingY, emitfn\);)B
8256 9350(ProcessEdges \(rule_a, rule_b, emitfn\);)B
8088 9190(})B
7920 9030(})B
7920 8710(ProcessEdges \(rule_a, rule_b, emitfn\))B
8340 8550(int rule_a, rule_b;)B
8340 8390(void \(*emitfn\)\(\);)B
7920 8230({)B
8088 8070(register struct edge **intp;)B
8088 7910(register struct edge *up_edge;)B
8088 7750(register int count_a = 0, count_b = 0;)B
8088 7590(register int i;)B
8088 7270(i = ninteresting;)B
8088 7110(intp = interesting;)B
8088 6950(while\(i-- > 0\) {)B
8256 6790(register int d_a = 0, d_b = 0;)B
8256 6470(if \(\(*intp\)->clip\))B
8424 6310(d_a = \(*intp\)->dir;)B
8256 6150(else)B
8424 5990(d_b = \(*intp\)->dir;)B
8256 5670(if \(UpEdge \(count_a, count_b, d_a, d_b, rule_a, rule_b\)\))B
8424 5510(up_edge = *intp;)B
8256 5350(else if\(DownEdge \(count_a, count_b, d_a, d_b, rule_a, rule_b\)\){)B
8424 5190(ThisBit \(up_edge,\(*intp\), interestingY, emitfn\);)B
8256 5030(})B
8256 4870(else {)B
8424 4710(NotThisBit \(\(*intp\),interestingY,emitfn\);)B
8256 4550(})B
8256 4390(count_a += d_a;)B
EndPage
HfDict begin ep end
%%Page: ? 26
HfDict begin bp end
StartPage
Landscape
()(fill.c)[(89/04/06)(12:01:35)](4)Gaudy
0 F
696 14470(count_b += d_b;)B
696 14150(intp++;)B
528 13990(})B
528 13670(if \(count_a || count_b\) {)B
696 13510(fprintf \(stderr, "count_a = %dcount_b = %d\\n", count_a, count_b\);)B
696 13350(Panic\("something wrong in area fill"\);)B
528 13190(})B
360 13030(})B
360 12710(/* BZS - Open code */)B
360 12550(#ifndef ThisBit)B
360 12390(ThisBit \(left, right, where, emitfn\))B
780 12230(struct edge *left, *right;)B
780 12070(int where;)B
780 11910(void \(*emitfn\)\(\);)B
360 11750({)B
528 11590(if \(left->pair != right || right->up\) {)B
696 11430(if \(left->pair != NULL\) {)B
864 11270(\(*emitfn\) \(left, left->pair, left->startingY, left->where\);)B
864 11110(left->pair->startingY = left->pair->where;)B
864 10950(left->pair->pair->startingY = left->pair->pair->where;)B
864 10790(left->pair->pair = NULL;)B
696 10630(})B
696 10470(if \(right->pair != NULL\) {)B
864 10310(\(*emitfn\) \(right, right->pair, right->startingY, right->where\);)B
864 10150(right->pair->startingY = right->pair->where;)B
864 9990(right->pair->pair->startingY = right->pair->pair->where;)B
864 9830(right->pair->pair = NULL;)B
696 9670(})B
696 9350(left->pair = right;)B
696 9190(right->pair = left;)B
696 9030(left->startingY = right->startingY = where;)B
528 8870(})B
528 8710(left->where = right->where = where;)B
528 8550(left->up = TRUE; right->up = FALSE;)B
360 8390(})B
360 8230(#endif)B
360 7910(/*)B
444 7750(* BZS - Open Code this, it can be called hundreds of thousands of times)B
444 7590(* in even simple pictures. Mooreforms spend 50% of its time in this.)B
444 7430(*/)B
360 7270(#ifndef NotThisBit)B
360 7110(NotThisBit \(edge, where, emitfn\))B
780 6950(struct edge *edge;)B
780 6790(int where;)B
780 6630(void \(*emitfn\)\(\);)B
360 6470({)B
528 6310(if \(edge->pair != NULL\) {)B
696 6150(\(*emitfn\) \(edge, edge->pair, edge->startingY, where\);)B
696 5990(edge->pair->startingY = where;)B
696 5830(edge->pair->where = where;)B
696 5670(edge->pair->pair = NULL;)B
696 5510(edge->pair = NULL;)B
528 5350(})B
528 5190(edge->startingY = where;)B
528 5030(edge->where = where;)B
360 4870(})B
360 4710(#endif)B
360 4390(static void RemoveEdges \(interestingY, emitfn\))B
8340 14470(int interestingY;)B
8340 14310(void \(*emitfn\)\(\);)B
7920 14150({)B
8088 13990(register int i, j = 0;)B
8088 13670(for \(i = 0; i < ninteresting; i++\))B
8256 13510(if \(interesting [i]->bottomY > interestingY\))B
8424 13350(interesting [j++] = interesting [i];)B
8256 13190(else)B
8424 13030(NotThisBit \(interesting[i], interestingY, emitfn\);)B
8088 12870(ninteresting = j;)B
7920 12710(})B
7920 12390(static float Yintersect \(a, b\))B
8340 12230(struct edge *a, *b;)B
7920 12070({)B
8088 11910(float)B
8256 11750(num = \(a->bottomX * a->topY - a->bottomY * a->topX\) * \(b->topY - b->bottomY\) -)B
8424 11590(\(b->bottomX * b->topY - b->bottomY * b->topX\) * \(a->topY - a->bottomY\),)B
8424 11430(denom = \(a->bottomX - a->topX\) * \(b->topY - b->bottomY\) -)B
8592 11270(\(b->bottomX - b->topX\) * \(a->topY - a->bottomY\);)B
8088 10950(if \(denom == 0\) {)B
8256 10790(return infinity;)B
8088 10630(})B
8088 10470(return num / denom;)B
7920 10310(})B
7920 9990(#ifndef Xvalue)B
7920 9830(static int Xvalue \(ax, ay, bx, by, cy\))B
8340 9670(int ax, ay, bx, by, cy;)B
7920 9510({)B
8088 9350(return bx + \(cy - by\) * \(ax - bx\) / \(float\) \(ay - by\);)B
7920 9190(})B
7920 9030(#endif)B
7920 8710(static int intercmp \(aa, bb\))B
8340 8550(char *aa, *bb;)B
7920 8390({)B
8088 8230(register struct edge *a = *\(struct edge **\) aa, *b = *\(struct edge **\) bb;)B
8088 8070(int sign;)B
8088 7750(sign = Xvalue \(a->topX, a->topY, a->bottomX, a->bottomY, interestingY + 1\) -)B
8256 7590(Xvalue \(b->topX, b->topY, b->bottomX, b->bottomY, interestingY + 1\);)B
8088 7430(if \(sign == 0\))B
8256 7270(return a->bottomX - b->bottomX;)B
8088 7110(return sign;)B
7920 6950(})B
7920 6630(static void AddInteresting \(\))B
7920 6470({)B
8088 6310(register int i;)B
8088 6150(register struct edge **intp;)B
8088 5830(nextY = infinity;)B
8088 5670(for \(; here < nedges && edge[here].topY <= interestingY; here++\) {)B
8256 5510(/* look at each new interesting edge */)B
8256 5350(register int i, n;)B
8256 5030(i = ninteresting;)B
8256 4870(intp = interesting;)B
8256 4710(while\(i-- > 0\) { /* look at all possible intersections */)B
8424 4550(int inter = Yintersect \(&edge[here], \(*intp\)\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(fill.c)[(89/04/06)(12:01:35)](5)Gaudy
0 F
864 14470(if \(inter >= interestingY &&)B
1200 14310(inter <= edge[here].bottomY &&)B
1200 14150(inter <= \(*intp\)->bottomY\))B
1032 13990(AddLowest \(inter\);)B
864 13830(intp++;)B
696 13670(})B
696 13510(n = ninteresting++;)B
696 13350(intp = &interesting[n];)B
696 13190(*intp = &edge[here];)B
696 13030(\(*intp\)->pair = NULL;)B
696 12870(\(*intp\)->up = FALSE;)B
696 12710(\(*intp\)->startingY = \(*intp\)->where = edge[here].topY;)B
696 12550(\(*intp\)->name = names++;)B
528 12390(})B
528 12230(i = NextLowest \(interestingY\);)B
528 12070(if \(i\))B
696 11910(nextY = i;)B
528 11750(if \(here != nedges && edge[here].topY < nextY\))B
696 11590(nextY = edge[here].topY;)B
528 11430(i = ninteresting;)B
528 11270(intp = interesting;)B
528 11110(while\(i-- > 0\) {)B
696 10950(if \(\(*intp\)->topY > interestingY && \(*intp\)->topY < nextY\))B
864 10790(nextY = \(*intp\)->topY;)B
696 10630(if \(\(*intp\)->bottomY > interestingY && \(*intp\)->bottomY < nextY\))B
864 10470(nextY = \(*intp\)->bottomY;)B
696 10310(intp++;)B
528 10150(})B
528 9990(qsort \(\(char *\) interesting, \(unsigned\) ninteresting,)B
1116 9830(sizeof \(struct edge *\), intercmp\);)B
360 9670(})B
360 9350(static void FindInfinity \(\))B
360 9190({)B
528 9030(register int i;)B
528 8710(infinity = edge[0].topY;)B
528 8550(for \(i = 0; i < nedges; i++\))B
696 8390(if \(edge[i].bottomY > infinity\))B
864 8230(infinity = edge[i].bottomY;)B
360 8070(})B
360 7750(/***************************/)B
360 7430(static int edgecmp \(a, b\))B
780 7270(char *a, *b;)B
360 7110({)B
528 6950(struct edge *aa = \(struct edge *\) a, *bb = \(struct edge *\) b;)B
528 6630(return aa->topY - bb->topY;)B
360 6470(})B
360 6150(static int AddEdge \(e, from, to, clip\))B
780 5990(struct edge *e;)B
780 5830(HardPoint from, to;)B
780 5670(int clip;)B
360 5510({)B
528 5350(int dir = 1;)B
528 5190(HardPoint temp;)B
528 4870(if \(\(int\) \(from.hy\) == \(int\) \(to.hy\)\))B
696 4710(return 0;)B
528 4550(if \(\(int\) \(from.hy\) > \(int\) \(to.hy\)\) {)B
696 4390(temp = from; from = to; to = temp;)B
8256 14470(dir = -dir;)B
8088 14310(})B
8088 14150(e->topX = from.hx;)B
8088 13990(e->topY = from.hy;)B
8088 13830(e->bottomX = to.hx;)B
8088 13670(e->bottomY = to.hy;)B
8088 13510(e->dir = dir;)B
8088 13350(e->clip = clip;)B
8088 13030(return 1;)B
7920 12870(})B
7920 12550(static void BuildEdgeList \(path, clip\))B
8340 12390(Path path;)B
8340 12230(int clip;)B
7920 12070({)B
8088 11910(register Path p;)B
8088 11750(HardPoint move, here;)B
8088 11430(for \(p = path->next; p != path; p = p->next\))B
8256 11270(switch \(p->ptype\) {)B
8256 11110(case EMove: move = here = p->pe.point; break;)B
8256 10950(case ELine:)B
8424 10790(nedges += AddEdge \(&edge[nedges], here, p->pe.point, clip\);)B
8424 10630(here = p->pe.point;)B
8424 10470(break;)B
8256 10150(case EClose:)B
8424 9990(nedges += AddEdge \(&edge[nedges], here, move, clip\);)B
8424 9830(here = move;)B
8424 9670(break;)B
8256 9510(})B
7920 9350(})B
7920 9030(/* keep list of interesting entries to come */)B
7920 8710(struct lowest)B
7920 8550({)B
8088 8390(struct lowest *higher;)B
8088 8230(int e;)B
7920 8070(} *lowest_free = NULL, *lowest = NULL;)B
7920 7750(static int NextLowest \(y\))B
8340 7590(int y;)B
7920 7430({)B
8088 7270(int res;)B
8088 7110(register struct lowest *p;)B
8088 6790(for \(p = lowest; p && p->e <= y; p = lowest\) {)B
8256 6630(/* delete any which are now irrelevent */)B
8256 6470(lowest = p->higher;)B
8256 6310(p->higher = lowest_free;)B
8256 6150(lowest_free = p;)B
8088 5990(})B
8088 5670(if \(lowest == NULL\))B
8256 5510(return 0;)B
8088 5350(res = lowest->e;)B
8088 5030(return res;)B
7920 4870(})B
7920 4550(static void AddLowest \(e\))B
8340 4390(int e;)B
EndPage
HfDict begin ep end
%%Page: ? 27
HfDict begin bp end
StartPage
Landscape
()(fill.c)[(89/04/06)(12:01:35)](6)Gaudy
0 F
360 14470({)B
528 14310(register struct lowest *res, *p, *q;)B
528 13990(for \(p = lowest; p && p->e < e; q = p, p = p->higher\))B
696 13830(;)B
528 13510(if \(p && p->e == e\))B
696 13350(return;)B
528 13190(if \(lowest_free == NULL\))B
696 13030(res = \(struct lowest *\) Malloc \(sizeof \(struct lowest\)\);)B
528 12870(else)B
696 12710(res = lowest_free, lowest_free = lowest_free->higher;)B
528 12390(res->e = e;)B
528 12230(res->higher = p;)B
528 12070(if \(p != lowest\))B
696 11910(q->higher = res;)B
528 11750(else)B
696 11590(lowest = res;)B
360 11430(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(font.c)[(89/04/06)(12:02:33)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(#define MOVETO)B
168(0x80)X
360 11750(#define BYTE)B
336(0xFF)X
360 11430(#define FONT_USER)B
588(3)X
360 11270(#define MakeVector\(V, X, Y, T\) V->vx = X; V->vy = Y; V->vt = T;)B
360 10950(/* Also change #define in X11.c */)B
360 10790(#define UpdateControl\(h, on\) {})B
360 10470(static struct show_context show_stack [MAXGSAVES];)B
360 10150(int MoveTo \(\), LineTo \(\);)B
360 9830(static int PCurrentFont \(\);)B
360 9670(static int PDefineFont \(\);)B
360 9510(static int PFindFont \(\);)B
360 9350(static int PScaleFont \(\);)B
360 9190(static int PMakeFont \(\);)B
360 9030(static int PSetFont \(\);)B
360 8710(static int BuildHershey \(\);)B
360 8550(static int PShow \(\);)B
360 8390(static int PWidthShow \(\);)B
360 8230(static int PAShow \(\);)B
360 8070(static int PAWidthShow \(\);)B
360 7910(static int PStringWidth \(\);)B
360 7750(static int PAdjust \(\);)B
360 7430(static Vector *GetMetrics \(\);)B
360 7270(extern Vector NewVector \(\);)B
360 6950(static int ShowString \(\);)B
360 6790(static int ShowStop \(\);)B
360 6630(static int ShowStopped \(\);)B
360 6310(Object Fid, FD, FontMatrix, FontType, Encoding, FontBBox;)B
360 6150(Object OpShowStop, OpShowString, OpStopped;)B
360 5990(Object UserShow, CharStrings, Metrics, BuildChar, FontName;)B
360 5670(static last_fid = 0;)B
360 5350(static int Update \(\);)B
360 5030(static HardPoint zeroHardPoint;)B
360 4710(extern Matrix HardPointTranslate \(\);)B
360 4390(InitFont \(\))B
7920 14470({)B
8088 14310(Fid )B
840(= NameFrom \("FID"\);)X
8088 14150(FontMatrix )B
252(= NameFrom \("FontMatrix"\);)X
8088 13990(FontType)B
504(= NameFrom \("FontType"\);)X
8088 13830(Encoding)B
504(= NameFrom \("Encoding"\);)X
8088 13670(FontBBox )B
420(= NameFrom \("FontBBox"\);)X
8088 13510(UserShow )B
420(= NameFrom \(".show"\);)X
8088 13350(CharStrings)B
252(= NameFrom \("CharStrings"\);)X
8088 13190(Metrics)B
588(= NameFrom \("Metrics"\);)X
8088 13030(BuildChar)B
420(= NameFrom \("BuildChar"\);)X
8088 12870(FontName)B
504(= NameFrom \("FontName"\);)X
8088 12550(OpShowStop = MakeOp \("\(showstop\)",)B
1008(ShowStop,)X
588(1, 0, 0, 0,)X
9852 12390(Bool\);)B
8088 12230(OpShowString = MakeOp \("\(showstring\)",)B
672(ShowString,)X
420(1, 0, 0, 0,)X
10020 12070(String\);)B
8088 11910(OpStopped = MakeOp \("\(showstopped\)",)B
840(ShowStopped,0, 1, 1, 0\);)X
8088 11590(InstallOp \("currentfont",)B
420(PCurrentFont,)X
252(0, 1, 0, 0\);)X
8088 11430(InstallOp \("definefont",)B
504(PDefineFont,)X
336(2, 1, 0, 0,)X
9012 11270(Poly, Dictionary\);)B
8088 11110(InstallOp \("findfont",)B
672(PFindFont,)X
504(1, 1, 0, 0, Poly\);)X
8088 10950(InstallOp \("scalefont",)B
588(PScaleFont,)X
420(2, 1, 0, 0,)X
9012 10790(Dictionary, Float\);)B
8088 10630(InstallOp \("makefont",)B
672(PMakeFont,)X
504(2, 1, 0, 0,)X
9012 10470(Dictionary, Array\);)B
8088 10310(InstallOp \("setfont",)B
756(PSetFont,)X
588(1, 0, 0, 0,)X
9012 10150(Dictionary\);)B
8088 9830(InstallOp \("show",)B
1008(PShow,)X
840(1, 0, 0, 0, String\);)X
8088 9670(InstallOp \("widthshow",)B
588(PWidthShow,)X
420(4, 0, 0, 0,)X
9012 9510(Float, Float, Integer, String\);)B
8088 9350(InstallOp \("ashow",)B
924(PAShow,)X
756(3, 0, 0, 0,)X
9012 9190(Float, Float, String\);)B
8088 9030(InstallOp \("awidthshow",)B
504(PAWidthShow,)X
336(6, 0, 0, 0,)X
9012 8870(Float, Float, Integer, Float, Float, String\);)B
8088 8710(InstallOp \("stringwidth",)B
420(PStringWidth,)X
252(1, 2, 0, 0, String\);)X
8088 8550(InstallOp \(".adjust",)B
756(PAdjust,)X
672(1, 0, 0, 0, Integer\);)X
8088 8390(InstallOp \("buildhershey",)B
336(BuildHershey,)X
252(2, 0, 0, 0,)X
9012 8230(Dictionary, Integer\);)B
8088 8070(InstallOp \("update",)B
840(Update,)X
756(1, 0, 0, 0, Bool\);)X
8088 7750(Install \("FontDirectory",)B
420(FD = MakeDict \(20\)\);)X
8088 7430(zeroHardPoint = NewHardPoint \(0.0, 0.0\);)B
7920 7270(})B
7920 6950(HardPoint DExtToInt \(p\))B
8340 6790(UserPoint p;)B
7920 6630({)B
8088 6470(Matrix m;)B
8088 6310(HardPoint res;)B
8088 5990(m = gstate->CTM;)B
8088 5830(res.hx = p.x * m.A + p.y * m.C;)B
8088 5670(res.hy = p.x * m.B + p.y * m.D;)B
8088 5350(return res;)B
7920 5190(})B
7920 4870(static int update_state = TRUE;)B
7920 4550(static int Update \(bool\))B
8340 4390(Object bool;)B
EndPage
HfDict begin ep end
%%Page: ? 28
HfDict begin bp end
StartPage
Landscape
()(font.c)[(89/04/06)(12:02:33)](2)Gaudy
0 F
360 14470({)B
528 14310(int new = BodyBool \(bool\);)B
528 13990(if \(new != update_state\))B
696 13830(UpdateControl \(gstate->device->dev, update_state = new\);)B
528 13670(return TRUE;)B
360 13510(})B
360 13190(InitShowContext \(\))B
360 13030({)B
528 12870(gstate->show = show_stack;)B
360 12710(})B
360 12390(HardPoint Adjust \(basic, code\))B
780 12230(HardPoint basic;)B
780 12070(char code;)B
360 11910({)B
528 11750(if \(code == gstate->show->space\))B
696 11590(return MoveHardPoint \(MoveHardPoint \(gstate->show->shim,)B
3804 11430(gstate->show->space_shim\),)B
2544 11270(basic\);)B
528 11110(else)B
696 10950(return MoveHardPoint \(gstate->show->shim, basic\);)B
360 10790(})B
360 10470(static int PAdjust \(code\))B
780 10310(Object code;)B
360 10150({)B
528 9990(gstate->CTM = HardPointTranslate \(gstate->CTM,)B
3384 9830(Adjust \(ExtToInt \(NewUserPoint \(0.0,)B
6072 9670(0.0\)\),)B
4056 9510(BodyInteger \(code\)\)\);)B
528 9350(return TRUE;)B
360 9190(})B
360 8870(static int PCurrentFont \(\))B
360 8710({)B
528 8550(return Push \(OpStack, gstate->font\);)B
360 8390(})B
360 8070(static int PFindFont \(key\))B
780 7910(Object key;)B
360 7750({)B
528 7590(Object res;)B
528 7270(res = DictLoad \(FD, key\);)B
528 7110(if \(TypeOf \(res\) == Condition\))B
696 6950(return Error \(PInvFont\);)B
528 6790(return Push \(OpStack, res\);)B
360 6630(})B
360 6310(static Object *encodingCache = NULL;)B
360 6150(static Matrix fontmatrixCache;)B
360 5990(static int fonttypeCache;)B
360 5830(int fidCache;)B
360 5670(float fontbboxCache[4];)B
360 5350(static int PSetFont \(font\))B
780 5190(Object font;)B
360 5030({)B
528 4870(Object tmp;)B
528 4550(if \(!CheckFont \(font\)\))B
696 4390(return Error \(PInvFont\);)B
8088 14470(gstate->font = font;)B
8088 14310(ExtractMatrix \(&fontmatrixCache, DictLoad \(font, FontMatrix\)\);)B
8088 14150(tmp = DictLoad \(font, Encoding\);)B
8088 13990(encodingCache = BodyArray \(tmp\);)B
8088 13830(tmp = DictLoad \(font, FontType\);)B
8088 13670(fonttypeCache = BodyInteger \(tmp\);)B
8088 13510(fidCache = BodyFontID \(DictLoad \(font, Fid\)\);)B
8088 13350(ExtractBBox \(fontbboxCache, DictLoad \(font, FontBBox\)\);)B
8088 13190(return TRUE;)B
7920 13030(})B
7920 12710(int CheckFont \(font\))B
8340 12550(Object font;)B
7920 12390({)B
8088 12230(Object mat, bbox, enc, fonttype;)B
8088 12070(Matrix dummy;)B
8088 11910(float bboxdummy[4];)B
8088 11590(mat = DictLoad \(font, FontMatrix\);)B
8088 11430(if \(TypeOf \(mat\) == Condition || !ExtractMatrix \(&dummy, mat\)\))B
8256 11270(return FALSE;)B
8088 11110(fonttype = DictLoad \(font, FontType\);)B
8088 10950(if \(TypeOf \(fonttype\) != Integer\))B
8256 10790(return FALSE;)B
8088 10630(bbox = DictLoad \(font, FontBBox\);)B
8088 10470(if \(TypeOf \(bbox\) != Array || lengthArray \(bbox\) != 4 || !ExtractBBox \(bboxdummy, bbox\))B
8256 10310(return FALSE;)B
8088 10150(enc = DictLoad \(font, Encoding\);)B
8088 9990(if \(TypeOf \(enc\) != Array\))B
8256 9830(return FALSE;)B
8088 9670(/*)B
8172 9510(* DCJ: Since LaserWriter allows smaller arrays, we should)B
8172 9350(* too...)B
8172 9190(*/)B
8088 9030(if \( lengthArray \(enc\) != 256 \))B
8256 8870(Message\("Warning: Encoding array does not contain 256 elements."\);)B
8088 8550(switch \(BodyInteger \(fonttype\)\) {)B
8088 8390(case FONT_USER: return TRUE;)B
8088 8070(default: return TRUE;)B
8088 7910(})B
7920 7750(})B
7920 7430(int CheckHershey \(font, encoding\))B
8340 7270(Object font, *encoding;)B
7920 7110({)B
8088 6950(Object cs, metrics;)B
8088 6790(int i;)B
8088 6630(cs = DictLoad \(font, CharStrings\);)B
8088 6470(if \(TypeOf \(cs\) != Dictionary\))B
8256 6310(return FALSE;)B
8088 6150(metrics = DictLoad \(font, Metrics\);)B
8088 5990(if \(TypeOf \(metrics\) != Dictionary\))B
8256 5830(return FALSE;)B
8088 5510(for \(i = 0; i < 256; i++\) {)B
8256 5350(Object met;)B
8256 5030(met = DictLoad \(metrics, encoding[i]\);)B
8256 4870(if \(TypeOf \(met\) == Array\) {)B
8424 4710(Object *m = BodyArray \(met\);)B
8424 4550(int j, l = lengthArray \(met\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(font.c)[(89/04/06)(12:02:33)](3)Gaudy
0 F
864 14470(if \(l != 1 && l != 2 && l != 4\))B
1032 14310(return FALSE;)B
864 13990(for \(j = 0; j < l; j++\))B
1032 13830(if \(TypeOf \(m[j]\) != Integer && TypeOf \(m[j]\) != Real\))B
1200 13670(return FALSE;)B
696 13510(})B
696 13350(else if \(TypeOf \(metrics\) != Integer && TypeOf \(metrics\) != Real\))B
864 13190(return FALSE;)B
528 13030(})B
528 12870(return TRUE;)B
360 12710(})B
360 12390(int ExtractBBox \(bbox, array\))B
780 12230(float *bbox;)B
780 12070(Object array;)B
360 11910({)B
528 11750(Object num;)B
528 11590(int i;)B
528 11270(if \(lengthArray \(array\) != 4\))B
696 11110(return FALSE;)B
528 10950(for \(i = 0; i < 4; i++\) {)B
696 10790(num = getArray \(array, i\);)B
696 10470(if \(TypeOf \(num\) == Integer\))B
864 10310(bbox [i] = BodyInteger \(num\);)B
696 10150(else if \(TypeOf \(num\) == Real\))B
864 9990(bbox [i] = BodyReal \(num\);)B
696 9830(else)B
864 9670(return FALSE;)B
528 9510(})B
528 9350(return TRUE;)B
360 9190(})B
360 8870(static Object MakeFontID \(\))B
360 8710({)B
528 8550(Object res;)B
528 8230(MakeObject \(res, FontID\);)B
528 8070(res.u.Font = last_fid++; /* just for uniqueness */)B
528 7750(return res;)B
360 7590(})B
360 7270(int BodyFontID \(fid\))B
780 7110(Object fid;)B
360 6950({)B
528 6790(return fid.u.Font;)B
360 6630(})B
360 6310(static int PDefineFont \(key, dict\))B
780 6150(Object key, dict;)B
360 5990({)B
528 5830(if \(maxDict \(dict\) == lengthDict \(dict\) || maxDict \(FD\) == lengthDict \(FD\)\))B
696 5670(return Error \(PDictFull\);)B
528 5350(if \(!CheckFont \(dict\)\))B
696 5190(return Error \(PInvFont\);)B
528 4870(DictStore \(FD, key, ReadOnly \(dict\)\);)B
528 4710(DictStore \(dict, Fid, MakeFontID \(\)\);)B
528 4550(return Push \(OpStack, ReadOnly \(dict\)\);)B
360 4390(})B
7920 14310(struct font_entry)B
7920 14150({)B
8088 13990(Object font;)B
8088 13830(Matrix mat;)B
8088 13670(int fid;)B
8088 13510(struct font_entry *font_next;)B
8004 13350(} *font_list = NULL;)B
7920 13030(#define EqFont\(m,n\) \(m.A == n.A && m.B == n.B && m.C == n.C && m.D == n.D\))B
7920 12710(Object LookupFont \(font, matrix\))B
8340 12550(Object font;)B
8340 12390(Matrix matrix;)B
7920 12230({)B
8088 12070(Object res, mat, new;)B
8088 11910(Matrix m, n;)B
8088 11750(struct font_entry *p, *fe;)B
8088 11590(int fid = BodyFontID \(DictLoad \(font, Fid\)\);)B
8088 11270(mat = DictLoad \(font, FontMatrix\);)B
8088 11110(ExtractMatrix \(&m, mat\);)B
8088 10950(n = MatMult \(matrix, m\);)B
8088 10630(for \(p = font_list; p != NULL; p = p->font_next\))B
8256 10470(if \(p->fid == fid && EqFont \(p->mat, n\)\) {)B
8424 10310(Message \("font matched"\);)B
8424 10150(return p->font;)B
8256 9990(})B
8088 9830(Message \("building a font dict"\);)B
8088 9510(copyDict \(font, res = MakeDict \(maxDict \(font\)\)\);)B
8088 9350(new = MakeArray \(\(Object *\) Malloc \(\(unsigned\) 6 * sizeof \(Object\)\), 6\);)B
8088 9190(VOID AssignMatrix \(new, n\);)B
8088 9030(DictStore \(res, FontMatrix, new\);)B
8088 8710(res = ReadOnly \(res\);)B
8088 8390(fe = \(struct font_entry *\) Malloc \(sizeof \(struct font_entry\)\);)B
8088 8230(fe->mat = n;)B
8088 8070(fe->font = res;)B
8088 7910(fe->font_next = font_list;)B
8088 7750(fe->fid = fid;)B
8088 7590(font_list = fe;)B
8088 7270(return res;)B
7920 7110(})B
7920 6790(static int PScaleFont \(font, scale\))B
8340 6630(Object font, scale;)B
7920 6470({)B
8088 6310(Object res;)B
8088 6150(float s = BodyReal \(scale\);)B
8088 5990(Matrix m;)B
8088 5670(if \(!CheckFont \(font\)\))B
8256 5510(return Error \(PInvFont\);)B
8088 5350(NewMatrix\(m, s, 0.0, 0.0, s, 0.0, 0.0\);)B
8088 5190(res = LookupFont \(font, m\);)B
8088 4870(return Push \(OpStack, res\);)B
7920 4710(})B
7920 4390(static int PMakeFont \(font, matrix\))B
EndPage
HfDict begin ep end
%%Page: ? 29
HfDict begin bp end
StartPage
Landscape
()(font.c)[(89/04/06)(12:02:33)](4)Gaudy
0 F
780 14470(Object font, matrix;)B
360 14310({)B
528 14150(Object res;)B
528 13990(Matrix m;)B
528 13670(if \(!CheckFont \(font\)\))B
696 13510(return Error \(PInvFont\);)B
528 13350(ExtractMatrix \(&m, matrix\);)B
528 13190(res = LookupFont \(font, m\);)B
528 12870(return Push \(OpStack, res\);)B
360 12710(})B
360 12390(static Vector *GetMetrics \(v, ob\))B
780 12230(Vector *v;)B
780 12070(Object ob;)B
360 11910({)B
528 11750(if \(TypeOf \(ob\) == Integer || TypeOf \(ob\) == Real\) {)B
696 11590(MakeVector \(v, BodyFloat \(ob\), 0.0, 0.0\);)B
528 11430(} else if \(TypeOf \(ob\) != Array\) {)B
696 11270(MakeVector \(v, 0.0, 0.0, 1.0\);)B
528 11110(} else if \(lengthArray \(ob\) == 2\) {)B
696 10950(MakeVector \(v, BodyFloat \(getArray \(ob, 1\)\), 0.0, 0.0\);)B
528 10790(} else if \(lengthArray \(ob\) == 4\) {)B
696 10630(MakeVector \(v, BodyFloat \(getArray \(ob, 2\)\),)B
1704 10470(BodyFloat \(getArray \(ob, 3\)\), 0.0\);)B
528 10310(} else {)B
696 10150(MakeVector \(v, 0.0, 0.0, 1.0\);)B
528 9990(})B
528 9670(return v;)B
360 9510(})B
360 9350(/*)B
444 9190(* BZS - some small changes to allow macrification of DictLoad\(\))B
444 9030(*/)B
360 8870(static int BuildHershey \(font, code\))B
780 8710(Object font, code;)B
360 8550({)B
528 8390(Vector vtmp, *met;)B
528 8230(Object *bbox, string, nm, tmp;)B
528 8070(unsigned char *s;)B
528 7910(Path p;)B
528 7750(Matrix *mp;)B
528 7590(int \(*func\)\(\);)B
528 7430(register float a,b,c,d,tx,ty;)B
528 7270(register int x,y, i, l;)B
528 6950(tmp = DictLoad \(font, FontBBox\);)B
528 6790(bbox )B
84(= BodyArray \(tmp\);)X
528 6630(tmp = DictLoad \(font, Encoding\);)B
528 6470(nm )B
252(= BodyArray \(tmp\) [BodyInteger \(code\)];)X
528 6310(/*)B
612 6150(* met )B
588(= GetMetrics \(DictLoad \(DictLoad \(font, Metrics\), nm\)\);)X
612 5990(*/)B
528 5830(tmp = DictLoad\(font,Metrics\);)B
528 5670(met = GetMetrics\(&vtmp, DictLoad\(tmp,nm\)\);)B
528 5510(met->vx -= 2; /* hershey bodge - they look better closer */)B
528 5350(/*)B
612 5190(* string )B
336(= DictLoad \(DictLoad \(font, CharStrings\), nm\);)X
612 5030(*/)B
528 4870(tmp = DictLoad\(font,CharStrings\);)B
528 4710(string = DictLoad\(tmp,nm\);)B
528 4390(SetCacheDevice \(nm, NewUserPoint \(met->vx, met->vy\),)B
9432 14470(BodyReal \(bbox[0]\), BodyReal \(bbox[1]\),)B
9432 14310(BodyReal \(bbox[2]\), BodyReal \(bbox[3]\)\);)B
8088 13990(if \(TypeOf \(string\) != String\) return TRUE;)B
8088 13830(gstate->line_width = 1.5;)B
8088 13670(gstate->line_join = 2;)B
8088 13510(gstate->line_cap = 0;)B
8088 13350(gstate->dash_length = 0;)B
8088 13030(s = BodyString \(string\);)B
8088 12870(l = lengthString \(string\) / 2;)B
8088 12710(p = gstate->path;)B
8088 12390(VOID PNewPath \(\);)B
8088 12230(mp = &gstate->CTM;)B
8088 12070(a = mp->A; b = mp->B; c = mp->C; d = mp->D; tx = mp->tx; ty = mp->ty;)B
8088 11910(for \(i = 0; i < l; i++\) {)B
8256 11750(HardPoint po;)B
8256 11590(func = \(*s & MOVETO\) ? MoveTo : LineTo;)B
8256 11430(x = \(*s++ & ~MOVETO\) - 64;)B
8256 11270(y = \(*s++ & ~MOVETO\) - 73;)B
8256 11110(po.hx = x*a + y*c + tx;)B
8256 10950(po.hy = x*b + y*d + ty;)B
8256 10790(\(*func\)\(p,po\);)B
8088 10630(})B
8088 10470(return Push \(ExecStack, Cvx \(NameFrom \("stroke"\)\)\);)B
7920 10310(})B
7920 9990(/*)B
8592 9830(Persistent state important across a BuildChar call-back)B
9264 9670(InShow )B
756(- the fact that we're in a call back)X
9264 9510(gstate )B
756(- graphics state)X
9264 9350(ccache )B
756(- the current cache device)X
9264 9190(gstate->device )B
84(- whether a cache device has been set or not.)X
10776 9030(The old device if a cache device is)B
10776 8870(installed.)B
10776 8710(The old CTM.)B
9264 8550(Width )B
840(- current width information - used for)X
10860 8390(moving cp)B
9264 8230(awx, awy)B
672(- shim adjustment parameters)X
9264 8070(scode,)B
9264 7910(axcode, aycode)B
168(- spacing adjustment parameters)X
8592 7590(XXXXXXX         XXXXXX         XXXXXXXXXX         XXXXXXXXX)B
8592 7430(XXXXXXX         XXXXXX         XXXXXXXXXX         XXXXXXXXX)B
8592 7270(XXXXXXX         XXXXXX         XXXXXXXXXX         XXXXXXXXX)B
8592 7110(XXXXXXX         XXXXXX         XXXXXXXXXX         XXXXXXXXX)B
8592 6950(XXXXXXX         XXXXXX         XXXXXXXXXX         XXXXXXXXX)B
9180 6790(|_______|      |_______|          |_______|)B
9516 6630(|)B
9264 6470(ashow/widthshow width vector)B
8592 6150(ShowUser shows the first character \(to avoid a leading gap\).)B
9936 5990(It may have to call buildchar if the character)B
9936 5830(is not cached. )B
8592 5670(ShowString finishes off a BuildChar \(if necessary\))B
9936 5510(then shows gaps and characters until it encounters)B
9936 5350(one which is not cached.)B
9264 5190(It then stacks:)B
9936 5030(a stopped context to reset things if an error occurs.)B
9936 4870(another ShowString to continue output.)B
9936 4710(A buildchar to build a character)B
7920 4550(*/)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(font.c)[(89/04/06)(12:02:33)](5)Gaudy
0 F
360 14470(static int Show \(string, space, shim, space_shim\))B
780 14310(Object string;)B
780 14150(char space;)B
780 13990(HardPoint shim, space_shim;)B
360 13830({)B
528 13670(if \(!gstate->cp_defined\))B
696 13510(return Error \(PNoCurrentPoint\);)B
528 13190(switch \(fonttypeCache\) {)B
528 13030(case FONT_USER:)B
696 12870(return ShowUser \(string, fontmatrixCache, space, shim,)B
2124 12710(space_shim\);)B
528 12390(default:)B
696 12230(return Error \(PInvFont\);)B
528 12070(})B
360 11910(})B
360 11590(static int ShowStopped \(\))B
360 11430({)B
528 11270(VOID Pop \(ExecStack\);)B
528 11110(VOID Push \(OpStack, False\);)B
528 10950(return TRUE;)B
360 10790(})B
360 10470(int ShowUser \(string, m, space, shim, space_shim\))B
780 10310(Object string;)B
780 10150(Matrix m;)B
780 9990(char space;)B
780 9830(HardPoint shim, space_shim;)B
360 9670({)B
528 9510(unsigned char *s = BodyString \(string\);)B
528 9350(int l = lengthString \(string\);)B
528 9030(if \(l == 0\))B
696 8870(return TRUE;)B
528 8550(/* GSave \(\); */)B
528 8230(++gstate->show;)B
528 8070(gstate->show->InShow = TRUE;)B
528 7910(gstate->show->shim = shim;)B
528 7750(gstate->show->space_shim = space_shim;)B
528 7590(gstate->show->space = space;)B
528 7430(gstate->show->mat = gstate->CTM;)B
528 7110(gstate->CTM.tx = gstate->cp.hx;)B
528 6950(gstate->CTM.ty = gstate->cp.hy;)B
528 6630(gstate->CTM = MatMult \(m, gstate->CTM\);)B
528 6470(FindCache \(\);)B
528 6150(UpdateControl \(gstate->device->dev, FALSE\);)B
528 5830(gstate->cp.hx = gstate->CTM.tx;)B
528 5670(gstate->cp.hy = gstate->CTM.ty;)B
528 5510(if \(CacheShow \(encodingCache [*s], gstate->cp\)\))B
696 5350(return ShowStringAux \(string, s, l, gstate->show->Width\);)B
528 5030(UpdateControl \(gstate->device->dev, TRUE\);)B
528 4710(GSave \(\);)B
528 4550(VOID Push \(ExecStack, OpShowStop\);)B
528 4390(PStopped \(OpShowString\);)B
8088 14470(VOID Push \(OpStack, string\);)B
8088 14310(VOID Push \(OpStack, gstate->font\);)B
8088 14150(VOID Push \(OpStack, MakeInteger \(*s\)\);)B
8088 13990(VOID Push \(ExecStack, DictLoad \(gstate->font, BuildChar\)\);)B
8088 13830(return TRUE;)B
7920 13670(})B
7920 13350(static int ShowString \(string\))B
8340 13190(Object string;)B
7920 13030({)B
8088 12870(int l = lengthString \(string\);)B
8088 12710(unsigned char *st = BodyString \(string\);)B
8088 12550(UserPoint last_width;)B
8088 12230(Pop \(ExecStack\);)B
8088 12070(Pop \(ExecStack\);)B
8088 11910(Pop \(ExecStack\);)B
8088 11750(GRestore \(\);)B
8088 11430(UpdateControl \(gstate->device->dev, FALSE\);)B
8088 11110(last_width = gstate->show->Width;)B
8088 10950(CacheShow \(encodingCache [*st], gstate->cp\);)B
8088 10630(return ShowStringAux \(string, st, l, last_width\);)B
7920 10470(})B
7920 10150(ShowStringAux \(string, st, l, last_width\))B
8340 9990(Object string;)B
8340 9830(unsigned char *st;)B
8340 9670(int l;)B
8340 9510(UserPoint last_width;)B
7920 9350({)B
8088 9190(unsigned char *s = st;)B
8088 9030(HardPoint loc;)B
8088 8710(loc.hx = gstate->CTM.tx; loc.hy = gstate->CTM.ty;)B
8088 8550(for \(;;\) {)B
8256 8390(int code = *++s;)B
8256 8230(HardPoint offset;)B
8256 7910(offset = Adjust \(DExtToInt \(last_width\), code\);)B
8256 7750(loc.hx += offset.hx;)B
8256 7590(loc.hy += offset.hy;)B
8256 7430(if \(--l == 0\))B
8424 7270(break;)B
8256 7110(if \(!CacheShow \(encodingCache [code], loc\)\) {)B
8424 6950(gstate->cp = loc;)B
8424 6790(gstate->CTM.tx = loc.hx; gstate->CTM.ty = loc.hy;)B
8424 6470(VOID Push \(ExecStack, OpShowStop\);)B
8424 6310(PStopped \(OpShowString\);)B
8424 5990(VOID Push \(OpStack, getIString \(string, s - st, l\)\);)B
8424 5670(VOID Push \(OpStack, gstate->font\);)B
8424 5510(VOID Push \(OpStack, MakeInteger \(*s\)\);)B
8424 5350(VOID Push \(ExecStack, DictLoad \(gstate->font,)B
11112 5190(BuildChar\)\);)B
8424 5030(UpdateControl \(gstate->device->dev, TRUE\);)B
8424 4710(GSave \(\);)B
8424 4390(return TRUE;)B
EndPage
HfDict begin ep end
%%Page: ? 30
HfDict begin bp end
StartPage
Landscape
()(font.c)[(89/04/06)(12:02:33)](6)Gaudy
0 F
696 14470(})B
696 14310(last_width = gstate->show->Width;)B
528 14150(})B
528 13990(gstate->CTM.tx = loc.hx; gstate->CTM.ty = loc.hy;)B
528 13830(UpdateControl \(gstate->device->dev, TRUE\);)B
528 13510(return ShowStopAux \(\);)B
360 13350(})B
360 13030(static int ShowStop \(st\))B
780 12870(Object st;)B
360 12710({)B
528 12550(GRestore \(\);)B
528 12390(ShowStopAux \(\);)B
528 12230(if \(BodyBool \(st\)\))B
696 12070(return PStop \(\);)B
528 11910(return TRUE;)B
360 11750(})B
360 11430(ShowStopAux \(\))B
360 11270({)B
528 11110(HardPoint cp;)B
528 10790(cp.hx = gstate->CTM.tx;)B
528 10630(cp.hy = gstate->CTM.ty;)B
528 10470(/* GRestore \(\); */)B
528 10310(gstate->CTM = gstate->show->mat;)B
528 10150(--gstate->show;)B
528 9990(gstate->cp = cp;)B
528 9670(return TRUE;)B
360 9510(})B
360 9190(static int PShow \(string\))B
780 9030(Object string;)B
360 8870({)B
528 8710(return Show \(string, 0, zeroHardPoint, zeroHardPoint\);)B
360 8550(})B
360 8230(static int PWidthShow \(x, y, code, string\))B
780 8070(Object x, y, code, string;)B
360 7910({)B
528 7750(return Show \(string, BodyInteger \(code\), zeroHardPoint,)B
1620 7590(DExtToInt \(NewUserPoint \(BodyReal \(x\), BodyReal \(y\)\)\)\);)B
360 7430(})B
360 7110(static int PAShow \(ax, ay, string\))B
780 6950(Object ax, ay, string;)B
360 6790({)B
528 6630(return Show \(string, 0, DExtToInt \(NewUserPoint \(BodyReal \(ax\),)B
4644 6470(BodyReal \(ay\)\)\),)B
1620 6310(zeroHardPoint\);)B
360 6150(})B
360 5830(static int PAWidthShow \(x, y, code, ax, ay, string\))B
780 5670(Object x, y, code, ax, ay, string;)B
360 5510({)B
528 5350(return Show \(string,)B
1620 5190(BodyInteger \(code\),)B
1620 5030(DExtToInt \(NewUserPoint \(BodyReal \(x\), BodyReal \(y\)\)\),)B
1620 4870(DExtToInt \(NewUserPoint \(BodyReal \(ax\), BodyReal \(ay\)\)\)\);)B
360 4710(})B
360 4390(static int PStringWidth \(string\))B
8340 14470(Object string;)B
7920 14310({)B
8088 14150(Matrix m;)B
8088 13990(Vector *v, vtmp;)B
8088 13830(Object *enc, met, tmp;)B
8088 13670(int i, l = lengthString \(string\);)B
8088 13510(unsigned char *s = BodyString \(string\);)B
8088 13350(float x = 0, y = 0;)B
8088 13030(if \(!CheckFont \(gstate->font\)\))B
8256 12870(return Error \(PInvFont\);)B
8088 12710(tmp = DictLoad \(gstate->font, FontType\);)B
8088 12550(if \(BodyInteger \(tmp\) == 3\) {)B
8256 12390(VOID Push \(OpStack, string\);)B
8256 12230(VOID Push \(ExecStack, Cvx \(NameFrom \(".stringwidth"\)\)\);)B
8256 12070(return TRUE;)B
8088 11910(})B
8088 11750(tmp = DictLoad \(gstate->font, Encoding\);)B
8088 11590(enc = BodyArray \(tmp\);)B
8088 11430(met = DictLoad \(gstate->font, Metrics\);)B
8088 11270(for \(i = 0; i < l; i++\) {)B
8256 11110(v = GetMetrics \(&vtmp, DictLoad \(met, enc[s[i]]\)\);)B
8256 10950(x += v->vx;)B
8256 10790(y += v->vy;)B
8088 10630(})B
8088 10470(ExtractMatrix \(&m, DictLoad \(gstate->font, FontMatrix\)\);)B
8088 10310(vtmp = Transform \(NewVector \(x, y, 0.0\), m\);)B
8088 10150(return Push \(OpStack, MakeReal \(vtmp.vx\)\), Push \(OpStack,)B
12204 9990(MakeReal \(vtmp.vy\)\);)B
7920 9830(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(font.h)[(89/03/24)(05:57:29)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13670(extern Object Fid, FD, FontMatrix, FontType, Encoding, FontBBox, FontName;)B
360 13510(extern Object UserShow, CharStrings, Metrics;)B
EndPage
HfDict begin ep end
%%Page: ? 31
HfDict begin bp end
StartPage
Landscape
()(graphics.h)[(89/03/24)(05:59:34)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(#include "device.h")B
360 13670(#include "point.h")B
360 13510(#include "font.h")B
360 13190(#ifndef PI)B
360 13030(#define PI \(float\) 3.14159265358979)B
360 12870(#endif)B
360 12550(#define MAXDASH)B
84(11)X
360 12230(#define MAXGSAVES)B
588(20)X
360 11910(#define BBOX_LEFT)B
588(0)X
360 11750(#define BBOX_TOP)B
672(1)X
360 11590(#define BBOX_RIGHT)B
504(2)X
360 11430(#define BBOX_BOTTOM)B
420(3)X
360 11110(struct show_context)B
360 10950({)B
528 10790(char InShow;)B
528 10630(char space;)B
528 10470(UserPoint Width;)B
528 10310(HardPoint shim, space_shim;)B
528 10150(Object CharName;)B
528 9990(struct cache *ccache;)B
528 9830(Matrix mat;)B
360 9670(};)B
360 9350(struct state)B
360 9190({)B
528 9030(Matrix CTM;)B
528 8870(Colour colour;)B
528 8710(HardPoint cp; int cp_defined;)B
528 8550(Path path;)B
528 8390(Path clip;)B
528 8230(Object font;)B
528 8070(float line_width;)B
528 7910(int line_cap;)B
528 7750(int line_join;)B
528 7590(struct {)B
696 7430(float frequency, rotation, *thresh;)B
696 7270(int count;)B
696 7110(Object spot_function;)B
528 6950(} screen;)B
528 6790(struct {)B
696 6630(Object transfn;)B
696 6470(float *tran;)B
696 6310(int tcount;)B
528 6150(} transfer;)B
528 5990(int flatness;)B
528 5830(float miter_limit;)B
528 5670(float dash_offset, dash_array [MAXDASH];)B
528 5510(int dash_length;)B
528 5350(struct device *device;)B
528 5190(struct show_context *show;)B
528 5030(struct device *clipdevice;)B
360 4870(};)B
360 4550(extern struct state *gstate;)B
7920 14470(extern int stroke_method, fill_method;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(gsave.c)[(89/03/24)(06:01:22)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(static struct state gstate_stack [MAXGSAVES];)B
360 11590(struct state *gstate = gstate_stack;)B
360 11270(static int gstate_height = 0;)B
360 10950(int GSave \(\), GRestore \(\), GRestoreAll \(\);)B
360 10630(InitGSave \(\))B
360 10470({)B
528 10310(InstallOp \("gsave",)B
924(GSave, )X
756(0, 0, 0, 0\);)X
528 10150(InstallOp \("grestore",)B
672(GRestore, )X
504(0, 0, 0, 0\);)X
528 9990(InstallOp \("grestoreall",)B
420(GRestoreAll, )X
252(0, 0, 0, 0\);)X
528 9670(gstate->screen.count = 0;)B
420(/* stops thresh getting freed accidentally */)X
528 9510(gstate->transfer.tcount = 0;)B
168(/* stops tran getting freed accidentally */)X
360 9350(})B
360 9030(int GSave \(\))B
360 8870({)B
528 8710(if \(gstate_height == MAXGSAVES - 1\))B
696 8550(return Error \(PLimitCheck\);)B
528 8390(gstate_stack [gstate_height + 1] = gstate_stack [gstate_height];)B
528 8230(++gstate_height; ++gstate;)B
528 8070(gstate->path = PathCopy \(gstate->path\);)B
528 7910(gstate->clip = PathCopy \(gstate->clip\);)B
528 7750(LinkDevice \(gstate->device\);)B
528 7590(LinkDevice \(gstate->clipdevice\);)B
528 7430(++gstate->screen.count;)B
528 7270(++gstate->transfer.tcount;)B
528 6950(return TRUE;)B
360 6790(})B
360 6470(int GRestore \(\))B
360 6310({)B
528 6150(if \(gstate_height == 0\))B
696 5990(VOID InitGraphics \(\);)B
528 5830(else {)B
696 5670(int sflag = FALSE, tflag = FALSE;)B
696 5350(UnlinkDevice \(gstate->device\);)B
696 5190(UnlinkDevice \(gstate->clipdevice\);)B
696 5030(PathFree \(gstate->path\);)B
696 4870(PathFree \(gstate->clip\);)B
696 4550(if \(gstate->screen.count == 1\) {)B
864 4390(Free \(\(char *\) gstate->screen.thresh\);)B
8424 14470(sflag = TRUE;)B
8256 14310(})B
8256 14150(if \(gstate->transfer.tcount == 1\) {)B
8424 13990(Free \(\(char *\) gstate->transfer.tran\);)B
8424 13830(tflag = TRUE;)B
8256 13670(})B
8256 13510(--gstate_height;)B
8256 13350(--gstate;)B
8256 13190(if \(sflag\))B
8424 13030(SetScreen \(gstate->screen.frequency, gstate->screen.rotation, gstate->screen.thresh)B
8256 12870(if \(tflag\))B
8424 12710(SetTransfer \(gstate->transfer.tran\);)B
8256 12550(\(void\) SetClipHardware \(gstate->device->dev,)B
10272 12390(\(gstate->clipdevice ? gstate->clipdevice->dev : \(struct hardw)B
8088 12230(})B
8088 11910(return TRUE;)B
7920 11750(})B
7920 11430(int GRestoreAll \(\))B
7920 11270({)B
8088 11110(while \(gstate != gstate_stack\))B
8256 10950(VOID GRestore \(\);)B
8088 10790(InitGraphics \(\);)B
8088 10470(return TRUE;)B
7920 10310(})B
EndPage
HfDict begin ep end
%%Page: ? 32
HfDict begin bp end
StartPage
Landscape
()(hard.h)[(89/03/24)(06:02:39)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(#include "mat.h")B
360 13670(#include "rop.h")B
360 13510(#include "colour.h")B
360 13350(#include "path.h")B
360 13030(typedef struct device_point { int dx, dy; } DevicePoint;)B
360 12710(struct hardware)B
360 12550({)B
528 12390(union hard {)B
696 12230(char *addr;)B
696 12070(int handle;)B
528 11910(} hard;)B
528 11750(int flags;)B
528 11590(DevicePoint extent;)B
528 11430(HardPoint realsize;)B
528 11270(struct hardware *aux, *clip;)B
528 11110(short touched;)B
528 10950(short changed;)B
360 10790(};)B
360 10470(extern struct hardware *HardwareFromString \(\), *NewBitmapHardware \(\);)B
360 10310(extern struct hardware *NewWindowHardware \(\), *InitHardware \(\);)B
360 10150(extern DevicePoint HardwareExtent \(\);)B
360 9990(extern unsigned char *StringFromHardware \(\);)B
360 9670(extern void BitBlt \(\), BitBltBlob \(\), BitBltLine \(\), DestroyHardware \(\);)B
360 9510(extern void HardUpdate \(\), UpdateControl \(\);)B
360 9350(extern Matrix DeviceMatrix \(\);)B
360 9030(extern void RasterTile \(\), BitBltTrapezoid \(\);)B
360 8710(extern int IsWindowHardware \(\), TransferSize \(\);)B
360 8550(extern void SetTransfer \(\);)B
360 8390(extern void Paint \(\), PaintLine \(\), PaintTrapezoid \(\);)B
360 8230(extern int ScreenSize \(\);)B
360 8070(extern void BuildScreen \(\), SetScreen \(\);)B
360 7910(extern DevicePoint NewDevicePoint \(\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(icon.h)[(89/01/20)(18:18:57)](1)Gaudy
0 F
360 14470(#define icon_width 40)B
360 14310(#define icon_height 40)B
360 14150(static char icon_bits[] = {)B
612 13990(0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,)B
612 13830(0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x44, 0x00, 0x00, 0x00,)B
612 13670(0x00, 0x44, 0x80, 0x18, 0x00, 0x20, 0x44, 0x80, 0x24, 0x40, 0x20, 0x3c,)B
612 13510(0xc0, 0x05, 0x00, 0x70, 0x84, 0xb1, 0xc4, 0x59, 0x27, 0x44, 0x8a, 0x48,)B
612 13350(0x55, 0x29, 0x44, 0xb2, 0x50, 0x44, 0x29, 0x44, 0xa2, 0x50, 0x44, 0x29,)B
612 13190(0x84, 0x99, 0x92, 0x45, 0x27, 0x0e, 0x00, 0x0c, 0x00, 0x01, 0x00, 0x00,)B
612 13030(0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,)B
612 12870(0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x22,)B
612 12710(0x00, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x00, 0x22, 0x00, 0x04,)B
612 12550(0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x62, 0x17, 0x75, 0x49, 0x67,)B
612 12390(0x52, 0xa5, 0x54, 0x55, 0x55, 0x12, 0xa3, 0x34, 0x55, 0x13, 0x12, 0x41,)B
612 12230(0x14, 0x22, 0x11, 0x12, 0x46, 0x64, 0x22, 0x16, 0x07, 0x00, 0x00, 0x00,)B
612 12070(0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,)B
612 11910(0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x18, 0x00, 0x00, 0x12, 0x9d,)B
612 11750(0x13, 0x00, 0x00, 0xa2, 0xb4, 0x10, 0x00, 0x00, 0x42, 0xa4, 0x13, 0x00,)B
612 11590(0x00, 0xa2, 0x34, 0x12, 0x00, 0x00, 0x16, 0x9d, 0x1b, 0x00, 0x00, 0x00,)B
612 11430(0x04, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00};)B
EndPage
HfDict begin ep end
%%Page: ? 33
HfDict begin bp end
StartPage
Landscape
()(image.c)[(89/04/06)(12:03:39)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(static int RealImage \(\);)B
360 11750(static int RealImageMask \(\);)B
360 11430(struct hardware *ScaleBitmap \(\);)B
360 11110(InitImage \(\))B
360 10950({)B
528 10790(InstallOp \("realimage",)B
588(RealImage,)X
504(5, 0, 0, 0,)X
1452 10630(Integer, Integer, Integer, Array, String\);)B
528 10470(InstallOp \("realimagemask",)B
252(RealImageMask,)X
168(5, 0, 0, 0,)X
1452 10310(Integer, Integer, Bool, Array, String\);)B
360 10150(})B
360 9830(static int RealImageMask \(width, height, invert, mat, string\))B
780 9670(Object width, height, invert, mat, string;)B
360 9510({)B
528 9350(Matrix m, m2;)B
528 9190(Vector origin, right, bottom;)B
528 9030(int w = BodyInteger \(width\), h = BodyInteger \(height\);)B
528 8870(int inv = BodyBool \(invert\), l = lengthString \(string\);)B
528 8710(int dwidth, dheight;)B
528 8550(unsigned char *s = BodyString \(string\);)B
528 8230(VOID GSave \(\);)B
528 8070(if \(!ExtractMatrix \(&m, mat\)\))B
696 7910(return Error \(PTypeCheck\);)B
528 7750(if \(l != \(w + 7\) / 8 * h || w < 0 || h < 0\))B
696 7590(return Error \(PRangeCheck\);)B
528 7430(if \(w == 0 || h == 0\))B
696 7270(return TRUE;)B
528 7110(m = MatInvert \(m\);)B
528 6950(gstate->CTM = m2 = MatMult \(m, gstate->CTM\);)B
528 6790(origin = Transform \(NewVector \(0.0, 0.0, 1.0\), m2\);)B
528 6630(right  = Transform \(NewVector \(\(float\) w, 0.0, 1.0\), m2\);)B
528 6470(bottom = Transform \(NewVector \(0.0, \(float\) h, 1.0\), m2\);)B
528 6150(/*)B
336(fprintf \(stderr, "origin = \(%g, %g\), right = \(%g, %g\), bottom = \(%g, %g\)\\n", orig)X
612 5990(* fprintf \(stderr, "matrix == [%g %g %g %g %g %g]\\n", m2.A, m2.B, m2.C, m2.D, m2.tx, m)B
528 5670(dwidth = \(int\) \(right.vx - origin.vx\);)B
528 5510(dheight = \(int\) \(bottom.vy - origin.vy\);)B
528 5190(if \(origin.vx == bottom.vx && origin.vy == right.vy &&)B
864 5030(dwidth > 0 && dheight > 0/* && dwidth >= w && dheight >= h*/\) {)B
696 4870(/* simple orientation */)B
696 4710(struct hardware *from, *to;)B
696 4390(from = HardwareFromString \(s, w, h\);)B
8256 14470(if \(!inv\))B
8424 14310(BitBlt \(from, from,)B
9096 14150(NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\),)B
9096 13990(HardwareExtent \(from\), ROP_NOTSOURCE\);)B
8256 13830(if \(dwidth != w || dheight != h\) {)B
8424 13670(to = ScaleBitmap \(from, \(float\) dwidth / w,)B
9936 13510(\(float\) dheight / h\);)B
8424 13350(DestroyHardware \(from\);)B
8256 13190(})B
8256 13030(else)B
8424 12870(to = from;)B
8256 12550(Paint \(to, gstate->device->dev,)B
8844 12390(NewDevicePoint \(0, 0\),)B
8844 12230(NewDevicePoint \(\(int\) origin.vx, \(int\) origin.vy\),)B
8844 12070(NewDevicePoint \(dwidth, dheight\),)B
8844 11910(gstate->colour\);)B
8256 11750(DestroyHardware \(to\);)B
8088 11590(})B
8088 11430(else)B
8256 11270(DrawBitmap \(s, w, h, inv\);)B
8088 11110(VOID GRestore \(\);)B
8088 10790(return TRUE;)B
7920 10630(})B
7920 10310(DrawBitmap \(s, width, height, inv\))B
8340 10150(unsigned char *s;)B
8340 9990(int width, height, inv;)B
7920 9830({)B
8088 9670(int w, h;)B
8088 9350(VOID PNewPath \(\);)B
8088 9030(for \(h = 0; h < height; h++\))B
8256 8870(for \(w = 0; w < width; w++\))B
8424 8710(if \(\(\(s [h * \(width >> 3\) + \(w >> 3\)] & \(1 << \(7 - \(w & 0x7\)\)\)\) != 0\) == inv\))B
8592 8550(FillUnitBox \(w, h\);)B
7920 8390(})B
7920 8070(void Tile \(t, h\))B
8340 7910(struct hardware *t, *h;)B
7920 7750({)B
8088 7590(DevicePoint xt, xh;)B
8088 7430(int i, sw, sh;)B
8088 7110(xt = HardwareExtent \(t\);)B
8088 6950(xh = HardwareExtent \(h\);)B
8088 6630(BitBlt \(t, h, NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\), xt,)B
8760 6470(ROP_SOURCE\);)B
8088 6150(sw = xt.dx;)B
8088 5990(for \(i = sw;;\) {)B
8256 5830(BitBlt \(h, h, NewDevicePoint \(0, 0\), NewDevicePoint \(i, 0\),)B
8928 5670(NewDevicePoint \(sw, xt.dy\), ROP_SOURCE\);)B
8256 5510(if \(i >= xh.dx\))B
8424 5350(break;)B
8256 5190(i += sw;)B
8256 5030(sw <<= 1;)B
8088 4870(})B
8088 4550(sh = xt.dy;)B
8088 4390(for \(i = sh;;\) {)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(image.c)[(89/04/06)(12:03:39)](2)Gaudy
0 F
696 14470(BitBlt \(h, h, NewDevicePoint \(0, 0\), NewDevicePoint \(0, i\),)B
1368 14310(NewDevicePoint \(xh.dx, sh\), ROP_SOURCE\);)B
696 14150(if \(i >= xh.dy\))B
864 13990(break;)B
696 13830(i += sh;)B
696 13670(sh <<= 1;)B
528 13510(})B
360 13350(})B
360 13030(void FillMask \(h, mask, width\))B
780 12870(struct hardware *h;)B
780 12710(char mask;)B
780 12550(int width;)B
360 12390({)B
528 12230(struct hardware *m;)B
528 11910(mask <<= 8 - width;)B
528 11590(m = HardwareFromString \(&mask, width, 1\);)B
528 11270(Tile \(m, h\);)B
528 10950(DestroyHardware \(m\);)B
360 10790(})B
360 10470(struct hardware *UnpaddedHardwareFromString \(s, w, h\))B
780 10310(unsigned char *s;)B
780 10150(int w, h;)B
360 9990({)B
528 9830(struct hardware *thin;)B
528 9670(struct hardware *res;)B
528 9510(int i;)B
528 9190(if \(w & 7 == 0\))B
696 9030(return HardwareFromString \(s, w, h\);)B
528 8710(thin = HardwareFromString \(s, w * h, 1\);)B
528 8550(res = NewBitmapHardware \(w, h\);)B
528 8230(for \(i = 0; i < h; i++\))B
696 8070(BitBlt \(thin, res, NewDevicePoint \(i * w, 0\),)B
1368 7910(NewDevicePoint \(0, i\), NewDevicePoint \(w, 1\),)B
1368 7750(ROP_SOURCE\);)B
528 7430(DestroyHardware \(thin\);)B
528 7270(return res;)B
360 7110(})B
360 6790(static void VerticalReverseImage \(h\))B
780 6630(struct hardware *h;)B
360 6470({)B
528 6310(DevicePoint ex;)B
528 6150(int i, n;)B
528 5830(ex = HardwareExtent \(h\);)B
528 5510(n = ex.dy;)B
528 5190(for \(i = 0; i < n / 2; i++\))B
696 5030(BitBlt \(h, h, NewDevicePoint \(0, i\),)B
1368 4870(NewDevicePoint \(0, n - i - 1\),)B
1368 4710(NewDevicePoint \(ex.dx, 1\), ROP_XOR\),)B
696 4550(BitBlt \(h, h, NewDevicePoint \(0, n - i - 1\),)B
1368 4390(NewDevicePoint \(0, i\),)B
8928 14470(NewDevicePoint \(ex.dx, 1\), ROP_XOR\),)B
8256 14310(BitBlt \(h, h, NewDevicePoint \(0, i\),)B
8928 14150(NewDevicePoint \(0, n - i - 1\),)B
8928 13990(NewDevicePoint \(ex.dx, 1\), ROP_XOR\);)B
7920 13830(})B
7920 13510(static int RealImage \(width, height, depth, mat, string\))B
8340 13350(Object width, height, depth, mat, string;)B
7920 13190({)B
8088 13030(Matrix m, m2;)B
8088 12870(Vector origin, right, bottom;)B
8088 12710(int w = BodyInteger \(width\), h = BodyInteger \(height\);)B
8088 12550(int vrev = 0, dep = BodyInteger \(depth\), l = lengthString \(string\);)B
8088 12390(int dwidth, dheight;)B
8088 12230(unsigned char *s = BodyString \(string\);)B
8088 11910(VOID GSave \(\);)B
8088 11750(if \(!ExtractMatrix \(&m, mat\)\))B
8256 11590(return Error \(PTypeCheck\);)B
8088 11430(if \(l != \(w * dep + 7\) / 8 * h || w < 0 || h < 0\))B
8256 11270(return Error \(PRangeCheck\);)B
8088 11110(if \(w == 0 || h == 0\))B
8256 10950(return TRUE;)B
8088 10790(m = MatInvert \(m\);)B
8088 10630(gstate->CTM = m2 = MatMult \(m, gstate->CTM\);)B
8088 10470(origin = Transform \(NewVector \(0.0, 0.0, 1.0\), m2\);)B
8088 10310(right  = Transform \(NewVector \(\(float\) w, 0.0, 1.0\), m2\);)B
8088 10150(bottom = Transform \(NewVector \(0.0, \(float\) h, 1.0\), m2\);)B
8088 9830(dwidth = \(int\) \(right.vx - origin.vx\);)B
8088 9670(dheight = \(int\) \(bottom.vy - origin.vy\);)B
8088 9350(if \(dheight < 0\))B
8256 9190(origin.vy += \(float\) dheight, right.vy += \(float\)dheight,)B
8256 9030(++vrev, dheight = -dheight;)B
8088 8710(/* fprintf \(stderr, "origin.vx = %g, origin.vy = %g, bottom.vx = %g, right.vy = %g, dwi)B
8172 8550(* origin.vx, origin.vy, bottom.vx, right.vy, dwidth, dheight, w, h\); */)B
8088 8230(if \(dep != 16 && \(int\) origin.vx == \(int\) bottom.vx && \(int\) origin.vy == \(int\) right.v)B
8424 8070(dwidth > 0 && dheight > 0/* && dwidth >= w && dheight >= h */\) {)B
8256 7910(/* simple orientation */)B
8256 7750(struct hardware *from , *to;)B
8256 7430(if \(dep == 1\) {)B
8424 7270(from = HardwareFromString \(s, w, h\);)B
8424 7110(if \(vrev\))B
8592 6950(VerticalReverseImage \(from\);)B
8424 6790(if \(dwidth != w || dheight != h\) {)B
8592 6630(to = ScaleBitmap \(from, \(float\) dwidth / w,)B
10104 6470(\(float\) dheight / h\);)B
8592 6310(DestroyHardware \(from\);)B
8424 6150(})B
8424 5990(else)B
8592 5830(to = from;)B
8424 5510(Paint \(to, gstate->device->dev,)B
9012 5350(NewDevicePoint \(0, 0\),)B
9012 5190(NewDevicePoint \(\(int\) origin.vx,)B
10356 5030(\(int\) origin.vy\),)B
9012 4870(NewDevicePoint \(dwidth, dheight\),)B
9012 4710(NewGray \(1.0\)\);)B
8424 4550(BitBlt \(to, to,)B
9096 4390(NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\),)B
EndPage
HfDict begin ep end
%%Page: ? 34
HfDict begin bp end
StartPage
Landscape
()(image.c)[(89/04/06)(12:03:39)](3)Gaudy
0 F
1536 14470(NewDevicePoint \(dwidth, dheight\),)B
1536 14310(ROP_NOTSOURCE\);)B
864 14150(Paint \(to, gstate->device->dev,)B
1452 13990(NewDevicePoint \(0, 0\),)B
1452 13830(NewDevicePoint \(\(int\) origin.vx,)B
2796 13670(\(int\) origin.vy\),)B
1452 13510(NewDevicePoint \(dwidth, dheight\),)B
1452 13350(NewGray \(0.0\)\);)B
864 13190(DestroyHardware \(to\);)B
696 13030(} else {)B
864 12870(struct hardware *mask, *new, *temp;)B
864 12710(int i, j;)B
864 12390(from = HardwareFromString \(s, w * dep, h\);)B
864 12230(if \(vrev\))B
1032 12070(VerticalReverseImage \(from\);)B
864 11910(new = HardwareFromString \(s, w, h\);)B
864 11750(mask = NewBitmapHardware \(w * dep, h\);)B
864 11590(temp = NewBitmapHardware \(w * dep, h\);)B
864 11270(for \(i = 0; i < \(1<<dep\); i++\) {)B
1032 11110(FillMask \(mask, i, dep\);)B
1032 10790(BitBlt \(from, mask, NewDevicePoint \(0, 0\),)B
1704 10630(NewDevicePoint \(0, 0\),)B
1704 10470(HardwareExtent \(from\), ROP_NXOR\);)B
1032 10310(BitBlt \(NULL, temp, NewDevicePoint \(0, 0\),)B
1704 10150(NewDevicePoint \(0, 0\),)B
1704 9990(HardwareExtent \(temp\), ROP_TRUE\);)B
1032 9830(for \(j = 0; j < dep; j++\))B
1200 9670(BitBlt \(mask, temp,)B
1872 9510(NewDevicePoint \(j, 0\),)B
1872 9350(NewDevicePoint \(0, 0\),)B
1872 9190(HardwareExtent \(mask\),)B
1872 9030(ROP_AND\);)B
1032 8870(for \(j = 0; j < w; j++\))B
1200 8710(BitBlt \(temp, new,)B
1872 8550(NewDevicePoint \(j * dep, 0\),)B
1872 8390(NewDevicePoint \(j, 0\),)B
1872 8230(NewDevicePoint \(1, h\),)B
1872 8070(ROP_SOURCE\);)B
1032 7910(to = ScaleBitmap \(new, \(float\) dwidth / w,)B
2544 7750(\(float\) dheight / h\);)B
1032 7590(Paint \(to, gstate->device->dev,)B
1620 7430(NewDevicePoint \(0, 0\),)B
1620 7270(NewDevicePoint \(\(int\) origin.vx,)B
2964 7110(\(int\) origin.vy\),)B
1620 6950(NewDevicePoint \(dwidth, dheight\),)B
1620 6790(NewGray \(\(float\) i / \(\(1 << dep\)- 1\)\)\);)B
1032 6630(DestroyHardware \(to\);)B
864 6470(})B
864 6310(DestroyHardware \(from\);)B
864 6150(DestroyHardware \(mask\);)B
864 5990(DestroyHardware \(temp\);)B
864 5830(DestroyHardware \(new\);)B
696 5670(})B
528 5510(} else {)B
696 5350(if \(vrev\))B
864 5190(origin.vy += \(float\) dheight,)B
864 5030(right.vy += \(float\) dheight, dheight = -dheight;)B
696 4870(DrawColourBitmap \(s, w, h, dep\);)B
528 4710(})B
528 4550(VOID GRestore \(\);)B
8088 14470(return TRUE;)B
7920 14310(})B
7920 13990(DrawColourBitmap \(s, width, height, depth\))B
8340 13830(unsigned char *s;)B
8340 13670(int width, height, depth;)B
7920 13510({)B
8088 13350(int w, h, c, i;)B
8088 13030(VOID PNewPath \(\);)B
8088 12710(switch\(depth\) {)B
8256 12550(case 16:)B
8424 12390(i = 0;)B
8424 12230(for \(h = 0; h < height; h++\))B
8592 12070(for \(w = 0; w < width; w++\) {)B
8760 11910(gstate->colour = NewColour \(0.0, 0.0,)B
9096 11750(\(float\) \(\(s[i] << 8\) | s[i+1]\) / \(1 << 16\)\);)B
8760 11590(FillUnitBox\(w, h\);)B
8760 11430(i += 2;)B
8592 11270(})B
8424 11110(break;)B
8256 10950(case 8:)B
8424 10790(for \(c = 0; c < 256; c++\) {)B
8592 10630(gstate->colour = NewColour \(0.0, 0.0,\(float\) c/255\);)B
8592 10470(i = 0;)B
8592 10310(for \(h = 0; h < height; h++\))B
8760 10150(for \(w = 0; w < width; w++\))B
8928 9990(if \(c == s[i++]\) FillUnitBox\(w, h\);)B
8424 9830(})B
8424 9670(break;)B
8256 9510(case 4:)B
8424 9350(for \(c = 0; c < 16; c++\) {)B
8592 9190(gstate->colour = NewColour \(0.0, 0.0,\(float\) c/15\);)B
8592 9030(i = 0;)B
8592 8870(for \(h = 0; h < height; h++\) {)B
8760 8710(for \(w = 0; w < width; w++\))B
8928 8550(if\(c == \(\(s[i+\(w>>1\)] >> \(\(1-\(w&1\)<<2\)\)\) & 15\)\) FillUnitBox\(w,h\);)B
8760 8390(i += width>>1;)B
8592 8230(})B
8424 8070(})B
8424 7910(break;)B
8256 7750(case 2:)B
8424 7590(for \(c = 0; c < 4; c++\) {)B
8592 7430(gstate->colour = NewColour \(0.0, 0.0,\(float\) c/3\);)B
8592 7270(i = 0;)B
8592 7110(for \(h = 0; h < height; h++\) {)B
8760 6950(for \(w = 0; w < width; w++\))B
8928 6790(if \(c == \(\(s[i+\(w>>2\)] >> \(\(3-\(w&3\)\)<<1\)\) & 3\)\) FillUnitBox\(w,h\);)B
8760 6630(i += width>>2;)B
8592 6470(})B
8424 6310(})B
8424 6150(break;)B
8256 5990(case 1:)B
8424 5830(gstate->colour = NewColour \(0.0, 0.0, 0.0\);)B
8424 5670(i = 0;)B
8424 5510(for \(h = 0; h < height; h++\) {)B
8592 5350(for \(w = 0; w < width; w++\))B
8760 5190(if \(0 == \(\(s[i+\(w>>3\)] >> \(7-\(w&7\)\)\) & 1\)\) FillUnitBox\(w,h\);)B
8592 5030(i += width>>3;)B
8424 4870(})B
8424 4710(break;)B
8088 4550(})B
7920 4390(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(image.c)[(89/04/06)(12:03:39)](4)Gaudy
0 F
360 14310(FillUnitBox \(w, h\))B
780 14150(int w, h;)B
360 13990({)B
528 13830(Matrix *m;)B
528 13670(float a,b,c,d,x,y;)B
528 13510(HardPoint P;)B
528 13190(x = \(float\) w;  y = \(float\) h;)B
528 13030(m = &gstate->CTM;)B
528 12870(a = m->A;  b = m->B;  c = m->C;  d = m->D;)B
528 12710(P.hx = x*a + y*c + m->tx;)B
528 12550(P.hy = x*b + y*d + m->ty;  VOID MoveTo \(gstate->path, P\);)B
528 12390(P.hx += a;  P.hy += b;     VOID LineTo \(gstate->path, P\);)B
528 12230(P.hx += c;  P.hy += d;     VOID LineTo \(gstate->path, P\);)B
528 12070(P.hx -= a;  P.hy -= b;     VOID LineTo \(gstate->path, P\);)B
528 11910(VOID ClosePath \(gstate->path\);)B
528 11750(VOID Fill \(\);)B
360 11590(})B
360 11270(struct hardware *ScaleBitmap \(from, xscale, yscale\))B
780 11110(struct hardware *from;)B
780 10950(float xscale, yscale;)B
360 10790({)B
528 10630(struct hardware *middle, *middle2, *high, *high2;)B
528 10470(int i, w, h, dwidth, dheight, ixscale, iyscale;)B
528 10310(DevicePoint extent;)B
528 9990(extent = HardwareExtent \(from\);)B
528 9830(w = extent.dx; h = extent.dy;)B
528 9670(dwidth = \(int\) \(\(float\) w * xscale + 0.5\);)B
528 9510(dheight = \(int\) \(\(float\) h * yscale + 0.5\);)B
528 9190(if \(dwidth > w\) {)B
696 9030(middle = NewBitmapHardware \(dwidth, h\);)B
696 8870(for \(i = 0; i < w; i++\))B
864 8710(BitBlt \(from, )B
336(middle,)X
1536 8550(NewDevicePoint \(i, 0\),)B
1536 8390(NewDevicePoint \(\(int\) \(i*xscale\), 0\),)B
1536 8230(NewDevicePoint \(1, h\),)B
1536 8070(ROP_OR\);)B
696 7910(middle2 = NewBitmapHardware \(dwidth, h\);)B
696 7750(ixscale = \(int\) \(\(float\) dwidth / w + 0.5\); )B
696 7590(for \(i = 0; i < ixscale + 1; i++\))B
864 7430(BitBlt \(middle, middle2,)B
1536 7270(NewDevicePoint \(0, 0\), NewDevicePoint \(i, 0\),)B
1536 7110(NewDevicePoint \(dwidth - ixscale + 1, h\),)B
1536 6950(ROP_OR\);)B
696 6790(DestroyHardware \(middle\);)B
528 6630(} else {)B
696 6470(middle2 = NewBitmapHardware \(dwidth, h\);)B
696 6310(for \(i = 0; i < dwidth; i++\))B
864 6150(BitBlt \(from, )B
336(middle2,)X
1536 5990(NewDevicePoint \(\(int\) \(i/xscale\), 0\),)B
1536 5830(NewDevicePoint \(i, 0\),)B
1536 5670(NewDevicePoint \(1, h\),)B
1536 5510(ROP_OR\);)B
528 5350(})B
528 5030(if \(dheight > h\) {)B
696 4870(high = NewBitmapHardware \(dwidth, dheight\);)B
696 4710(for \(i = 0; i < h; i++\))B
864 4550(BitBlt \(middle2, high,)B
1536 4390(NewDevicePoint \(0, i\),)B
9096 14470(NewDevicePoint \(0, \(int\) \(i*yscale\)\),)B
9096 14310(NewDevicePoint \(dwidth, 1\),)B
9096 14150(ROP_OR\);)B
8256 13990(DestroyHardware \(middle2\);)B
8256 13670(high2 = NewBitmapHardware \(dwidth, dheight\);)B
8256 13510(iyscale = \(int\) \(\(float\) dheight / h + 0.5\);)B
8256 13350(for \(i = 0; i < iyscale + 1; i++\))B
8424 13190(BitBlt \(high, )B
336(high2, )X
9096 13030(NewDevicePoint \(0, 0\), NewDevicePoint \(0, i\),)B
9096 12870(NewDevicePoint \(dwidth, dheight - iyscale + 1\),)B
9096 12710(ROP_OR\);)B
8256 12550(DestroyHardware \(high\);)B
8088 12390(} else {)B
8256 12230(high2 = NewBitmapHardware \(dwidth, dheight\);)B
8256 12070(for \(i = 0; i < dheight; i++\))B
8424 11910(BitBlt \(middle2, high2,)B
9096 11750(NewDevicePoint \(0, \(int\) \(i/yscale\)\),)B
9096 11590(NewDevicePoint \(0, i\),)B
9096 11430(NewDevicePoint \(dwidth, 1\),)B
9096 11270(ROP_OR\);)B
8088 11110(})B
8088 10950(return high2;)B
7920 10790(})B
EndPage
HfDict begin ep end
%%Page: ? 35
HfDict begin bp end
StartPage
Landscape
()(integer.c)[(89/03/24)(06:47:37)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include <signal.h>)B
360 12230(#include "main.h")B
360 11910(static Object OpFor;)B
360 11590(static int For \(\), PFor \(\), Eq \(\), Lt \(\), Le \(\), Gt \(\), Ge \(\), Not \(\);)B
360 11430(static int And \(\), Or \(\), Xor \(\), BitShift \(\), Abs \(\), Add \(\), Sub \(\);)B
360 11270(static int Mul \(\), Div \(\), Mod \(\), Neg \(\), Exp \(\), Sqrt \(\), Sin \(\);)B
360 11110(static int Cos \(\), Atan \(\), Ln \(\), Log \(\), Identity \(\), Cvr \(\), Cvs \(\);)B
360 10950(static int EqEq \(\);)B
360 10630(static int WordSize, Word2, LowMask;)B
360 10310(#define Body\(O\) \(O.u.Integer\))B
360 9990(InitInteger \(\))B
360 9830({)B
528 9670(unsigned word;)B
528 9350(OpFor = MakeOp \("\(forinteger\)", For, 0, 1, 5, 6\);)B
528 9030(TypeInstallOp \(Integer, "cvi",)B
672(Identity,)X
588(1, 1, 0, 0, Integer\);)X
528 8870(TypeInstallOp \(Integer, "cvr",)B
672(Cvr,)X
1008(1, 1, 0, 0, Integer\);)X
528 8710(TypeInstallOp \(Integer, "cvs",)B
672(Cvs,)X
1008(2, 1, 0, 0, Integer,)X
1788 8550(String\);)B
528 8390(TypeInstallOp \(Integer, "==", )B
672(EqEq,)X
924(1, 0, 0, 0, Integer\);)X
528 8230(TypeInstallOp \(Integer, "for",)B
672(PFor, )X
840(4, 0, 0, 6, Integer,)X
1788 8070(Integer, Integer, Array\);)B
528 7910(TypeInstallOp \(Integer, "eq",)B
756(Eq,)X
1092(2, 1, 0, 0, Integer,)X
1788 7750(Integer\);)B
528 7590(TypeInstallOp \(Integer, "lt",)B
756(Lt,)X
1092(2, 1, 0, 0, Integer,)X
1788 7430(Integer\);)B
528 7270(TypeInstallOp \(Integer, "le",)B
756(Le,)X
1092(2, 1, 0, 0, Integer,)X
1788 7110(Integer\);)B
528 6950(TypeInstallOp \(Integer, "gt",)B
756(Gt,)X
1092(2, 1, 0, 0, Integer,)X
1788 6790(Integer\);)B
528 6630(TypeInstallOp \(Integer, "ge",)B
756(Ge,)X
1092(2, 1, 0, 0, Integer,)X
1788 6470(Integer\);)B
528 6310(TypeInstallOp \(Integer, "not",)B
672(Not,)X
1008(1, 1, 0, 0, Integer\);)X
528 6150(TypeInstallOp \(Integer, "and",)B
672(And,)X
1008(2, 1, 0, 0, Integer,)X
1788 5990(Integer\);)B
528 5830(TypeInstallOp \(Integer, "or",)B
756(Or,)X
1092(2, 1, 0, 0, Integer,)X
1788 5670(Integer\);)B
528 5510(TypeInstallOp \(Integer, "xor",)B
672(Xor,)X
1008(2, 1, 0, 0, Integer,)X
1788 5350(Integer\);)B
528 5190(TypeInstallOp \(Integer, "bitshift", )B
168(BitShift,)X
588(2, 1, 0, 0, Integer,)X
1788 5030(Integer\);)B
528 4870(TypeInstallOp \(Integer, "abs",)B
672(Abs,)X
1008(1, 1, 0, 0, Integer\);)X
528 4710(TypeInstallOp \(Integer, "add",)B
672(Add,)X
1008(2, 1, 0, 0, Integer,)X
1788 4550(Integer\);)B
528 4390(TypeInstallOp \(Integer, "sub",)B
672(Sub,)X
1008(2, 1, 0, 0, Integer,)X
9348 14470(Integer\);)B
8088 14310(TypeInstallOp \(Integer, "mul",)B
672(Mul,)X
1008(2, 1, 0, 0, Integer,)X
9348 14150(Integer\);)B
8088 13990(TypeInstallOp \(Integer, "div",)B
672(Div,)X
1008(2, 1, 0, 0, Integer,)X
9348 13830(Integer\);)B
8088 13670(TypeInstallOp \(Integer, "mod",)B
672(Mod,)X
1008(2, 1, 0, 0, Integer,)X
9348 13510(Integer\);)B
8088 13350(TypeInstallOp \(Integer, "neg",)B
672(Neg,)X
1008(1, 1, 0, 0, Integer\);)X
8088 13190(TypeInstallOp \(Integer, "exp",)B
672(Exp,)X
1008(2, 1, 0, 0, Integer,)X
9348 13030(Integer\);)B
8088 12870(TypeInstallOp \(Integer, "sqrt",)B
588(Sqrt,)X
924(1, 1, 0, 0, Integer\);)X
8088 12710(TypeInstallOp \(Integer, "sin",)B
672(Sin,)X
1008(1, 1, 0, 0, Integer\);)X
8088 12550(TypeInstallOp \(Integer, "cos",)B
672(Cos,)X
1008(1, 1, 0, 0, Integer\);)X
8088 12390(TypeInstallOp \(Integer, "atan", )B
504(Atan,)X
924(2, 1, 0, 0, Integer,)X
9348 12230(Integer\);)B
8088 12070(TypeInstallOp \(Integer, "ln",)B
756(Ln,)X
1092(1, 1, 0, 0, Integer\);)X
8088 11910(TypeInstallOp \(Integer, "log",)B
672(Log,)X
1008(1, 1, 0, 0, Integer\);)X
8088 11750(TypeInstallOp \(Integer, "ceiling", )B
252(Identity,)X
588(1, 1, 0, 0, Integer\);)X
8088 11590(TypeInstallOp \(Integer, "floor", )B
420(Identity,)X
588(1, 1, 0, 0, Integer\);)X
8088 11430(TypeInstallOp \(Integer, "round", )B
420(Identity,)X
588(1, 1, 0, 0, Integer\);)X
8088 11270(TypeInstallOp \(Integer, "truncate", )B
168(Identity,)X
588(1, 1, 0, 0, Integer\);)X
8088 10950(word = -1;)B
8088 10790(PanicIf \(word != ~0, "Need 2's complement machine! Sorry."\);)B
8088 10470(for \(WordSize = 0; word != 0; WordSize++\))B
8256 10310(word >>= 1;)B
8088 10150(Word2 = WordSize / 2;)B
8088 9990(LowMask = \(1<<Word2\) - 1;)B
7920 9830(})B
7920 9510(int StrictMul \(a, b\))B
8340 9350(int a, b;)B
7920 9190({)B
8088 9030(int atop, abot, btop, bbot, sum, signedp;)B
8088 8710(signedp = \(a < 0\) != \(b < 0\);)B
8088 8550(a = a < 0 ? -a : a;)B
8088 8390(b = b < 0 ? -b : b;)B
8088 8230(abot = a & LowMask;)B
8088 8070(bbot = b & LowMask;)B
8088 7910(atop = a >> Word2;)B
8088 7750(btop = b >> Word2;)B
8088 7590(sum = abot * btop + atop * bbot;)B
8088 7430(sum += \(\(unsigned\) \(abot * bbot\) >> Word2\);)B
8088 7270(sum = \(\(unsigned\) sum >> Word2\) + atop * btop;)B
8088 7110(if \(sum != 0 || a * b < 0\))B
8256 6950(kill \(getpid \(\), SIGFPE\);)B
8088 6790(return signedp ? -a * b : a * b;)B
7920 6630(})B
7920 6310(int StrictAdd \(a, b\))B
8340 6150(int a, b;)B
7920 5990({)B
8088 5830(if \(\(a < 0\) == \(b < 0\) && \(a < 0\) != \(a + b < 0\)\))B
8256 5670(kill \(getpid \(\), SIGFPE\);)B
8088 5510(return a + b;)B
7920 5350(})B
7920 5030(Object MakeInteger \(i\))B
8340 4870(int i;)B
7920 4710({)B
8088 4550(Object res;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(integer.c)[(89/03/24)(06:47:37)](2)Gaudy
0 F
528 14470(MakeObject \(res, Integer\);)B
528 14310(res.u.Integer = i;)B
528 13990(return res;)B
360 13830(})B
360 13510(static Object Make \(i\))B
780 13350(int i;)B
360 13190({)B
528 13030(Object res;)B
528 12710(MakeObject \(res, Integer\);)B
528 12550(res.u.Integer = i;)B
528 12230(return res;)B
360 12070(})B
360 11750(static int Cvr \(item\))B
780 11590(Object item;)B
360 11430({)B
528 11270(return Push \(OpStack, RealInteger \(item\)\);)B
360 11110(})B
360 10790(static int Cvs \(v, string\))B
780 10630(Object v, string;)B
360 10470({)B
528 10310(int length;)B
528 10150(char buf [BUFSIZE];)B
528 9830(VOID sprintf \(buf, "%d", BodyInteger \(v\)\);)B
528 9670(if \(\(length = strlen \(buf\)\) > lengthString \(string\)\))B
696 9510(return Error \(PRangeCheck\);)B
528 9350(VOID Bcopy \(BodyString \(string\), buf, length\);)B
528 9190(return Push \(OpStack, getIString \(string, 0, length\)\);)B
360 9030(})B
360 8710(static int EqEq \(v\))B
780 8550(Object v;)B
360 8390({)B
528 8230(printf \("%d", BodyInteger \(v\)\);)B
528 8070(return TRUE;)B
360 7910(})B
360 7590(Object IntReal \(o\))B
780 7430(Object o;)B
360 7270({)B
528 7110(return Make \(\(int\) BodyReal \(o\)\);)B
360 6950(})B
360 6630(static int PFor \(initial, increment, limit, proc\))B
948 6470(Object initial, increment, limit, proc;)B
360 6310({)B
528 6150(VOID Push \(ExecStack, Nil\);)B
528 5990(VOID Push \(ExecStack, increment\);)B
528 5830(VOID Push \(ExecStack, limit\);)B
528 5670(VOID Push \(ExecStack, initial\);)B
528 5510(VOID Push \(ExecStack, proc\);)B
528 5350(VOID Push \(ExecStack, OpFor\);)B
528 5030(return TRUE;)B
360 4870(})B
360 4550(static int For \(\))B
360 4390({)B
8088 14470(Object current, limit, increment, proc;)B
8088 14150(proc)B
840(= Pop \(ExecStack\);)X
8088 13990(current)B
588(= Pop \(ExecStack\);)X
8088 13830(limit)B
756(= Pop \(ExecStack\);)X
8088 13670(increment)B
420(= Pop \(ExecStack\);)X
8088 13350(if \(Body \(increment\) > 0)B
8424 13190(? Body \(current\) > Body \(limit\))B
8424 13030(: Body \(current\) < Body \(limit\)\))B
8256 12870(VOID Pop \(ExecStack\);)B
8088 12710(else {)B
8256 12550(VOID Push \(ExecStack, increment\);)B
8256 12390(VOID Push \(ExecStack, limit\);)B
8256 12230(VOID Push \(ExecStack, Make \(StrictAdd \(Body \(current\), Body \(increment\)\)\)\);)B
8256 12070(VOID Push \(ExecStack, proc\);)B
8256 11910(VOID Push \(ExecStack, OpFor\);)B
8256 11750(VOID Push \(ExecStack, proc\);)B
8256 11590(VOID Push \(OpStack, current\);)B
8088 11430(})B
8088 11270(return TRUE;)B
7920 11110(})B
7920 10790(static int Eq \(a, b\))B
8340 10630(Object a, b;)B
7920 10470({)B
8088 10310(return Push \(OpStack, MakeBool \(Body \(a\) == Body \(b\)\)\);)B
7920 10150(})B
7920 9830(static int Lt \(a, b\))B
8340 9670(Object a, b;)B
7920 9510({)B
8088 9350(return Push \(OpStack, MakeBool \(Body \(a\) < Body \(b\)\)\);)B
7920 9190(})B
7920 8870(static int Le \(a, b\))B
8340 8710(Object a, b;)B
7920 8550({)B
8088 8390(return Push \(OpStack, MakeBool \(Body \(a\) <= Body \(b\)\)\);)B
7920 8230(})B
7920 7910(static int Gt \(a, b\))B
8340 7750(Object a, b;)B
7920 7590({)B
8088 7430(return Push \(OpStack, MakeBool \(Body \(a\) > Body \(b\)\)\);)B
7920 7270(})B
7920 6950(static int Ge \(a, b\))B
8340 6790(Object a, b;)B
7920 6630({)B
8088 6470(return Push \(OpStack, MakeBool \(Body \(a\) >= Body \(b\)\)\);)B
7920 6310(})B
7920 5990(static int Not \(integer\))B
8340 5830(Object integer;)B
7920 5670({)B
8088 5510(return Push \(OpStack, Make \(~ Body \(integer\)\)\);)B
7920 5350(})B
7920 5030(static int And \(a, b\))B
8340 4870(Object a, b;)B
7920 4710({)B
8088 4550(return Push \(OpStack, Make \(Body \(a\) & Body \(b\)\)\);)B
7920 4390(})B
EndPage
HfDict begin ep end
%%Page: ? 36
HfDict begin bp end
StartPage
Landscape
()(integer.c)[(89/03/24)(06:47:37)](3)Gaudy
0 F
360 14310(static int Or \(a, b\))B
780 14150(Object a, b;)B
360 13990({)B
528 13830(return Push \(OpStack, Make \(Body \(a\) | Body \(b\)\)\);)B
360 13670(})B
360 13350(static int Xor \(a, b\))B
780 13190(Object a, b;)B
360 13030({)B
528 12870(return Push \(OpStack, Make \(Body \(a\) ^ Body \(b\)\)\);)B
360 12710(})B
360 12390(static int BitShift \(a, b\))B
780 12230(Object a, b;)B
360 12070({)B
528 11910(if \(Body \(b\) > 0\))B
696 11750(return Push \(OpStack, Make \(\(int\) \(\(unsigned\) Body \(a\) << Body \(b\)\)\)\);)B
528 11590(else)B
696 11430(return Push \(OpStack, Make \(\(int\) \(\(unsigned\) Body \(a\) >> \(-Body \(b\)\)\)\)\);)B
360 11270(})B
360 10950(static int Abs \(v\))B
780 10790(Object v;)B
360 10630({)B
528 10470(return Push \(OpStack, Make \(Body \(v\) >= 0 ? Body \(v\) : -Body \(v\)\)\);)B
360 10310(})B
360 9990(static int Add \(a, b\))B
780 9830(Object a, b;)B
360 9670({)B
528 9510(return Push \(OpStack, Make \(StrictAdd \(Body \(a\), Body \(b\)\)\)\);)B
360 9350(})B
360 9030(static int Sub \(a, b\))B
780 8870(Object a, b;)B
360 8710({)B
528 8550(return Push \(OpStack, Make \(StrictAdd \(Body \(a\), -Body \(b\)\)\)\);)B
360 8390(})B
360 8070(static int Mul \(a, b\))B
780 7910(Object a, b;)B
360 7750({)B
528 7590(return Push \(OpStack, Make \(StrictMul \(Body \(a\), Body \(b\)\)\)\);)B
360 7430(})B
360 7110(static int Div \(a, b\))B
780 6950(Object a, b;)B
360 6790({)B
528 6630(if \(Body \(b\) == 0\))B
696 6470(return Error \(PUnResult\);)B
528 6310(return Push \(OpStack, MakeReal \(\(float\) Body \(a\) / \(float\) Body \(b\)\)\);)B
360 6150(})B
360 5830(static int Mod \(a, b\))B
780 5670(Object a, b;)B
360 5510({)B
528 5350(if \(Body \(b\) == 0\))B
696 5190(return Error \(PUnResult\);)B
528 5030(return Push \(OpStack, Make \(Body \(a\) % Body \(b\)\)\);)B
360 4870(})B
360 4550(static int Neg \(a\))B
780 4390(Object a;)B
7920 14470({)B
8088 14310(return Push \(OpStack, Make \(-Body \(a\)\)\);)B
7920 14150(})B
7920 13830(static int Sqrt \(v\))B
8340 13670(Object v;)B
7920 13510({)B
8088 13350(if \(Body \(v\) < 0\))B
8256 13190(return Error \(PUnResult\);)B
8088 13030(return Push \(OpStack, MakeReal \(\(float\) sqrt \(\(double\) Body \(v\)\)\)\);)B
7920 12870(})B
7920 12550(static int Exp \(a, b\))B
8340 12390(Object a, b;)B
7920 12230({)B
8088 12070(return Push \(OpStack, MakeReal \(\(float\) pow \(\(double\) Body \(a\), \(double\) Body \(b\)\)\)\);)B
7920 11910(})B
7920 11590(static int Identity \(v\))B
8340 11430(Object v;)B
7920 11270({)B
8088 11110(return Push \(OpStack, v\);)B
7920 10950(})B
7920 10630(static int Sin \(v\))B
8340 10470(Object v;)B
7920 10310({)B
8088 10150(return Push \(OpStack, MakeReal \(\(float\) sin \(Rad \(\(double\) Body \(v\)\)\)\)\);)B
7920 9990(})B
7920 9670(static int Cos \(v\))B
8340 9510(Object v;)B
7920 9350({)B
8088 9190(return Push \(OpStack, MakeReal \(\(float\) cos \(Rad \(\(double\) Body \(v\)\)\)\)\);)B
7920 9030(})B
7920 8710(static int Atan \(a, b\))B
8340 8550(Object a, b;)B
7920 8390({)B
8088 8230(return Push \(OpStack, MakeReal \(\(float\) Deg \(atan2 \(\(double\) Body \(a\), \(double\) Body \(b)B
7920 8070(})B
7920 7750(static int Ln \(v\))B
8340 7590(Object v;)B
7920 7430({)B
8088 7270(return Push \(OpStack, MakeReal \(\(float\) log \(\(double\) Body \(v\)\)\)\);)B
7920 7110(})B
7920 6790(static int Log \(v\))B
8340 6630(Object v;)B
7920 6470({)B
8088 6310(return Push \(OpStack, MakeReal \(\(float\) log10 \(\(double\) Body \(v\)\)\)\);)B
7920 6150(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(main.c)[(89/04/04)(11:45:23)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include <signal.h>)B
360 12230(#include "main.h")B
360 11910(#define ERRORDICTSIZE)B
336(25)X
360 11590(Object PDictFull;)B
360 11430(Object PDictOverflow,)B
924(PInvFont,)X
1260(PSyntaxError;)X
360 11270(Object PDictUnderflow,)B
840(PInvRestore,)X
1008(PTypeCheck;)X
360 11110(Object PExecOverflow,)B
924(PIOError,)X
1260(PUndefined;)X
360 10950(Object PExecUnderflow,)B
840(PLimitCheck,)X
1008(PUnFilename;)X
360 10790(Object PInterrupt,)B
1176(PNoCurrentPoint,)X
672(PUnResult;)X
360 10630(Object PInvAccess,)B
1176(PRangeCheck,)X
1008(PUnMatched;)X
360 10470(Object PInvExit,)B
1344(POpOverflow,)X
1008(PUnregistered;)X
360 10310(Object PInvFileAccess,)B
840(POpUnderflow,)X
924(PVMError;)X
360 9990(Object Lbracket, Rbracket;)B
360 9830(Object OpInterp, ErrorDict;)B
360 9510(/* External variables for hashing statistics */)B
360 9350(extern int hash_tries, hash_collisions, hash_attempts;)B
360 9030(static int ErrorFn \(\);)B
360 8870(static Object InsErr \(\);)B
360 8710(static void InitErrors \(\), InitArguments \(\), Interpreter \(\);)B
360 8550(static Object OpError, error_name, execName;)B
360 8230(static catchint \(\);)B
360 8070(static int EnableInterrupts \(\);)B
360 7750(char *library = NULL;)B
360 7430(Object InitialObject = {READABLE|WRITEABLE};)B
360 7270(Object InitialExecObject = {READABLE|WRITEABLE|EXECUTABLE};)B
360 6950(static int files_present = 0, interrupted = FALSE, protected = 0;)B
360 6790(int interactive = FALSE, verbose = FALSE, RUNSYNC = FALSE, TESTING = FALSE;)B
360 6630(FILE *vfp = NULL;)B
360 6310(main \(argc, argv\))B
780 6150(int argc;)B
780 5990(char **argv;)B
360 5830({)B
528 5670(char profile[BUFSIZE], rcfile [BUFSIZE];)B
360 5510(#ifndef MACINTOSH)B
528 5350(char *getenv \(\);)B
360 5190(#endif)B
528 5030(FILE *fp;)B
528 4870(int here;)B
360 4550(#ifndef MACINTOSH)B
528 4390(library = getenv \("POSTSCRIPTLIB"\);)B
7920 14470(#endif)B
8088 14310(if \(library == NULL\) library = default_library;)B
8088 13990(VOID sprintf \(rcfile, "%s/psrc", library\);)B
7920 13670(#ifdef MACINTOSH)B
8088 13510(vfp = stderr;)B
7920 13350(#else)B
8088 13190(if \(close \(dup \(9\)\) == 0\) {)B
8256 13030(verbose = TRUE;)B
8256 12870(vfp = fdopen \(9, "w"\);)B
8088 12710(})B
7920 12550(#endif)B
8088 12230(Message \("POSTSCRIPT"\);)B
8088 11910(Init \(\);)B
8088 11750(Message \("Init Errors"\);)B
8088 11590(InitErrors \(\);)B
8088 11430(Message \("Init Arguments"\);)B
8088 11110(VOID Push \(ExecStack, Cvx \(NameFrom \("executive"\)\)\);)B
8088 10790(here = Height \(ExecStack\);)B
8088 10470(Install \("Library", StringFrom \(library\)\);)B
8088 10150(InitArguments \(argc, argv\);)B
7920 9990(#ifdef MACINTOSH)B
8088 9830(interactive = interactive || !files_present;)B
7920 9670(#else)B
8088 9510(interactive = interactive || isatty \(0\) && !files_present;)B
7920 9350(#endif)B
8088 9190(ReverseStack \(ExecStack, Height \(ExecStack\) - here\);)B
7920 8870(#ifndef MACINTOSH)B
8088 8710(VOID strcpy \(profile, getenv \("HOME"\) ? getenv \("HOME"\) : "/etc"\);)B
7920 8550(#endif)B
8088 8390(VOID strcat \(profile, "/.postscript"\);)B
8088 8070(if \(fp = fopen \(profile, "r"\)\))B
8256 7910(VOID Push \(ExecStack, Cvx \(FileFrom \(fp\)\)\);)B
8088 7590(if \(!interactive\))B
8256 7430(VOID Push \(ExecStack,)B
9180 7270(Cvx \(StringFrom \(files_present ?)B
10608 7110("/executive null def" :)B
10608 6950("/executive \(%stdin\) \(r\) file cvx def"\)\)\);)B
8088 6630(if \(TESTING\))B
8256 6470(VOID Push \(ExecStack,)B
8424 6310(Cvx \(StringFrom \("/showpage { copypage initgraphics erasepage } def"\)\)\);)B
8088 5990(if \(\(fp = fopen \(rcfile, "r"\)\) == NULL\))B
8256 5830(fprintf \(stderr, "%s: cannot open %s\\n", argv[0], rcfile\),)B
8256 5670(exit \(1\);)B
8088 5510(else)B
8256 5350(VOID Push \(ExecStack, Cvx \(FileFrom \(fp\)\)\);)B
8088 5190(InstallOp \("enableinterrupts",)B
672(EnableInterrupts, 0, 0, 0, 0\);)X
7920 5030(/*)B
504(SysDict = ReadOnly \(SysDict\);)X
252(*/)X
8088 4870(Message \("Entering Interpreter"\);)B
8088 4710(Interpreter \(\);)B
7920 4550(})B
EndPage
HfDict begin ep end
%%Page: ? 37
HfDict begin bp end
StartPage
Landscape
()(main.c)[(89/04/04)(11:45:23)](2)Gaudy
0 F
360 14470(Protect \(\))B
360 14310({)B
528 14150(++protected;)B
360 13990(})B
360 13670(Unprotect \(\))B
360 13510({)B
528 13350(--protected;)B
360 13190(})B
360 12870(static int EnableInterrupts \(\))B
360 12710({)B
528 12550(if \(interactive\))B
696 12390(VOID signal \(SIGINT, catchint\);)B
528 12230(return TRUE;)B
360 12070(})B
360 11750(static void InitArguments \(argc, argv\))B
780 11590(int argc;)B
780 11430(char **argv;)B
360 11270({)B
528 11110(int i, command = FALSE;)B
528 10790(for \(i = 1; i < argc; i++\) {)B
696 10630(FILE *fp;)B
696 10310(if \(command\) {)B
864 10150(command = FALSE;)B
864 9990(VOID Push \(ExecStack, Cvx \(StringFrom \(argv[i]\)\)\);)B
696 9830(})B
696 9670(else if \(*argv[i] == '-'\))B
864 9510(switch \(argv[i][1]\) {)B
864 9350(case 'n':)B
1032 9190(RUNSYNC = TRUE;)B
1032 9030(break;)B
864 8710(case 't':)B
1032 8550(TESTING = TRUE;)B
1032 8390(break;)B
864 8070(case 'i':)B
1032 7910(interactive = TRUE;)B
1032 7750(break;)B
864 7430(case 'c':)B
1032 7270(++files_present; )B
1032 7110(command = TRUE;)B
1032 6950(break;)B
864 6630(case 's': case '\\0':)B
1032 6470(++files_present;)B
1032 6310(VOID Push \(ExecStack, Cvx \(Fstdin\)\);)B
1032 6150(break;)B
864 5830(default:)B
1032 5670(fprintf \(stderr, "%s: unknown option '%c'\\n", argv[0],)B
1788 5510(argv[i][1]\);)B
1032 5350(exit \(1\);)B
864 5190(})B
696 5030(else {)B
864 4870(++files_present;)B
864 4710(if \(fp = Fopen \(argv[i], "r"\)\))B
1032 4550(VOID Push \(ExecStack, Cvx \(FileFrom \(fp\)\)\);)B
864 4390(else)B
8592 14470(fprintf \(stderr, "%s: cannot open %s\\n", argv[0],)B
9348 14310(argv[i]\);)B
8256 14150(})B
8088 13990(})B
7920 13830(})B
7920 13510(static void Interpreter \(\))B
7920 13350({)B
8088 13190(register Stack ExecSt,OpSt,DictSt;)B
8088 12870(Self = execName = NameFrom \("exec"\);)B
8088 12710(ExecSt = ExecStack;)B
8088 12550(OpSt = OpStack;)B
8088 12390(DictSt = DictStack;)B
8088 12070(while \(Height \(ExecSt\) != 0\) {)B
8256 11910(int res;)B
8256 11750(Object item, exop;)B
8256 11590(Type itype;)B
8256 11270(item = Pop \(ExecSt\);)B
8256 11110(if \(!xCheck \(item\)\))B
8424 10950(res = Push \(OpSt, item\);)B
8256 10790(else if \(\(itype = TypeOf \(item\)\) == Operator\))B
8424 10630(/* Marginally slower when inlined... */)B
8424 10470(res = ExecOperator\(item\);)B
8256 10310(else if \(itype == Array\) {)B
8424 10150(/* Arrays get special treatment for speed */)B
8424 9990(int l = lengthArray \(item\);)B
8424 9830(register Object *rp;)B
8424 9670(Type t;)B
8424 9350(if \(l != 0\) {)B
8592 9190(if\(ExecSt->stack_fill != ExecSt->stack_size\) {)B
8760 9030(rp = &ExecSt->stack_body[ExecSt->stack_fill++];)B
8760 8870(rp->type = Array;)B
8760 8710(rp->u.Integer = 0;)B
8760 8550(rp->u.Array = item.u.Array + 1;)B
8760 8390(rp->Length = l - 1;)B
8760 8230(rp->flags = item.flags;)B
8592 8070(})B
8592 7750(rp = BodyArray\(item\);)B
8592 7590(t = TypeOf\(*rp\);)B
8592 7430(if\(t == Name || t == Operator\) Push \(ExecSt, *rp\);)B
8592 7270(else                           Push \(OpSt, *rp\);)B
8424 7110(})B
8424 6950(res = TRUE;)B
8256 6790(})B
8256 6630(else if \(itype == Name\) {)B
8424 6470(/* Names get special treatment for speed */)B
8424 6310(Type dict;)B
8424 6150(struct dict_entry *hash;)B
8424 5990(int level,i,h,size,hashval;)B
8424 5670(/* Try to load the object from the dictionary */)B
8424 5510(/* Initialize information based solely on the item */)B
8424 5350(hashval = item.Length + BodyInteger\(item\) + \(int\) itype;)B
8424 5030(/* Search through the levels of the dict stack from the top down */)B
8424 4870(for \(level = Height \(DictSt\) - 1; level >= 0; level--\) {)B
8592 4710(dict = BodyDict\(DictSt->stack_body[level]\);)B
8592 4550(if \(\(size=dict->dict_size\) != 0\) {)B
8760 4390(hash = dict->dict_body;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(main.c)[(89/04/04)(11:45:23)](3)Gaudy
0 F
1200 14470(++hash_attempts;)B
1200 14310(i = h = hashval % size;)B
1200 13990(for\(;;\) {)B
1368 13830(if \(TypeOf \(hash[i].entry_key\) == Null\) break;)B
1368 13670(if \(DictEqual \(item, hash[i].entry_key\)\) {)B
1536 13510(++hash_tries;)B
1536 13350(item = hash[i].entry_value;)B
1536 13190(level = 0;)B
1536 13030(break;)B
1368 12870(})B
1368 12710(if \(++i == size\) i = 0;)B
1368 12550(if \(i == h\) break;)B
1368 12390(++hash_collisions;)B
1200 12230(})B
1032 12070(})B
864 11910(})B
864 11590(if \(!xCheck \(item\)\)  res = Push \(OpSt, item\);)B
864 11430(else if \(\(itype = TypeOf \(item\)\) == Operator\) res = ExecOperator \(item\);)B
864 11270(else if \(itype == Array\))B
168(res = ExecArray \(item\);)X
864 11110(else if \(itype == File\)   res = ExecFile \(item\);)B
864 10950(else {)B
1032 10790(res = Push \(OpSt, item\);)B
1032 10630(exop = Lookup \(TypeOf \(item\), execName\);)B
1032 10470(if \(TypeOf \(exop\) != Condition\))B
1200 10310(VOID Push \(ExecSt, exop\);)B
864 10150(})B
696 9990(})B
696 9830(else if \(itype == File\))B
864 9670(res = ExecFile \(item\);)B
696 9510(else {)B
864 9350(res = Push \(OpSt, item\);)B
864 9190(exop = Lookup \(TypeOf \(item\), execName\);)B
864 9030(if \(TypeOf \(exop\) != Condition\))B
1032 8870(VOID Push \(ExecSt, exop\);)B
696 8710(})B
696 8390(if \(interrupted && !protected\) {)B
864 8230(interrupted = FALSE;)B
864 8070(error_name = PInterrupt;)B
864 7910(res = FALSE;)B
696 7750(})B
696 7430(if \(!res\) {)B
864 7270(Object error_op;)B
864 6950(VOID Push \(OpSt, Self\);)B
864 6790(error_op = DictLoad \(ErrorDict, error_name\);)B
864 6630(if \(TypeOf \(error_op\) == Condition\))B
1032 6470(VOID Push \(ExecSt, OpError\);)B
864 6310(else)B
1032 6150(VOID Push \(ExecSt, error_op\);)B
864 5990(Cbreak \(TRUE\);)B
696 5830(})B
528 5670(})B
360 5510(})B
360 5190(static void InitErrors \(\))B
360 5030({)B
528 4870(ErrorDict = MakeDict \(ERRORDICTSIZE\);)B
528 4710(PDictFull = InsErr \(ErrorDict, "dictfull",)B
1680(ErrorFn\);)X
528 4550(PDictOverflow)B
84(= InsErr \(ErrorDict, "dictstackoverflow",)X
588(ErrorFn\);)X
528 4390(PDictUnderflow = InsErr \(ErrorDict, "dictstackunderflow",)B
420(ErrorFn\);)X
8088 14470(PExecOverflow)B
84(= InsErr \(ErrorDict, "execstackoverflow",)X
588(ErrorFn\);)X
8088 14310(PExecUnderflow = InsErr \(ErrorDict, "execstackunderflow",)B
420(ErrorFn\);)X
8088 14150(PInterrupt = InsErr \(ErrorDict, "interrupt",)B
1512(ErrorFn\);)X
8088 13990(PInvAccess = InsErr \(ErrorDict, "invalidaccess",)B
1176(ErrorFn\);)X
8088 13830(PInvExit = InsErr \(ErrorDict, "invalidexit",)B
1512(ErrorFn\);)X
8088 13670(PInvFileAccess = InsErr \(ErrorDict, "invalidfileaccess",)B
504(ErrorFn\);)X
8088 13510(PInvFont = InsErr \(ErrorDict, "invalidfont",)B
1512(ErrorFn\);)X
8088 13350(PInvRestore = InsErr \(ErrorDict, "invalidrestore",)B
1008(ErrorFn\);)X
8088 13190(PIOError = InsErr \(ErrorDict, "ioerror",)B
1848(ErrorFn\);)X
8088 13030(PLimitCheck = InsErr \(ErrorDict, "limitcheck",)B
1344(ErrorFn\);)X
8088 12870(PNoCurrentPoint = InsErr \(ErrorDict, "nocurrentpoint",)B
672(ErrorFn\);)X
8088 12710(PRangeCheck = InsErr \(ErrorDict, "rangecheck",)B
1344(ErrorFn\);)X
8088 12550(POpOverflow = InsErr \(ErrorDict, "stackoverflow",)B
1092(ErrorFn\);)X
8088 12390(POpUnderflow = InsErr \(ErrorDict, "stackunderflow",)B
924(ErrorFn\);)X
8088 12230(PSyntaxError = InsErr \(ErrorDict, "syntaxerror",)B
1176(ErrorFn\);)X
8088 12070(PTypeCheck = InsErr \(ErrorDict, "typecheck",)B
1512(ErrorFn\);)X
8088 11910(PUndefined = InsErr \(ErrorDict, "undefined",)B
1512(ErrorFn\);)X
8088 11750(PUnFilename = InsErr \(ErrorDict, "undefinedfilename",)B
756(ErrorFn\);)X
8088 11590(PUnResult)B
420(= InsErr \(ErrorDict, "undefinedresult",)X
756(ErrorFn\);)X
8088 11430(PUnMatched = InsErr \(ErrorDict, "unmatchedmark",)B
1176(ErrorFn\);)X
8088 11270(PUnregistered = InsErr \(ErrorDict, "unregistered",)B
1008(ErrorFn\);)X
8088 11110(PVMError = InsErr \(ErrorDict, "VMerror",)B
1848(ErrorFn\);)X
8088 10950(Install \("errordict", ErrorDict\);)B
8088 10790(OpError = MakeOp \("\(errorfn\)", ErrorFn, 1, 0, 0, 1, Name\);)B
7920 10630(})B
7920 10310(/*)B
8004 10150(* This is the code to deal with user interrupts.)B
8004 9990(* In order to do this cleanly, we effectively poll for interrupts in)B
8004 9830(* the main interpreter loop \(above\). Possibly any routine which could)B
8004 9670(* take an inordinate amount of time out of this loop should also poll)B
8004 9510(* the `interrupted' variable and generate an error if one is found.)B
8004 9350(* Currently none do - "run"ning a file is done by the interpreter)B
8004 9190(* above.)B
8004 9030(*)B
8004 8870(*/)B
7920 8550(static catchint \(\))B
7920 8390({)B
8088 8230(VOID signal \(SIGINT, catchint\);)B
8088 8070(interrupted = TRUE;)B
7920 7910(})B
7920 7590(int Interrupted \(\))B
7920 7430({)B
8088 7270(return interrupted && !protected;)B
7920 7110(})B
7920 6790(/*)B
8004 6630(*)B
504(An intrinsic operator generates an error condition by)X
8004 6470(*)B
504(returning FALSE.  The usual way to do this is to call Error)X
8004 6310(*)B
504(with the PostScript name of the error condition.)X
8004 6150(*)B
8004 5990(*/)B
7920 5670(static Object InsErr \(dict, name, fn\))B
8340 5510(Object dict;)B
8340 5350(unsigned char *name;)B
8340 5190(int \(*fn\)\(\);)B
7920 5030({)B
8088 4870(Object op;)B
8088 4550(DictStore \(dict, op = NameFrom \(name\), MakeOp \(name, fn, 1, 0, 0, 1, Name\)\);)B
8088 4390(return op;)B
EndPage
HfDict begin ep end
%%Page: ? 38
HfDict begin bp end
StartPage
Landscape
()(main.c)[(89/04/04)(11:45:23)](4)Gaudy
0 F
360 14470(})B
360 14150(static ErrorFn \(name\))B
780 13990(Object name;)B
360 13830({)B
528 13670(PrintName \(Self\);)B
528 13510(printf \(" in operator "\);)B
528 13350(PrintName \(name\);)B
528 13190(putchar \('\\n'\);)B
528 13030(return Push \(ExecStack, Cvx \(NameFrom \("stop"\)\)\);)B
360 12870(})B
360 12550(int Error \(error\))B
780 12390(Object error;)B
360 12230({)B
528 12070(error_name = error;)B
528 11910(return FALSE;)B
360 11750(})B
360 11430(int OpCheck \(args, res\))B
780 11270(int args, res;)B
360 11110({)B
528 10950(if \(OpStack->stack_fill < args\))B
696 10790(return Error \(POpUnderflow\);)B
528 10630(else if \(OpStack->stack_fill - args + res > OpStack->stack_size\))B
696 10470(return Error \(POpOverflow\);)B
528 10310(else)B
696 10150(return TRUE;)B
360 9990(})B
360 9670(Panic \(s\))B
780 9510(char *s;)B
360 9350({)B
528 9190(fprintf \(stderr, "PostScript panic: %s\\n", s\);)B
528 9030(fprintf \(stderr, "Please report this fault to the support person for this program\\n"\);)B
528 8870(Cleanup \(\);)B
528 8710(exit \(1\);)B
360 8550(})B
360 8230(Object Cvx \(o\))B
780 8070(Object o;)B
360 7910({)B
528 7750(o.flags |= EXECUTABLE;)B
528 7590(return o;)B
360 7430(})B
360 7110(Object Cvlit \(o\))B
780 6950(Object o;)B
360 6790({)B
528 6630(o.flags &= ~EXECUTABLE;)B
528 6470(return o;)B
360 6310(})B
360 5990(Object ExecOnly \(o\))B
780 5830(Object o;)B
360 5670({)B
528 5510(if \(o.type == Dictionary\))B
696 5350(o.u.Dictionary->dict_flags &= ~\(READABLE | WRITEABLE\);)B
528 5190(else)B
696 5030(o.flags &= ~\(READABLE | WRITEABLE\);)B
528 4870(return ReadOnly \(o\);)B
360 4710(})B
360 4390(Object ReadOnly \(o\))B
8340 14470(Object o;)B
7920 14310({)B
8088 14150(if \(o.type == Dictionary\))B
8256 13990(o.u.Dictionary->dict_flags &= ~WRITEABLE;)B
8088 13830(else)B
8256 13670(o.flags &= ~WRITEABLE;)B
8088 13510(return o;)B
7920 13350(})B
7920 13030(Object WriteOnly \(o\))B
8340 12870(Object o;)B
7920 12710({)B
8088 12550(if \(o.type == Dictionary\))B
8256 12390(o.u.Dictionary->dict_flags &= ~READABLE;)B
8088 12230(else)B
8256 12070(o.flags &= ~READABLE;)B
8088 11910(return o;)B
7920 11750(})B
7920 11430(Object SameFlags \(a, b\))B
8340 11270(Object a, b;)B
7920 11110({)B
8088 10950(b.flags = a.flags;)B
8088 10790(return b;)B
7920 10630(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(main.h)[(89/04/06)(12:04:14)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(#include <stdio.h>)B
360 13670(#include <math.h>)B
360 13510(#include <assert.h>)B
360 13350(#include <setjmp.h>)B
360 13190(#include <strings.h>)B
360 12870(#define NONE)B
1008(\(-2\))X
360 12710(#define EOS)B
1092('\\0')X
360 12550(#define TRUE)B
1008(1)X
360 12390(#define FALSE)B
924(0)X
360 12070(#ifdef BUFSIZE)B
360 11910(#undef BUFSIZE)B
360 11750(#endif)B
360 11590(#define BUFSIZE)B
504(1000)X
360 11430(#define STRSIZE      4000)B
360 11110(#ifndef unix)B
360 10950(#define MACINTOSH)B
360 10790(#endif)B
360 10470(#define VOID)B
336(\(void\))X
360 10150(#define READABLE)B
756(01)X
360 9990(#define WRITEABLE)B
672(02)X
360 9830(#define EXECUTABLE)B
588(04)X
360 9670(#define PERMANENT)B
588(010)X
360 9510(#define PIPED)B
924(020)X
360 9190(typedef struct dict_struct *Type;)B
360 8870(typedef struct object {)B
528 8710(int flags;)B
528 8550(Type type;)B
528 8390(int Length;)B
528 8230(union {)B
696 8070(int Integer, Bool, Font;)B
696 7910(float Real;)B
696 7750(Type Dictionary;)B
696 7590(unsigned char *String;)B
696 7430(struct name_struct *Name;)B
696 7270(struct op_struct *Operator;)B
696 7110(struct file_struct *File;)B
696 6950(struct object *Array;)B
528 6790(} u;)B
360 6630(} Object;)B
360 6310(struct name_struct)B
360 6150({)B
528 5990(struct name_struct *next;)B
528 5830(int string_length;)B
528 5670(unsigned char *string_body;)B
360 5510(};)B
360 5190(enum file_type { StringFile, StreamFile };)B
360 4870(struct file_struct {)B
528 4710(enum file_type file_type;)B
528 4550(int available;)B
528 4390(union {)B
8256 14470(unsigned char *c_ptr;)B
8256 14310(FILE)B
840(*f_ptr;)X
8088 14150(} f;)B
7920 13990(};)B
7920 13670(struct dict_entry { Object entry_key, entry_value; };)B
7920 13350(struct dict_struct {)B
8088 13190(int dict_flags, dict_size, dict_fill;)B
8088 13030(struct dict_entry *dict_body;)B
7920 12870(};)B
7920 12550(typedef struct stack {)B
8088 12390(int stack_fill, stack_size;)B
8088 12230(Object overflow, underflow, *stack_body;)B
7920 12070(} *Stack, StackOb;)B
7920 11750(struct op_struct {)B
8088 11590(Object name;)B
8088 11430(int \(*fn\)\(\), arguments, results, execpop, execpush, execuse;)B
8088 11270(Type *argtypes;)B
7920 11110(};)B
7920 10790(Object SameFlags \(\), Cvx \(\), Cvlit \(\);)B
7920 10630(Object ReadOnly \(\), WriteOnly \(\), ExecOnly \(\);)B
7920 10470(int OpCheck \(\);)B
7920 10310(Object MakeArray \(\), ParseArray \(\), getArray \(\), getIArray \(\), *BodyArray \(\);)B
7920 10150(Object MakeBool \(\);)B
7920 9830(Object MakeDict \(\), DictLoad \(\), Lookup \(\), DictFrom \(\), Load \(\);)B
7920 9670(Type MakeType \(\), TypeOf \(\), BodyDict \(\);)B
7920 9350(extern int EqTrue \(\), Equal \(\);)B
7920 9030(Object FileFrom \(\), FileString \(\);)B
7920 8710(int Getch \(\);)B
7920 8550(struct file_struct *BodyFile \(\);)B
7920 8390(Object MakeInteger \(\), IntReal \(\);)B
7920 8070(Object ParseNumber \(\);)B
7920 7910(float Deg \(\), Rad \(\);)B
7920 7750(Object ParseId \(\), NameFrom \(\), MakeName \(\), Cvn \(\), StringName \(\);)B
7920 7590(unsigned char *BodyName \(\);)B
7920 7430(Object MakeOp \(\), NameOperator \(\);)B
7920 7270(Object Parse \(\);)B
7920 6950(int PolyFirst \(\), PolySecond \(\), PolyThird \(\), PolyPair \(\);)B
7920 6630(Object MakeReal \(\), RealInteger \(\);)B
7920 6310(float BodyReal \(\), BodyFloat \(\);)B
7920 5990(extern char *malloc\(\);)B
7920 5830(extern int free\(\);)B
7920 5670(#define Malloc\(I\) malloc\(I\))B
7920 5510(#define Free\(S\) free\(S\))B
7920 5190(Object Where \(\), DictLookup \(\);)B
7920 4870(extern Object MakeString \(\), StringFrom \(\), getIString \(\);)B
7920 4710(extern Object ParseString \(\), ParseHexString \(\);)B
7920 4390(extern Object PDictFull;)B
EndPage
HfDict begin ep end
%%Page: ? 39
HfDict begin bp end
StartPage
Landscape
()(main.h)[(89/04/06)(12:04:14)](2)Gaudy
0 F
360 14470(extern Object PDictOverflow,)B
1008(PInvFont,)X
1260(PSyntaxError;)X
360 14310(extern Object PDictUnderflow,)B
924(PInvRestore,)X
1008(PTypeCheck;)X
360 14150(extern Object PExecOverflow,)B
1008(PIOError,)X
1260(PUndefined;)X
360 13990(extern Object PExecUnderflow,)B
924(PLimitCheck,)X
1008(PUnFilename;)X
360 13830(extern Object PInterrupt,)B
1260(PNoCurrentPoint,)X
672(PUnResult;)X
360 13670(extern Object PInvAccess,)B
1260(PRangeCheck,)X
1008(PUnMatched;)X
360 13510(extern Object PInvExit,)B
1428(POpOverflow,)X
1008(PUnregistered;)X
360 13350(extern Object PInvFileAccess,)B
924(POpUnderflow,)X
924(PVMError;)X
360 13030(extern Type Bool, Mark, String, Real, Poly, Operator;)B
360 12870(extern Type Name, File, Dictionary, Condition, Null, Integer;)B
360 12710(extern Type Array, Mark, Condition, Null, Float, FontID;)B
360 12390(extern Object SysDict, Absent, Nil;)B
360 12230(extern Object True, False, Marker, Self;)B
360 12070(extern Object OpInterp, Lbracket, Rbracket;)B
360 11910(extern Object StatementEdit, Fstdin, Fstdout, Fstderr;)B
360 11590(extern Stack OpStack, ExecStack, DictStack;)B
360 11430(extern jmp_buf env;)B
360 11270(extern int interactive, verbose;)B
360 11110(extern char default_library[], *library;)B
360 10950(extern FILE *vfp, *Fopen \(\);)B
360 10790(extern void Fclose \(\);)B
360 10470(/* Stack macros */)B
360 10310(#define Top\(S\))B
672(\(\(S\)->stack_body[\(S\)->stack_fill - 1]\))X
360 10150(#define Height\(S\)     \(\(S\)->stack_fill\))B
360 9990(#define MaxStack\(S\)   \(\(S\)->stack_size\))B
360 9830(#define Space\(S\)      \(\(S\)->stack_size - \(S\)->stack_fill\))B
360 9670(#define Pop\(S\) )B
588(\(\(S\)->stack_body[--\(S\)->stack_fill]\))X
360 9510(#define FastPush\(S,O\) \(\(S\)->stack_body[\(S\)->stack_fill]=\(O\),\(S\)->stack_fill++\))B
360 9350(#define Push\(S, O\)    \(\(\(S\)->stack_fill != \(S\)->stack_size\) ? \\)B
2208 9190(\(\(S\)->stack_body[\(S\)->stack_fill] = \(O\), \\)B
2208 9030(\(S\)->stack_fill++, TRUE\) : FALSE\))B
360 8710(/* File macros */)B
360 8550(extern int getchbuf;)B
360 8390(#define BodyFile\(file\)   \(\(file\).u.File\))B
360 8230(#define StatusFile\(file\) \(BodyFile\(file\)->available != 0\))B
360 8070(#define Getch\(file\) \\)B
528 7910(\(\(StatusFile\(file\) && BodyFile\(file\)->file_type == StreamFile\) \\)B
528 7750(? \(\(getchbuf = getc \(BodyFile\(file\)->f.f_ptr\)\), \\)B
696 7590(\(\(getchbuf != EOF\) ? getchbuf : \(\(BodyFile\(file\)->available = 0\), \\)B
3468 7430(Close \(file\), EOF\)\)\) \\)B
528 7270(: GeneralGetch \(file\)\))B
360 6950(/* Dictionary macros */)B
360 6790(Object DictFind\(\);)B
360 6630(#define DictLoad\(DICT,KEY\) DictFind\(\(DICT.u.Dictionary\)->dict_body,KEY,\\)B
3384 6470(\(DICT.u.Dictionary\)->dict_size\))B
360 6310(#define DictEqual\(A,B\) \(\(TypeOf\(A\) == TypeOf\(B\)\) && \\)B
2292 6150(\(A.Length == B.Length\) && \\)B
2292 5990(\(\(A.u.Integer == B.u.Integer\)|| \\)B
2376 5830(\(TypeOf\(A\) == Array\) && \(A.Length == 0\)\)\))B
360 5670(#define maxDict\(D\)     \(BodyDict\(D\)->dict_size\))B
360 5510(#define lengthDict\(D\)  \(BodyDict\(D\)->dict_fill\))B
360 5190(/* Flag macros */)B
360 5030(#define rCheck\(O\) \(\(O.type == Dictionary\) \\)B
2040 4870(? \(O.u.Dictionary->dict_flags & READABLE\) \\)B
2040 4710(: \(O.flags & READABLE\)\))B
360 4550(#define wCheck\(O\) \(\(O.type == Dictionary\) \\)B
2040 4390(? \(O.u.Dictionary->dict_flags & WRITEABLE\) \\)B
9600 14470(: \(O.flags & WRITEABLE\)\))B
7920 14310(#define xCheck\(O\) \(O.flags & EXECUTABLE\))B
7920 13990(/* Body macros */)B
7920 13830(#define BodyInteger\(O\)  \(\(O\).u.Integer\))B
7920 13670(#define BodyReal\(O\)     \(\(O\).u.Real\))B
7920 13510(#define BodyOperator\(O\))B
84(\(\(O\).u.Operator\))X
7920 13350(#define BodyString\(O\))B
252(\(\(O\).u.String\))X
7920 13190(#define BodyArray\(O\)    \(\(O\).u.Array\))B
7920 13030(#define BodyDict\(O\)     \(\(O\).u.Dictionary\))B
7920 12870(#define BodyName\(O\)     \(\(O\).u.Name->string_body\))B
7920 12710(#define lengthName\(O\)   \(\(O\).u.Name->string_length\))B
7920 12550(#define lengthString\(O\) \(\(O\).Length\))B
7920 12230(/* Path macros */)B
7920 12070(extern struct path_element *free_pelem;)B
7920 11910(#define NewElem\(T, P\) { P = free_pelem; if \(P\) free_pelem = P->next;\\)B
8340 11750(else P = \(Path\) Malloc \(sizeof \(struct path_element\)\);\\)B
8340 11590(P->ptype = T; })B
7920 11430(#define CurEType\(P\) \(\(P\)->last->ptype\))B
7920 11270(#define EmptyPath\(P\) \(\(!\(P\)\)?TRUE:\(\(P\)->next == \(P\)\)\))B
7920 11110(#define ElemFree\(P\)  { PanicIf \(\(P\) == NULL, "ElemFree given NULL"\);\\)B
9852 10950(\(P\)->next = free_pelem; free_pelem = \(P\); })B
7920 10790(#define PathInsert\(P, I\) { PanicIf \(\(I\) == NULL, "PathInsert given NULL"\);\\)B
10608 10630(\(I\)->next = \(P\); \(I\)->last = \(P\)->last;\\)B
10608 10470(\(P\)->last->next = \(I\); \(P\)->last = \(I\); })B
7920 10310(#define PathFree\(P\) { PanicIf\(\(P\) == NULL, "PathFree given NULL"\);\\)B
10188 10150(\(P\)->last->next = free_pelem; \\)B
10608 9990(\(P\)->last = \(P\); \\)B
10188 9830(free_pelem = \(P\); })B
7920 9670(#define PathDelete\(P\) { Path R;\\)B
9936 9510(PanicIf \(\(P\)->next == \(P\), "delete from empty path"\);\\)B
9936 9350(R=\(P\)->last; R->last->next = \(P\); \(P\)->last = R->last;\\)B
9936 9190(R->next = free_pelem; free_pelem = R; })B
7920 8710(/* Object macros */)B
7920 8550(extern Object InitialObject,InitialExecObject;)B
7920 8390(#define MakeObject\(O, T\) { O = InitialObject; O.type = T;})B
7920 8230(#define MakeExecObject\(O, T\) { O = InitialExecObject; O.type = T;})B
7920 7910(/* Matrix macros */)B
7920 7750(#define NewMatrix\(m, pA, pB, pC, pD, ptx, pty\) { \\)B
8088 7590(\(m\).A = pA; \(m\).B = pB; \(m\).C = pC; \(m\).D = pD; \(m\).tx = ptx; \(m\).ty = pty; })B
7920 7430(#define RotatePosQ\(m,t\) { t=m.A; m.A=m.C; m.C = -t; t=m.B; m.B=m.D; m.D = -t; })B
7920 7270(#define RotateNegQ\(m,t\) { t=m.A; m.A = -m.C; m.C=t; t=m.B; m.B = -m.D; m.D=t; })B
7920 6950(/* Miscellaneous macros */)B
7920 6790(#define lengthArray\(a\)   \(\(a\).Length\))B
7920 6630(#define NameOperator\(op\) \(\(op\).u.Operator->name\))B
7920 6470(#define TypeOf\(a\)        \(\(a\).type\))B
7920 6310(#define Message\(S\) { if \(vfp != NULL\) fprintf \(vfp, "%s\\n", S\), fflush \(vfp\); })B
7920 6150(#define PanicIf\(COND,STR\) if\(COND\) Panic\(STR\))B
7920 5990(#define Max\(a, b\) \(\(a > b\) ? a : b\))B
7920 5830(#define Min\(a, b\) \(\(a < b\) ? a : b\))B
7920 5510(#ifdef AUX)B
7920 5350(#define Bcopy\(D,S,N\) memcpy\(D,S,N\))B
7920 5190(#else)B
7920 5030(#ifdef MACINTOSH)B
7920 4870(#define Bcopy\(D,S,N\) bcopy\(S,D,N\))B
7920 4710(#else)B
7920 4550(#define Bcopy\(D,S,N\) bcopy\(S,D,N\))B
7920 4390(#endif)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(main.h)[(89/04/06)(12:04:14)](3)Gaudy
0 F
360 14470(#endif)B
EndPage
HfDict begin ep end
%%Page: ? 40
HfDict begin bp end
StartPage
Landscape
()(mat.c)[(89/03/25)(04:16:29)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(Matrix identity =   { 1.0, 0.0, 0.0, 1.0, 0.0, 0.0 };)B
360 11590(Vector NewVector \(A, B, vt\))B
780 11430(float A, B, vt;)B
360 11270({)B
528 11110(Vector v;)B
528 10790(v.vx = A; v.vy = B; v.vt = vt;)B
528 10470(return v;)B
360 10310(})B
360 9990(Matrix Translate \(m, x, y\))B
780 9830(Matrix m;)B
780 9670(float x, y;)B
360 9510({)B
528 9350(m.tx += x * m.A + y * m.C;)B
528 9190(m.ty += x * m.B + y * m.D;)B
528 9030(return m;)B
360 8870(})B
360 8550(HereTranslate \(pm, p\))B
780 8390(Matrix *pm;)B
780 8230(UserPoint p;)B
360 8070({)B
528 7910(pm->tx += p.x * pm->A + p.y * pm->C;)B
528 7750(pm->ty += p.x * pm->B + p.y * pm->D;)B
360 7590(})B
360 7270(Matrix Scale \(m, x, y\))B
780 7110(Matrix m;)B
780 6950(float x, y;)B
360 6790({)B
528 6630(m.A *= x;  m.B *= x;  m.C *= y;  m.D *= y;)B
528 6470(return m;)B
360 6310(})B
360 5990(Matrix Rotate \(m, a\))B
780 5830(Matrix m;)B
780 5670(float a;)B
360 5510({)B
528 5350(float ca = cos\(a\), sa = sin\(a\);)B
528 5190(Matrix r;)B
528 5030(NewMatrix\(r, m.A * ca + m.C * sa, m.B * ca + m.D * sa,)B
1368 4870(m.C * ca - m.A * sa, m.D * ca - m.B * sa,)B
1368 4710(m.tx,                m.ty\);)B
528 4550(return r;)B
360 4390(})B
7920 14310(Matrix MatMult \(a, b\))B
8340 14150(Matrix a, b;)B
7920 13990({)B
8088 13830(Matrix r;)B
8088 13670(NewMatrix \(r,    a.A  * b.A + a.B * b.C, a.A * b.B + a.B * b.D,)B
9012 13510(a.C  * b.A + a.D * b.C, a.C * b.B + a.D * b.D,)B
9012 13350(a.tx * b.A + a.ty * b.C + b.tx,)B
9012 13190(a.tx * b.B + a.ty * b.D + b.ty\);)B
8088 13030(return r;)B
7920 12870(})B
7920 12550(Matrix MatInvert \(m\))B
8340 12390(Matrix m;)B
8340 12230(/* know any good matrix inversion algorithms ? */)B
7920 12070({)B
3276(/* this one will be simplistic */)X
8088 11910(Matrix r;)B
8088 11750(float detinv = 1 / \(m.A * m.D - m.B * m.C\);)B
8088 11430(NewMatrix\(r,m.D * detinv,)B
8928 11270(-m.B * detinv,)B
8928 11110(-m.C * detinv,)B
8928 10950(m.A * detinv,)B
8928 10790(\(m.C * m.ty - m.D * m.tx\) * detinv,)B
8928 10630(-\(m.A * m.ty - m.B * m.tx\) * detinv\);)B
8088 10470(return r;)B
7920 10310(})B
7920 9990(Vector Transform \(v, m\))B
8340 9830(Vector v;)B
8340 9670(Matrix m;)B
7920 9510({)B
8088 9350(return NewVector \(v.vx * m.A + v.vy * m.C + v.vt * m.tx,)B
9600 9190(v.vx * m.B + v.vy * m.D + v.vt * m.ty,)B
9600 9030(v.vt\);)B
7920 8870(})B
7920 8550(Vector DTransform \(v, m\))B
8340 8390(Vector v;)B
8340 8230(Matrix m;)B
7920 8070({)B
8088 7910(return NewVector \(v.vx * m.A + v.vy * m.C,)B
9600 7750(v.vx * m.B + v.vy * m.D,)B
9600 7590(v.vt\);)B
7920 7430(})B
7920 7110(Vector ITransform \(v, mi\))B
8340 6950(Vector v;)B
8340 6790(Matrix mi;)B
7920 6630({)B
8088 6470(Matrix m;)B
8088 6150(m = MatInvert \(mi\);)B
8088 5990(return NewVector \(v.vx * m.A + v.vy * m.C + v.vt * m.tx,)B
9600 5830(v.vx * m.B + v.vy * m.D + v.vt * m.ty,)B
9600 5670(v.vt\);)B
7920 5510(})B
7920 5190(Vector IDTransform \(v, mi\))B
8340 5030(Vector v;)B
8340 4870(Matrix mi;)B
7920 4710({)B
8088 4550(Matrix m;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(mat.c)[(89/03/25)(04:16:29)](2)Gaudy
0 F
528 14470(m = MatInvert \(mi\);)B
528 14310(return NewVector \(v.vx * m.A + v.vy * m.C,)B
2040 14150(v.vx * m.B + v.vy * m.D,)B
2040 13990(v.vt\);)B
360 13830(})B
360 13510(Vector DiffVector \(a, o\))B
780 13350(Vector a, o;)B
360 13190({)B
528 13030(return NewVector \(a.vx - o.vx, a.vy - o.vy, 1.0\);)B
360 12870(})B
EndPage
HfDict begin ep end
%%Page: ? 41
HfDict begin bp end
StartPage
Landscape
()(mat.h)[(89/03/24)(06:31:45)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(typedef struct matrix { float A, B, C, D, tx, ty; } Matrix;)B
360 13510(typedef struct vector { float vx, vy, vt; } Vector;)B
360 13190(extern Matrix MatMult \(\), MatInvert \(\), Translate \(\), Rotate \(\), Scale \(\);)B
360 13030(extern Vector NewVector \(\), DiffVector \(\);)B
360 12870(extern Vector Transform \(\), ITransform \(\), DTransform \(\), IDTransform \(\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(math.c)[(89/04/05)(01:53:23)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include <signal.h>)B
360 12070(#include "main.h")B
360 11750(#ifndef PI)B
360 11590(#define PI 3.14159265358979)B
360 11430(#endif)B
360 11110(static int PRand \(\), PSrand \(\), PRrand \(\), Idiv \(\);)B
360 10950(static int ParseInteger \(\);)B
360 10630(static catchmath \(\);)B
360 10470(extern int errno;)B
360 10310(jmp_buf penv;)B
360 9990(InitMath \(\))B
360 9830({)B
528 9670(InstallOp \("abs",)B
420(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 9510(InstallOp \("add",)B
420(PolyPair,)X
588(2, 1, 0, 0, Poly, Poly\);)X
528 9350(InstallOp \("div",)B
420(PolyPair,)X
588(2, 1, 0, 0, Poly, Poly\);)X
528 9190(InstallOp \("mod",)B
420(PolyPair,)X
588(2, 1, 0, 0, Poly, Poly\);)X
528 9030(InstallOp \("mul",)B
420(PolyPair,)X
588(2, 1, 0, 0, Poly, Poly\);)X
528 8870(InstallOp \("neg",)B
420(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 8710(InstallOp \("sub",)B
420(PolyPair,)X
588(2, 1, 0, 0, Poly, Poly\);)X
528 8550(InstallOp \("sqrt",)B
336(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 8390(InstallOp \("exp",)B
420(PolyPair,)X
588(2, 1, 0, 0, Poly, Poly\);)X
528 8230(InstallOp \("ceiling",)B
84(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 8070(InstallOp \("floor",)B
252(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 7910(InstallOp \("round",)B
252(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 7750(InstallOp \("truncate",)B
672(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 7590(InstallOp \("atan",)B
336(PolyPair,)X
588(2, 1, 0, 0, Poly, Poly\);)X
528 7430(InstallOp \("cos",)B
420(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 7270(InstallOp \("sin",)B
420(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 7110(InstallOp \("ln",)B
504(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 6950(InstallOp \("log",)B
420(PolyFirst,)X
504(1, 1, 0, 0, Poly\);)X
528 6790(InstallOp \("rand",)B
336(PRand,)X
840(0, 1, 0, 0\);)X
528 6630(InstallOp \("srand",)B
252(PSrand,)X
756(1, 0, 0, 0, Integer\);)X
528 6470(InstallOp \("rrand",)B
252(PRrand,)X
756(0, 1, 0, 0\);)X
528 6310(InstallOp \("idiv", )B
252(Idiv,)X
924(2, 1, 0, 0, Float, Float\);)X
528 5990(/*)B
336(PanicIf \(setjmp \(penv\), "Unexpected floating point error"\);)X
1032 5830(VOID signal \(SIGFPE, catchmath\);)B
360 5670(*/)B
360 5510(})B
360 5190(static catchmath \(\))B
360 5030({)B
528 4870(VOID signal \(SIGFPE, catchmath\);)B
528 4710(longjmp \(penv, TRUE\);)B
360 4550(})B
7920 14470(float Deg \(r\))B
8340 14310(float r;)B
7920 14150({)B
8088 13990(float res = 360 * r / \(2 * PI\);)B
8088 13830(return res < 0 ? res + 360 : res;)B
7920 13670(})B
7920 13350(float Rad \(d\))B
8340 13190(float d;)B
7920 13030({)B
8088 12870(return 2 * PI * d / 360;)B
7920 12710(})B
7920 12390(float BodyFloat \(ob\))B
8340 12230(Object ob;)B
7920 12070({)B
8088 11910(if \(TypeOf \(ob\) == Integer\))B
8256 11750(return \(float\) BodyInteger \(ob\);)B
8088 11590(else if \(TypeOf \(ob\) == Real\))B
8256 11430(return BodyReal \(ob\);)B
8088 11270(else)B
8256 11110(Panic \("BodyFloat passed arg of bad type"\);)B
8088 10950(return 0.0;)B
7920 10790(})B
7920 10470(static float pow10[]={1,1e1,1e2,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11};)B
7920 10150(#define RetInt\(V\) {res.type=Integer; res.u.Integer=sign?-\(V\):\(V\); return res;})B
7920 9990(#define RetReal\(V\) {res.type=Real; res.u.Real = sign?-\(V\):\(V\); return res;})B
7920 9670(Object ParseNumber \(s, length\) unsigned char *s; int length;)B
7920 9510({)B
8088 9350(Object res;)B
8088 9190(int c, sign, ival, dval, olength;)B
8088 9030(float fval;)B
8088 8710(if \(length == 0\) return Nil;)B
7920 8390(#ifdef MACINTOSH)B
8088 8230(setmem\(&res, sizeof\(Object\), '\\0'\);)B
7920 8070(#else)B
8088 7910(bzero\(&res, sizeof\(Object\)\);)B
7920 7750(#endif)B
8088 7430(res.flags =  READABLE|WRITEABLE;)B
8088 7270(if \(\(c = *s\) == '+'\) { sign = 0;  c = *++s; --length; })B
8088 7110(else if \(c == '-'\) { sign = 1; c = *++s; --length; })B
8088 6950(else sign = 0;)B
8088 6630(if \(c == '.'\) {)B
8256 6470(if \(\(++s, --length\) == 0 || \(c = *s\) < '0' || c > '9'\) return Nil;)B
8256 6310(olength = length;  dval = c - '0';)B
8256 6150(while \(\(++s, --length\) > 0 && \(c = *s\) >= '0' && c <= '9'\))B
8424 5990(dval = dval*10 + c-'0';)B
8256 5830(fval = \(float\) dval / pow10[olength-length];)B
8256 5670(if \(length == 0\) RetReal\(fval\);)B
8088 5510(})B
8088 5350(else {)B
8256 5190(if \(length == 0 || c < '0' || c > '9'\) return Nil;)B
8256 5030(ival = c - '0';)B
8256 4870(while \(\(++s, --length\) > 0 && \(c = *s\) >= '0' && c <= '9'\))B
8424 4710(ival = ival*10 + c-'0';)B
8256 4550(if \(length == 0\) RetInt\(ival\);)B
EndPage
HfDict begin ep end
%%Page: ? 42
HfDict begin bp end
StartPage
Landscape
()(math.c)[(89/04/05)(01:53:23)](2)Gaudy
0 F
696 14470(if \(\(c = *s\) == '.'\) {)B
864 14310(if \(\(s++, --length\) == 0 || \(c = *s\) < '0' || c > '9'\) return Nil;)B
864 14150(olength = length;  dval = c - '0';)B
864 13990(while \(\(++s, --length\) > 0 && \(c = *s\) >= '0' && c <= '9'\))B
1032 13830(dval = dval*10 + c-'0';)B
864 13670(fval = ival + \(float\) dval / pow10[olength-length];)B
864 13510(if \(length == 0\) RetReal\(fval\);)B
696 13350(})B
696 13190(else if \(c == '#'\) {)B
864 13030(if \(ival < 2 || ival > 36\) return Nil;)B
864 12870(s++; --length;)B
864 12710(ival = ParseInteger \(&s, &length, ival\);)B
864 12550(if \(length >= 0\) RetInt\(ival\);)B
864 12390(return Nil;)B
696 12230(})B
696 12070(else fval = \(float\) ival;)B
528 11910(})B
528 11590(if \(\(c = *s\) == 'e' || c == 'E'\) {)B
696 11430(if \(\(s++, --length\) == 0\) return Nil;)B
696 11110(if \(sign\) fval = -fval;)B
696 10950(if \(\(c = *s\) == '+'\) { sign = 0;  c = *++s; --length; })B
696 10790(else if\(c == '-'\) { sign = 1; c = *++s; --length; })B
696 10630(else sign = 0;)B
696 10310(if \(length == 0 || c < '0' || c > '9'\) return Nil;)B
696 10150(ival = c - '0';)B
696 9990(while \(\(++s, --length\) > 0 && \(c = *s\) >= '0' && c <= '9'\))B
864 9830(ival = ival*10 + c-'0';)B
696 9670(if \(sign\) ival = -ival;)B
696 9510(res.type = Real; res.u.Real = fval * pow\(10.0,\(double\) ival\);)B
696 9350(return res;)B
528 9190(})B
528 9030(return Nil;)B
360 8870(})B
360 8550(static int ParseInteger \(p, length, base\))B
780 8390(unsigned char **p;)B
780 8230(int *length, base;)B
360 8070({)B
528 7910(int present = FALSE, ival = 0, digit;)B
528 7750(if \(*length == 0\) {)B
696 7590(*length = -1;)B
696 7430(return 0;)B
528 7270(})B
528 7110(for \(;;\) {)B
696 6950(int c = *\(*p\)++;)B
696 6630(if \(c >= '0' && c <= '9'\)      digit = c - '0';)B
696 6470(else if \(c >= 'a' && c <= 'z'\) digit = c - 'a' + 10;)B
696 6310(else if \(c >= 'A' && c <= 'Z'\) digit = c - 'A' + 10;)B
696 6150(else break;)B
696 5830(if \(digit < base\) ival = ival * base + digit;)B
696 5670(else break;)B
696 5510(++present;)B
696 5350(if \(--*length == 0\) return ival;)B
528 5190(})B
528 5030(--*p;)B
528 4870(if \(!present\) *length = -1;)B
528 4710(return ival;)B
360 4550(})B
7920 14470(static int seed = 1;)B
7920 14150(static int random \(\))B
7920 13990({)B
8088 13830(return seed = \(\(seed * 1103515245 + 12345\) & 0x7fffffff\);)B
7920 13670(})B
7920 13350(static int PRand \(\))B
1092(/* --- integer */)X
7920 13190({)B
8088 13030(VOID random \(\);)B
8088 12870(return Push \(OpStack, MakeInteger \(seed\)\);)B
7920 12710(})B
7920 12390(static int PSrand \(see\))B
8340 12230(Object see;)B
7920 12070({)B
8088 11910(srand \(\(unsigned\) \(seed = BodyInteger \(see\)\)\);)B
8088 11750(return TRUE;)B
7920 11590(})B
7920 11270(static int PRrand \(\))B
7920 11110({)B
8088 10950(return Push \(OpStack, MakeInteger \(seed\)\);)B
7920 10790(})B
7920 10470(static int Idiv \(a, b\))B
8340 10310(Object a, b;)B
7920 10150({)B
8088 9990(if \(BodyReal \(b\) == 0\))B
8256 9830(return Error \(PUnResult\);)B
8088 9670(return Push \(OpStack, MakeInteger \(\(int\) BodyReal \(a\) / \(int\) BodyReal \(b\)\)\);)B
7920 9510(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(matrix.c)[(89/03/25)(04:16:16)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(Object AssignMatrix \(\);)B
360 11750(extern Matrix identity;)B
360 11590(static int PMatrix \(\);)B
360 11430(static int PIdentMatrix \(\);)B
360 11270(static int PDefaultMatrix \(\);)B
360 11110(static int PCurrentMatrix \(\);)B
360 10950(static int PSetMatrix \(\);)B
360 10790(static int PTranslate \(\);)B
360 10630(static int PScale \(\);)B
360 10470(static int PRotate \(\);)B
360 10310(static int PConcat \(\);)B
360 10150(static int PConcatMatrix \(\);)B
360 9990(static int PTransform \(\);)B
360 9830(static int PDTransform \(\);)B
360 9670(static int PITransform \(\);)B
360 9510(static int PIDTransform \(\);)B
360 9350(static int PInvertMatrix \(\);)B
360 9030(InitMatrix \(\))B
360 8870({)B
528 8710(InstallOp \("matrix",)B
840(PMatrix,)X
672(0, 1, 0, 0\);)X
528 8550(InstallOp \("initmatrix",)B
504(PInitMatrix,)X
336(0, 0, 0, 0\);)X
528 8390(InstallOp \("identmatrix",)B
420(PIdentMatrix,)X
252(1, 1, 0, 0, Array\);)X
528 8230(InstallOp \("defaultmatrix",)B
252(PDefaultMatrix,)X
84(1, 1, 0, 0, Array\);)X
528 8070(InstallOp \("currentmatrix",)B
252(PCurrentMatrix,)X
84(1, 1, 0, 0, Array\);)X
528 7910(InstallOp \("setmatrix",)B
588(PSetMatrix,)X
420(1, 0, 0, 0, Array\);)X
528 7750(InstallOp \("translate",)B
588(PTranslate,)X
420(0, 0, 0, 0\);)X
528 7590(InstallOp \("scale",)B
924(PScale,)X
756(0, 0, 0, 0\);)X
528 7430(InstallOp \("rotate",)B
840(PRotate,)X
672(0, 0, 0, 0\);)X
528 7270(InstallOp \("concat",)B
840(PConcat,)X
672(1, 0, 0, 0, Array\);)X
528 7110(InstallOp \("concatmatrix",)B
336(PConcatMatrix,)X
168(3, 1, 0, 0, Array, Array,)X
1452 6950(Array\);)B
528 6790(InstallOp \("transform",)B
588(PTransform,)X
420(0, 0, 0, 0\);)X
528 6630(InstallOp \("dtransform",)B
504(PDTransform,)X
336(0, 0, 0, 0\);)X
528 6470(InstallOp \("itransform",)B
504(PITransform,)X
336(0, 0, 0, 0\);)X
528 6310(InstallOp \("idtransform",)B
420(PIDTransform,)X
252(0, 0, 0, 0\);)X
528 6150(InstallOp \("invertmatrix",)B
336(PInvertMatrix,)X
168(2, 1, 0, 0, Array, Array\);)X
360 5990(})B
360 5670(Object MatrixFrom \(m\))B
780 5510(Matrix m;)B
360 5350({)B
528 5190(return AssignMatrix \(MakeArray \(\(Object *\) Malloc \(6 * sizeof \(Object\)\), 6\), m\);)B
360 5030(})B
360 4710(int ExtractMatrix \(pm, o\))B
780 4550(Matrix *pm;)B
780 4390(Object o;)B
7920 14470({)B
8088 14310(int i;)B
8088 14150(float temp[6];)B
8088 13830(for \(i = 0; i < 6; i++\) {)B
8256 13670(Object item;)B
8256 13350(item = getArray \(o, i\);)B
8256 13190(if \(TypeOf \(item\) == Integer\))B
8424 13030(temp[i] = \(float\) BodyInteger \(item\);)B
8256 12870(else if \(TypeOf \(item\) == Real\))B
8424 12710(temp[i] = BodyReal \(item\);)B
8256 12550(else)B
8424 12390(return FALSE;)B
8088 12230(})B
8088 11910(NewMatrix\(*pm, temp[0], temp[1], temp[2], temp[3], temp[4], temp[5]\);)B
8088 11750(return TRUE;)B
7920 11590(})B
7920 11270(static int PMatrix \(\))B
7920 11110({)B
8088 10950(return Push \(OpStack, MatrixFrom \(identity\)\);)B
7920 10790(})B
7920 10470(int PInitMatrix \(\))B
7920 10310({)B
8088 10150(gstate->CTM = gstate->device->default_matrix;)B
8088 9830(return TRUE;)B
7920 9670(})B
7920 9350(static int PIdentMatrix \(array\))B
8340 9190(Object array;)B
7920 9030({)B
8088 8870(if \(lengthArray \(array\) != 6\))B
8256 8710(return Error \(PRangeCheck\);)B
8088 8550(VOID AssignMatrix \(array, identity\);)B
8088 8390(return Push \(OpStack, array\);)B
7920 8230(})B
7920 7910(static int PDefaultMatrix \(array\))B
8340 7750(Object array;)B
7920 7590({)B
8088 7430(if \(lengthArray \(array\) != 6\))B
8256 7270(return Error \(PRangeCheck\);)B
8088 7110(VOID AssignMatrix \(array, gstate->device->default_matrix\);)B
8088 6950(return Push \(OpStack, array\);)B
7920 6790(})B
7920 6470(static int PCurrentMatrix \(array\))B
8340 6310(Object array;)B
7920 6150({)B
8088 5990(if \(lengthArray \(array\) != 6\))B
8256 5830(return Error \(PRangeCheck\);)B
8088 5670(VOID AssignMatrix \(array, gstate->CTM\);)B
8088 5510(return Push \(OpStack, array\);)B
7920 5350(})B
7920 5030(static int PSetMatrix \(array\))B
8340 4870(Object array;)B
7920 4710({)B
8088 4550(if \(lengthArray \(array\) != 6\))B
8256 4390(return Error \(PRangeCheck\);)B
EndPage
HfDict begin ep end
%%Page: ? 43
HfDict begin bp end
StartPage
Landscape
()(matrix.c)[(89/03/25)(04:16:16)](2)Gaudy
0 F
528 14470(else if \(!ExtractMatrix \(&gstate->CTM, array\)\))B
696 14310(return Error \(PTypeCheck\);)B
528 14150(else)B
696 13990(return TRUE;)B
360 13830(})B
360 13510(static int PTranslate \(\))B
360 13350({)B
528 13190(Object tx, ty, mat;)B
528 13030(float x, y;)B
528 12870(Matrix m;)B
528 12550(if \(!OpCheck \(2, 1\)\))B
696 12390(return FALSE;)B
528 12230(mat = Pop \(OpStack\);)B
528 12070(if \(TypeOf \(mat\) == Array\))B
696 11910(if \(!wCheck \(mat\)\))B
864 11750(return Push \(OpStack, mat\), Error \(PInvAccess\);)B
696 11590(else if \(lengthArray \(mat\) != 6\))B
864 11430(return Push \(OpStack, mat\), Error \(PRangeCheck\);)B
696 11270(else {)B
864 11110(ty = Pop \(OpStack\);)B
864 10950(if \(TypeOf \(ty\) == Integer\))B
1032 10790(y = \(float\) BodyInteger \(ty\);)B
864 10630(else if \(TypeOf \(ty\) == Real\))B
1032 10470(y = BodyReal \(ty\);)B
864 10310(else)B
1032 10150(return Push \(OpStack, ty\), Push \(OpStack, mat\), Error \(PTypeCheck\);)B
864 9990(tx = Pop \(OpStack\);)B
864 9830(if \(TypeOf \(tx\) == Integer\))B
1032 9670(x = \(float\) BodyInteger \(tx\);)B
864 9510(else if \(TypeOf \(tx\) == Real\))B
1032 9350(x = BodyReal \(tx\);)B
864 9190(else)B
1032 9030(return Push \(OpStack, tx\), Push \(OpStack, ty\), Push \(OpStack, mat\), Error \(PTypeC)B
864 8710(NewMatrix\(m, 1.0, 0.0, 0.0, 1.0, x, y\);)B
864 8550(VOID AssignMatrix \(mat, m\);)B
864 8230(return Push \(OpStack, mat\);)B
696 8070(})B
528 7910(else if \(TypeOf \(mat\) == Integer\))B
696 7750(y = \(float\) BodyInteger \(mat\);)B
528 7590(else if \(TypeOf \(mat\) == Real\))B
696 7430(y = BodyReal \(mat\);)B
528 7270(else)B
696 7110(return Push \(OpStack, mat\), Error \(PTypeCheck\);)B
528 6790(tx = Pop \(OpStack\);)B
528 6630(if \(TypeOf \(tx\) == Integer\))B
696 6470(x = \(float\) BodyInteger \(tx\);)B
528 6310(else if \(TypeOf \(tx\) == Real\))B
696 6150(x = BodyReal \(tx\);)B
528 5990(else)B
696 5830(return Push \(OpStack, tx\), Push \(OpStack, mat\), Error \(PTypeCheck\);)B
528 5670(gstate->CTM = Translate \(gstate->CTM, x, y\);)B
528 5510(return TRUE;)B
360 5350(})B
360 5030(static int PScale \(\))B
360 4870({)B
528 4710(Object tx, ty, mat;)B
528 4550(float x, y;)B
528 4390(Matrix m;)B
8088 14310(if \(!OpCheck \(2, 1\)\))B
8256 14150(return FALSE;)B
8088 13990(mat = Pop \(OpStack\);)B
8088 13830(if \(TypeOf \(mat\) == Array\))B
8256 13670(if \(!wCheck \(mat\)\))B
8424 13510(return Push \(OpStack, mat\), Error \(PInvAccess\);)B
8256 13350(else if \(lengthArray \(mat\) != 6\))B
8424 13190(return Push \(OpStack, mat\), Error \(PRangeCheck\);)B
8256 13030(else {)B
8424 12870(ty = Pop \(OpStack\);)B
8424 12710(if \(TypeOf \(ty\) == Integer\))B
8592 12550(y = \(float\) BodyInteger \(ty\);)B
8424 12390(else if \(TypeOf \(ty\) == Real\))B
8592 12230(y = BodyReal \(ty\);)B
8424 12070(else)B
8592 11910(return Push \(OpStack, ty\), Push \(OpStack, mat\), Error \(PTypeCheck\);)B
8424 11750(tx = Pop \(OpStack\);)B
8424 11590(if \(TypeOf \(tx\) == Integer\))B
8592 11430(x = \(float\) BodyInteger \(tx\);)B
8424 11270(else if \(TypeOf \(tx\) == Real\))B
8592 11110(x = BodyReal \(tx\);)B
8424 10950(else)B
8592 10790(return Push \(OpStack, tx\), Push \(OpStack, ty\), Push \(OpStack, mat\), Error \(PTypeC)B
8424 10470(NewMatrix \(m, x, 0.0, 0.0, y, 0.0, 0.0\);)B
8424 10310(VOID AssignMatrix \(mat, m\);)B
8424 9990(return Push \(OpStack, mat\);)B
8256 9830(})B
8088 9670(else if \(TypeOf \(mat\) == Integer\))B
8256 9510(y = \(float\) BodyInteger \(mat\);)B
8088 9350(else if \(TypeOf \(mat\) == Real\))B
8256 9190(y = BodyReal \(mat\);)B
8088 9030(else)B
8256 8870(return Push \(OpStack, mat\), Error \(PTypeCheck\);)B
8088 8550(tx = Pop \(OpStack\);)B
8088 8390(if \(TypeOf \(tx\) == Integer\))B
8256 8230(x = \(float\) BodyInteger \(tx\);)B
8088 8070(else if \(TypeOf \(tx\) == Real\))B
8256 7910(x = BodyReal \(tx\);)B
8088 7750(else)B
8256 7590(return Push \(OpStack, tx\), Push \(OpStack, mat\), Error \(PTypeCheck\);)B
8088 7430(gstate->CTM = Scale \(gstate->CTM, x, y\);)B
8088 7270(return TRUE;)B
7920 7110(})B
7920 6790(static int PRotate \(\))B
7920 6630({)B
8088 6470(Object ang, mat;)B
8088 6310(float a,ca,sa;)B
8088 6150(Matrix m;)B
8088 5830(if \(!OpCheck \(1, 1\)\))B
8256 5670(return FALSE;)B
8088 5510(mat = Pop \(OpStack\);)B
8088 5350(if \(TypeOf \(mat\) == Array\))B
8256 5190(if \(!wCheck \(mat\)\))B
8424 5030(return Push \(OpStack, mat\), Error \(PInvAccess\);)B
8256 4870(else if \(lengthArray \(mat\) != 6\))B
8424 4710(return Push \(OpStack, mat\), Error \(PRangeCheck\);)B
8256 4550(else {)B
8424 4390(ang = Pop \(OpStack\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(matrix.c)[(89/03/25)(04:16:16)](3)Gaudy
0 F
864 14470(if \(TypeOf \(ang\) == Integer\))B
1032 14310(a = \(float\) BodyInteger \(ang\);)B
864 14150(else if \(TypeOf \(ang\) == Real\))B
1032 13990(a = BodyReal \(ang\);)B
864 13830(else)B
1032 13670(return Push \(OpStack, ang\), Push \(OpStack, mat\), Error \(PTypeCheck\);)B
864 13350(ca = cos\(a\);  sa = sin\(a\);)B
864 13190(NewMatrix \(m, ca, sa, -sa, -ca, 0.0, 0.0\);)B
864 13030(VOID AssignMatrix \(mat, m\);)B
864 12710(return Push \(OpStack, mat\);)B
696 12550(})B
528 12390(else if \(TypeOf \(mat\) == Integer\))B
696 12230(a = \(float\) BodyInteger \(mat\);)B
528 12070(else if \(TypeOf \(mat\) == Real\))B
696 11910(a = BodyReal \(mat\);)B
528 11750(else)B
696 11590(return Push \(OpStack, mat\), Error \(PTypeCheck\);)B
528 11270(gstate->CTM = Rotate \(gstate->CTM, Rad \(a\)\);)B
528 11110(return TRUE;)B
360 10950(})B
360 10630(static int PConcat \(mat\))B
780 10470(Object mat;)B
360 10310({)B
528 10150(Matrix m;)B
528 9830(if \(!ExtractMatrix \(&m, mat\)\))B
696 9670(return Error \(PTypeCheck\);)B
528 9510(gstate->CTM = MatMult \(m, gstate->CTM\);)B
528 9350(return TRUE;)B
360 9190(})B
360 8870(static int PConcatMatrix \(mat1, mat2, mat3\))B
780 8710(Object mat1, mat2, mat3;)B
360 8550({)B
528 8390(Matrix m1, m2;)B
528 8070(if \(!ExtractMatrix \(&m1, mat1\) || !ExtractMatrix \(&m2, mat2\) ||)B
864 7910(lengthArray \(mat3\) != 6\))B
696 7750(return Error \(PTypeCheck\);)B
528 7590(VOID AssignMatrix \(mat3, MatMult \(m1, m2\)\);)B
528 7430(VOID Push \(OpStack, mat3\);)B
528 7270(return TRUE;)B
360 7110(})B
360 6790(static int Transfn \(fn\))B
780 6630(Vector \(*fn\)\(\);)B
360 6470({)B
528 6310(Matrix m;)B
528 6150(Object tx, ty, mat;)B
528 5990(Vector v;)B
528 5830(float x, y;)B
528 5670(int mflag = FALSE;)B
528 5350(m = gstate->CTM;)B
528 5190(if \(!OpCheck \(2, 1\)\))B
696 5030(return FALSE;)B
528 4710(mat = Pop \(OpStack\);)B
528 4550(if \(TypeOf \(mat\) == Array\) {)B
696 4390(if \(lengthArray \(mat\) != 6 || !ExtractMatrix \(&m, mat\)\))B
8424 14470(return Push \(OpStack, mat\), Error \(PTypeCheck\);)B
8256 14310(mflag = TRUE;)B
8088 14150(})B
8088 13990(else)B
8256 13830(VOID Push \(OpStack, mat\);)B
8088 13510(if \(!OpCheck \(2, 1\)\))B
8256 13350(return Push \(OpStack, mat\), FALSE;)B
8088 13190(ty = Pop \(OpStack\);)B
8088 13030(if \(TypeOf \(ty\) == Integer\))B
8256 12870(y = \(float\) BodyInteger \(ty\);)B
8088 12710(else if \(TypeOf \(ty\) == Real\))B
8256 12550(y = BodyReal \(ty\);)B
8088 12390(else {)B
8256 12230(VOID Push \(OpStack, ty\);)B
8256 12070(if \(mflag\))B
8424 11910(VOID Push \(OpStack, mat\);)B
8256 11750(return Error \(PTypeCheck\);)B
8088 11590(})B
8088 11430(tx = Pop \(OpStack\);)B
8088 11270(if \(TypeOf \(tx\) == Integer\))B
8256 11110(x = \(float\) BodyInteger \(tx\);)B
8088 10950(else if \(TypeOf \(tx\) == Real\))B
8256 10790(x = BodyReal \(tx\);)B
8088 10630(else {)B
8256 10470(VOID Push \(OpStack, tx\);)B
8256 10310(VOID Push \(OpStack, ty\);)B
8256 10150(if \(mflag\))B
8424 9990(VOID Push \(OpStack, mat\);)B
8256 9830(return Error \(PTypeCheck\);)B
8088 9670(})B
8088 9350(v = \(*fn\) \(NewVector \(x, y, 1.0\), m\);)B
8088 9030(return Push \(OpStack, MakeReal \(v.vx\)\), Push \(OpStack, MakeReal \(v.vy\)\);)B
7920 8870(})B
7920 8550(static int PTransform \(\))B
7920 8390({)B
8088 8230(return Transfn \(Transform\);)B
7920 8070(})B
7920 7750(static int PDTransform \(\))B
7920 7590({)B
8088 7430(return Transfn \(DTransform\);)B
7920 7270(})B
7920 6950(static int PITransform \(\))B
7920 6790({)B
8088 6630(return Transfn \(ITransform\);)B
7920 6470(})B
7920 6150(static int PIDTransform \(\))B
7920 5990({)B
8088 5830(return Transfn \(IDTransform\);)B
7920 5670(})B
7920 5350(static int PInvertMatrix \(mat1, mat2\))B
8340 5190(Object mat1, mat2;)B
7920 5030({)B
8088 4870(Matrix m;)B
8088 4550(if \(!ExtractMatrix \(&m, mat1\) || lengthArray \(mat2\) != 6\))B
8256 4390(return Error \(PTypeCheck\);)B
EndPage
HfDict begin ep end
%%Page: ? 44
HfDict begin bp end
StartPage
Landscape
()(matrix.c)[(89/03/25)(04:16:16)](4)Gaudy
0 F
528 14470(VOID AssignMatrix \(mat2, MatInvert \(m\)\);)B
528 14310(VOID Push \(OpStack, mat2\);)B
528 14150(return TRUE;)B
360 13990(})B
360 13670(UserPoint IntToExt \(P\))B
780 13510(HardPoint P;)B
360 13350({)B
528 13190(register Matrix *mp;)B
528 13030(UserPoint p;)B
528 12870(float x,y,det;)B
528 12550(/* TMD - Try really open coding this...)B
528 12390(**  )B
168(v = Transform \(NewVector \(\(float\) p.hx, \(float\) p.hy, 1.0\),)X
528 12230(**                   MatInvert \(gstate->CTM\)\);)B
528 12070(**    return NewPoint \(v.vx, v.vy\);)B
528 11910(*/)B
528 11750(mp = &gstate->CTM;)B
528 11590(det = mp->A * mp->D - mp->B * mp->C;)B
528 11430(x = P.hx - mp->tx;  y = P.hy - mp->ty;)B
528 11270(p.x = \(x * mp->D - y * mp->C\) / det;)B
528 11110(p.y = \(y * mp->A - x * mp->B\) / det;)B
528 10950(return p;)B
360 10790(})B
360 10470(HardPoint ExtToInt \(p\))B
780 10310(UserPoint p;)B
360 10150({)B
528 9990(HardPoint P;)B
528 9830(register Matrix *mp;)B
360 9670(/*)B
444 9510(* BZS - try open coding this)B
444 9350(*)B
1032 9190(v = Transform \(NewVector \(p.x, p.y, 1.0\), gstate->CTM\);)B
444 9030(* )B
444 8870(* TMD - try really open coding this...)B
444 8710(*/)B
528 8550(mp = &gstate->CTM;)B
528 8390(P.hx = p.x * mp->A + p.y * mp->C + mp->tx;)B
528 8230(P.hy = p.x * mp->B + p.y * mp->D + mp->ty;)B
528 8070(return P;)B
360 7910(})B
360 7590(Matrix PointTranslate \(m, p\))B
780 7430(Matrix m;)B
780 7270(UserPoint p;)B
360 7110({)B
528 6950(return Translate \(m, p.x, p.y\);)B
360 6790(})B
360 6470(Matrix HardPointTranslate \(m, p\))B
780 6310(Matrix m;)B
780 6150(HardPoint p;)B
360 5990({)B
528 5830(m.tx += p.hx;)B
528 5670(m.ty += p.hy;)B
528 5350(return m;)B
360 5190(})B
360 4870(Object AssignMatrix \(o, m\))B
780 4710(Object o;)B
780 4550(Matrix m;)B
360 4390({)B
8088 14470(Object *vec = BodyArray \(o\);)B
8088 14150(vec[0] = MakeReal \(m.A\);)B
8088 13990(vec[1] = MakeReal \(m.B\);)B
8088 13830(vec[2] = MakeReal \(m.C\);)B
8088 13670(vec[3] = MakeReal \(m.D\);)B
8088 13510(vec[4] = MakeReal \(m.tx\);)B
8088 13350(vec[5] = MakeReal \(m.ty\);)B
8088 13030(return o;)B
7920 12870(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(misc.c)[(89/03/24)(06:48:39)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include <sys/param.h>)B
360 12070(#ifdef AUX)B
360 11910(#include <signal.h>)B
360 11750(#include <sys/types.h>)B
360 11590(#endif /* AUX */)B
360 11430(#include <sys/times.h>)B
360 11270(#ifndef HZ)B
360 11110(#)B
588(define HZ 60)X
360 10950(#endif)B
360 10630(static int PUserTime \(\);)B
360 10310(InitMisc \(\))B
360 10150({)B
528 9990(InstallOp \("usertime",)B
672(PUserTime,)X
504(0, 1, 0, 0\);)X
528 9830(InstallOp \("==",)B
1176(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
360 9670(})B
360 9350(static int PUserTime \(\))B
360 9190({)B
528 9030(struct tms tbuf;)B
528 8870(long times \(\);)B
528 8550(times \(&tbuf\);)B
528 8390(return Push \(OpStack, MakeInteger \(\(int\) \(tbuf.tms_utime * 1000 / HZ\)\)\);)B
360 8230(})B
EndPage
HfDict begin ep end
%%Page: ? 45
HfDict begin bp end
StartPage
Landscape
()(name.c)[(89/04/06)(12:05:15)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(static int Cvs \(\), EqEq \(\), Eq \(\), ExecName \(\);)B
360 11910(static Object OpExecName;)B
360 11590(Object Self;)B
360 11270(InitName \(\))B
360 11110({)B
528 10950(OpExecName = MakeOp \("exec", ExecName,)B
672(1, 1, 0, 4, Name\);)X
528 10630(TypeInstall \(Name, "exec", )B
252(OpExecName\);)X
528 10310(TypeInstallOp \(Name, "==", )B
252(EqEq,)X
252(1, 0, 0, 0, Name\);)X
528 10150(TypeInstallOp \(Name, "cvs", )B
168(Cvs,)X
336(2, 1, 0, 0, Name, String\);)X
528 9990(TypeInstallOp \(Name, "eq", )B
252(Eq, )X
336(2, 1, 0, 0, Name, Name\);)X
360 9830(})B
360 9510(static int Cvs \(v, string\))B
780 9350(Object v, string;)B
360 9190({)B
528 9030(int length;)B
528 8710(if \(lengthString \(string\) < \(length = lengthName \(v\)\)\))B
696 8550(return Error \(PRangeCheck\);)B
528 8390(VOID Bcopy \(BodyString \(string\), BodyName \(v\), length\);)B
528 8230(return Push \(OpStack, getIString \(string, 0, length\)\);)B
360 8070(})B
360 7750(static int EqEq \(v\))B
780 7590(Object v;)B
360 7430({)B
528 7270(if \(!xCheck \(v\)\))B
696 7110(putchar \('/'\);)B
528 6950(PrintName \(v\);)B
528 6790(return TRUE;)B
360 6630(})B
360 6310(static int Eq \(a, b\))B
780 6150(Object a, b;)B
360 5990({)B
528 5830(return Push \(OpStack, MakeBool \(BodyName \(a\) == BodyName \(b\) && lengthName \(a\) == lengt)B
360 5670(})B
360 5350(static int ExecName \(item\))B
780 5190(Object item;)B
360 5030({)B
528 4870(Object v;)B
528 4550(v = DictLookup \(item\);)B
528 4390(if \(TypeOf \(v\) == Condition\))B
8256 14470(return Error \(PUndefined\);)B
8088 14310(else)B
8256 14150(return Push \(ExecStack, v\);)B
7920 13990(})B
7920 13670(#if 0)B
7920 13510(static struct name_struct *FindTreeName \(s, length, root\))B
8340 13350(unsigned char *s;)B
8340 13190(int length;)B
8340 13030(struct name_struct **root;)B
7920 12870({)B
8088 12710(struct name_struct *r;)B
8088 12550(int rootlen,cmp;)B
8088 12230(while \(*root\) {)B
8256 12070(rootlen = \(*root\)->string_length;)B
8256 11910(if\(rootlen == length\) {)B
8424 11750(cmp = strncmp\(s, \(*root\)->string_body, length\);)B
8424 11590(if \(cmp == 0\) return *root;)B
8256 11430(} else)B
8424 11270(cmp = length - rootlen;)B
8256 10950(root = \(cmp < 0\) ? &\(*root\)->prev_name : &\(*root\)->next_name;)B
8088 10790(})B
8088 10470(r = *root = \(struct name_struct *\) Malloc \(sizeof \(struct name_struct\)\);)B
8088 10150(r->next_name = r->prev_name = NULL;)B
8088 9990(Bcopy\(r->string_body = \(unsigned char *\)Malloc\(\(unsigned\)length\),s,length\);)B
8088 9830(r->string_length = length;)B
8088 9510(return r;)B
7920 9350(})B
7920 9030(#define HASH_NAME_SIZE)B
168(1024)X
7920 8870(int name_tries = 0, name_hits = 0;)B
7920 8710(static struct name_struct *hash_name [HASH_NAME_SIZE];)B
7920 8550(static struct name_struct *name_tree = NULL;)B
7920 8230(static struct name_struct *FindName \(s, length\))B
8340 8070(unsigned char *s;)B
8340 7910(int length;)B
7920 7750({)B
8088 7590(struct name_struct *p;)B
8088 7430(int hash = 0,tmplen = length;)B
8088 7110(while\(tmplen--\) hash += *s++;)B
8088 6950(hash &= \(HASH_NAME_SIZE - 1\);)B
8088 6630(p = hash_name [hash];)B
8088 6470(++name_tries;)B
8088 6310(++name_hits;)B
8088 5990(if \(p == NULL || p->string_length != length ||)B
8424 5830(strncmp \(s, p->string_body, length\)\) {)B
8256 5670(p = FindTreeName \(s, length, &name_tree\);)B
8256 5350(if \(p != NULL\) {)B
8424 5190(hash_name [hash] = p;)B
8424 5030(--name_hits;)B
8256 4870(})B
8088 4710(})B
8088 4550(return p;)B
7920 4390(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(name.c)[(89/04/06)(12:05:15)](2)Gaudy
0 F
360 14470(#else)B
360 14150(#define HASH_NAME_SIZE)B
168(1009)X
360 13990(int name_tries = 0, name_hits = 0;)B
360 13830(static struct name_struct *hash_name [HASH_NAME_SIZE];)B
360 13510(static struct name_struct *FindName \(s, length\))B
780 13350(unsigned char *s;)B
780 13190(int length;)B
360 13030({)B
528 12870(struct name_struct *p,**slot;)B
528 12710(unsigned char *t1,*t2;)B
528 12550(int hash,shift,tmplen;)B
528 12230(/* Convert each character to a 5 bit number between 3 and 28.)B
612 12070(* Xor these into a 32 bit integer in the following pattern:)B
612 11910(* --------------------------------)B
612 11750(*        4444433333222221111100000   <-- first 5 bits go in 00000)B
612 11590(*      9999988888777776666655555)B
612 11430(*    4444433333222221111100000)B
612 11270(*       9999988888777776666655555)B
612 11110(*     4444433333222221111100000)B
612 10950(*/)B
528 10790(t1 = s; hash = 0; shift = 0; tmplen = length;)B
528 10630(while \(tmplen--\) {)B
696 10470(hash ^= *t1++ << shift;)B
696 10310(if\(\(shift += 5\) >= 22\) shift -= 22;)B
528 10150(})B
528 9990(hash %= HASH_NAME_SIZE;)B
528 9830(slot = &hash_name[hash];)B
528 9670(p = *slot;)B
528 9510(++name_tries;)B
528 9350(++name_hits;)B
528 9030(while\(p != NULL\) {)B
696 8870(if\(p->string_length == length\) {)B
864 8710(tmplen = length;)B
864 8550(t1 = p->string_body; t2 = s;)B
864 8390(while\(*t1++ == *t2++ && --tmplen > 0\);)B
864 8230(if\(tmplen == 0\) return p;)B
696 8070(})B
696 7910(slot = &p->next;)B
696 7750(p = *slot;)B
696 7590(name_tries++;)B
528 7430(})B
528 7110(--name_hits;)B
528 6950(*slot = p = \(struct name_struct *\) Malloc \(sizeof \(struct name_struct\)\);)B
528 6790(p->next = NULL;)B
528 6630(Bcopy\(p->string_body = \(unsigned char *\)Malloc\(\(unsigned\)length\),s,length\);)B
528 6470(p->string_length = length;)B
528 6310(return p;)B
360 6150(})B
360 5990(#endif)B
360 5670(Object NameFrom \(s\))B
780 5510(unsigned char *s;)B
360 5350({)B
528 5190(Object res;)B
528 4870(MakeObject \(res, Name\);)B
528 4710(res.u.Name = FindName \(s, strlen \(s\)\);)B
528 4550(return res;)B
360 4390(})B
7920 14310(Object Cvn \(o\))B
8340 14150(Object o;)B
7920 13990({)B
8088 13830(Object res;)B
8088 13510(MakeObject \(res, Name\);)B
8088 13350(res.u.Name = FindName \(BodyString \(o\), lengthString \(o\)\);)B
8088 13030(return res;)B
7920 12870(})B
7920 12550(Object StringName \(o\))B
8340 12390(Object o;)B
7920 12230({)B
8088 12070(return MakeString \(BodyName \(o\), lengthName \(o\)\);)B
7920 11910(})B
7920 11590(PrintName \(n\))B
8340 11430(Object n;)B
7920 11270({)B
8088 11110(printf \("%.*s", lengthName \(n\), BodyName \(n\)\);)B
7920 10950(})B
7920 10630(Object ParseId \(o\))B
8340 10470(Object o;)B
7920 10310({)B
8088 10150(unsigned char buf[BUFSIZE], *p = buf;)B
8088 9990(int c, length;)B
8088 9830(Object res;)B
8088 9510(if\(!StatusFile\(o\)\) return Absent;)B
8088 9350(if\(BodyFile\(o\)->file_type == StreamFile\) {)B
8256 9190(FILE *fp = BodyFile\(o\)->f.f_ptr;)B
8256 9030(for \(;;\) {)B
8424 8870(switch \(c = getc\(fp\)\) {)B
8592 8710(case EOF: case ' ': case '\\t': case '\\n': break;)B
8592 8390(case '/': case '<': case '>': case '\(': case '\)':)B
8592 8230(case '%': case '{': case '}': case '[': case ']':)B
7920 8070(/*)B
672(BodyFile\(o\)->available++; */)X
8760 7910(ungetc\(c,fp\);)B
8760 7750(break;)B
8592 7590(default: *p++ = c; continue;)B
8424 7430(})B
8424 7270(break;)B
8256 7110(})B
8088 6950(})B
8088 6790(else {)B
8256 6630(for \(;;\) {)B
8424 6470(switch \(c = GeneralGetch\(o\)\) {)B
8592 6310(case EOF: case ' ': case '\\t': case '\\n': break;)B
8592 5990(case '/': case '<': case '>': case '\(': case '\)':)B
8592 5830(case '%': case '{': case '}': case '[': case ']':)B
8760 5670(Ungetch \(o, c\);)B
8760 5510(break;)B
8592 5350(default: *p++ = c; continue;)B
8424 5190(})B
8424 5030(break;)B
8256 4870(})B
8088 4710(})B
8088 4390(length = \(int\) \(p - buf\);)B
EndPage
HfDict begin ep end
%%Page: ? 46
HfDict begin bp end
StartPage
Landscape
()(name.c)[(89/04/06)(12:05:15)](3)Gaudy
0 F
528 14470(if \(length == 0\) return Absent;)B
528 14150(/* Only attempt to parse as a number if it could possibly be one */)B
528 13990(c = buf[0];)B
528 13830(if\(\(c >= '0' && c <= '9'\) || c == '.' || c == '+' || c == '-'\) {)B
696 13670(res = ParseNumber \(buf, length\);)B
696 13510(if \(TypeOf \(res\) != Null\) return res;)B
528 13350(})B
528 13030(/* Not a number, so place it in the name space */)B
528 12870(MakeObject\(res, Name\);)B
528 12710(res.u.Name = FindName\(buf,length\);)B
528 12550(return res;)B
360 12390(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(operator.c)[(89/03/25)(06:24:18)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(int ExecOperator \(\);)B
360 11910(static int EqEq \(\), Cvs \(\), Eq \(\), Signature \(\);)B
360 11590(InitOperator \(\))B
360 11430({)B
528 11270(TypeInstallOp \(Operator, "==",  EqEq,)B
84(1, 0, 0, 0, Operator\);)X
528 11110(TypeInstallOp \(Operator, "cvs", Cvs,)B
168(2, 1, 0, 0, Operator, String\);)X
528 10950(TypeInstallOp \(Operator, "exec",ExecOperator,)B
84(1, 0, 0, 0, Operator\);)X
528 10790(TypeInstallOp \(Operator, "eq",  Eq,)B
840(2, 1, 0, 0, Operator, Operator\);)X
528 10630(TypeInstallOp \(Operator, "signature",)B
84(Signature,1, 0, 0, 0, Operator\);)X
360 10470(})B
360 10150(/*VARARGS6*/)B
360 9990(/*ARGSUSED*/)B
360 9830(Object MakeOp \(name, fn, arguments, results, execpop, execpush,)B
1620 9670(arg1, arg2, arg3, arg4, arg5, arg6, arg7\))B
780 9510(char *name;)B
780 9350(int \(*fn\)\(\), arguments, results, execpop, execpush;)B
780 9190(Type arg1, arg2, arg3, arg4, arg5, arg6, arg7;)B
360 9030({)B
528 8870(Object res;)B
528 8710(struct op_struct *op;)B
528 8550(int i;)B
528 8230(MakeExecObject \(res, Operator\);)B
528 8070(res.u.Operator = op = \(struct op_struct *\) Malloc \(sizeof \(struct op_struct\)\);)B
528 7750(op->name)B
504(= NameFrom \(name\);)X
528 7590(op->fn)B
672(= fn;)X
528 7430(op->arguments)B
84(= arguments;)X
528 7270(op->results)B
252(= results;)X
528 7110(op->execpop)B
252(= execpop;)X
528 6950(op->execpush)B
168(= execpush;)X
528 6790(op->execuse)B
252(= \(execpop + execpush\) > 0;)X
528 6630(op->argtypes)B
168(= \(Type *\) Malloc \(\(unsigned\) sizeof \(Type\) * arguments\);)X
528 6310(for \(i = 0; i < arguments; i++\))B
696 6150(op->argtypes[i] = \(&arg1\)[i];)B
528 5830(return res;)B
360 5670(})B
360 5350(/*VARARGS6*/)B
360 5190(/*ARGSUSED*/)B
360 5030(InstallOp \(name, fn, arguments, results, execpop, execpush,)B
1284 4870(arg1, arg2, arg3, arg4, arg5, arg6, arg7\))B
780 4710(char *name;)B
780 4550(int \(*fn\)\(\), arguments, results, execpop, execpush;)B
780 4390(Type arg1, arg2, arg3, arg4, arg5, arg6, arg7;)B
7920 14470({)B
8088 14310(Object res;)B
8088 14150(struct op_struct *op;)B
8088 13990(/* )B
252(int i;)X
8172 13830(*/)B
8088 13670(MakeExecObject \(res, Operator\);)B
8088 13510(res.u.Operator = op = \(struct op_struct *\) Malloc \(sizeof \(struct op_struct\)\);)B
8088 13190(op->name)B
504(= NameFrom \(name\);)X
8088 13030(op->fn)B
672(= fn;)X
8088 12870(op->arguments)B
84(= arguments;)X
8088 12710(op->results)B
252(= results;)X
8088 12550(op->execpop)B
252(= execpop;)X
8088 12390(op->execpush)B
168(= execpush;)X
8088 12230(op->execuse)B
252(= \(execpop + execpush\) > 0;)X
8088 11910(op->argtypes)B
168(= \(Type *\) Malloc \(\(unsigned\) sizeof \(Type\) * arguments\);)X
8088 11590(/* )B
252(for \(i = 0; i < arguments; i++\))X
8172 11430(* op->argtypes[i] = \(&arg1\)[i];)B
8172 11270(*/)B
8088 11110(switch \(arguments\) {)B
8088 10950(default:)B
8256 10790(Panic \("too many arguments in InstallOp"\);)B
8256 10630(break;)B
8088 10470(case 7: op->argtypes[6] = arg7;)B
8088 10310(case 6: op->argtypes[5] = arg6;)B
8088 10150(case 5: op->argtypes[4] = arg5;)B
8088 9990(case 4: op->argtypes[3] = arg4;)B
8088 9830(case 3: op->argtypes[2] = arg3;)B
8088 9670(case 2: op->argtypes[1] = arg2;)B
8088 9510(case 1: op->argtypes[0] = arg1;)B
8088 9350(case 0: break;)B
8088 9190(})B
8088 9030(DictStore \(SysDict, NameOperator \(res\), res\);)B
7920 8870(})B
7920 8550(/*VARARGS7*/)B
7920 8390(/*ARGSUSED*/)B
7920 8230(TypeInstallOp \(type, name, fn, arguments, results, execpop, execpush,)B
9180 8070(arg1, arg2, arg3, arg4, arg5, arg6, arg7\))B
8340 7910(char *name;)B
8340 7750(int \(*fn\)\(\), arguments, results, execpop, execpush;)B
8340 7590(Type type, arg1, arg2, arg3, arg4, arg5, arg6, arg7;)B
7920 7430({)B
8088 7270(Object res;)B
8088 7110(struct op_struct *op;)B
8088 6950(int i;)B
8088 6630(MakeExecObject \(res, Operator\);)B
8088 6470(res.u.Operator = op = \(struct op_struct *\) Malloc \(sizeof \(struct op_struct\)\);)B
8088 6150(op->name)B
504(= NameFrom \(name\);)X
8088 5990(op->fn)B
672(= fn;)X
8088 5830(op->arguments)B
84(= arguments;)X
8088 5670(op->results)B
252(= results;)X
8088 5510(op->execpop)B
252(= execpop;)X
8088 5350(op->execpush)B
168(= execpush;)X
8088 5190(op->execuse)B
252(= \(execpop + execpush\) > 0;)X
8088 4870(op->argtypes)B
168(= \(Type *\) Malloc \(\(unsigned\) sizeof \(Type\) * arguments\);)X
8088 4550(for \(i = 0; i < arguments; i++\))B
8256 4390(op->argtypes[i] = \(&arg1\)[i];)B
EndPage
HfDict begin ep end
%%Page: ? 47
HfDict begin bp end
StartPage
Landscape
()(operator.c)[(89/03/25)(06:24:18)](2)Gaudy
0 F
528 14310(TypeInstall \(type, name, res\);)B
360 14150(})B
360 13830(static int Eq \(a, b\))B
780 13670(Object a, b;)B
360 13510({)B
528 13350(return Push \(OpStack, MakeBool \(BodyOperator\(a\)==BodyOperator\(b\)\)\);)B
360 13190(})B
360 12870(static int Cvs \(v, string\))B
780 12710(Object v, string;)B
360 12550({)B
528 12390(Object vv;)B
528 12230(int length;)B
528 11910(vv = NameOperator \(v\);)B
528 11590(if \(lengthString \(string\) < \(length = lengthName \(vv\)\)\))B
696 11430(return Error \(PRangeCheck\);)B
528 11270(VOID strncpy \(BodyString \(string\), BodyName \(vv\), length\);)B
528 11110(return Push \(OpStack, getIString \(string, 0, length\)\);)B
360 10950(})B
360 10630(static int EqEq \(v\))B
780 10470(Object v;)B
360 10310({)B
528 10150(VOID Push \(OpStack, NameOperator \(v\)\);)B
528 9990(VOID Push \(ExecStack, Cvx \(NameFrom \("=="\)\)\);)B
528 9830(return TRUE;)B
360 9670(})B
360 9350(/*)B
444 9190(* Operator types.)B
444 9030(*)B
444 8870(* PostScript has 200 or so operators which can be divided into groups by the)B
444 8710(* arguments required.)B
444 8550(*)B
444 8390(* Type Real )B
420(causes an Integer argument to get floated)X
444 8230(* Type Unchecked causes an argument to be passed through whatever type it has)B
444 8070(* Type Number)B
336(causes all Number arguments to be Integer or Real)X
444 7910(*)B
444 7750(* An operator object comprises several pieces of information:)B
444 7590(*)B
444 7430(* 1)B
336(Number of arguments required)X
444 7270(* 2)B
336(Number of results which may be returned)X
444 7110(* 3)B
336(Number of items required on the ExecStack)X
444 6950(* 4)B
336(Number of items added to the ExecStack)X
444 6790(* 5)B
336(A List of argument types)X
444 6630(*)B
444 6470(* Functions requiring strange arguments can declare themselves to take few)B
444 6310(* arguments and then use some directly from the OpStack.)B
444 6150(*)B
444 5990(* The first four pieces of information are only required for checking Stack)B
444 5830(* over and underflow, thus operators are not required to hold to their)B
444 5670(* requests.)B
444 5510(*)B
444 5350(* After resolving any peculiar type rules, Exec will lookup the operator)B
444 5190(* name in the type dictionary for the argument type which is specified as)B
444 5030(* being the controlling argument.  The operator will receive the correct)B
444 4870(* number of arguments and will be expected to stack its own results. There)B
444 4710(* will be a fixed maximum limit of the number of arguments an operator)B
444 4550(* can declare for itself. This is likely to be the maximum that PostScript)B
444 4390(* uses, i.e. 6 or 7.)B
8004 14470(*/)B
7920 14150(/*)B
8004 13990(* BZS - try to speed up a little)B
8004 13830(* TMD - speed it up more by reordering the typechecking if statements)B
8004 13670(*       and by adding an execuse flag which indicates if the exec stack)B
8004 13510(*       is used or not.)B
8004 13350(*/)B
7920 13190(int ExecOperator \(item\))B
8340 13030(Object item;)B
7920 12870({)B
8088 12710(register struct op_struct *op = BodyOperator\(item\);)B
8088 12550(register int i, opargs, res;)B
8088 12390(Object arg[7];)B
8088 12070(Self = NameOperator \(item\);)B
8088 11910(opargs = op->arguments;)B
8088 11750(if\(op->results > Space\(OpStack\)\) return Error \(POpOverflow\);)B
8088 11590(if\(opargs > Height\(OpStack\)\)     return Error \(POpUnderflow\);)B
8088 11430(if\(op->execuse\) {)B
8256 11270(if\(op->execpush > Space\(ExecStack\)\) return Error \(PExecOverflow\);)B
8256 11110(if\(op->execpop > Height\(ExecStack\)\) return Error \(PExecUnderflow\);)B
8088 10950(})B
8088 10630(/* Pop all arguments off of Opstack */)B
8088 10470(for \(i = opargs - 1; i >= 0; i--\)  arg[i] = Pop \(OpStack\);)B
8088 10150(/* Do type checking of the arguments */)B
8088 9990(for \(i = opargs - 1; i >= 0; i--\) {)B
8256 9830(register Type formal = op->argtypes[i], actual = TypeOf \(arg[i]\);)B
8256 9510(if \(\(formal==Float && actual==Real\) || formal==actual || formal==Poly\))B
8424 9350(continue;)B
8256 9190(if \(formal == Float && actual == Integer\) {)B
8424 9030(/* Convert operand and continue */)B
8424 8870(arg[i].type = Real;)B
8424 8710(arg[i].u.Real = \(float\) arg[i].u.Integer;)B
8424 8550(continue;)B
8256 8390(})B
8256 8070(/* Incorrect type, push all args back on and report an error */)B
8256 7910(for \(i = 0; i < opargs; i++\) FastPush \(OpStack, arg[i]\);)B
8256 7750(return Error \(PTypeCheck\);)B
8088 7590(})B
8088 7270(/* Perform the operation */)B
8088 7110(switch \(opargs\) {)B
8256 6950(case 0: res=\(*\(op->fn\)\)\(\); break;)B
8256 6790(case 1: res=\(*\(op->fn\)\)\(arg[0]\); break;)B
8256 6630(case 2: res=\(*\(op->fn\)\)\(arg[0],arg[1]\); break;)B
8256 6470(case 3: res=\(*\(op->fn\)\)\(arg[0],arg[1],arg[2]\); break;)B
8256 6310(case 4: res=\(*\(op->fn\)\)\(arg[0],arg[1],arg[2],arg[3]\); break;)B
8256 6150(case 5: res=\(*\(op->fn\)\)\(arg[0],arg[1],arg[2],arg[3],arg[4]\); break;)B
8256 5990(case 6: res=\(*\(op->fn\)\)\(arg[0],arg[1],arg[2],arg[3],arg[4],arg[5]\); break;)B
8256 5830(case 7: res=\(*\(op->fn\)\)\(arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6]\);)B
8928 5670(break;)B
8256 5510(default: Panic \("primitive with too many arguments"\);)B
8088 5350(})B
8088 5030(/* If the result was false, push back all the operands */)B
8088 4870(if \(!res\))B
8256 4710(for \(i = 0; i < opargs; i++\) FastPush \(OpStack, arg[i]\);)B
8088 4390(return res;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(operator.c)[(89/03/25)(06:24:18)](3)Gaudy
0 F
360 14470(})B
360 14150(static int Signature \(op\))B
780 13990(Object op;)B
360 13830({)B
528 13670(Object tn;)B
528 13510(struct op_struct *ops = BodyOperator\(op\);)B
528 13350(int i;)B
528 13030(tn = NameFrom \("type"\);)B
528 12870(if \(!OpCheck \(0, ops->arguments + 1\)\))B
696 12710(return FALSE;)B
528 12550(for \(i = 0; i < ops->arguments; i++\))B
696 12390(VOID Push \(OpStack, Lookup \(ops->argtypes[i], tn\)\);)B
528 12230(VOID Push \(OpStack, MakeInteger \(ops->arguments\)\);)B
528 12070(VOID Push \(OpStack, MakeInteger \(ops->results\)\);)B
528 11750(return TRUE;)B
360 11590(})B
EndPage
HfDict begin ep end
%%Page: ? 48
HfDict begin bp end
StartPage
Landscape
()(pat.c)[(89/04/06)(12:06:12)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(#include "graphics.h")B
360 11750(Path NewPath \(\);)B
360 11590(UserPoint NewUserPoint \(\), IntToExt \(\);)B
360 11270(HardPoint NewHardPoint \(\), ExtToInt \(\);)B
360 10950(struct path_element *free_pelem = NULL;)B
360 10630(#ifdef __STDC__)B
360 10470(int Bezier\(float,float,float,float,float,float,float,float\);)B
360 10310(#endif)B
360 9990(#ifndef NewElem)B
360 9830(void NewElem \(type, p\))B
780 9670(enum pelem_type type;)B
780 9510(Path *p;)B
360 9350({)B
528 9190(p = free_pelem;)B
528 8870(if \(p != NULL\))B
696 8710(free_pelem = p->next;)B
528 8550(else)B
696 8390(p = \(Path\) Malloc \(sizeof \(struct path_element\)\);)B
528 8230(p->ptype = type;)B
360 8070(})B
360 7910(#endif)B
360 7590(#ifndef ElemFree)B
360 7430(void ElemFree \(p\))B
780 7270(Path p;)B
360 7110({)B
528 6950(PanicIf \(p == NULL, "ElemFree given NULL"\);)B
528 6790(p->next = free_pelem;)B
528 6630(free_pelem = p;)B
360 6470(})B
360 6310(#endif)B
360 5990(Path NewPath \(\))B
360 5830({)B
528 5670(Path res;)B
528 5350(NewElem \(EHeader, res\);)B
528 5030(return res->next = res->last = res;)B
360 4870(})B
360 4550(#ifndef PathFree)B
360 4390(PathFree \(p\))B
8340 14470(Path p;)B
7920 14310({)B
8088 14150(while \(!EmptyPath \(p\)\))B
8256 13990(PathDelete \(p\);)B
8088 13830(ElemFree \(p\);)B
7920 13670(})B
7920 13510(#endif)B
7920 13190(Path PathCopy \(path\))B
8340 13030(Path path;)B
7920 12870({)B
8088 12710(Path p, tmp, new;)B
8088 12390(NewElem \(EHeader, new\);)B
8088 12230(new->next = new->last = new;)B
8088 11910(for \(p = path->next; p != path; p = p->next\) {)B
8256 11750(NewElem \(p->ptype, tmp\);)B
8256 11590(tmp->pe = p->pe;)B
8256 11430(PathInsert \(new, tmp\);)B
8088 11270(})B
8088 11110(return new;)B
7920 10950(})B
7920 10630(#ifndef CurEType)B
7920 10470(enum pelem_type CurEType \(p\))B
8340 10310(Path p;)B
7920 10150({)B
8088 9990(return p->last->ptype;)B
7920 9830(})B
7920 9670(#endif)B
7920 9350(#ifndef EmptyPath)B
7920 9190(int EmptyPath \(p\))B
8340 9030(Path p;)B
7920 8870({)B
8088 8710(return p->next == p;)B
7920 8550(})B
7920 8390(#endif)B
7920 8070(#ifndef PathDelete)B
7920 7910(PathDelete \(p\))B
8340 7750(Path p;)B
7920 7590({)B
8088 7430(Path res = p->last, ret;)B
8088 7110(PanicIf \(p->next == p, "delete from empty path"\);)B
8088 6950(ret = PathRemove \(res\);)B
8088 6790(ElemFree \(ret\);)B
8088 6470(return TRUE;)B
7920 6310(})B
7920 6150(#endif)B
7920 5830(Path PathRemove \(p\))B
8340 5670(Path p;)B
7920 5510({)B
8088 5350(p->last->next = p->next;)B
8088 5190(p->next->last = p->last;)B
8088 4870(return p;)B
7920 4710(})B
7920 4390(#ifndef PathInsert)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(pat.c)[(89/04/06)(12:06:12)](2)Gaudy
0 F
360 14470(PathInsert \(p, i\))B
780 14310(Path p, i;)B
360 14150({)B
528 13990(PanicIf \(i == NULL, "PathInsert given NULL"\);)B
528 13830(i->next = p;)B
528 13670(i->last = p->last;)B
528 13510(p->last->next = i;)B
528 13350(p->last = i;)B
360 13190(})B
360 13030(#endif)B
360 12710(int MoveTo \(p, np\))B
780 12550(Path p;)B
780 12390(HardPoint np;)B
360 12230({)B
528 12070(Path res;)B
528 11750(NewElem \(EMove, res\);)B
528 11590(res->pe.point = np;)B
528 11270(if \(!EmptyPath \(p\) && CurEType \(p\) == EMove\))B
696 11110(PathDelete \(p\);)B
528 10950(gstate->cp_defined = TRUE;)B
528 10790(gstate->cp = np;)B
528 10630(PathInsert \(p, res\);)B
528 10470(return TRUE;)B
360 10310(})B
360 9990(int LineTo \(p, np\))B
780 9830(Path p;)B
780 9670(HardPoint np;)B
360 9510({)B
528 9350(Path res;)B
528 9030(NewElem \(ELine, res\);)B
528 8870(res->pe.point = np;)B
528 8550(gstate->cp = np;)B
528 8390(PathInsert \(p, res\);)B
528 8070(return TRUE;)B
360 7910(})B
360 7590(int CurveTo \(p, p0, p1, p2\))B
780 7430(Path p;)B
780 7270(HardPoint p0, p1, p2;)B
360 7110({)B
528 6950(Path new;)B
528 6630(NewElem \(ECurve, new\);)B
528 6310(new->pe.curve.x0 = p0;)B
528 6150(new->pe.curve.x1 = p1;)B
528 5990(new->pe.curve.x2 = p2;)B
528 5830(gstate->cp = p2;)B
528 5670(PathInsert \(p, new\);)B
528 5510(return TRUE;)B
360 5350(})B
360 5030(float Normalise \(ang\))B
780 4870(float ang;)B
360 4710({)B
528 4550(while \(ang < -PI || ang > PI\))B
696 4390(if \(ang < PI\)  ang += 2 * PI;)B
8256 14470(else           ang -= 2 * PI;)B
8088 14310(return ang;)B
7920 14150(})B
7920 13830(int Arc \(p, dir, centre, radius, ang1, ang2\))B
8340 13670(Path p;)B
8340 13510(int dir;)B
8340 13350(UserPoint centre;)B
8340 13190(float radius, ang1, ang2;)B
7920 13030({)B
8088 12870(Path new;)B
8088 12710(HardPoint P1,P2,P3;)B
8088 12550(Matrix m;)B
8088 12390(float diff,ca,sa,x,y,t1,t2;)B
8088 12230(int quarters;)B
8088 11910(/* Find absolute difference between the two angles */)B
8088 11750(diff = dir > 0 ? ang2 - ang1 : ang1 - ang2;)B
8088 11590(while \(diff < \(float\) 0.0\) diff += \(float\) \(2 * PI\);)B
8088 11270(/* Translate center of arc to origin */)B
8088 11110(m = gstate->CTM;)B
8088 10950(m.tx += centre.x * m.A + centre.y * m.C;)B
8088 10790(m.ty += centre.x * m.B + centre.y * m.D;)B
8088 10470(/* Don't bother rotating if starting angle is 0 */)B
8088 10310(if\(ang1 != \(float\) 0.0\) {)B
8256 10150(ca = cos\(ang1\); sa = sin\(ang1\);)B
8256 9990(t1 = m.A;  t2 = m.B;)B
8256 9830(m.A = m.A * ca + m.C * sa; m.B = m.B * ca + m.D * sa;)B
8256 9670(m.C = m.C * ca - t1 * sa;  m.D = m.D * ca - t2 * sa;)B
8088 9510(})B
8088 9190(/* For arcs larger than a quarter circle, draw quarter circles first */)B
8088 9030(quarters = \(int\) \(diff / \(float\) \(PI/2 - .00001\)\);)B
8088 8870(if\(quarters > 0\) {)B
8256 8710(diff -= quarters * \(float\) \(PI/2\);)B
8256 8550(t2 = \(\(float\) .5522847\) * radius;  /* \(4/3\)*\(sqrt\(2\) - 1\) */)B
8256 8390(if\(dir > 0\))B
8424 8230(do {)B
8592 8070(/* Add a quarter circle, rotate m by 90 degrees */)B
8592 7910(P1.hx = m.tx + radius*m.A + t2*m.C; P1.hy = m.ty + radius*m.B + t2*m.D;)B
8592 7750(P3.hx = m.tx + radius*m.C;          P3.hy = m.ty + radius*m.D;)B
8592 7590(P2.hx = P3.hx + t2*m.A;             P2.hy = P3.hy + t2*m.B;)B
8592 7270(NewElem \(ECurve, new\);)B
8592 7110(new->pe.curve.x0 = P1;)B
168(new->pe.curve.x1 = P2;)X
168(new->pe.curve.x2 = P3;)X
8592 6950(gstate->cp = P3; PathInsert \(p, new\);)B
8592 6630(RotatePosQ\(m,t1\);)B
8424 6470(} while\(--quarters > 0\);)B
8256 6310(else)B
8424 6150(do {)B
8592 5990(/* Add a quarter circle, rotate m by -90 degrees */)B
8592 5830(P1.hx = m.tx + radius*m.A - t2*m.C; P1.hy = m.ty + radius*m.B - t2*m.D;)B
8592 5670(P3.hx = m.tx - radius*m.C;          P3.hy = m.ty - radius*m.D;)B
8592 5510(P2.hx = P3.hx + t2*m.A;             P2.hy = P3.hy + t2*m.B;)B
8592 5190(NewElem \(ECurve, new\);)B
8592 5030(new->pe.curve.x0 = P1;)B
168(new->pe.curve.x1 = P2;)X
168(new->pe.curve.x2 = P3;)X
8592 4870(gstate->cp = P3; PathInsert \(p, new\);)B
8592 4550(RotateNegQ\(m,t1\);)B
8424 4390(} while\(--quarters > 0\);)B
EndPage
HfDict begin ep end
%%Page: ? 49
HfDict begin bp end
StartPage
Landscape
()(pat.c)[(89/04/06)(12:06:12)](3)Gaudy
0 F
528 14470(})B
528 14150(/* Draw the rest of the arc, if there is any left */)B
528 13990(if\(diff <= \(float\) 0.0\) return TRUE;)B
528 13670(/* Compute cosine and sine of half the angle just once */)B
528 13510(ca = cos\(diff/2\);  sa = sin\(diff/2\);)B
528 13350(if \(dir < 0\) {)B
696 13190(/* Rotate m by -diff/2 and invert x axis */)B
696 13030(t1 = m.A; t2 = m.B;)B
696 12870(m.A = m.A * ca - m.C * sa;  m.B = m.B * ca - m.D * sa;)B
696 12710(m.C = -m.C * ca - t1 * sa;  m.D = -m.D * ca - t2 * sa;)B
696 12550(x = radius * ca; y = -radius * sa;)B
696 12390(P3.hx = x * m.A - y * m.C + m.tx;  P3.hy = x * m.B - y * m.D + m.ty;)B
528 12230(})B
528 12070(else {)B
696 11910(/* Rotate m by diff/2 */)B
696 11750(t1 = m.A; t2 = m.B;)B
696 11590(m.A = m.A * ca + m.C * sa;  m.B = m.B * ca + m.D * sa;)B
696 11430(m.C = m.C * ca - t1 * sa;   m.D = m.D * ca - t2 * sa;)B
696 11270(x = radius * ca; y = radius * sa;)B
696 11110(P3.hx = x * m.A + y * m.C + m.tx;  P3.hy = x * m.B + y * m.D + m.ty;)B
528 10950(})B
528 10630(/* Compute P1 and P2 and P3 from x, y and m */)B
528 10470(x = \(4 * radius - x\) / 3;)B
528 10310(y = sa * \(radius / ca - x\) / ca;)B
528 10150(P1.hx = x * m.A - y * m.C + m.tx;  P1.hy = x * m.B - y * m.D + m.ty;)B
528 9990(P2.hx = x * m.A + y * m.C + m.tx;  P2.hy = x * m.B + y * m.D + m.ty;)B
528 9670(NewElem \(ECurve, new\);)B
528 9510(new->pe.curve.x0 = P1;  new->pe.curve.x1 = P2;  new->pe.curve.x2 = P3;)B
528 9350(gstate->cp = P3; PathInsert \(p, new\);)B
528 9190(return TRUE;)B
360 9030(})B
360 8710(ArcTo \(path, cp, x1, y1, x2, y2, r, xt1, yt1, xt2, yt2\) )B
780 8550(Path path;)B
780 8390(HardPoint cp;)B
780 8230(float x1, y1, x2, y2, r;)B
780 8070(float *xt1, *yt1, *xt2, *yt2;)B
360 7910({)B
528 7750(UserPoint p0;)B
528 7590(float x0, y0, x3, y3, dist,)B
528 7430(ang, anga, angb, absang, delta;)B
528 7270(int dir;)B
528 6950(p0 = IntToExt \(cp\); x0 = p0.x, y0 = p0.y;)B
528 6790(angb = atan2 \(y2 - y1, x2 - x1\);)B
528 6630(if \(angb <= 0\))B
696 6470(angb += 2 * PI;)B
528 6310(anga = atan2 \(y0 - y1, x0 - x1\);)B
528 6150(if \(anga <= 0\))B
696 5990(anga += 2 * PI;)B
528 5830(ang = angb - anga;)B
528 5670(if \(ang <= 0\))B
696 5510(ang += 2 * PI;)B
528 5350(if \(ang >= 2 * PI\))B
696 5190(ang -= 2 * PI;)B
528 5030(if \(ang >= PI\))B
696 4870(ang -= 2 * PI;)B
528 4710(dir = ang <= 0 ? 1 : -1;)B
528 4550(dist = fabs \(r / sin \(ang / 2\)\);)B
528 4390(absang = ang / 2 + anga;)B
8088 14470(x3 = dist * cos \(absang\) + x1;)B
8088 14310(y3 = dist * sin \(absang\) + y1;)B
8088 14150(absang += PI;)B
8088 13990(delta = \(ang + \(ang > 0 ? - PI : PI\)\) / 2;)B
8088 13830(*xt1 = x3 + r * cos \(absang - delta\);)B
8088 13670(*yt1 = y3 + r * sin \(absang - delta\);)B
8088 13510(*xt2 = x3 + r * cos \(absang + delta\);)B
8088 13350(*yt2 = y3 + r * sin \(absang + delta\);)B
8088 13190(LineTo \(path, ExtToInt \(NewUserPoint \(*xt1, *yt1\)\)\);)B
8088 13030(Arc \(path,)B
8508 12870(dir,)B
8508 12710(NewUserPoint \(x3, y3\),)B
8508 12550(r, absang - delta,)B
8508 12390(absang + delta\);)B
8088 12230(return TRUE;)B
7920 12070(})B
7920 11750(int ClosePath \(p\))B
8340 11590(Path p;)B
7920 11430({)B
8088 11270(Path pp, res;)B
8088 10950(if \(!gstate->cp_defined\) return TRUE;)B
8088 10630(NewElem \(EClose, res\);)B
8088 10470(res->pe.point.hx = gstate->CTM.tx;)B
8088 10310(res->pe.point.hy = gstate->CTM.ty;)B
8088 9990(for \(pp = p; pp->ptype != EMove; pp = pp->last\))B
8256 9830(;)B
8088 9670(PathInsert \(p, res\);)B
8088 9350(NewElem \(EMove, res\);)B
8088 9190(gstate->cp = res->pe.point = pp->pe.point;)B
8088 9030(PathInsert \(p, res\);)B
8088 8870(return TRUE;)B
7920 8710(})B
7920 8390(UserPoint NewUserPoint \(x, y\))B
8340 8230(float x, y;)B
7920 8070({)B
8088 7910(UserPoint res;)B
8088 7590(res.x = x; res.y = y;)B
8088 7430(return res;)B
7920 7270(})B
7920 6950(HardPoint NewHardPoint \(x, y\))B
8340 6790(float x, y;)B
7920 6630({)B
8088 6470(HardPoint res;)B
8088 6150(res.hx = x; res.hy = y;)B
8088 5990(return res;)B
7920 5830(})B
7920 5510(HardPoint MoveHardPoint \(a, b\))B
8340 5350(HardPoint a, b;)B
7920 5190({)B
8088 5030(return NewHardPoint \(a.hx + b.hx, a.hy + b.hy\);)B
7920 4870(})B
7920 4550(UserPoint MoveUserPoint \(a, b\))B
8340 4390(UserPoint a, b;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(pat.c)[(89/04/06)(12:06:12)](4)Gaudy
0 F
360 14470({)B
528 14310(return NewUserPoint \(a.x + b.x, a.y + b.y\);)B
360 14150(})B
360 13830(float PointX \(p\))B
780 13670(UserPoint p;)B
360 13510({)B
528 13350(return p.x;)B
360 13190(})B
360 12870(float PointY \(p\))B
780 12710(UserPoint p;)B
360 12550({)B
528 12390(return p.y;)B
360 12230(})B
360 11910(/*)B
444 11750(* This algorithm subdivides a Bezier curve.)B
444 11590(* The algorithm is taken from:)B
444 11430(*)B
444 11270(*)B
504("The Beta2-split: A special case of the Beta-spline Curve and)X
444 11110(*)B
588(Surface Representation." B. A. Barsky and A. D. DeRose. IEEE, 1985.)X
444 10950(*)B
444 10790(* A vector of control points W is transformed by two matrices into two)B
444 10630(* Vectors which describe the sub-polygons. This is done twice, once each)B
444 10470(* for the X and Y coordinates. The matrices required for the 'left' and)B
444 10310(* 'Right' sub-polygons are as follows:)B
444 10150(*)B
444 9990(*)B
588(/  1    0    0    0  \\)X
1512(/ 1/8  3/8  3/8  1/8 \\)X
444 9830(* W  =)B
84(|  1/2  1/2   0    0   |)X
672(W  =)X
336(|   0   1/4  1/2  1/4  |)X
444 9670(*  L)B
252(|  1/4  1/2  1/4   0   |)X
756(R)X
504(|   0    0   1/2  1/2  |)X
444 9510(*)B
588(\\ 1/8  3/8  3/8  1/8 /)X
1512(\\  0    0    0    1  /)X
444 9350(*)B
444 9190(* The algorithm subdivides the curve recursively until each sub-polygon)B
444 9030(* is deemed to be flat to within the required tolerance. Flatness is)B
444 8870(* defined as the greater distance of the inner control points \(P1 & P2\))B
444 8710(* from the line through the outer ones \(P0 & P3\):)B
444 8550(*)B
444 8390(*)B
4452(P2)X
444 8230(*)B
3108(/-------------X)X
444 8070(*)B
1008(P1)X
924(------------    )X
840(|\\_)X
444 7910(*)B
1092(_X---------/)X
2184(|)X
168(\\_)X
444 7750(*)B
924(_/)X
84(|)X
3024(|)X
336(\\_)X
444 7590(*)B
756(_/)X
252(|)X
3024(|)X
504(\\_)X
444 7430(*       _/)B
420(|)X
3024(|)X
672(\\_)X
444 7270(*     _/)B
588(| D1)X
2520(D2 |)X
840(\\_)X
444 7110(*   _/)B
756(|)X
3024(|)X
1008(\\_)X
444 6950(*  /)B
924(|)X
3024(|)X
1176(\\)X
444 6790(* X-----------------------------------------------------------------X)B
444 6630(* P0)B
444 6470(* )B
4956(P3)X
444 6310(*/)B
360 5990(static Path path;)B
360 5670(#ifdef __STDC__)B
360 5510(int Bezier \(float x0,float y0,float x1,float y1,)B
1368 5350(float x2,float y2,float x3,float y3\))B
360 5190(#else)B
360 5030(int Bezier \(x0,y0, x1, y1, x2, y2, x3, y3\))B
780 4870(float x0, y0, x1, y1, x2, y2, x3, y3;)B
360 4710(#endif)B
360 4550({)B
528 4390(Path new;)B
8088 14470(HardPoint P3;)B
8088 14310(float xsave,ysave,y,opp,adj;)B
8088 14150(float flatness;)B
8088 13830(/* If bezier curve is a point, return a path to \(x3,y3\) */)B
8088 13670(opp = y3-y0;    adj = x3-x0;)B
8088 13510(if\(opp == \(float\) 0.0 && adj == \(float\) 0.0\) {)B
8256 13350(P3.hx = x3;   P3.hy = y3;)B
8256 13190(NewElem \(ELine, new\);)B
8256 13030(gstate->cp = new->pe.point = P3;)B
8256 12870(PathInsert \(path, new\);)B
8256 12710(return TRUE;)B
8088 12550(})B
8088 12230(/* If flatness of \(x1,y1\) and \(x2,y2\) are good, return a path to \(x3,y3\) */)B
8088 12070(flatness = gstate->flatness * sqrt\(opp*opp + adj*adj\);)B
8088 11910(y = - opp*\(x1-x0\) + adj*\(y1-y0\);)B
8088 11750(if \(y >= -flatness && y <= flatness\) {)B
8256 11590(y = - opp*\(x2-x0\) + adj*\(y2-y0\);)B
8256 11430(if \(y >= -flatness && y <= flatness\) {)B
8424 11270(P3.hx = x3;   P3.hy = y3;)B
8424 11110(NewElem \(ELine, new\);)B
8424 10950(gstate->cp = new->pe.point = P3;)B
8424 10790(PathInsert \(path, new\);)B
8424 10630(return TRUE;)B
8256 10470(})B
8088 10310(})B
8088 9990(/* Subdivide bezier curve into two smaller ones and recur */)B
8088 9830(xsave = \(x0+x3\)/8 + 3*\(x1+x2\)/8;)B
8088 9670(ysave = \(y0+y3\)/8 + 3*\(y1+y2\)/8;)B
8088 9510(if \(!Bezier\(x0, )B
1428(y0,)X
9096 9350(\(x0+x1\)/2, )B
840(\(y0+y1\)/2,)X
9096 9190(\(x0+x2\)/4 + x1/2,    \(y0+y2\)/4 + y1/2,)B
9096 9030(xsave,               ysave\)\))B
8256 8870(return 0;)B
8088 8710(return Bezier\(xsave,            ysave,)B
9264 8550(\(x1+x3\)/4 + x2/2, \(y1+y3\)/4 + y2/2,)B
9264 8390(\(x2+x3\)/2,        \(y2+y3\)/2,)B
9264 8230(x3,               y3\);)B
7920 8070(})B
7920 7750(static int RevSeg \(new, p, next\))B
8340 7590(Path new, next;)B
8340 7430(HardPoint p;)B
7920 7270({)B
8088 7110(switch \(next->ptype\) {)B
8088 6950(case EClose:)B
8088 6790(case EHeader:)B
8088 6630(case EMove:)B
252(return MoveTo \(new, p\);)X
8088 6470(case ELine:)B
252(return LineTo \(new, p\);)X
8088 6310(case ECurve:)B
168(return CurveTo \(new, next->pe.curve.x1, next->pe.curve.x0, p\);)X
8088 6150(})B
8088 5990(Panic \("RevSeg: unknown pe type"\);)B
8088 5830(return TRUE;)B
7920 5670(})B
7920 5350(Path ReversePath \(path\))B
8340 5190(Path path;)B
7920 5030({)B
8088 4870(Path p, new, pnew;)B
8088 4710(int closed = FALSE;)B
8088 4390(NewElem \(EHeader, new\);)B
EndPage
HfDict begin ep end
%%Page: ? 50
HfDict begin bp end
StartPage
Landscape
()(pat.c)[(89/04/06)(12:06:12)](5)Gaudy
0 F
528 14470(new->next = new->last = new;)B
528 14310(pnew = new;)B
528 13990(for \(p = path->last; p != path; p = p->last\))B
696 13830(switch \(p->ptype\) {)B
696 13670(case EClose:)B
864 13510(closed = TRUE;)B
864 13350(break;)B
696 13030(case EMove:)B
864 12870(if \(!RevSeg \(new, p->pe.point, p->next\)\) {)B
1032 12710(PathFree \(new\);)B
1032 12550(return NULL;)B
864 12390(})B
864 12230(if \(closed\) {)B
1032 12070(if \(!ClosePath \(new\)\) {)B
1200 11910(PathFree \(new\);)B
1200 11750(return NULL;)B
1032 11590(})B
864 11430(})B
864 11270(new = new->next;)B
864 11110(closed = FALSE;)B
864 10950(break;)B
696 10630(case ELine:)B
864 10470(if \(!RevSeg \(new, p->pe.point, p->next\)\) {)B
1032 10310(PathFree \(new\);)B
1032 10150(return NULL;)B
864 9990(})B
864 9670(break;)B
696 9350(case ECurve:)B
864 9190(if \(!RevSeg \(new, p->pe.curve.x2, p->next\)\) {)B
1032 9030(PathFree \(new\);)B
1032 8870(return NULL;)B
864 8710(})B
864 8390(break;)B
696 8070(default:)B
864 7910(Panic \("ReversePath: unknown element type"\);)B
696 7750(})B
528 7590(PathFree \(p\);)B
528 7270(return pnew;)B
360 7110(})B
360 6790(Path FlattenPath \(arg\))B
780 6630(Path arg;)B
360 6470({)B
528 6310(Path p, pp, new, add;)B
528 6150(HardPoint lastp;)B
528 5830(NewElem \(EHeader, new\);)B
528 5670(new->next = new->last = new;)B
528 5510(path = new;)B
528 5350(for \(p = arg->next; p != arg; p = p->next\))B
696 5190(switch \(p->ptype\) {)B
864 5030(case EMove:)B
1032 4870(lastp = p->pe.point;)B
1032 4710(NewElem \(EMove, add\);)B
1032 4550(add->pe.point = lastp;)B
1032 4390(if \(!EmptyPath \(new\) && CurEType \(new\) == EMove\) PathDelete \(new\);)B
8592 14470(gstate->cp_defined = TRUE;)B
8592 14310(gstate->cp = lastp;)B
8592 14150(PathInsert \(new, add\);)B
8592 13990(break;)B
8424 13830(case ELine:)B
8592 13670(lastp = p->pe.point;)B
8592 13510(NewElem \(ELine, add\);)B
8592 13350(add->pe.point = lastp;)B
8592 13190(gstate->cp = lastp;)B
8592 13030(PathInsert \(new, add\);)B
8592 12870(break;)B
8424 12710(case EClose:)B
8592 12550(if \(gstate->cp_defined\) {)B
8760 12390(NewElem \(EClose, add\);)B
8760 12230(add->pe.point.hx = gstate->CTM.tx;)B
8760 12070(add->pe.point.hy = gstate->CTM.ty;)B
8760 11750(for \(pp = new; pp->ptype != EMove; pp = pp->last\))B
8928 11590(;)B
8760 11430(PathInsert \(new, add\);)B
8760 11110(NewElem \(EMove, add\);)B
8760 10950(gstate->cp = add->pe.point = pp->pe.point;)B
8760 10790(PathInsert \(new, add\);)B
8592 10630(})B
8592 10470(break;)B
8424 10310(case ECurve:)B
8592 10150(if \(!Bezier\(lastp.hx,          lastp.hy,)B
9600 9990(p->pe.curve.x0.hx, p->pe.curve.x0.hy,)B
9600 9830(p->pe.curve.x1.hx, p->pe.curve.x1.hy,)B
9600 9670(p->pe.curve.x2.hx, p->pe.curve.x2.hy\)\) {)B
8760 9510(PathFree \(new\);)B
8760 9350(return NULL;)B
8592 9190(})B
8592 9030(lastp = p->pe.curve.x2;)B
8592 8870(break;)B
8424 8710(default:)B
8592 8550(Panic \("Flattenpath discovers unknown path element type"\);)B
8592 8390(break;)B
8256 8230(})B
8088 8070(return path;)B
7920 7910(})B
7920 7590(int CloseAll \(path\))B
8340 7430(Path path;)B
7920 7270({)B
8088 7110(/* closes all open portions of a path *in place* */)B
8088 6950(Path p;)B
8088 6790(enum pelem_type last_type = EHeader;)B
8088 6470(for \(p = path->next; p != path; last_type = p->ptype, p = p->next\))B
8256 6310(if \(p->ptype == EMove && last_type != EClose && last_type != EHeader\))B
8424 6150(if \(!ClosePath \(p\)\))B
8592 5990(return Error \(PLimitCheck\);)B
8088 5830(if \(last_type == EMove\) {)B
8256 5670(PathDelete \(p\);)B
8256 5510(return TRUE;)B
8088 5350(})B
8088 5190(if \(last_type == EHeader || last_type == EClose\))B
8256 5030(return TRUE;)B
8088 4870(return ClosePath \(p\);)B
7920 4710(})B
7920 4390(SetPath \(p, v\))B
EndPage
HfDict begin hp end
StartPage
Landscape
()(pat.c)[(89/04/06)(12:06:12)](6)Gaudy
0 F
780 14470(Path *p, v;)B
360 14310({)B
528 14150(PathFree \(\(*p\)\);)B
528 13990(*p = v;)B
360 13830(})B
360 13510(Bound \(left, right, top, bottom, p\))B
780 13350(float *left, *right, *top, *bottom;)B
780 13190(HardPoint p;)B
360 13030({)B
528 12870(if \(p.hx < *left\) )B
336(*left )X
168(= p.hx;)X
528 12710(if \(p.hx > *right\) )B
252(*right )X
84(= p.hx;)X
528 12550(if \(p.hy < *bottom\) )B
168(*bottom = p.hy;)X
528 12390(if \(p.hy > *top\) )B
420(*top )X
252(= p.hy;)X
360 12230(})B
360 11910(int PathBBox \(left, right, top, bottom\))B
780 11750(float *left, *right, *top, *bottom;)B
360 11590({)B
528 11430(Path p;)B
528 11110(if \(!gstate->cp_defined || EmptyPath \(gstate->path\)\))B
696 10950(return Error \(PNoCurrentPoint\);)B
528 10630(*left = *right = gstate->cp.hx;)B
528 10470(*top = *bottom = gstate->cp.hy;)B
528 10150(for \(p = gstate->path->next; p != gstate->path; p = p->next\))B
696 9990(switch \(p->ptype\) {)B
696 9830(case EMove:)B
696 9670(case ELine:)B
864 9510(Bound \(left, right, top, bottom, p->pe.point\);)B
864 9350(break;)B
696 9190(case EClose:)B
864 9030(break;)B
696 8870(case ECurve:)B
864 8710(Bound \(left, right, top, bottom, p->pe.curve.x0\);)B
864 8550(Bound \(left, right, top, bottom, p->pe.curve.x1\);)B
864 8390(Bound \(left, right, top, bottom, p->pe.curve.x2\); )B
864 8230(break;)B
696 8070(case EHeader:)B
864 7910(Panic \("PathBBox, header found."\);)B
864 7750(break;)B
696 7590(default:)B
864 7430(Panic \("PathBBox, unknown path element type."\);)B
864 7270(break;)B
696 7110(})B
528 6790(return TRUE;)B
360 6630(})B
360 6310(UserBound \(left, right, top, bottom, p\))B
780 6150(float *left, *right, *top, *bottom;)B
780 5990(UserPoint p;)B
360 5830({)B
528 5670(if \(p.x < *left\) )B
420(*left )X
168(= p.x;)X
528 5510(if \(p.x > *right\) )B
336(*right )X
84(= p.x;)X
528 5350(if \(p.y < *bottom\) )B
252(*bottom = p.y;)X
528 5190(if \(p.y > *top\) )B
504(*top )X
252(= p.y;)X
360 5030(})B
EndPage
HfDict begin ep end
%%Page: ? 51
HfDict begin bp end
StartPage
Landscape
()(path.c)[(89/03/25)(06:25:09)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(#include "graphics.h")B
360 11750(#define PATHFORALLDEPTH 500)B
360 11430(static int PCurrentPoint \(\);)B
360 11270(static int PMoveTo \(\);)B
360 11110(static int PRMoveTo \(\);)B
360 10950(static int PLineTo \(\);)B
360 10790(static int PRLineTo \(\);)B
360 10630(static int PArc \(\);)B
360 10470(static int PArcN \(\);)B
360 10310(static int PArcTo \(\);)B
360 10150(static int PCurveTo \(\);)B
360 9990(static int PRCurveTo \(\);)B
360 9830(static int PClosePath \(\);)B
360 9670(static int PPathBBox \(\);)B
360 9510(static int PReversePath \(\);)B
360 9350(static int PPathForAll \(\);)B
360 9030(static int PathForAll \(\);)B
360 8870(static int PPathProc \(\);)B
360 8550(int PFlattenPath \(\);)B
360 8230(Object OpPathForAll;)B
360 7910(InitPath \(\))B
360 7750({)B
528 7590(OpPathForAll = MakeOp \("\(oppathforall\)", PathForAll, 0, 6, 7, 7\);)B
528 7270(InstallOp \("newpath",)B
756(PNewPath,)X
588(0, 0, 0, 0\);)X
528 7110(InstallOp \("currentpoint",)B
336(PCurrentPoint,)X
168(0, 2, 0, 0\);)X
528 6950(InstallOp \("moveto",)B
840(PMoveTo,)X
672(2, 0, 0, 0, Float, Float\);)X
528 6790(InstallOp \("rmoveto",)B
756(PRMoveTo,)X
588(2, 0, 0, 0, Float, Float\);)X
528 6630(InstallOp \("lineto",)B
840(PLineTo,)X
672(2, 0, 0, 0, Float, Float\);)X
528 6470(InstallOp \("rlineto",)B
756(PRLineTo,)X
588(2, 0, 0, 0, Float, Float\);)X
528 6310(InstallOp \("arc",)B
1092(PArc,)X
924(5, 0, 0, 0, Float, Float,)X
1452 6150(Float, Float, Float\);)B
528 5990(InstallOp \("arcn",)B
1008(PArcN,)X
840(5, 0, 0, 0, Float, Float,)X
1452 5830(Float, Float, Float\);)B
528 5670(InstallOp \("arcto",)B
924(PArcTo,)X
756(5, 4, 0, 0, Float, Float,)X
1452 5510(Float, Float, Float\);)B
528 5350(InstallOp \("curveto",)B
756(PCurveTo,)X
588(6, 0, 0, 0, Float, Float,)X
1452 5190(Float, Float, Float, Float\);)B
528 5030(InstallOp \("rcurveto",)B
672(PRCurveTo,)X
504(6, 0, 0, 0, Float,)X
1452 4870(Float, Float, Float, Float, Float\);)B
528 4710(InstallOp \("closepath",)B
588(PClosePath,)X
420(0, 0, 0, 0\);)X
528 4550(InstallOp \("pathbbox",)B
672(PPathBBox,)X
504(0, 4, 0, 0\);)X
528 4390(InstallOp \("flattenpath",)B
420(PFlattenPath,)X
252(0, 0, 0, 0\);)X
8088 14470(InstallOp \("reversepath",)B
420(PReversePath,)X
252(0, 0, 0, 0\);)X
8088 14310(InstallOp \("pathforall",)B
504(PPathForAll,)X
336(4, 0, 0, 6, Array, Array,)X
9012 14150(Array, Array\);)B
8088 13990(InstallOp \("pathproc",)B
672(PPathProc,)X
504(0, 1, 0, 0\);)X
8088 13830(gstate->path = NewPath \(\);)B
8088 13670(gstate->clip = NewPath \(\);)B
7920 13510(})B
7920 13190(int PNewPath \(\))B
7920 13030({)B
8088 12870(Path new;)B
8088 12550(gstate->cp_defined = FALSE;)B
8088 12390(PathFree \(gstate->path\);)B
8088 12230(NewElem\(EHeader,new\);)B
8088 12070(new->next = new->last = new;)B
8088 11910(gstate->path = new;)B
8088 11750(return TRUE;)B
7920 11590(})B
7920 11270(static int PCurrentPoint \(\))B
7920 11110({)B
8088 10950(UserPoint cp;)B
8088 10630(if \(!gstate->cp_defined\))B
8256 10470(return Error \(PNoCurrentPoint\);)B
8088 10310(cp = IntToExt \(gstate->cp\);)B
8088 10150(VOID Push \(OpStack, MakeReal \(PointX \(cp\)\)\);)B
8088 9990(VOID Push \(OpStack, MakeReal \(PointY \(cp\)\)\);)B
8088 9830(return TRUE;)B
7920 9670(})B
7920 9350(static int PMoveTo \(x, y\))B
8340 9190(Object x, y;)B
7920 9030({)B
8088 8870(UserPoint new;)B
8088 8710(extern FILE *vfp;)B
8088 8550(char foo[BUFSIZ];)B
8088 8230(if\(vfp != NULL\) {)B
8256 8070(sprintf\(foo, "PMoveto XY: %f %f", BodyReal\(x\), BodyReal\(y\)\);)B
8256 7910(Message\(foo\);)B
8088 7750(})B
8088 7590(new.x = BodyReal\(x\);    new.y = BodyReal\(y\);)B
8088 7430(return MoveTo \(gstate->path, ExtToInt \(new\)\);)B
7920 7270(})B
7920 6950(static int PRMoveTo \(x, y\))B
8340 6790(Object x, y;)B
7920 6630({)B
8088 6470(if \(!gstate->cp_defined\))B
8256 6310(return Error \(PNoCurrentPoint\);)B
8088 6150(return MoveTo \(gstate->path, ExtToInt \(MoveUserPoint \(NewUserPoint \(BodyReal \(x\), BodyR)B
7920 5990(})B
7920 5670(static int PLineTo \(x, y\))B
8340 5510(Object x, y;)B
7920 5350({)B
8088 5190(UserPoint new;)B
8088 4870(if \(!gstate->cp_defined\))B
8256 4710(return Error \(PNoCurrentPoint\);)B
8088 4550(new.x = BodyReal\(x\);    new.y = BodyReal\(y\);)B
8088 4390(return LineTo \(gstate->path, ExtToInt \(new\)\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(path.c)[(89/03/25)(06:25:09)](2)Gaudy
0 F
360 14470(})B
360 14150(static int PRLineTo \(x, y\))B
780 13990(Object x, y;)B
360 13830({)B
528 13670(if \(!gstate->cp_defined\))B
696 13510(return Error \(PNoCurrentPoint\);)B
528 13350(return LineTo \(gstate->path, ExtToInt \(MoveUserPoint \(NewUserPoint \(BodyReal \(x\), BodyR)B
360 13190(})B
360 12870(static int PArc \(x, y, rad, ang1, ang2\))B
780 12710(Object x, y, rad, ang1, ang2;)B
360 12550({)B
528 12390(UserPoint centre, start;)B
528 12230(float a1 = Rad \(BodyReal \(ang1\)\), a2 = Rad \(BodyReal \(ang2\)\);)B
528 12070(float r = BodyReal \(rad\);)B
528 11750(start = NewUserPoint \(cos \(a1\) * r, sin \(a1\) * r\);)B
528 11590(centre = NewUserPoint \(BodyReal \(x\), BodyReal \(y\)\);)B
528 11430(/* DCJ:)B
612 11270(* Compiler barfed on original line.  Don't blame it.)B
612 11110(*/)B
528 10950(if \(EmptyPath \(gstate->path\)\) {)B
696 10790(if \(!MoveTo \(gstate->path, ExtToInt \(MoveUserPoint \(centre, start\)\)\)\))B
864 10630(return FALSE;)B
528 10470(} else {)B
696 10310(if \(!LineTo \(gstate->path, ExtToInt \(MoveUserPoint \(centre, start\)\)\)\))B
864 10150(return FALSE;)B
528 9990(})B
528 9670(/* )B
252(if \(!\(*\(EmptyPath \(gstate->path\) ? MoveTo : LineTo\)\) \(gstate->path, ExtToInt \(Mov)X
612 9510(* return FALSE;)B
612 9350(*/)B
528 9190(return Arc \(gstate->path, 1, centre, r, a1, a2\);)B
360 9030(})B
360 8710(static int PArcN \(x, y, rad, ang1, ang2\))B
780 8550(Object x, y, rad, ang1, ang2;)B
360 8390({)B
528 8230(UserPoint centre, start;)B
528 8070(float a1 = Rad \(BodyReal \(ang1\)\), a2 = Rad \(BodyReal \(ang2\)\);)B
528 7910(float r = BodyReal \(rad\);)B
528 7590(start = NewUserPoint \(cos \(a1\) * r, sin \(a1\) * r\);)B
528 7430(centre = NewUserPoint \(BodyReal \(x\), BodyReal \(y\)\);)B
528 7270(/* DCJ:)B
612 7110(* Compiler barfed on original line.  Don't blame it.)B
612 6950(*/)B
528 6790(if \(EmptyPath \(gstate->path\)\) {)B
696 6630(if \(!MoveTo \(gstate->path, ExtToInt \(MoveUserPoint \(centre, start\)\)\)\))B
864 6470(return FALSE;)B
528 6310(} else {)B
696 6150(if \(!LineTo \(gstate->path, ExtToInt \(MoveUserPoint \(centre, start\)\)\)\))B
864 5990(return FALSE;)B
528 5830(})B
528 5510(/* )B
252(if \(!\(*\(EmptyPath \(gstate->path\) ? MoveTo : LineTo\)\) \(gstate->path, ExtToInt \(Mov)X
612 5350(* return FALSE;)B
612 5190(*/)B
528 5030(return Arc \(gstate->path, -1, centre, r, a1, a2\);)B
360 4870(})B
360 4550(static int PArcTo \(X1, Y1, X2, Y2, rad\))B
780 4390(Object X1, Y1, X2, Y2, rad;)B
7920 14470({)B
8088 14310(float xt1, xt2, yt1, yt2;)B
8088 14150(if \(!gstate->cp_defined\))B
8256 13990(return Error \(PNoCurrentPoint\);)B
8088 13670(return ArcTo \(gstate->path, gstate->cp,)B
9264 13510(BodyReal \(X1\), BodyReal \(Y1\), BodyReal \(X2\), BodyReal \(Y2\), BodyReal \(rad)B
9264 13350(&xt1, &yt1, &xt2,  &yt2\) &&)B
9432 13190(Push \(OpStack, MakeReal \(xt1\)\) &&)B
9600 13030(Push \(OpStack, MakeReal \(yt1\)\) &&)B
9768 12870(Push \(OpStack, MakeReal \(xt2\)\) &&)B
9936 12710(Push \(OpStack, MakeReal \(yt2\)\);)B
7920 12550(})B
7920 12230(static int PCurveTo \(x0, y0, x1, y1, x2, y2\))B
8340 12070(Object x0, y0, x1, y1, x2, y2;)B
7920 11910({)B
8088 11750(if \(!gstate->cp_defined\))B
8256 11590(return Error \(PNoCurrentPoint\);)B
8088 11430(return CurveTo \(gstate->path,)B
9432 11270(ExtToInt \(NewUserPoint \(BodyReal \(x0\), BodyReal \(y0\)\)\),)B
9432 11110(ExtToInt \(NewUserPoint \(BodyReal \(x1\), BodyReal \(y1\)\)\),)B
9432 10950(ExtToInt \(NewUserPoint \(BodyReal \(x2\), BodyReal \(y2\)\)\)\);)B
7920 10790(})B
7920 10470(static int PRCurveTo \(x0, y0, x1, y1, x2, y2\))B
8340 10310(Object x0, y0, x1, y1, x2, y2;)B
7920 10150({)B
8088 9990(UserPoint cp;)B
8088 9670(if \(!gstate->cp_defined\))B
8256 9510(return Error \(PNoCurrentPoint\);)B
8088 9350(cp = IntToExt \(gstate->cp\);)B
8088 9190(return CurveTo \(gstate->path,)B
9432 9030(ExtToInt \(MoveUserPoint \(cp,)B
11532 8870(NewUserPoint \(BodyReal \(x0\),)B
12708 8710(BodyReal \(y0\)\)\)\),)B
9432 8550(ExtToInt \(MoveUserPoint \(cp,)B
11532 8390(NewUserPoint \(BodyReal \(x1\),)B
12708 8230(BodyReal \(y1\)\)\)\),)B
9432 8070(ExtToInt \(MoveUserPoint \(cp,)B
11532 7910(NewUserPoint \(BodyReal \(x2\),)B
12708 7750(BodyReal \(y2\)\)\)\)\);)B
7920 7590(})B
7920 7270(static int PClosePath \(\))B
7920 7110({)B
8088 6950(return ClosePath \(gstate->path\);)B
7920 6790(})B
7920 6470(int PFlattenPath \(\))B
7920 6310({)B
8088 6150(Path res;)B
8088 5830(if \(\(res = FlattenPath \(gstate->path\)\) == NULL\))B
8256 5670(return Error \(PLimitCheck\);)B
8088 5510(SetPath \(&gstate->path, res\);)B
8088 5350(return TRUE;)B
7920 5190(})B
7920 4870(static int PReversePath \(\))B
7920 4710({)B
8088 4550(Path res;)B
EndPage
HfDict begin ep end
%%Page: ? 52
HfDict begin bp end
StartPage
Landscape
()(path.c)[(89/03/25)(06:25:09)](3)Gaudy
0 F
528 14470(if \(\(res = ReversePath \(gstate->path\)\) == NULL\))B
696 14310(return Error \(PLimitCheck\);)B
528 14150(SetPath \(&gstate->path, res\);)B
528 13990(return TRUE;)B
360 13830(})B
360 13510(static Path pathforall [PATHFORALLDEPTH], *pathp = pathforall;)B
360 13350(static int path_depth = 0;)B
360 13030(static int PPathForAll \(move, line, curve, close\))B
780 12870(Object move, line, curve, close;)B
360 12710({)B
528 12550(Path res;)B
528 12230(if \(\(res = PathCopy \(gstate->path\)\) == NULL || path_depth == PATHFORALLDEPTH - 1\))B
696 12070(return Error \(PLimitCheck\);)B
528 11910(*++pathp = res;)B
528 11750(++path_depth;)B
528 11590(VOID Push \(ExecStack, Nil\);)B
528 11430(VOID Push \(ExecStack, move\);)B
528 11270(VOID Push \(ExecStack, line\);)B
528 11110(VOID Push \(ExecStack, curve\);)B
528 10950(VOID Push \(ExecStack, close\);)B
528 10790(VOID Push \(ExecStack, OpPathForAll\);)B
528 10630(return TRUE;)B
360 10470(})B
360 10150(static int PathForAll \(\))B
360 9990({)B
528 9830(Path res;)B
528 9670(Object move, line, curve, close, fn;)B
528 9510(UserPoint p;)B
528 9190(close = Pop \(ExecStack\);)B
528 9030(curve = Pop \(ExecStack\);)B
528 8870(line = Pop \(ExecStack\);)B
528 8710(move = Pop \(ExecStack\);)B
528 8550(if \(EmptyPath \(*pathp\)\) {)B
696 8390(PathFree \(*pathp\);)B
696 8230(*pathp--;)B
696 8070(--path_depth;)B
696 7910(VOID Pop \(ExecStack\);)B
696 7750(return TRUE;)B
528 7590(})B
528 7430(res = \(*pathp\)->next;)B
528 7270(switch \(res->ptype\) {)B
528 7110(case EMove:)B
696 6950(p = IntToExt \(res->pe.point\);)B
696 6790(VOID Push \(OpStack, MakeReal \(p.x\)\);)B
696 6630(VOID Push \(OpStack, MakeReal \(p.y\)\);)B
696 6470(fn = move;)B
696 6310(break;)B
528 5990(case ELine:)B
696 5830(p = IntToExt \(res->pe.point\);)B
696 5670(VOID Push \(OpStack, MakeReal \(p.x\)\);)B
696 5510(VOID Push \(OpStack, MakeReal \(p.y\)\);)B
696 5350(fn = line;)B
696 5190(break;)B
528 4870(case ECurve:)B
696 4710(p = IntToExt \(res->pe.curve.x0\);)B
696 4550(VOID Push \(OpStack, MakeReal \(p.x\)\);)B
696 4390(VOID Push \(OpStack, MakeReal \(p.y\)\);)B
8256 14470(p = IntToExt \(res->pe.curve.x1\);)B
8256 14310(VOID Push \(OpStack, MakeReal \(p.x\)\);)B
8256 14150(VOID Push \(OpStack, MakeReal \(p.y\)\);)B
8256 13990(p = IntToExt \(res->pe.curve.x2\);)B
8256 13830(VOID Push \(OpStack, MakeReal \(p.x\)\);)B
8256 13670(VOID Push \(OpStack, MakeReal \(p.y\)\);)B
8256 13510(fn = curve;)B
8256 13350(break;)B
8088 13030(case EClose:)B
8256 12870(fn = close;)B
8256 12710(break;)B
8088 12390(default:)B
8256 12230(Panic \("OpPathForAll - encounters unknown path element"\);)B
8088 12070(})B
8088 11910(VOID Push \(ExecStack, move\);)B
8088 11750(VOID Push \(ExecStack, line\);)B
8088 11590(VOID Push \(ExecStack, curve\);)B
8088 11430(VOID Push \(ExecStack, close\);)B
8088 11270(VOID Push \(ExecStack, OpPathForAll\);)B
8088 11110(VOID Push \(ExecStack, fn\);)B
8088 10790(PathDelete \(res->next\);)B
8088 10630(return TRUE;)B
7920 10470(})B
7920 10150(static int PPathProc \(\))B
7920 9990({)B
8088 9830(Object *body, *p;)B
8088 9670(int sum = 0;)B
8088 9510(Path pa;)B
8088 9350(UserPoint po;)B
8088 9030(for \(pa = gstate->path->next; pa != gstate->path; pa = pa->next\))B
8256 8870(switch \(pa->ptype\) {)B
8256 8710(case EMove: case ELine: sum += 3; break;)B
8256 8550(case ECurve: sum += 7; break;)B
8256 8390(case EClose: ++sum; break;)B
8256 8230(})B
8088 7910(p = body = \(Object *\) Malloc \(\(unsigned\) sizeof \(Object\) * sum\);)B
8088 7750(for \(pa = gstate->path->next; pa != gstate->path; pa = pa->next\))B
8256 7590(switch \(pa->ptype\) {)B
8256 7430(case EMove:)B
8424 7270(po = IntToExt \(pa->pe.point\);)B
8424 7110(*p++ = MakeReal \(po.x\);)B
8424 6950(*p++ = MakeReal \(po.y\);)B
8424 6790(*p++ = Cvx \(NameFrom \("moveto"\)\);)B
8424 6630(break;)B
8256 6310(case ELine:)B
8424 6150(po = IntToExt \(pa->pe.point\);)B
8424 5990(*p++ = MakeReal \(po.x\);)B
8424 5830(*p++ = MakeReal \(po.y\);)B
8424 5670(*p++ = Cvx \(NameFrom \("lineto"\)\);)B
8424 5510(break;)B
8256 5190(case ECurve:)B
8424 5030(po = IntToExt \(pa->pe.curve.x0\);)B
8424 4870(*p++ = MakeReal \(po.x\);)B
8424 4710(*p++ = MakeReal \(po.y\);)B
8424 4550(po = IntToExt \(pa->pe.curve.x1\);)B
8424 4390(*p++ = MakeReal \(po.x\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(path.c)[(89/03/25)(06:25:09)](4)Gaudy
0 F
864 14470(*p++ = MakeReal \(po.y\);)B
864 14310(po = IntToExt \(pa->pe.curve.x2\);)B
864 14150(*p++ = MakeReal \(po.x\);)B
864 13990(*p++ = MakeReal \(po.y\);)B
864 13830(*p++ = Cvx \(NameFrom \("curve"\)\);)B
864 13670(break;)B
696 13350(case EClose:)B
864 13190(*p++ = Cvx \(NameFrom \("closepath"\)\);)B
864 13030(break;)B
696 12870(})B
528 12710(return Push \(OpStack, Cvx \(MakeArray \(body, sum\)\)\);)B
360 12550(})B
360 12230(static int PPathBBox \(\))B
360 12070({)B
528 11910(UserPoint right_top, left_bottom, left_top, right_bottom;)B
528 11750(float left, right, top, bottom, uleft, uright, utop, ubottom;)B
528 11430(if \(!PathBBox \(&left, &right, &top, &bottom\)\))B
696 11270(return FALSE;)B
528 10950(left_bottom)B
252(= IntToExt \(NewHardPoint \(left, bottom\)\);)X
528 10790(right_bottom)B
168(= IntToExt \(NewHardPoint \(right, bottom\)\);)X
528 10630(right_top )B
336(= IntToExt \(NewHardPoint \(right, top\)\);)X
528 10470(left_top)B
504(= IntToExt \(NewHardPoint \(left, top\)\);)X
528 10150(uleft = uright = left_bottom.x; utop = ubottom = left_bottom.y;)B
528 9990(UserBound \(&uleft, &uright, &utop, &ubottom, left_top\);)B
528 9830(UserBound \(&uleft, &uright, &utop, &ubottom, right_top\);)B
528 9670(UserBound \(&uleft, &uright, &utop, &ubottom, right_bottom\);)B
528 9350(VOID Push \(OpStack, MakeReal \(uleft\)\);)B
528 9190(VOID Push \(OpStack, MakeReal \(ubottom\)\);)B
528 9030(VOID Push \(OpStack, MakeReal \(uright\)\);)B
528 8870(VOID Push \(OpStack, MakeReal \(utop\)\);)B
528 8550(return TRUE;)B
360 8390(})B
EndPage
HfDict begin ep end
%%Page: ? 53
HfDict begin bp end
StartPage
Landscape
()(path.h)[(89/04/06)(12:08:13)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(#define CBUTT)B
252(0)X
360 13670(#define CROUND)B
168(1)X
360 13510(#define CSQUARE)B
84(2)X
360 13190(#define JMITRE)B
168(0)X
360 13030(#define JROUND)B
168(1)X
360 12870(#define JBEVEL)B
168(2)X
360 12550(#define STROKE_FILL 0)B
360 12390(#define STROKE_THIN 1)B
360 12070(#define FILL_SINGLE)B
1092(0)X
360 11910(#define FILL_CACHE_DOUBLE)B
588(1)X
360 11750(#define FILL_DOUBLE)B
1092(2)X
360 11590(#define FILL_DOUBLE_STROKE)B
504(3)X
360 11270(#ifdef MACINTOSH)B
360 11110(#define MAXPATHELEMENTS 3000)B
360 10950(#else)B
360 10790(#define MAXPATHELEMENTS 3000)B
360 10630(#endif)B
360 10310(typedef struct hard_point { float hx, hy; } HardPoint;)B
360 9990(enum pelem_type { EHeader, EMove, ELine, EArc, ECurve, EClose };)B
360 9670(struct path_element)B
360 9510({)B
528 9350(enum pelem_type ptype;)B
528 9190(union {)B
696 9030(HardPoint point;)B
696 8870(struct arc { int dir; HardPoint centre; float radius, from, to; } arc;)B
696 8710(struct bezier { HardPoint x0, x1, x2; } curve;)B
528 8550(} pe;)B
528 8390(struct path_element *next, *last;)B
360 8230(};)B
360 7910(typedef struct path_element *Path;)B
360 7590(extern HardPoint NewHardPoint \(\), ExtToInt \(\), MoveHardPoint \(\);)B
360 7430(extern Path NewPath \(\), PathCopy \(\), NewMove \(\);)B
360 7270(extern int PNewPath \(\), PInitMatrix \(\);)B
360 7110(extern Path NewClipPath \(\), PathRemove \(\), ReversePath \(\), FlattenPath \(\);)B
360 6950(extern float Normalise \(\), PointX \(\), PointY \(\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(point.h)[(89/03/24)(06:33:42)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(typedef struct point { float x, y; } UserPoint;)B
360 13510(extern Matrix PointTranslate \(\);)B
360 13350(extern UserPoint NewUserPoint \(\), IntToExt \(\), MoveUserPoint \(\);)B
360 13190(extern int MoveTo \(\), LineTo \(\);)B
360 13030(extern Object AssignMatrix \(\);)B
EndPage
HfDict begin ep end
%%Page: ? 54
HfDict begin bp end
StartPage
Landscape
()(poly.c)[(89/04/06)(12:09:15)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not sold for)B
444 13830(* profit or incorporated into a product except under licence from the author.)B
444 13670(* It is not in the public domain.)B
444 13510(* This notice should remain in the source unaltered, and any changes to the)B
444 13350(* source made by persons other than the author should be marked as such.)B
444 13190(* )B
444 13030(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12870(*/)B
360 12710(#include "main.h")B
360 12390(static int Copy \(\);)B
360 12070(int PolyFirst \(\), PolySecond \(\), PolyThird \(\), PolyPair \(\);)B
360 11750(InitPoly \(\))B
360 11590({)B
528 11430(Lbracket = Cvx \(NameFrom\("["\)\);)B
528 11270(Rbracket = Cvx \(NameFrom\("]"\)\);)B
528 10950(InstallOp \("token",)B
588(PolyFirst,)X
168(1, 1, 0, 0, Poly\);)X
528 10790(InstallOp \("copy",)B
672(Copy, )X
504(0, 0, 0, 0\);)X
528 10630(InstallOp \("length",)B
504(PolyFirst,)X
168(1, 1, 0, 0, Poly\);)X
528 10470(InstallOp \("forall",)B
504(PolySecond,)X
84(2, 2, 0, 0, Poly, Poly\);)X
528 10310(InstallOp \("get",)B
756(PolySecond,)X
84(2, 2, 0, 0, Poly, Poly\);)X
528 10150(InstallOp \("put",)B
756(PolyThird,)X
168(3, 3, 0, 0, Poly, Poly, Poly\);)X
528 9990(InstallOp \("getinterval", PolyThird,)B
168(3, 3, 0, 0, Poly, Poly, Poly\);)X
528 9830(InstallOp \("putinterval", PolyThird,)B
168(3, 3, 0, 0, Poly, Poly, Poly\);)X
528 9670(InstallOp \("signature",   PolyFirst,)B
168(1, 0, 0, 0, Poly\);)X
360 9510(})B
360 9190(Object Parse \(f\))B
780 9030(Object f;)B
360 8870({)B
528 8710(Object res;)B
528 8550(int c;)B
528 8230(if\(BodyFile\(f\)->file_type == StreamFile\) {)B
696 8070(FILE *fp = BodyFile\(f\)->f.f_ptr;)B
696 7910(for \(;;\))B
864 7750(switch \(c = getc\(fp\)\) {)B
1032 7590(default:)B
360 7430(/*)B
672(BodyFile\(f\)->available++; */)X
1200 7270(ungetc\(c,fp\);)B
1200 7110(res = ParseId \(f\);)B
1200 6950(if \(!\(TypeOf \(res\) == Integer || TypeOf \(res\) == Real\)\))B
1368 6790(res.flags |= EXECUTABLE;)B
1200 6630(return res;)B
1032 6310(case '/': return ParseId \(f\);)B
1032 6150(case '{': res = ParseArray \(f\); res.flags |= EXECUTABLE; return res;)B
1032 5990(case '}': return True;)B
1032 5830(case '[': return Lbracket;)B
1032 5670(case ']': return Rbracket;)B
1032 5510(case '<': return ParseHexString \(f\);)B
1032 5350(case '\(': return ParseString \(f\);)B
1032 5190(case '\)': return Absent;)B
1032 4870(case EOF: return False;)B
1032 4550(case ' ':)B
1032 4390(case '\\t':)B
8592 14470(case '\\n': continue;)B
8592 14150(case '%':)B
8760 13990(while \(\(c = getc\(fp\)\) != '\\n' && c != EOF\))B
8928 13830(;)B
8760 13670(if\(c == EOF\) return False;)B
8760 13510(continue;)B
8424 13350(})B
8088 13190(})B
8088 13030(else {)B
8256 12870(for \(;;\))B
8424 12710(switch \(c = Getch \(f\)\) {)B
8592 12550(default:)B
8760 12390(Ungetch \(f, c\);)B
8760 12230(res = ParseId \(f\);)B
8760 12070(if \(!\(TypeOf \(res\) == Integer || TypeOf \(res\) == Real\)\))B
8928 11910(res.flags |= EXECUTABLE;)B
8760 11750(return res;)B
8592 11430(case '/': return ParseId \(f\);)B
8592 11270(case '{': res = ParseArray \(f\); res.flags |= EXECUTABLE; return res;)B
8592 11110(case '}': return True;)B
8592 10950(case '[': return Lbracket;)B
8592 10790(case ']': return Rbracket;)B
8592 10630(case '<': return ParseHexString \(f\);)B
8592 10470(case '\(': return ParseString \(f\);)B
8592 10310(case '\)': return Absent;)B
8592 9990(case EOF: return False;)B
8592 9670(case ' ':)B
8592 9510(case '\\t':)B
8592 9350(case '\\n': continue;)B
8592 9030(case '%':)B
8760 8870(while \(\(c = Getch \(f\)\) != '\\n' && c != EOF\))B
8928 8710(;)B
8760 8550(if\(c == EOF\) return False;)B
8760 8390(continue;)B
8424 8230(})B
8088 8070(})B
7920 7910(})B
7920 7590(/*)B
8004 7430(* The following are a few of the polymorphic generic routines which actually)B
8004 7270(* get called by user PostScript.)B
8004 7110(* They call type-checked routines on behalf of the types of their arguments.)B
8004 6950(*)B
8004 6790(*/)B
7920 6470(int PolyFirst \(arg1\) Object arg1;)B
588(/* type dictionary choice determined by top of st)X
8004 6310({)B
8592 6150(if \(!Apply \(TypeOf \(arg1\)\)\))B
9264 5990(return Error \(PTypeCheck\);)B
8592 5830(return Push \(OpStack, arg1\);)B
8004 5670(})B
7920 5350(int PolySecond \(arg1, arg2\) Object arg1, arg2;)B
168(/* type dictionary choice determined by f)X
8004 5190({)B
8592 5030(if \(!Apply \(TypeOf \(arg1\)\)\))B
9264 4870(return Error \(PTypeCheck\);)B
8592 4710(return Push \(OpStack, arg1\), Push \(OpStack, arg2\);)B
8004 4550(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(poly.c)[(89/04/06)(12:09:15)](2)Gaudy
0 F
360 14470(int PolyThird \(arg1, arg2, arg3\) Object arg1, arg2, arg3;)B
588(/* type dictionary choice)X
444 14310({)B
1032 14150(if \(!Apply \(TypeOf \(arg1\)\)\))B
1704 13990(return Error \(PTypeCheck\);)B
1032 13830(return Push \(OpStack, arg1\), Push \(OpStack, arg2\), Push \(OpStack, arg3\);)B
444 13670(})B
360 13350(int PolyPair \(arg1, arg2\) Object arg1, arg2;)B
444 13190({)B
1032 13030(if \(TypeOf \(arg1\) == Integer && TypeOf \(arg2\) == Real\))B
1704 12870(arg1 = RealInteger \(arg1\);)B
1032 12710(else if \(TypeOf \(arg2\) == Integer && TypeOf \(arg1\) == Real\))B
1704 12550(arg2 = RealInteger \(arg2\);)B
1032 12390(if \(TypeOf \(arg1\) != TypeOf \(arg2\)\))B
1704 12230(return Error \(PTypeCheck\);)B
1032 12070(if \(!Apply \(TypeOf \(arg1\)\)\))B
1704 11910(return Error \(PTypeCheck\);)B
1032 11750(return Push \(OpStack, arg1\), Push \(OpStack, arg2\);)B
444 11590(})B
360 11270(int Apply \(type\) Type type;)B
444 11110({)B
1032 10950(Object fn;)B
1032 10630(fn = Lookup \(type, Self\);)B
1032 10470(if \(TypeOf \(fn\) == Condition\))B
1704 10310(return Error \(PTypeCheck\);)B
1032 10150(else)B
1704 9990(return Push \(ExecStack, fn\);)B
444 9830(})B
360 9510(static int Copy \(\))B
504(/* any1 . . . anyn N)X
336(--- any1 . . . anyn any1 . . . anyn */)X
1704 9350(/* other1  other2)B
588(--- subother2 */)X
444 9190({)B
1032 9030(Object object1, object2;)B
1032 8870(int h = Height \(OpStack\);)B
1032 8550(object2 = Pop \(OpStack\);)B
1032 8390(if \(h == 0\))B
1704 8230(return Error \(POpUnderflow\);)B
1032 8070(else if \(TypeOf \(object2\) == Integer\))B
1116 7910({)B
1704 7750(int n = BodyInteger \(object2\);)B
1704 7430(if \(n < 0 || n >= h\))B
2376 7270(return Error \(PRangeCheck\);)B
1704 7110(else if \(h - 1 + n > MaxStack \(OpStack\)\))B
2376 6950(return Error \(POpOverflow\);)B
1704 6790(else)B
1788 6630({)B
2376 6470(int i;)B
2376 6150(for \(i = h - 1 - n; i < h; i++\))B
3048 5990(OpStack->stack_body[i+n] = OpStack->stack_body[i];)B
2376 5830(OpStack->stack_fill += n;)B
2376 5670(return TRUE;)B
1788 5510(})B
1116 5350(})B
1032 5190(object1 = Top \(OpStack\);)B
1032 5030(VOID Push \(OpStack, object2\);)B
1032 4870(if \(TypeOf \(object1\) != TypeOf \(object2\)\))B
1704 4710(return Error \(PTypeCheck\);)B
1032 4550(else if \(!rCheck \(object1\) || !wCheck \(object2\)\))B
1704 4390(return Error \(PInvAccess\);)B
8592 14470(else)B
9264 14310(return Apply \(TypeOf \(object1\)\);)B
8004 14150(})B
EndPage
HfDict begin ep end
%%Page: ? 55
HfDict begin bp end
StartPage
Landscape
()(property.c)[(89/03/24)(07:17:41)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(static int PCvs \(\), PCvrs \(\), PCvn \(\), PType \(\), PCvlit\(\), PxCheck \(\);)B
360 11910(int PCvx \(\);)B
360 11590(Object type;)B
360 11270(InitProperty \(\))B
360 11110({)B
528 10950(type = NameFrom \("type"\);)B
528 10630(InstallOp \("type",)B
1008(PType,)X
840(1, 1, 0, 0, Poly\);)X
528 10470(InstallOp \("cvlit",)B
924(PCvlit,)X
756(1, 1, 0, 0, Poly\);)X
528 10310(InstallOp \("cvn",)B
1092(PCvn,)X
924(1, 1, 0, 0, String\);)X
528 10150(InstallOp \("cvrs",)B
1008(PCvrs,)X
840(3, 1, 0, 0, Integer, Integer, String\);)X
528 9990(InstallOp \("cvs",)B
1092(PCvs,)X
924(2, 1, 0, 0, Poly, String\);)X
528 9830(InstallOp \("cvx",)B
1092(PCvx,)X
924(1, 1, 0, 0, Poly\);)X
528 9670(InstallOp \("xcheck",)B
840(PxCheck,)X
672(1, 1, 0, 0, Poly\);)X
528 9510(InstallOp \("cvi",)B
1092(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
528 9350(InstallOp \("cvr",)B
1092(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
528 9190(InstallOp \("readonly",)B
672(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
528 9030(InstallOp \("rcheck",)B
840(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
528 8870(InstallOp \("wcheck",)B
840(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
528 8710(InstallOp \("executeonly",)B
420(PolyFirst, )X
420(1, 1, 0, 0, Poly\);)X
360 8550(})B
360 8230(static int PType \(item\))B
780 8070(Object item;)B
360 7910({)B
528 7750(return Push \(OpStack, Lookup \(TypeOf \(item\), type\)\);)B
360 7590(})B
360 7270(static int PCvs \(item, string\))B
780 7110(Object item, string;)B
360 6950({)B
528 6790(int l;)B
528 6630(Object t;)B
528 6310(t = Lookup \(TypeOf \(item\), NameFrom \("cvs"\)\);)B
528 6150(if \(TypeOf \(t\) == Condition\))B
696 5990(if \(lengthString \(string\) < \(l = strlen \("--nostringval--"\)\)\))B
864 5830(return Error \(PRangeCheck\);)B
696 5670(else {)B
864 5510(putIString \(string, 0, StringFrom \("--nostringval--"\)\);)B
864 5350(return Push \(OpStack, getIString \(string, 0, l\)\);)B
696 5190(} else {)B
864 5030(VOID Push \(OpStack, item\);)B
864 4870(VOID Push \(OpStack, string\);)B
864 4710(return Apply \(TypeOf \(item\)\);)B
696 4550(})B
360 4390(})B
7920 14310(static int PCvlit \(item\))B
8340 14150(Object item;)B
7920 13990({)B
8088 13830(return Push \(OpStack, Cvlit \(item\)\);)B
7920 13670(})B
7920 13350(static int PCvn \(string\))B
8340 13190(Object string;)B
7920 13030({)B
8088 12870(return Push \(OpStack, SameFlags \(string, Cvn \(string\)\)\);)B
7920 12710(})B
7920 12390(static int PCvrs \(num, base, string\))B
8340 12230(Object num, base, string;)B
7920 12070({)B
8088 11910(unsigned n = BodyInteger \(num\);)B
8088 11750(unsigned char buf [BUFSIZE], *p = buf, *q = BodyString \(string\);)B
8088 11590(int b, length;)B
8088 11270(if \(!wCheck \(string\)\))B
8256 11110(return Error \(PInvAccess\);)B
8088 10950(else if \(\(b = BodyInteger \(base\)\) < 2 || b > 36\))B
8256 10790(return Error \(PRangeCheck\);)B
8088 10630(do {)B
8256 10470(int dig_val = n % b;)B
8256 10150(n /= b;)B
8256 9990(*p++ = dig_val >= 10 ? 'A' + dig_val - 10 : '0' + dig_val;)B
8088 9830(} while \(n != 0\);)B
8088 9510(if \(\(length = p - buf\) > lengthString \(string\)\))B
8256 9350(return Error \(PRangeCheck\);)B
8088 9030(while \(--p >= buf\))B
8256 8870(*q++ = *p;)B
8088 8710(return Push \(OpStack, getIString \(string, 0, length\)\);)B
7920 8550(})B
7920 8230(/*ARGSUSED*/)B
7920 8070(int NoStringVal \(v, string\))B
8340 7910(Object v, string;)B
7920 7750({)B
8088 7590(char *mess = "--nostringval--";)B
8088 7430(int length = strlen \(mess\);)B
8088 7110(if \(lengthString \(string\) < length\))B
8256 6950(return Error \(PRangeCheck\);)B
8088 6790(VOID Bcopy \(BodyString \(string\), mess, length\);)B
8088 6630(return Push \(OpStack, getIString \(string, 0, length\)\);)B
7920 6470(})B
7920 6150(int PCvx \(item\))B
8340 5990(Object item;)B
7920 5830({)B
8088 5670(return Push \(OpStack, Cvx \(item\)\);)B
7920 5510(})B
7920 5190(static int PxCheck \(item\))B
8340 5030(Object item;)B
7920 4870({)B
8088 4710(return Push \(OpStack, MakeBool \(xCheck \(item\)\)\);)B
7920 4550(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(real.c)[(89/03/24)(07:25:32)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(static Object OpFor;)B
360 11750(static int For \(\), PFor \(\), Eq \(\), Lt \(\), Le \(\), Gt \(\), Ge \(\), Identity \(\);)B
360 11590(static int Abs \(\), Add \(\), Sub \(\), Mul \(\), Div \(\), Neg \(\), EqEq \(\), Cvi \(\);)B
360 11430(static int Cvs \(\), Exp \(\), Sqrt \(\), Sin \(\), Cos \(\), Atan \(\), Ln \(\), Log \(\);)B
360 11270(static int Ceiling \(\), Floor \(\), Round \(\), Truncate \(\);)B
360 10950(InitReal \(\))B
360 10790({)B
528 10630(OpFor = MakeOp \("\(forreal\)", For, 0, 1, 5, 6, Real, Real, Real, Array\);)B
528 10310(TypeInstallOp \(Real, "cvr", )B
168(Identity,)X
588(1, 1, 0, 0, Real\);)X
528 10150(TypeInstallOp \(Real, "cvi", )B
168(Cvi,)X
1008(1, 1, 0, 0, Real\);)X
528 9990(TypeInstallOp \(Real, "cvs", )B
168(Cvs,)X
1008(2, 1, 0, 0, Real, String\);)X
528 9830(TypeInstallOp \(Real, "==", )B
252(EqEq,)X
924(1, 0, 0, 0, Real\);)X
528 9670(TypeInstallOp \(Real, "for", )B
168(PFor,)X
924(4, 0, 0, 6, Real, Real, Real, Array\);)X
528 9510(TypeInstallOp \(Real, "eq", )B
252(Eq,)X
1092(2, 1, 0, 0, Real, Real\);)X
528 9350(TypeInstallOp \(Real, "lt", )B
252(Lt,)X
1092(2, 1, 0, 0, Real, Real\);)X
528 9190(TypeInstallOp \(Real, "le", )B
252(Le,)X
1092(2, 1, 0, 0, Real, Real\);)X
528 9030(TypeInstallOp \(Real, "gt", )B
252(Gt,)X
1092(2, 1, 0, 0, Real, Real\);)X
528 8870(TypeInstallOp \(Real, "ge", )B
252(Ge,)X
1092(2, 1, 0, 0, Real, Real\);)X
528 8710(TypeInstallOp \(Real, "abs", )B
168(Abs,)X
1008(1, 1, 0, 0, Real\);)X
528 8550(TypeInstallOp \(Real, "add",)B
252(Add,)X
1008(2, 1, 0, 0, Real, Real\);)X
528 8390(TypeInstallOp \(Real, "sub", )B
168(Sub,)X
1008(2, 1, 0, 0, Real, Real\);)X
528 8230(TypeInstallOp \(Real, "mul", )B
168(Mul,)X
1008(2, 1, 0, 0, Real, Real\);)X
528 8070(TypeInstallOp \(Real, "div", )B
168(Div,)X
1008(2, 1, 0, 0, Real, Real\);)X
528 7910(TypeInstallOp \(Real, "neg", )B
168(Neg,)X
1008(1, 1, 0, 0, Real\);)X
528 7750(TypeInstallOp \(Real, "exp", )B
168(Exp,)X
1008(2, 1, 0, 0, Real, Real\);)X
528 7590(TypeInstallOp \(Real, "sqrt", )B
84(Sqrt,)X
924(1, 1, 0, 0, Real\);)X
528 7430(TypeInstallOp \(Real, "sin", )B
168(Sin,)X
1008(1, 1, 0, 0, Real\);)X
528 7270(TypeInstallOp \(Real, "cos", )B
168(Cos,)X
1008(1, 1, 0, 0, Real\);)X
528 7110(TypeInstallOp \(Real, "atan",)B
168(Atan,)X
924(2, 1, 0, 0, Real, Real\);)X
528 6950(TypeInstallOp \(Real, "ln", )B
252(Ln,)X
1092(1, 1, 0, 0, Real\);)X
528 6790(TypeInstallOp \(Real, "log",)B
252(Log,)X
1008(1, 1, 0, 0, Real\);)X
528 6630(TypeInstallOp \(Real, "ceiling", Ceiling,)B
504(1, 1, 0, 0, Real\);)X
528 6470(TypeInstallOp \(Real, "floor",)B
84(Floor,)X
840(1, 1, 0, 0, Real\);)X
528 6310(TypeInstallOp \(Real, "round",)B
84(Round,)X
840(1, 1, 0, 0, Real\);)X
528 6150(TypeInstallOp \(Real, "truncate",Truncate,)B
420(1, 1, 0, 0, Real\);)X
360 5990(})B
360 5670(Object MakeReal \(f\))B
780 5510(float f;)B
360 5350({)B
528 5190(Object res;)B
528 4870(MakeObject \(res, Real\);)B
528 4710(res.u.Real = f;)B
528 4390(return res;)B
7920 14470(})B
7920 14150(static Object Make \(f\))B
8340 13990(float f;)B
7920 13830({)B
8088 13670(Object res;)B
8088 13350(MakeObject \(res, Real\);)B
8088 13190(res.u.Real = f;)B
8088 12870(return res;)B
7920 12710(})B
7920 12390(static int Identity \(item\))B
8340 12230(Object item;)B
7920 12070({)B
8088 11910(return Push \(OpStack, item\);)B
7920 11750(})B
7920 11430(static int Cvi \(item\))B
8340 11270(Object item;)B
7920 11110({)B
8088 10950(return Push \(OpStack, IntReal \(item\)\);)B
7920 10790(})B
7920 10470(static int Cvs \(v, string\))B
8340 10310(Object v, string;)B
7920 10150({)B
8088 9990(char buf [BUFSIZ];)B
8088 9830(int length;)B
8088 9510(VOID sprintf \(buf, "%g", BodyReal \(v\)\);)B
8088 9350(if \(\(length = strlen \(buf\)\) > lengthString \(string\)\))B
8256 9190(return Error \(PRangeCheck\);)B
8088 9030(VOID Bcopy \(BodyString \(string\), buf, length\);)B
8088 8870(return Push \(OpStack, getIString \(string, 0, length\)\);)B
7920 8710(})B
7920 8390(static int EqEq \(v\))B
8340 8230(Object v;)B
7920 8070({)B
8088 7910(printf \("%g", BodyReal \(v\)\);)B
8088 7750(return TRUE;)B
7920 7590(})B
7920 7270(#ifndef BodyReal)B
7920 7110(float BodyReal \(item\))B
8340 6950(Object item;)B
7920 6790({)B
8088 6630(return item.u.Real;)B
7920 6470(})B
7920 6310(#endif)B
7920 5990(#define Body\(I\) \(\(I\).u.Real\))B
7920 5670(#ifndef Body)B
7920 5510(static float Body \(item\))B
8340 5350(Object item;)B
7920 5190({)B
8088 5030(return item.u.Real;)B
7920 4870(})B
7920 4710(#endif)B
7920 4390(Object RealInteger \(o\))B
EndPage
HfDict begin ep end
%%Page: ? 56
HfDict begin bp end
StartPage
Landscape
()(real.c)[(89/03/24)(07:25:32)](2)Gaudy
0 F
780 14470(Object o;)B
360 14310({)B
528 14150(return Make \(\(float\) BodyInteger \(o\)\);)B
360 13990(})B
360 13670(static int PFor \(initial, increment, limit, proc\))B
780 13510(Object initial, increment, limit, proc;)B
360 13350({)B
528 13190(VOID Push \(ExecStack, Nil\);)B
528 13030(VOID Push \(ExecStack, increment\);)B
528 12870(VOID Push \(ExecStack, limit\);)B
528 12710(VOID Push \(ExecStack, initial\);)B
528 12550(VOID Push \(ExecStack, proc\);)B
528 12390(VOID Push \(ExecStack, OpFor\);)B
528 12070(return TRUE;)B
360 11910(})B
360 11590(static int For \(\) )B
360 11430({)B
528 11270(Object current, limit, increment, proc;)B
528 10950(proc)B
336(= Pop \(ExecStack\);)X
528 10790(current   = Pop \(ExecStack\);)B
528 10630(limit)B
252(= Pop \(ExecStack\);)X
528 10470(increment = Pop \(ExecStack\);)B
528 10150(if \(Body \(increment\) > 0)B
864 9990(? Body \(current\) > Body \(limit\))B
864 9830(: Body \(current\) < Body \(limit\)\))B
696 9670(VOID Pop \(ExecStack\);)B
528 9510(else {)B
696 9350(VOID Push \(ExecStack, increment\);)B
696 9190(VOID Push \(ExecStack, limit\);)B
696 9030(VOID Push \(ExecStack, Make \(Body \(current\) + Body \(increment\)\)\);)B
696 8870(VOID Push \(ExecStack, proc\);)B
696 8710(VOID Push \(ExecStack, OpFor\);)B
696 8550(VOID Push \(ExecStack, proc\);)B
696 8390(VOID Push \(OpStack, current\);)B
528 8230(})B
528 8070(return TRUE;)B
360 7910(})B
360 7590(static int Eq \(a, b\))B
780 7430(Object a, b;)B
360 7270({)B
528 7110(return Push \(OpStack, MakeBool \(Body \(a\) == Body \(b\)\)\);)B
360 6950(})B
360 6630(static int Lt \(a, b\))B
780 6470(Object a, b;)B
360 6310({)B
528 6150(return Push \(OpStack, MakeBool \(Body \(a\) < Body \(b\)\)\);)B
360 5990(})B
360 5670(static int Le \(a, b\))B
780 5510(Object a, b;)B
360 5350({)B
528 5190(return Push \(OpStack, MakeBool \(Body \(a\) <= Body \(b\)\)\);)B
360 5030(})B
360 4710(static int Gt \(a, b\))B
780 4550(Object a, b;)B
360 4390({)B
8088 14470(return Push \(OpStack, MakeBool \(Body \(a\) > Body \(b\)\)\);)B
7920 14310(})B
7920 13990(static int Ge \(a, b\))B
8340 13830(Object a, b;)B
7920 13670({)B
8088 13510(return Push \(OpStack, MakeBool \(Body \(a\) >= Body \(b\)\)\);)B
7920 13350(})B
7920 13030(static int Abs \(v\))B
8340 12870(Object v;)B
7920 12710({)B
8088 12550(return Push \(OpStack, Make \(Body \(v\) >= 0 ? Body \(v\) : -Body \(v\)\)\);)B
7920 12390(})B
7920 12070(static int Add \(a, b\))B
8340 11910(Object a, b;)B
7920 11750({)B
8088 11590(return Push \(OpStack, Make \(Body \(a\) + Body \(b\)\)\);)B
7920 11430(})B
7920 11110(static int Sub \(a, b\))B
8340 10950(Object a, b;)B
7920 10790({)B
8088 10630(return Push \(OpStack, Make \(Body \(a\) - Body \(b\)\)\);)B
7920 10470(})B
7920 10150(static int Mul \(a, b\))B
8340 9990(Object a, b;)B
7920 9830({)B
8088 9670(return Push \(OpStack, Make \(Body \(a\) * Body \(b\)\)\);)B
7920 9510(})B
7920 9190(static int Div \(a, b\))B
8340 9030(Object a, b;)B
7920 8870({)B
8088 8710(return Push \(OpStack, Make \(Body \(a\) / Body \(b\)\)\);)B
7920 8550(})B
7920 8230(static int Neg \(a\))B
8340 8070(Object a;)B
7920 7910({)B
8088 7750(return Push \(OpStack, Make \(-Body \(a\)\)\);)B
7920 7590(})B
7920 7270(static int Sqrt \(v\))B
8340 7110(Object v;)B
7920 6950({)B
8088 6790(return Push \(OpStack, Make \(\(float\) sqrt \(\(double\) Body \(v\)\)\)\);)B
7920 6630(})B
7920 6310(static int Exp \(a, b\))B
8340 6150(Object a, b;)B
7920 5990({)B
8088 5830(return Push \(OpStack, Make \(\(float\) pow \(\(double\) Body \(a\), \(double\) Body \(b\)\)\)\);)B
7920 5670(})B
7920 5350(static int Ceiling \(v\))B
8340 5190(Object v;)B
7920 5030({)B
8088 4870(return Push \(OpStack, Make \(\(float\) ceil \(\(double\) Body \(v\)\)\)\);)B
7920 4710(})B
7920 4390(static int Floor \(v\))B
EndPage
HfDict begin hp end
StartPage
Landscape
()(real.c)[(89/03/24)(07:25:32)](3)Gaudy
0 F
780 14470(Object v;)B
360 14310({)B
528 14150(return Push \(OpStack, Make \(\(float\) floor \(\(double\) Body \(v\)\)\)\);)B
360 13990(})B
360 13670(static int Round \(v\))B
780 13510(Object v;)B
360 13350({)B
528 13190(return Push \(OpStack, Make \(Body \(v\) - floor \(\(double\) Body \(v\)\) >= 0.5)B
2880 13030(? ceil \(\(double\) Body \(v\)\))B
2880 12870(: floor \(\(double\) Body \(v\)\)\)\);)B
360 12710(})B
360 12390(static int Truncate \(v\))B
780 12230(Object v;)B
360 12070({)B
528 11910(return Push \(OpStack, Make \(Body \(v\) < 0 ? ceil \(Body \(v\)\) : floor \(Body \(v\)\)\)\);)B
360 11750(})B
360 11430(static int Atan \(a, b\))B
780 11270(Object a, b;)B
360 11110({)B
528 10950(return Push \(OpStack, Make \(\(float\) Deg \(atan2 \(Body \(a\), Body \(b\)\)\)\)\);)B
360 10790(})B
360 10470(static int Cos \(v\))B
780 10310(Object v;)B
360 10150({)B
528 9990(return Push \(OpStack, Make \(cos \(Rad \(Body \(v\)\)\)\)\);)B
360 9830(})B
360 9510(static int Sin \(v\))B
780 9350(Object v;)B
360 9190({)B
528 9030(return Push \(OpStack, Make \(sin \(Rad \(Body \(v\)\)\)\)\);)B
360 8870(})B
360 8550(static int Ln \(v\))B
780 8390(Object v;)B
360 8230({)B
528 8070(return Push \(OpStack, Make \(log \(Body \(v\)\)\)\);)B
360 7910(})B
360 7590(static int Log \(v\))B
780 7430(Object v;)B
360 7270({)B
528 7110(return Push \(OpStack, Make \(log10 \(Body \(v\)\)\)\);)B
360 6950(})B
EndPage
HfDict begin ep end
%%Page: ? 57
HfDict begin bp end
StartPage
Landscape
()(rop.h)[(88/08/23)(13:34:27)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(#define ROP_FALSE)B
588(0)X
588(/* F)X
1008(*/)X
360 13670(#define ROP_AND)B
756(1)X
588(/* S & D)X
672(*/)X
360 13510(#define ROP_ANDNOT)B
504(2)X
588(/* S & ~D)X
588(*/)X
360 13350(#define ROP_SOURCE)B
504(3)X
588(/* S)X
1008(*/)X
360 13190(#define ROP_NOTAND)B
504(4)X
588(/* ~S & D)X
588(*/)X
360 13030(#define ROP_DEST)B
672(5)X
588(/* D)X
1008(*/)X
360 12870(#define ROP_XOR)B
756(6)X
588(/* S ^ D)X
672(*/)X
360 12710(#define ROP_OR)B
840(7)X
588(/* S | D)X
672(*/)X
360 12550(#define ROP_NOR)B
756(8)X
588(/* ~\(S | D\))X
420(*/)X
360 12390(#define ROP_NXOR)B
672(9)X
588(/* ~\(S ^ D\))X
420(*/)X
360 12230(#define ROP_NOTDEST)B
420(10)X
504(/* ~D)X
924(*/)X
360 12070(#define ROP_ORNOT)B
588(11)X
504(/* S | ~D)X
588(*/)X
360 11910(#define ROP_NOTSOURCE)B
252(12)X
504(/* ~S)X
924(*/)X
360 11750(#define ROP_NOTOR)B
588(13)X
504(/* ~S | D)X
588(*/)X
360 11590(#define ROP_NAND)B
672(14)X
504(/* ~\(S & D\))X
420(*/)X
360 11430(#define ROP_TRUE)B
672(15)X
504(/* T)X
1008(*/)X
EndPage
HfDict begin hp end
StartPage
Landscape
()(stack.c)[(89/03/24)(07:31:07)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(#define   OPSTACKSIZE)B
252(500)X
360 11910(#define EXECSTACKSIZE)B
252(250)X
360 11750(#define DICTSTACKSIZE)B
336(20)X
360 11430(static StackOb)B
168(DStack, EStack, OStack;)X
360 11110(Stack)B
252(DictStack = &DStack;)X
360 10950(Stack)B
252(ExecStack = &EStack;)X
360 10790(Stack)B
252(OpStack   = &OStack;)X
360 10470(static int PPop \(\), PDup \(\), PExch \(\), PRoll \(\), PIndex \(\), PClear \(\);)B
360 10310(static int PCount \(\), PClearToMark \(\); )B
360 10150(static int PCountToMark \(\), PExecStack \(\), PCountDictStack \(\), PDictStack \(\);)B
360 9990(static int PReverseStack \(\);)B
360 9670(static StackOb MakeStack \(\);)B
360 9350(InitStack \(\))B
360 9190({)B
528 9030(DStack = MakeStack \(DICTSTACKSIZE, PDictOverflow,)B
420(PDictUnderflow\);)X
528 8870(VOID Push \(DictStack, SysDict\);)B
528 8550(OStack = MakeStack \(  OPSTACKSIZE, POpOverflow,)B
588(POpUnderflow\);)X
528 8390(EStack = MakeStack \(EXECSTACKSIZE, PExecOverflow,)B
420(PExecUnderflow\);)X
528 8070(Install \("mark", Marker\);)B
528 7750(InstallOp \("pop",)B
1092(PPop,)X
924(1, 0, 0, 0, Poly\);)X
528 7590(InstallOp \("dup",)B
1092(PDup,)X
924(1, 2, 0, 0, Poly\);)X
528 7430(InstallOp \("exch",)B
1008(PExch,)X
840(2, 2, 0, 0, Poly, Poly\);)X
528 7270(InstallOp \("roll",)B
1008(PRoll,)X
840(2, 0, 0, 0, Integer, Integer\);)X
528 7110(InstallOp \("index",)B
924(PIndex,)X
756(1, 1, 0, 0, Integer\);)X
528 6950(InstallOp \("clear",)B
924(PClear,)X
756(0, 0, 0, 0\);)X
528 6790(InstallOp \("count",)B
924(PCount,)X
756(0, 1, 0, 0\);)X
528 6630(InstallOp \("cleartomark",)B
420(PClearToMark,)X
252(0, 0, 0, 0\);)X
528 6470(InstallOp \("counttomark",)B
420(PCountToMark,)X
252(0, 1, 0, 0\);)X
528 6310(InstallOp \("execstack",)B
1260(PExecStack,)X
420(1, 1, 0, 0, Array\);)X
528 6150(InstallOp \("countdictstack",)B
168(PCountDictStack,0, 1, 0, 0\);)X
528 5990(InstallOp \("dictstack",)B
1260(PDictStack,)X
420(1, 1, 0, 0, Array\);)X
528 5830(InstallOp \("reversestack",)B
336(PReverseStack,)X
168(1, 0, 0, 0, Integer\);)X
360 5670(})B
360 5350(static StackOb MakeStack \(size, over, under\))B
780 5190(int size; Object over, under;)B
360 5030({)B
528 4870(StackOb res;)B
528 4550(res.stack_body = \(Object *\) Malloc \(\(unsigned\) sizeof \(Object\) * size\);)B
528 4390(res.stack_fill = 0; res.stack_size = size;)B
8088 14470(res.overflow = over; res.underflow = under;)B
8088 14150(return res;)B
7920 13990(})B
7920 13670(#ifdef notdef)B
7920 13510(int Push \(stack, object\))B
8340 13350(Stack stack;)B
8340 13190(Object object;)B
7920 13030({)B
8088 12870(if \(stack->stack_fill != stack->stack_size\))B
8256 12710(stack->stack_body[stack->stack_fill++] = object;)B
8088 12550(else)B
8256 12390(return FALSE;)B
8088 12230(return TRUE;)B
7920 12070(})B
7920 11750(Object Pop \(stack\))B
8340 11590(Stack stack;)B
7920 11430({)B
8088 11270(if \(stack->stack_fill\))B
8256 11110(return stack->stack_body[--stack->stack_fill];)B
8088 10950(printf \("%s", stack == OpStack ? "OpStack" : stack == ExecStack ? "ExecStack" : "OtherS)B
8088 10790(Panic \(": Pop empty stack"\);)B
8088 10630(return Nil; /* for lint */)B
7920 10470(})B
7920 10150(Object Top \(stack\))B
8340 9990(Stack stack;)B
7920 9830({)B
8088 9670(if \(stack->stack_fill\))B
8256 9510(return stack->stack_body[stack->stack_fill - 1];)B
8088 9350(printf \("%s", stack == OpStack ? "OpStack" : stack == ExecStack ? "ExecStack" : "OtherS)B
8088 9190(Panic \(": Top empty stack"\);)B
8088 9030(return Nil; /* for lint */)B
7920 8870(})B
7920 8550(int Height \(s\))B
8340 8390(Stack s;)B
7920 8230({)B
8088 8070(return s->stack_fill;)B
7920 7910(})B
7920 7590(int MaxStack \(s\))B
8340 7430(Stack s;)B
7920 7270({)B
8088 7110(return s->stack_size;)B
7920 6950(})B
7920 6790(#endif)B
7920 6470(Object DictLookup \(o\))B
8340 6310(Object o;)B
7920 6150({)B
8088 5990(int i;)B
8088 5670(for \(i = DictStack->stack_fill - 1; i >= 0; i--\) {)B
8256 5510(Object item;)B
8256 5190(item = DictLoad \(DictStack->stack_body[i], o\);)B
8256 5030(if \(TypeOf \(item\) != Condition\))B
8424 4870(return item;)B
8088 4710(})B
8088 4550(return Absent;)B
7920 4390(})B
EndPage
HfDict begin ep end
%%Page: ? 58
HfDict begin bp end
StartPage
Landscape
()(stack.c)[(89/03/24)(07:31:07)](2)Gaudy
0 F
360 14310(Object Where \(key\))B
780 14150(Object key;)B
360 13990({)B
528 13830(int i;)B
528 13510(for \(i = DictStack->stack_fill - 1; i >= 0; i--\) {)B
696 13350(Object t;)B
696 13030(t = DictLoad \(DictStack->stack_body[i], key\);)B
696 12870(if \(TypeOf \(t\) != Condition\))B
864 12710(return DictStack->stack_body[i];)B
528 12550(})B
528 12390(return Absent;)B
360 12230(})B
360 11910(static reverse \(vec, n\))B
780 11750(Object *vec;)B
780 11590(int n;)B
360 11430({)B
528 11270(Object temp;)B
528 11110(int i, lim = n / 2;)B
528 10790(for \(i = 0; i < lim; i++\))B
696 10630(temp = vec[i],)B
696 10470(vec[i] = vec[n-1-i],)B
696 10310(vec[n-1-i] = temp;)B
360 10150(})B
360 9830(int CountTo \(t, s\))B
780 9670(Type t;)B
780 9510(Stack s;)B
360 9350({)B
528 9190(int i;)B
528 8870(Object *body = s->stack_body;)B
528 8550(for \(i = Height \(s\) - 1; i >= 0; i--\))B
696 8390(if \(TypeOf \(body[i]\) == t\))B
864 8230(return Height \(s\) - i - 1;)B
528 8070(return -1;)B
360 7910(})B
360 7590(int ClearTo \(t, s\))B
780 7430(Type t;)B
780 7270(Stack s;)B
360 7110({)B
528 6950(int count;)B
528 6630(if \(\(count = CountTo \(t, s\)\) >= 0\))B
696 6470(s->stack_fill = s->stack_fill - \(count + 1\);)B
528 6310(else)B
696 6150(return FALSE;)B
528 5990(return TRUE;)B
360 5830(})B
360 5510(static int PCountDictStack \(\))B
360 5350({)B
528 5190(return Push \(OpStack, MakeInteger \(DictStack->stack_fill\)\);)B
360 5030(})B
360 4710(static int PDictStack \(array\))B
780 4550(Object array;)B
360 4390({)B
8088 14470(Object *body = DictStack->stack_body;)B
8088 14310(int i, l = Height \(DictStack\);)B
8088 13990(if \(!wCheck \(array\)\))B
8256 13830(return Error \(PInvAccess\);)B
8088 13670(if \(l > lengthArray \(array\)\))B
8256 13510(return Error \(PRangeCheck\);)B
8088 13350(for \(i = 0; i < l; i++\))B
8256 13190(putArray \(array, i, body[i]\);)B
8088 13030(return Push \(OpStack, getIArray \(array, 0, l\)\);)B
7920 12870(})B
7920 12550(/*ARGSUSED*/)B
7920 12390(static int PPop \(item\))B
8340 12230(Object item;)B
7920 12070({)B
8088 11910(return TRUE;)B
7920 11750(})B
7920 11430(static int PDup \(item\))B
8340 11270(Object item;)B
7920 11110({)B
8088 10950(return Push \(OpStack, item\), Push \(OpStack, item\);)B
7920 10790(})B
7920 10470(static int PExch \(a, b\))B
8340 10310(Object a, b;)B
7920 10150({)B
8088 9990(return Push \(OpStack, b\), Push \(OpStack, a\);)B
7920 9830(})B
7920 9510(static int PRoll \(size, count\))B
8340 9350(Object size, count;)B
7920 9190({)B
8088 9030(int s = BodyInteger \(size\), c = BodyInteger \(count\);)B
8088 8870(Object *body = OpStack->stack_body + Height \(OpStack\) - s;)B
8088 8550(if \(BodyInteger \(size\) < 0\))B
8256 8390(return Error \(PRangeCheck\);)B
8088 8230(if \(BodyInteger \(size\) > Height \(OpStack\)\))B
8256 8070(return Error \(POpUnderflow\);)B
8088 7910(if \(BodyInteger \(size\) == 0\))B
8256 7750(return TRUE;)B
8088 7590(if \(c > 0\) {)B
8256 7430(c = c % s;)B
8256 7270(reverse \(body, s - c\);)B
8256 7110(reverse \(body + s - c, c\);)B
8088 6950(} else {)B
8256 6790(c = \(-c\) % s;)B
8256 6630(reverse \(body, c\);)B
8256 6470(reverse \(body + c, s - c\);)B
8088 6310(})B
8088 6150(reverse \(body, s\);)B
8088 5990(return TRUE;)B
7920 5830(})B
7920 5510(static int PIndex \(index\))B
8340 5350(Object index;)B
7920 5190({)B
8088 5030(if \(BodyInteger \(index\) >= Height \(OpStack\) || BodyInteger \(index\) < 0\))B
8256 4870(return Error \(PRangeCheck\);)B
8088 4710(return Push \(OpStack, OpStack->stack_body[Height \(OpStack\) - 1 - BodyInteger \(index\)]\);)B
7920 4550(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(stack.c)[(89/03/24)(07:31:07)](3)Gaudy
0 F
360 14470(static int PClear \(\))B
360 14310({)B
528 14150(OpStack->stack_fill = 0;)B
528 13990(return TRUE;)B
360 13830(})B
360 13510(static int PCount \(\))B
360 13350({)B
528 13190(return Push \(OpStack, MakeInteger \(Height \(OpStack\)\)\);)B
360 13030(})B
360 12710(static int PClearToMark \(\))B
360 12550({)B
528 12390(if \(ClearTo \(Mark, OpStack\)\))B
696 12230(return TRUE;)B
528 12070(else)B
696 11910(return Error \(PUnMatched\);)B
360 11750(})B
360 11430(static int PCountToMark \(\))B
360 11270({)B
528 11110(int count;)B
528 10790(if \(\(count = CountTo \(Mark, OpStack\)\) >= 0\))B
696 10630(return Push \(OpStack, MakeInteger \(count\)\);)B
528 10470(else)B
696 10310(return Error \(PUnMatched\);)B
360 10150(})B
360 9830(static int PExecStack \(array\))B
780 9670(Object array;)B
360 9510({)B
528 9350(int i, l = Height \(ExecStack\);)B
528 9190(Object *body = ExecStack->stack_body;)B
528 8870(if\(!wCheck \(array\)\))B
696 8710(return Error \(PInvAccess\);)B
528 8550(if \(l > lengthArray \(array\)\))B
696 8390(return Error \(PRangeCheck\);)B
528 8230(for \(i = 0; i < l; i++\))B
696 8070(putArray \(array, i, body[i]\);)B
528 7910(VOID Push \(OpStack, getIArray \(array, 0, l\)\);)B
528 7750(return TRUE;)B
360 7590(})B
360 7270(ReverseStack \(stack, n\))B
780 7110(Stack stack; int n;)B
360 6950({)B
528 6790(Object *body = stack->stack_body;)B
528 6470(reverse \(&body[Height \(stack\) - n], n\);)B
360 6310(})B
360 5990(static int PReverseStack \(n\))B
780 5830(Object n;)B
360 5670({)B
528 5510(if \(BodyInteger \(n\) > Height \(OpStack\)\))B
696 5350(return Error \(PRangeCheck\);)B
528 5190(ReverseStack \(OpStack, BodyInteger \(n\)\);)B
528 5030(return TRUE;)B
360 4870(})B
EndPage
HfDict begin ep end
%%Page: ? 59
HfDict begin bp end
StartPage
Landscape
()(state.c)[(89/03/10)(01:09:01)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such. )B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#include "graphics.h")B
360 11910(extern int InitGraphics \(\);)B
360 11750(int ErasePage \(\);)B
360 11590(static int CopyPage \(\);)B
360 11270(static int SetLineWidth \(\);)B
360 11110(static int GetLineWidth \(\);)B
360 10950(static int SetLineCap \(\);)B
360 10790(static int GetLineCap \(\);)B
360 10630(static int SetLineJoin \(\);)B
360 10470(static int GetLineJoin \(\);)B
360 10310(static int SetDash \(\);)B
360 10150(static int GetDash \(\);)B
360 9990(static int SetFlat \(\);)B
360 9830(static int GetFlat \(\);)B
360 9670(static int SetMiterLimit \(\);)B
360 9510(static int GetMiterLimit \(\);)B
360 9350(static int SetHSB \(\);)B
360 9190(static int GetHSB \(\);)B
360 9030(static int SetRGB \(\);)B
360 8870(static int GetRGB \(\);)B
360 8550(static int PSetRealScreen \(\);)B
360 8390(static int PBuildScreen \(\);)B
360 8230(static int PScreenSize \(\);)B
360 8070(static int GetScreen \(\);)B
360 7750(static int PSetRealTransfer \(\);)B
360 7590(static int PGetTransfer \(\);)B
360 7430(static int PTransferSize \(\);)B
360 7110(static int SetGray \(\);)B
360 6950(static int GetGray \(\);)B
360 6630(static int SetFillMethod \(\);)B
360 6470(static int GetFillMethod \(\);)B
360 6310(static int SetStrokeMethod \(\);)B
360 6150(static int GetStrokeMethod \(\);)B
360 5830(int fill_method = 1, stroke_method = 0;)B
360 5510(InitState \(\))B
444 5350({)B
1032 5190(InstallOp \("erasepage",)B
756(ErasePage,)X
504(0, 0, 0, 0\);)X
1032 5030(InstallOp \("copypage",)B
840(CopyPage,)X
588(0, 0, 0, 0\);)X
1032 4870(InstallOp \("setlinewidth",)B
504(SetLineWidth,)X
252(1, 0, 0, 0, Float\);)X
1032 4710(InstallOp \("currentlinewidth",)B
168(GetLineWidth,)X
252(0, 1, 0, 0\);)X
1032 4550(InstallOp \("setlinecap",)B
672(SetLineCap,)X
420(1, 0, 0, 0, Integer\);)X
1032 4390(InstallOp \("currentlinecap",)B
336(GetLineCap,)X
420(0, 1, 0, 0\);)X
8592 14470(InstallOp \("setlinejoin",)B
588(SetLineJoin,)X
336(1, 0, 0, 0, Integer\);)X
8592 14310(InstallOp \("currentlinejoin",)B
252(GetLineJoin,)X
336(0, 1, 0, 0\);)X
8592 14150(InstallOp \("setdash",)B
924(SetDash,)X
672(2, 0, 0, 0,)X
9516 13990(Array, Float\);)B
8592 13830(InstallOp \("currentdash",)B
588(GetDash,)X
672(0, 2, 0, 2\);)X
8592 13670(InstallOp \("setflat",)B
924(SetFlat,)X
672(1, 0, 0, 0, Float\);)X
8592 13510(InstallOp \("currentflat",)B
588(GetFlat,)X
672(0, 1, 0, 0\);)X
8592 13350(InstallOp \("setmiterlimit",)B
420(SetMiterLimit,)X
168(1, 0, 0, 0, Float\);)X
8592 13190(InstallOp \("currentmiterlimit",)B
84(GetMiterLimit,)X
168(0, 1, 0, 0\);)X
8592 12870(InstallOp \("setgray",)B
924(SetGray,)X
672(1, 0, 0, 0, Float\);)X
8592 12710(InstallOp \("currentgray",)B
588(GetGray,)X
672(0, 1, 0, 0\);)X
8592 12550(InstallOp \("sethsbcolor",)B
588(SetHSB,)X
756(3, 0, 0, 0,)X
9516 12390(Float, Float, Float\);)B
8592 12230(InstallOp \("currenthsbcolor",)B
252(GetHSB,)X
756(0, 3, 0, 0\);)X
8592 12070(InstallOp \("setrgbcolor",)B
588(SetRGB,)X
756(3, 0, 0, 0,)X
9516 11910(Float, Float, Float\);)B
8592 11750(InstallOp \("currentrgbcolor",)B
252(GetRGB,)X
756(0, 3, 0, 0\);)X
8592 11430(InstallOp \("screensize",)B
672(PScreenSize,)X
336(2, 1, 0, 0,)X
9516 11270(Float, Float\);)B
8592 11110(InstallOp \("buildscreen",)B
588(PBuildScreen,)X
252(2, 2, 0, 0,)X
9516 10950(Float, Float\);)B
8592 10790(InstallOp \("setrealscreen",)B
420(PSetRealScreen,)X
84(4, 0, 0, 0,)X
9516 10630(Float, Float, Array, Array\);)B
8592 10470(InstallOp \("currentscreen",)B
420(GetScreen,)X
504(0, 3, 0, 0\);)X
8592 10150(InstallOp \("setrealtransfer",)B
252(PSetRealTransfer,)X
588(2, 0, 0, 0,)X
9516 9990(Array, Array\);)B
8592 9830(InstallOp \("currenttransfer",)B
252(PGetTransfer,)X
252(0, 1, 0, 0\);)X
8592 9670(InstallOp \("transfersize",)B
504(PTransferSize,)X
168(0, 1, 0, 0\);)X
8592 9350(InstallOp \("setfillmethod",)B
420(SetFillMethod,)X
168(1, 0, 0, 0, Integer\);)X
8592 9190(InstallOp \("currentfillmethod",)B
84(GetFillMethod,)X
168(0, 1, 0, 0\);)X
8592 9030(InstallOp \("setstrokemethod",)B
252(SetStrokeMethod,)X
672(1, 0, 0, 0,)X
9516 8870(Integer\);)B
8592 8710(InstallOp \("currentstrokemethod",GetStrokeMethod,)B
588(0, 1, 0, 0\);)X
8592 8550(InstallOp \("initgraphics",)B
504(InitGraphics,)X
252(0, 0, 0, 0\);)X
8592 8230(VOID InitGraphics \(\);)B
8004 8070(})B
7920 7750(int InitGraphics \(\))B
8004 7590({)B
8592 7430(VOID PInitMatrix \(\);)B
1008(/* initmatrix */)X
8592 7270(VOID InitClip \(\);)B
1260(/* initclip */)X
8592 7110(VOID PNewPath \(\);)B
1260(/* newpath */)X
8592 6790(gstate->colour = NewColour \(0.0, 0.0, 0.0\);)B
420(/* 0 setgray */)X
8592 6630(gstate->line_width = 1;)B
756(/* 1 setlinewidth */)X
8592 6470(gstate->line_cap = CBUTT;)B
588(/* setlinecap */)X
8592 6310(gstate->line_join = JMITRE;)B
420(/* setlinejoin */)X
8592 6150(gstate->dash_length = 0;)B
672(/* [] 0 setdash */)X
8592 5990(gstate->dash_offset = 0;)B
8592 5830(gstate->miter_limit = 10;)B
588(/* 10 setmiterlimit */)X
8592 5670(InitShowContext \(\);)B
8592 5350(return TRUE;)B
8004 5190(})B
7920 4870(int ErasePage \(\))B
8004 4710({)B
8592 4550(Paint \(NULL, gstate->device->dev,)B
9180 4390(NewDevicePoint \(0, 0\), NewDevicePoint \(0, 0\),)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(state.c)[(89/03/10)(01:09:01)](2)Gaudy
0 F
1620 14470(HardwareExtent \(gstate->device->dev\),)B
1620 14310(White\);)B
1032 14150(return TRUE;)B
444 13990(})B
360 13670(static int CopyPage \(\))B
444 13510({)B
1032 13350(return TRUE;)B
444 13190(})B
360 12870(static int SetLineWidth \(width\) Object width;)B
444 12710({)B
1032 12550(gstate->line_width = BodyReal \(width\);)B
1032 12390(return TRUE;)B
444 12230(})B
360 11910(static int GetLineWidth \(\))B
444 11750({)B
1032 11590(return Push \(OpStack, MakeReal \(gstate->line_width\)\);)B
444 11430(})B
360 11110(static int SetLineCap \(cap\) Object cap;)B
444 10950({)B
1032 10790(int v = BodyInteger \(cap\);)B
1032 10470(if \(v < 0 || v > 2\))B
1704 10310(return Error \(PRangeCheck\);)B
1032 10150(gstate->line_cap = v;)B
1032 9990(return TRUE;)B
444 9830(})B
360 9510(static int GetLineCap \(\))B
444 9350({)B
1032 9190(return Push \(OpStack, MakeInteger \(gstate->line_cap\)\);)B
444 9030(})B
360 8710(static int SetLineJoin \(join\) Object join;)B
444 8550({)B
1032 8390(int v = BodyInteger \(join\);)B
1032 8070(if \(v < 0 || v > 2\))B
1704 7910(return Error \(PRangeCheck\);)B
1032 7750(gstate->line_join = v;)B
1032 7590(return TRUE;)B
444 7430(})B
360 7110(static int GetLineJoin \(\))B
444 6950({)B
1032 6790(return Push \(OpStack, MakeInteger \(gstate->line_join\)\);)B
444 6630(})B
360 6310(static int SetDash \(array, offset\) Object array, offset;)B
444 6150({)B
1032 5990(Object *v = BodyArray \(array\);)B
1032 5830(int i, length = lengthArray \(array\);)B
1032 5670(float sum = 0;)B
1032 5350(if \(length > MAXDASH\))B
1704 5190(return Error \(PLimitCheck\);)B
1032 5030(if \(length == 0\))B
1116 4870({)B
1704 4710(gstate->dash_length = 0;)B
1704 4550(return TRUE;)B
1116 4390(})B
8592 14470(for \(i = 0; i < length; i++\))B
8676 14310({)B
9264 14150(float val;)B
9264 13830(if \(TypeOf \(v[i]\) == Real\))B
9936 13670(val = BodyReal\(v[i]\);)B
9264 13510(else if \(TypeOf \(v[i]\) == Integer\))B
9936 13350(val = \(float\) BodyInteger \(v[i]\);)B
9264 13190(else)B
9936 13030(return Error \(PLimitCheck\);)B
9264 12870(if \(val < 0\))B
9936 12710(return Error \(PRangeCheck\);)B
9264 12550(sum += val;)B
8676 12390(})B
8592 12230(if \(sum == 0\))B
9264 12070(return Error \(PRangeCheck\);)B
8592 11750(gstate->dash_length = length;)B
8592 11590(gstate->dash_offset = BodyReal \(offset\);)B
8592 11430(for \(i = 0; i < length; i++\))B
8676 11270({)B
9264 11110(if \(TypeOf \(v[i]\) == Integer\))B
9936 10950(gstate->dash_array [i] = BodyInteger \(v[i]\);)B
9264 10790(else)B
9936 10630(gstate->dash_array [i] = BodyReal \(v[i]\);)B
8676 10470(})B
8592 10310(return TRUE;)B
8004 10150(})B
7920 9830(static int GetDash \(\))B
8004 9670({)B
8592 9510(int i;)B
8592 9350(if \(!OpCheck \(0, gstate->dash_length + 1\)\))B
9264 9190(return FALSE;)B
8592 9030(VOID Push \(OpStack, Marker\);)B
8592 8870(for \(i = 0; i < gstate->dash_length; i++\))B
9264 8710(VOID Push \(OpStack, MakeReal \(gstate->dash_array[i]\)\);)B
8592 8550(VOID Push \(ExecStack, MakeReal \(gstate->dash_offset\)\);)B
8592 8390(VOID Push \(ExecStack, Cvx \(Rbracket\)\);)B
8592 8230(return TRUE;)B
8004 8070(})B
7920 7750(static int SetFlat \(flat\) Object flat;)B
8004 7590({)B
8592 7430(gstate->flatness = BodyReal \(flat\);)B
8592 7270(return TRUE;)B
8004 7110(})B
7920 6790(static int GetFlat \(\))B
8004 6630({)B
8592 6470(return Push \(OpStack, MakeInteger \(gstate->flatness\)\);)B
8004 6310(})B
7920 5990(static int SetMiterLimit \(miter\) Object miter;)B
8004 5830({)B
8592 5670(float m = BodyReal \(miter\);)B
8592 5350(if \(m < 1\))B
9264 5190(return Error \(PRangeCheck\);)B
8592 5030(gstate->miter_limit = m;)B
8592 4870(return TRUE;)B
8004 4710(})B
7920 4390(static int GetMiterLimit \(\))B
EndPage
HfDict begin ep end
%%Page: ? 60
HfDict begin bp end
StartPage
Landscape
()(state.c)[(89/03/10)(01:09:01)](3)Gaudy
0 F
444 14470({)B
1032 14310(return Push \(OpStack, MakeReal \(gstate->miter_limit\)\);)B
444 14150(})B
360 13830(static int SetGray \(gray\) Object gray;)B
444 13670({)B
1032 13510(float g = BodyReal \(gray\);)B
1032 13190(/* DCJ:)B
1116 13030(* Postscript manual doesn't specify what happens when a value)B
1116 12870(* to setgray is out of range.  Most printers will set the)B
1116 12710(* value to the bound that was exceeded.  We will do so too.)B
1116 12550(*/)B
1032 12390(if \(g < 0.0\))B
1452 12230(g = 0.0;)B
1032 12070(if \(g > 1.0\))B
1452 11910(g = 1.0;)B
1032 11750(gstate->colour = NewGray \(g\);)B
1032 11430(return TRUE;)B
444 11270(})B
360 10950(static int GetGray \(\))B
444 10790({)B
1032 10630(return Push \(OpStack, MakeReal \(Brightness \(gstate->colour\)\)\);)B
444 10470(})B
360 10150(static int SetHSB \(hue, sat, bright\) Object hue, sat, bright;)B
444 9990({)B
1032 9830(float h = BodyReal \(hue\), s = BodyReal \(sat\), b = BodyReal \(bright\);)B
1032 9670(if \(h < 0 || h > 1 || s < 0 || s > 1 || b < 0 || b > 1\))B
1704 9510(return Error \(PRangeCheck\);)B
1032 9350(gstate->colour = NewHSBColour \(h, s, b\);)B
1032 9190(return TRUE;)B
444 9030(})B
360 8710(static int SetRGB \(red, green, blue\) Object red, green, blue;)B
444 8550({)B
1032 8390(float R = BodyReal \(red\), G = BodyReal \(green\), B = BodyReal \(blue\);)B
1032 8070(if \(R < 0 || R > 1 || G < 0 || G > 1 || B < 0 || B > 1\))B
1704 7910(return Error \(PRangeCheck\);)B
1032 7590(gstate->colour = NewRGBColour \(R, G, B\);)B
1032 7430(return TRUE;)B
444 7270(})B
360 6950(static int GetHSB \(\))B
444 6790({)B
1032 6630(float h, s, b;)B
1032 6310(ColourHSB \(gstate->colour, &h, &s, &b\);)B
1032 6150(VOID Push \(OpStack, MakeReal \(h\)\);)B
1032 5990(VOID Push \(OpStack, MakeReal \(s\)\);)B
1032 5830(VOID Push \(OpStack, MakeReal \(b\)\);)B
1032 5510(return TRUE;)B
444 5350(})B
360 5030(static int GetRGB \(\))B
444 4870({)B
1032 4710(float R, G, B;)B
1032 4390(ColourRGB \(gstate->colour, &R, &G, &B\);)B
8592 14470(VOID Push \(OpStack, MakeReal \(R\)\);)B
8592 14310(VOID Push \(OpStack, MakeReal \(G\)\);)B
8592 14150(VOID Push \(OpStack, MakeReal \(B\)\);)B
8592 13830(return TRUE;)B
8004 13670(})B
7920 13350(static int PScreenSize \(freq, rot\) Object freq, rot;)B
8004 13190({)B
8592 13030(return Push \(OpStack, MakeInteger \(ScreenSize \(BodyReal \(freq\),)B
12540 12870(BodyReal \(rot\)\)\)\);)B
8004 12710(})B
7920 12390(static int PBuildScreen \(freq, rot\) Object freq, rot;)B
8004 12230({)B
8592 12070(float f = BodyReal \(freq\), r = BodyReal \(rot\);)B
8592 11910(int i, ss = ScreenSize \(f, r\);)B
8592 11750(float)B
252(*x = \(float *\) Malloc \(sizeof \(float\) * ss\),)X
9264 11590(*y = \(float *\) Malloc \(sizeof \(float\) * ss\);)B
8592 11270(Object *px = \(Object *\) Malloc \(sizeof \(Object\) * ss\),)B
9264 11110(*py = \(Object *\) Malloc \(sizeof \(Object\) * ss\);)B
8592 10790(BuildScreen \(f, r, x, y\);)B
8592 10470(for \(i = 0; i < ss; i++\))B
8676 10310({)B
9264 10150(px [i] = MakeReal \(x[i]\);)B
9264 9990(py [i] = MakeReal \(y[i]\);)B
8676 9830(})B
8592 9670(Free \(\(char *\) x\);)B
8592 9510(Free \(\(char *\) y\);)B
8592 9190(return Push \(OpStack,)B
9684 9030(MakeArray \(px, ss\)\) && Push \(OpStack, MakeArray \(py, ss\)\);)B
8004 8870(})B
7920 8550(static int PSetRealScreen \(freq, rot, spot, thresh\) Object freq, rot, spot, thresh;)B
8004 8390({)B
8592 8230(float f = BodyReal \(freq\), r = BodyReal \(rot\);)B
8592 8070(int i, ss = ScreenSize \(f, r\);)B
8592 7910(float *th = \(float *\) Malloc \(sizeof \(float\) * ss\);)B
8592 7590(gstate->screen.frequency )B
588(= f;)X
8592 7430(gstate->screen.rotation )B
672(= r;)X
8592 7270(gstate->screen.spot_function )B
252(= spot;)X
8592 6950(if \(lengthArray \(thresh\) != ss\))B
8676 6790({)B
9264 6630(free \(\(char *\) th\);)B
9264 6470(return Error \(PRangeCheck\);)B
8676 6310(})B
8592 5990(for \(i = 0; i < ss; i++\))B
8676 5830({)B
9264 5670(Object a;)B
9264 5350(a = getArray \(thresh, i\);)B
9264 5190(if \(TypeOf \(a\) != Real\))B
9348 5030({)B
9936 4870(Free \(\(char *\) th\);)B
9936 4710(return Error \(PTypeCheck\);)B
9348 4550(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(state.c)[(89/03/10)(01:09:01)](4)Gaudy
0 F
1704 14470(th[i] = BodyReal \(a\);)B
1116 14310(})B
1032 14150(if \(gstate->screen.count == 1\))B
1452 13990(/* allows 0 to mean 'not assigned yet' */)B
1704 13830(Free \(\(char *\) gstate->screen.thresh\);)B
1032 13670(gstate->screen.thresh = th;)B
1032 13510(gstate->screen.count = 1;)B
1032 13190(SetScreen \(f, r, th\);)B
1032 12870(return TRUE;)B
444 12710(})B
360 12390(static int GetScreen \(\))B
444 12230({)B
1032 12070(VOID Push \(OpStack, MakeReal \(gstate->screen.frequency\)\);)B
1032 11910(VOID Push \(OpStack, MakeReal \(gstate->screen.rotation\)\);)B
1032 11750(VOID Push \(OpStack, gstate->screen.spot_function\);)B
1032 11590(return TRUE;)B
444 11430(})B
360 11110(static int PSetRealTransfer \(transfer, values\) Object transfer, values;)B
444 10950({)B
1032 10790(Object v;)B
1032 10630(int i, size = TransferSize \(\);)B
1032 10470(float *val;)B
1032 10150(if \(lengthArray \(values\) != size\))B
1704 9990(return Error \(PRangeCheck\);)B
1032 9670(val = \(float *\) Malloc \(sizeof \(float\) * size\);)B
1032 9510(for \(i = 0; i < size; i++\))B
1116 9350({)B
1704 9190(v = getArray \(values, i\);)B
1704 9030(if \(TypeOf \(v\) == Real\))B
2376 8870(val [i] = BodyReal \(v\);)B
1704 8710(else)B
1788 8550({)B
2376 8390(Free \(\(char *\) val\);)B
2376 8230(return Error \(PTypeCheck\);)B
1788 8070(})B
1116 7910(})B
1032 7590(if \(gstate->transfer.tcount == 1\))B
1704 7430(Free \(\(char *\) gstate->transfer.tran\);)B
1032 7270(gstate->transfer.transfn = transfer;)B
1032 7110(gstate->transfer.tran = val;)B
1032 6950(gstate->transfer.tcount = 1;)B
1032 6630(SetTransfer \(val\);)B
1032 6310(return TRUE;)B
444 6150(})B
360 5830(static int PGetTransfer \(\))B
444 5670({)B
1032 5510(return Push \(OpStack, gstate->transfer.transfn\);)B
444 5350(})B
360 5030(static int PTransferSize \(\))B
444 4870({)B
1032 4710(return Push \(OpStack, MakeInteger \(TransferSize \(\)\)\);)B
444 4550(})B
7920 14470(static int SetFillMethod \(method\) Object method;)B
8004 14310({)B
8592 14150(fill_method = BodyInteger \(method\);)B
8592 13990(return TRUE;)B
8004 13830(})B
7920 13510(static int GetFillMethod \(\))B
8004 13350({)B
8592 13190(return Push \(OpStack, MakeInteger \(fill_method\)\);)B
8004 13030(})B
7920 12710(static int SetStrokeMethod \(method\) Object method;)B
8004 12550({)B
8592 12390(stroke_method = BodyInteger \(method\);)B
8592 12230(return TRUE;)B
8004 12070(})B
7920 11750(static int GetStrokeMethod \(\))B
8004 11590({)B
8592 11430(return Push \(OpStack, MakeInteger \(stroke_method\)\);)B
8004 11270(})B
EndPage
HfDict begin ep end
%%Page: ? 61
HfDict begin bp end
StartPage
Landscape
()(str.h)[(88/08/23)(13:34:44)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Crispin Goswell 1987, All Rights Reserved.)B
444 14150(*/)B
360 13830(char *strcat \(\), *strncat \(\);)B
360 13670(int strcmp \(\), strncmp \(\), strlen \(\), strspn \(\), strcspn \(\);)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(string.c)[(89/04/06)(12:10:35)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12070(static Object OpForString, Make \(\);)B
360 11750(int putIString \(\);)B
360 11430(Object ParseString \(\), ParseHexString \(\), StringFrom \(\);)B
360 11110(static int forString \(\);)B
360 10790(static int Exec \(\), Token \(\), PString \(\), Search \(\), AnchorSearch \(\);)B
360 10630(static int Copy \(\), EqEq \(\), Length \(\), ForAll \(\), Get \(\), Put \(\);)B
360 10470(static int GetInterval \(\), PutInterval \(\), Eq \(\), Lt \(\), Le \(\), Gt \(\);)B
360 10310(static int Ge \(\), PrCheck \(\), PwCheck \(\);)B
360 10150(static int Cvi \(\), Cvr \(\), Cvs \(\), PReadOnly \(\), PExecOnly \(\);)B
360 9830(InitString \(\))B
360 9670({)B
528 9510(OpForString = MakeOp \("\(forallstring\)", forString, 0, 0, 3, 5\);)B
528 9190(TypeInstallOp \(String, "cvi",)B
756(Cvi, )X
924(1, 1, 0, 0, String\);)X
528 9030(TypeInstallOp \(String, "cvr",)B
756(Cvr, )X
924(1, 1, 0, 0, String\);)X
528 8870(TypeInstallOp \(String, "cvs",)B
756(Cvs, )X
924(2, 1, 0, 0, String,)X
1788 8710(String\);)B
528 8550(TypeInstallOp \(String, "==", )B
756(EqEq, )X
840(1, 0, 0, 0, String\);)X
528 8390(TypeInstallOp \(String, "exec",)B
672(Exec,)X
924(1, 0, 0, 1, String\);)X
528 8230(TypeInstallOp \(String, "token", )B
504(Token,)X
840(1, 3, 0, 2, String\);)X
528 8070(TypeInstallOp \(String, "eq", )B
756(Eq, )X
1008(2, 1, 0, 0, String,)X
1788 7910(String\);)B
528 7750(TypeInstallOp \(String, "lt", )B
756(Lt, )X
1008(2, 1, 0, 0, String,)X
1788 7590(String\);)B
528 7430(TypeInstallOp \(String, "le", )B
756(Le, )X
1008(2, 1, 0, 0, String,)X
1788 7270(String\);)B
528 7110(TypeInstallOp \(String, "gt", )B
756(Gt, )X
1008(2, 1, 0, 0, String,)X
1788 6950(String\);)B
528 6790(TypeInstallOp \(String, "ge", )B
756(Ge, )X
1008(2, 1, 0, 0, String,)X
1788 6630(String\);)B
528 6470(TypeInstallOp \(String, "length", )B
420(Length,)X
756(1, 1, 0, 0, String\);)X
528 6310(TypeInstallOp \(String, "forall", )B
420(ForAll,)X
756(2, 0, 0, 4, String,)X
1788 6150(Array\);)B
528 5990(TypeInstallOp \(String, "copy",)B
672(Copy,)X
924(2, 1, 0, 0, String,)X
1788 5830(String\);)B
528 5670(TypeInstallOp \(String, "get",)B
756(Get,)X
1008(2, 1, 0, 0, String,)X
1788 5510(Integer\);)B
528 5350(TypeInstallOp \(String, "put",)B
756(Put,)X
1008(3, 0, 0, 0, String,)X
1788 5190(Integer, Integer\);)B
528 5030(TypeInstallOp \(String, "getinterval",)B
84(GetInterval,)X
336(3, 1, 0, 0, String,)X
1788 4870(Integer, Integer\);)B
528 4710(TypeInstallOp \(String, "putinterval",)B
84(PutInterval,)X
336(3, 0, 0, 0, String,)X
1788 4550(Integer, String\);)B
528 4390(TypeInstallOp \(String, "executeonly",)B
84(PExecOnly,)X
504(1, 1, 0, 0, String\);)X
8088 14470(TypeInstallOp \(String, "readonly", )B
252(PReadOnly,)X
504(1, 1, 0, 0, String\);)X
8088 14310(TypeInstallOp \(String, "rcheck", )B
420(PrCheck,)X
672(1, 1, 0, 0, String\);)X
8088 14150(TypeInstallOp \(String, "wcheck", )B
420(PwCheck,)X
672(1, 1, 0, 0, String\);)X
8088 13990(TypeInstallOp \(String, "token", )B
504(Token,)X
840(1, 3, 0, 0, String\);)X
8088 13670(InstallOp \("string",)B
840(PString,)X
672(1, 1, 0, 0, Integer\);)X
8088 13510(InstallOp \("search",)B
840(Search,)X
756(2, 4, 0, 0, String, String\);)X
8088 13350(InstallOp \("anchorsearch",)B
336(AnchorSearch,)X
252(2, 3, 0, 0, String, String\);)X
7920 13190(})B
7920 12870(static int Cvi \(rep\))B
8340 12710(Object rep;)B
7920 12550({)B
8088 12390(Object v;)B
8088 12070(v = ParseNumber \(BodyString \(rep\), lengthString \(rep\)\);)B
8088 11910(if \(TypeOf \(v\) == Integer\))B
8256 11750(return Push \(OpStack, v\);)B
8088 11590(else if \(TypeOf \(v\) == Real\))B
8256 11430(return Push \(OpStack, IntReal \(v\)\);)B
8088 11270(else if \(TypeOf \(v\) == Condition\))B
8256 11110(return Error \(PUnResult\);)B
8088 10950(else)B
8256 10790(return Error \(PSyntaxError\);)B
7920 10630(})B
7920 10310(static int Cvr \(rep\))B
8340 10150(Object rep;)B
7920 9990({)B
8088 9830(Object v;)B
8088 9510(v = ParseNumber \(BodyString \(rep\), lengthString \(rep\)\);)B
8088 9350(if \(TypeOf \(v\) == Real\))B
8256 9190(return Push \(OpStack, v\);)B
8088 9030(else if \(TypeOf \(v\) == Integer\))B
8256 8870(return Push \(OpStack, RealInteger \(v\)\);)B
8088 8710(else if \(TypeOf \(v\) == Condition\))B
8256 8550(return Push \(OpStack, rep\), Error \(PUnResult\);)B
8088 8390(else)B
8256 8230(return Push \(OpStack, rep\), Error \(PSyntaxError\);)B
7920 8070(})B
7920 7750(static int Cvs \(v, string\))B
8340 7590(Object v, string;)B
7920 7430({)B
8088 7270(int length;)B
8088 6950(if \(lengthString \(string\) < \(length = lengthString \(v\)\)\))B
8256 6790(return Error \(PRangeCheck\);)B
8088 6630(VOID Bcopy \(BodyString \(string\), BodyString \(v\), length\);)B
8088 6470(return Push \(OpStack, getIString \(string, 0, length\)\);)B
7920 6310(})B
7920 5990(static int EqEq \(v\))B
8340 5830(Object v;)B
7920 5670({)B
8088 5510(int c, i, l = lengthString \(v\);)B
8088 5350(unsigned char *s = BodyString \(v\);)B
8088 5030(putchar \('\('\);)B
8088 4870(for \(i = 0; i < l && !Interrupted \(\); i++\))B
8256 4710(switch \(c = s[i]\) {)B
8256 4550(default:)B
8424 4390(if \(c < ' ' || c > 126\))B
EndPage
HfDict begin ep end
%%Page: ? 62
HfDict begin bp end
StartPage
Landscape
()(string.c)[(89/04/06)(12:10:35)](2)Gaudy
0 F
1032 14470(printf \("\\\\%o", c\);)B
864 14310(else)B
1032 14150(putchar \(c\);)B
864 13990(break;)B
696 13670(case '\\n':)B
168(printf \("\\\\n"\); break;)X
696 13510(case '\\r':)B
168(printf \("\\\\r"\); break;)X
696 13350(case '\\t':)B
168(printf \("\\\\t"\); break;)X
696 13190(case '\\b':)B
168(printf \("\\\\b"\); break;)X
696 13030(case '\\f':)B
168(printf \("\\\\f"\); break;)X
696 12870(})B
528 12710(printf \("\)"\);)B
528 12550(return TRUE;)B
360 12390(})B
360 12070(static int Exec \(item\))B
780 11910(Object item;)B
360 11750({)B
528 11590(return Push \(ExecStack, Cvx \(FileString \(item\)\)\);)B
360 11430(})B
360 11110(static int Token \(f\))B
780 10950(Object f;)B
360 10790({)B
528 10630(Object res, fs;)B
528 10310(res = Parse \(fs = FileString \(f\)\);)B
528 10150(if \(TypeOf \(res\) == Condition\))B
696 9990(return Error \(PSyntaxError\);)B
528 9830(else if \(TypeOf \(res\) == Null\))B
696 9670(return Error \(PUnResult\);)B
528 9510(else if \(TypeOf \(res\) != Bool\) {)B
696 9350(VOID Push \(OpStack,)B
1620 9190(Cvx \(SameFlags \(f,)B
2964 9030(getIString \(f,)B
3972 8870(lengthString \(f\) -)B
3972 8710(BodyFile \(fs\)->available,)B
3972 8550(BodyFile \(fs\)->available\)\)\)\);)B
696 8390(VOID Push \(OpStack, res\);)B
696 8230(VOID Push \(OpStack, True\);)B
528 8070(} else if \(BodyBool \(res\)\) {)B
696 7910(VOID Push \(OpStack, f\);)B
696 7750(VOID Push \(OpStack, False\);)B
528 7590(} else)B
696 7430(return Error \(PSyntaxError\);)B
528 7270(return TRUE;)B
360 7110(})B
360 6790(Object MakeString \(s, length\))B
780 6630(unsigned char *s; int length;)B
360 6470({)B
528 6310(Object res;)B
528 6150(unsigned char *new;)B
528 5830(MakeObject \(res, String\);)B
528 5670(res.u.String = \(new = \(unsigned char *\) Malloc \(\(unsigned\) length\)\);)B
528 5510(VOID Bcopy \(new, s, length\);)B
528 5350(res.Length = length;)B
528 5030(return res;)B
360 4870(})B
360 4550(static Object Make \(s, length\))B
780 4390(unsigned char *s; int length;)B
7920 14470({)B
8088 14310(Object res;)B
8088 14150(unsigned char *new;)B
8088 13830(MakeObject \(res, String\);)B
8088 13670(res.u.String = \(new = \(unsigned char *\) Malloc \(\(unsigned\) length\)\);)B
8088 13510(VOID Bcopy \(new, s, length\);)B
8088 13350(res.Length = length;)B
8088 13030(return res;)B
7920 12870(})B
7920 12550(Object StringFrom \(s\))B
8340 12390(unsigned char *s;)B
7920 12230({)B
8088 12070(Object res;)B
8088 11750(MakeObject \(res, String\);)B
8088 11590(res.u.String = s;)B
8088 11430(res.Length = strlen \(\(unsigned char *\) s\);)B
8088 11110(return res;)B
7920 10950(})B
7920 10630(static int Eq \(a, b\))B
8340 10470(Object a, b;)B
7920 10310({)B
8088 10150(return Push \(OpStack, MakeBool \(EqString \(a, b\)\)\);)B
7920 9990(})B
7920 9670(int EqString \(a, b\))B
8340 9510(Object a, b;)B
7920 9350({)B
8088 9190(int )B
168(al = lengthString \(a\),)X
8088 9030(bl = lengthString \(b\);)B
8088 8710(return al == bl && 0 == strncmp \(\(unsigned char *\) BodyString \(a\),)B
10860 8550(\(unsigned char *\) BodyString \(b\), al\);)B
7920 8390(})B
7920 8070(static int Lt \(a, b\))B
8340 7910(Object a, b;)B
7920 7750({)B
8088 7590(int )B
168(al = lengthString \(a\),)X
8088 7430(bl = lengthString \(b\),)B
8088 7270(cmp = strncmp \(\(unsigned char *\) BodyString \(a\),)B
9348 7110(\(unsigned char *\) BodyString \(b\), Min \(al, bl\)\);)B
8088 6790(return Push \(OpStack, MakeBool \(cmp < 0 || cmp == 0 && al < bl\)\);)B
7920 6630(})B
7920 6310(static int Le \(a, b\))B
8340 6150(Object a, b;)B
7920 5990({)B
8088 5830(return Push \(OpStack,)B
9180 5670(MakeBool \(strncmp \(\(unsigned char *\) BodyString \(a\),)B
10776 5510(\(unsigned char *\) BodyString \(b\),)B
10776 5350(Min \(lengthString \(a\),)B
11196 5190(lengthString \(b\)\)\) <= 0\)\);)B
7920 5030(})B
7920 4710(static int Gt \(a, b\))B
8340 4550(Object a, b;)B
7920 4390({)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(string.c)[(89/04/06)(12:10:35)](3)Gaudy
0 F
528 14470(int )B
168(al = lengthString \(a\),)X
528 14310(bl = lengthString \(b\),)B
528 14150(cmp = strncmp \(\(unsigned char *\) BodyString \(a\),)B
1788 13990(\(unsigned char *\) BodyString \(b\), Min \(al, bl\)\);)B
528 13670(return Push \(OpStack, MakeBool \(cmp > 0 || cmp == 0 && al > bl\)\);)B
360 13510(})B
360 13190(static int Ge \(a, b\))B
780 13030(Object a, b;)B
360 12870({)B
528 12710(return Push \(OpStack,)B
1620 12550(MakeBool \(strncmp \(\(unsigned char *\) BodyString \(a\),)B
3216 12390(\(unsigned char *\) BodyString \(b\),)B
3216 12230(Min \(lengthString \(a\),)B
3636 12070(lengthString \(b\)\)\) >= 0\)\);)B
360 11910(})B
360 11590(static int Length \(object\))B
780 11430(Object object;)B
360 11270({)B
528 11110(return Push \(OpStack, MakeInteger \(lengthString \(object\)\)\);)B
360 10950(})B
360 10630(static int Get \(object, key\))B
780 10470(Object object, key;)B
360 10310({)B
528 10150(int index;)B
528 9830(if \(TypeOf \(key\) == Integer\))B
696 9670(index = BodyInteger \(key\);)B
528 9510(else if \(TypeOf \(key\) == Real\))B
696 9350(index = \(int\) BodyReal \(key\);)B
528 9190(else)B
696 9030(return Error \(PTypeCheck\);)B
528 8870(if \(index >= 0 && index < lengthString \(object\)\))B
696 8710(return Push \(OpStack, MakeInteger \(\(int\) BodyString \(object\)[index]\)\);)B
528 8550(else)B
696 8390(return Error \(PRangeCheck\);)B
360 8230(})B
360 7910(int getString \(object, index\))B
780 7750(Object object; int index;)B
360 7590({)B
528 7430(return BodyString \(object\)[index];)B
360 7270(})B
360 6950(static int GetInterval \(object, begin, length\))B
780 6790(Object object, begin, length;)B
360 6630({)B
528 6470(int b = BodyInteger \(begin\), l = BodyInteger \(length\);)B
528 6150(if \(l < 0 || b < 0 || b + l > lengthString \(object\)\))B
696 5990(return Error \(PRangeCheck\);)B
528 5830(return Push \(OpStack, getIString \(object, b, l\)\);)B
360 5670(})B
360 5350(Object getIString \(object, begin, length\))B
780 5190(Object object; int begin, length;)B
360 5030({)B
528 4870(return Make \(BodyString \(object\) + begin, length\);)B
360 4710(})B
360 4390(static int Put \(object, key, value\))B
8340 14470(Object object, key, value;)B
7920 14310({)B
8088 14150(int index;)B
8088 13830(if \(TypeOf \(key\) == Integer\))B
8256 13670(index = BodyInteger \(key\);)B
8088 13510(else if \(TypeOf \(key\) == Real\))B
8256 13350(index = \(int\) BodyReal \(key\);)B
8088 13190(else)B
8256 13030(return Error \(PTypeCheck\);)B
8088 12870(if \(index < 0 || index >= lengthString \(object\)\))B
8256 12710(return Error \(PRangeCheck\);)B
8088 12550(else if \(TypeOf \(value\) != Integer\))B
8256 12390(return Error \(PTypeCheck\);)B
8088 12230(BodyString \(object\)[index] = BodyInteger \(value\);)B
8088 12070(return TRUE;)B
7920 11910(})B
7920 11590(putString \(object, index, value\))B
8340 11430(Object object;)B
8340 11270(int index, value;)B
7920 11110({)B
8088 10950(BodyString \(object\)[index] = value;)B
7920 10790(})B
7920 10470(static int PutInterval \(object1, begin, object2\))B
8340 10310(Object object1, begin, object2;)B
7920 10150({)B
8088 9990(int b = BodyInteger \(begin\);)B
8088 9670(if \(lengthString \(object2\) + b > lengthString \(object1\)\))B
8256 9510(return Error \(PRangeCheck\);)B
8088 9350(VOID putIString \(object1, b, object2\);)B
8088 9190(return TRUE;)B
7920 9030(})B
7920 8710(int putIString \(object1, begin, object2\))B
8340 8550(Object object1, object2;)B
8340 8390(int begin;)B
7920 8230({)B
8088 8070(int l = lengthString \(object2\);)B
8088 7910(unsigned char *from = BodyString \(object2\),)B
9264 7750(*to = BodyString \(object1\) + begin;)B
8088 7430(while \(l--\))B
8256 7270(*to++ = *from++;)B
8088 6950(return TRUE;)B
7920 6790(})B
7920 6470(static int Copy \(object1, object2\))B
8340 6310(Object object1, object2;)B
7920 6150({)B
8088 5990(if \(lengthString \(object1\) <= lengthString \(object2\)\) {)B
8256 5830(VOID putIString \(object2, 0, object1\);)B
8256 5670(VOID Push \(OpStack, getIString \(object2, 0, lengthString \(object1\)\)\);)B
8256 5510(return TRUE;)B
8088 5350(} else)B
8256 5190(return Error \(PRangeCheck\);)B
7920 5030(})B
7920 4710(static int match \(a, b, max\))B
8340 4550(unsigned char *a, *b;)B
8340 4390(int max;)B
EndPage
HfDict begin ep end
%%Page: ? 63
HfDict begin bp end
StartPage
Landscape
()(string.c)[(89/04/06)(12:10:35)](4)Gaudy
0 F
360 14470({)B
528 14310(int i;)B
528 13990(for \(i = 0; i < max && *a++ == *b++; i++\))B
696 13830(;)B
528 13670(return i;)B
360 13510(})B
360 13190(static ForAll \(string, proc\))B
780 13030(Object string, proc;)B
360 12870({)B
528 12710(VOID Push \(ExecStack, string\);)B
528 12550(VOID Push \(ExecStack, MakeInteger \(0\)\);)B
528 12390(VOID Push \(ExecStack, proc\);)B
528 12230(VOID Push \(ExecStack, OpForString\);)B
528 11910(return TRUE;)B
360 11750(})B
360 11430(static int forString \(\))B
360 11270({)B
528 11110(Object string, index, proc;)B
528 10790(proc   = Pop \(ExecStack\);)B
528 10630(index  = Pop \(ExecStack\);)B
528 10470(string = Pop \(ExecStack\);)B
528 10150(if \(BodyInteger \(index\) >= lengthString \(string\)\))B
696 9990(return TRUE;)B
528 9670(VOID Push \(ExecStack, string\);)B
528 9510(VOID Push \(ExecStack, MakeInteger \(BodyInteger \(index\) + 1\)\);)B
528 9350(VOID Push \(ExecStack, proc\);)B
528 9190(VOID Push \(ExecStack, OpForString\);)B
528 9030(VOID Push \(ExecStack, proc\);)B
528 8710(VOID Push \(OpStack, MakeInteger \(getString \(string, BodyInteger \(index\)\)\)\);)B
528 8550(return TRUE;)B
360 8390(})B
360 8070(Object ParseString \(o\))B
780 7910(Object o;)B
360 7750({)B
528 7590(unsigned char buf[STRSIZE], *p = buf, *max;)B
528 7430(int c, level = 0, foo;)B
528 7110(max = p + STRSIZE;)B
528 6950(for \(;;\) {)B
696 6790(if \(p == max\) return Absent;)B
696 6630(switch \(c = Getch \(o\)\) {)B
864 6470(default:)B
168(*p++ = c; continue;)X
864 6310(case EOF: return Nil;)B
864 6150(case '\(':)B
84(++level; *p++ = c; continue;)X
864 5990(case '\)':)B
1032 5830(if \(--level < 0\) break;)B
1032 5670(else *p++ = c;)B
1032 5510(continue;)B
864 5350(case '\\\\':)B
1032 5190(if \(BodyFile \(o\)->file_type != StringFile\))B
1200 5030(switch \(c = Getch \(o\)\) {)B
1368 4870(default:  *p++ = c; break;)B
1368 4710(case EOF: return Nil;)B
1368 4550(case '\\n': break;)B
1368 4390(case 'n': c = '\\n'; *p++ = c;)B
588(break;)X
8928 14470(case 'r': c = '\\r'; *p++ = c;)B
588(break;)X
8928 14310(case 't': c = '\\t'; *p++ = c;)B
588(break;)X
8928 14150(case 'b': c = '\\b'; *p++ = c;)B
588(break;)X
8928 13990(case 'f': c = '\\f'; *p++ = c;)B
588(break;)X
8928 13830(case '0': case '1': case '2': case '3':)B
8928 13670(case '4': case '5': case '6': case '7':)B
9096 13510(c = c - '0';)B
9096 13350(foo = Getch \(o\);)B
168(/* breaks PNX C compiler when inline */)X
9096 13190(c = \(c << 3\) + foo - '0';)B
9096 13030(foo = Getch \(o\);)B
168(/* breaks PNX C compiler when inline */)X
9096 12870(c = \(c << 3\) + foo - '0';)B
9096 12710(*p++ = c;)B
9096 12550(break;)B
8760 12390(})B
8592 12230(else)B
8760 12070(*p++ = c;)B
8760 11910(continue;)B
8256 11750(})B
8256 11590(break;)B
8088 11430(})B
8088 11270(return Make \(buf, \(int\) \(p-buf\)\);)B
7920 11110(})B
7920 10790(/*)B
8004 10630(* TMD -- Perhaps the fastest way to parse a hex string into bytes.)B
8004 10470(*        Only the stream file case is really fast, since it uses)B
8004 10310(*        getc\(\) directly.  To make the string file case fast,)B
8004 10150(*        GeneralGetch\(\) should be replaced by something close)B
8004 9990(*        to an array reference.  But I'm not sure what exactly to use...)B
8004 9830(*/)B
7920 9510(Object ParseHexString \(o\))B
8340 9350(Object o;)B
7920 9190({)B
8088 9030(unsigned char buf[STRSIZE], *p = buf;)B
8088 8870(int c, val, length = 0;)B
8088 8550(if\(!StatusFile\(o\)\) return Absent;)B
8088 8390(if\(BodyFile\(o\)->file_type == StreamFile\) {)B
8256 8230(FILE *fp = BodyFile\(o\)->f.f_ptr;)B
8256 8070(do {)B
8424 7910(/* Get the first nibble */)B
8424 7750(for\(;;\) {)B
8592 7590(c = getc\(fp\);)B
8592 7430(if \(c >= '0' && c <= '9'\)      { val = \(c - '0'\) << 4;      break; })B
8592 7270(else if \(c >= 'A' && c <= 'F'\) { val = \(c - 'A' + 10\) << 4; break; })B
8592 7110(else if \(c >= 'a' && c <= 'f'\) { val = \(c - 'a' + 10\) << 4; break; })B
8592 6950(else if \(c == '>'\) return Make\(buf,length\);)B
8592 6790(else if \(c == EOF\) return Nil;)B
8424 6630(})B
8424 6310(/* Get the second nibble */)B
8424 6150(for\(;;\) {)B
8592 5990(c = getc\(fp\);)B
8592 5830(if \(c >= '0' && c <= '9'\)      { *p++ = val + c - '0';      break; })B
8592 5670(else if \(c >= 'A' && c <= 'F'\) { *p++ = val + c - 'A' + 10; break; })B
8592 5510(else if \(c >= 'a' && c <= 'f'\) { *p++ = val + c - 'a' + 10; break; })B
8592 5350(else if \(c == '>'\) return Make\(buf,length\);)B
8592 5190(else if \(c == EOF\) return Nil;)B
8424 5030(})B
8256 4870(} while\(++length != STRSIZE\);)B
8088 4710(})B
8088 4550(else {)B
8256 4390(do {)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(string.c)[(89/04/06)(12:10:35)](5)Gaudy
0 F
864 14470(/* Get the first nibble */)B
864 14310(for\(;;\) {)B
1032 14150(c = GeneralGetch\(o\);)B
1032 13990(if \(c >= '0' && c <= '9'\)      { val = \(c - '0'\) << 4;      break; })B
1032 13830(else if \(c >= 'A' && c <= 'F'\) { val = \(c - 'A' + 10\) << 4; break; })B
1032 13670(else if \(c >= 'a' && c <= 'f'\) { val = \(c - 'a' + 10\) << 4; break; })B
1032 13510(else if \(c == '>'\) return Make\(buf,length\);)B
1032 13350(else if \(c == EOF\) return Nil;)B
864 13190(})B
864 12870(/* Get the second nibble */)B
864 12710(for\(;;\) {)B
1032 12550(c = GeneralGetch\(o\);)B
1032 12390(if \(c >= '0' && c <= '9'\)      { *p++ = val + c - '0';      break; })B
1032 12230(else if \(c >= 'A' && c <= 'F'\) { *p++ = val + c - 'A' + 10; break; })B
1032 12070(else if \(c >= 'a' && c <= 'f'\) { *p++ = val + c - 'a' + 10; break; })B
1032 11910(else if \(c == '>'\) return Make\(buf,length\);)B
1032 11750(else if \(c == EOF\) return Nil;)B
864 11590(})B
696 11430(} while\(++length != STRSIZE\);)B
528 11270(})B
528 10950(return Absent;)B
360 10790(})B
360 10470(#ifdef notdef)B
360 10310(Object ParseHexString \(o\))B
780 10150(Object o;)B
360 9990({)B
528 9830(unsigned char buf [STRSIZE], *p = buf;)B
528 9670(int c, count = 0, val = 0, length = 0;)B
528 9350(while \(\(c = Getch \(o\)\) != '>' && c != EOF && length < STRSIZE\) {)B
696 9190(if \(c >= '0' && c <= '9'\))B
864 9030(val = val * 16 + c - '0';)B
696 8870(else if \(c >= 'A' && c <= 'F'\))B
864 8710(val = val * 16 + 10 + c - 'A';)B
696 8550(else if \(c >= 'a' && c <= 'z'\))B
864 8390(val = val * 16 + 10 + c - 'a';)B
696 8230(else)B
864 8070(--count;)B
696 7910(if \(++count == 2\) {)B
864 7750(*p++ = val; ++length;)B
864 7590(count = val = 0;)B
696 7430(})B
528 7270(})B
528 7110(if \(length == STRSIZE\))B
696 6950(return Absent;)B
528 6790(return c == EOF ? Nil : Make \(buf, length\);)B
444 6630(})B
360 6470(#endif)B
360 6150(static int PString \(length\))B
780 5990(Object length;)B
360 5830({)B
528 5670(int l;)B
528 5510(unsigned char *body, *p;)B
528 5190(if \(\(l = BodyInteger \(length\)\) < 0\))B
696 5030(return Error \(PRangeCheck\);)B
528 4870(body = \(unsigned char *\) Malloc \(\(unsigned\) l\);)B
528 4550(for \(p = body; p < &body[l]; p++\))B
696 4390(*p = '\\0';)B
8088 14470(return Push \(OpStack, Make \(body, l\)\);)B
7920 14310(})B
7920 13990(static int AnchorSearch \(string, seek\))B
8340 13830(Object string, seek;)B
7920 13670({)B
8088 13510(unsigned char *str = BodyString \(string\), *see = BodyString \(seek\);)B
8088 13350(int m, lstr = lengthString \(string\), lsee = lengthString \(seek\);)B
8088 13030(if \(lsee > lstr || \(m = match \(str, see, lsee\)\) != lsee\))B
8256 12870(VOID Push \(OpStack, string\),)B
8256 12710(VOID Push \(OpStack, False\);)B
8088 12550(else {)B
8256 12390(VOID Push \(OpStack, Make \(str + m, lstr - m\)\);)B
8256 12230(VOID Push \(OpStack, Make \(str, m\)\);)B
8256 12070(VOID Push \(OpStack, True\);)B
8088 11910(})B
8088 11750(return TRUE;)B
7920 11590(})B
7920 11270(static int Search \(string, seek\))B
8340 11110(Object string, seek;)B
7920 10950({)B
8088 10790(unsigned char *str = BodyString \(string\), *body = str,)B
9264 10630(*see = BodyString \(seek\);)B
8088 10470(int i, m, lstr = lengthString \(string\), lsee = lengthString \(seek\);)B
8088 10150(for \(i = lstr - lsee; i >= 0; i--\))B
8256 9990(if \(\(m = match \(str, see, lsee\)\) == lsee\) {)B
8424 9830(VOID Push \(OpStack, Make \(body + \(str-body\) + m, lstr - \(str-body+m\)\)\);)B
8424 9670(VOID Push \(OpStack, Make \(body + \(str - body\), m\)\);)B
8424 9510(VOID Push \(OpStack, Make \(body, str - body\)\);)B
8424 9350(VOID Push \(OpStack, True\);)B
8424 9190(return TRUE;)B
8256 9030(} else)B
8424 8870(++str;)B
8088 8710(VOID Push \(OpStack, string\);)B
8088 8550(VOID Push \(OpStack, False\);)B
8088 8230(return TRUE;)B
7920 8070(})B
7920 7750(static int PExecOnly \(item\))B
8340 7590(Object item;)B
7920 7430({)B
8088 7270(return Push \(OpStack, ExecOnly \(item\)\);)B
7920 7110(})B
7920 6790(static int PReadOnly \(item\))B
8340 6630(Object item;)B
7920 6470({)B
8088 6310(return Push \(OpStack, ReadOnly \(item\)\);)B
7920 6150(})B
7920 5830(static int PrCheck \(v\))B
8340 5670(Object v;)B
7920 5510({)B
8088 5350(return Push \(OpStack, MakeBool \(rCheck \(v\)\)\);)B
7920 5190(})B
7920 4870(static int PwCheck \(v\))B
8340 4710(Object v;)B
7920 4550({)B
8088 4390(return Push \(OpStack, MakeBool \(wCheck \(v\)\)\);)B
EndPage
HfDict begin ep end
%%Page: ? 64
HfDict begin bp end
StartPage
Landscape
()(string.c)[(89/04/06)(12:10:35)](6)Gaudy
0 F
360 14470(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(stroke.c)[(89/04/06)(12:11:23)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author. )B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12230(#include "main.h")B
360 12070(#include "graphics.h")B
360 11750(int PStrokePath \(\);)B
360 11430(int in_stroke = FALSE;)B
360 11110(int Stroke \(\);)B
360 10790(InitStroke \(\))B
360 10630({)B
528 10470(InstallOp \("strokepath",)B
504(PStrokePath,)X
336(0, 0, 0, 0\);)X
528 10310(InstallOp \("stroke",)B
840(Stroke,)X
756(0, 0, 0, 0\);)X
360 10150(})B
360 9830(int Stroke \(\))B
360 9670({)B
528 9510(int res;)B
528 9190(if \(!PFlattenPath \(\)\))B
696 9030(return FALSE;)B
528 8870(if \(EmptyPath \(gstate->path\)\))B
696 8710(return TRUE;)B
528 8550(if \(gstate->device->dev == NULL\))B
696 8390(return PNewPath \(\);)B
528 8230(if \(ThinStroke \(\)\))B
696 8070(return TRUE;)B
528 7910(in_stroke = TRUE;)B
528 7750(res = PStrokePath \(\) && Fill \(\);)B
528 7590(VOID PNewPath \(\);)B
528 7430(in_stroke = FALSE;)B
528 7110(return res;)B
360 6950(})B
360 6630(float Magnitude \(v\))B
780 6470(Vector v;)B
360 6310({)B
528 6150(return sqrt \(v.vx * v.vx + v.vy * v.vy\);)B
360 5990(})B
360 5670(#define Magnitude\(v\) sqrt \(v.vx * v.vx + v.vy * v.vy\))B
360 5350(static void Dash \(\))B
360 5190({)B
528 5030(Matrix m;)B
528 4870(Path p, new = NewPath \(\), last_move, last_dash;)B
528 4710(HardPoint move, here, next;)B
528 4550(Vector v, unit;)B
528 4390(int marking, start_marking = TRUE, index, start_index = 0;)B
8088 14470(float dash_left, start_dash_left = gstate->dash_offset;)B
8088 14310(float umag, dmag;)B
8088 13990(m = gstate->CTM;)B
8088 13830(m.tx = 0.0;  m.ty = 0.0;)B
8088 13510(while \(start_dash_left > gstate->dash_array [start_index]\) {)B
8256 13350(start_dash_left -= gstate->dash_array [start_index];)B
8256 13190(if \(++start_index == gstate->dash_length\))B
8424 13030(start_index = 0;)B
8256 12870(start_marking = !start_marking;)B
8088 12710(})B
8088 12550(start_dash_left = gstate->dash_array [start_index] - start_dash_left;)B
8088 12230(for \(p = gstate->path->next; p != gstate->path; p = p->next\))B
8256 12070(switch \(p->ptype\) {)B
8256 11910(case EMove:)B
8424 11750(index = start_index;)B
8424 11590(marking = start_marking;)B
8424 11430(dash_left = start_dash_left;)B
8424 11270(here = move = p->pe.point;)B
8424 11110(VOID MoveTo \(new, here\);)B
8424 10950(last_move = last_dash = new->last;)B
8424 10790(break;)B
8256 10470(case ELine:)B
8256 10310(case EClose:)B
8424 10150(if \(p->ptype == ELine\))B
8592 9990(next = p->pe.point;)B
8424 9830(else)B
8592 9670(next = move;)B
8424 9510(v = NewVector \(next.hx - here.hx, next.hy - here.hy, 1.0\);)B
8424 9350(dmag = Magnitude \(v\);)B
8424 9190(if \(dmag == 0\) {)B
8592 9030(here = next;)B
8592 8870(break;)B
8424 8710(})B
8424 8550(unit = ITransform \(v, m\);)B
8424 8390(umag = Magnitude \(unit\);)B
8424 8230(unit = NewVector \(v.vx / umag, v.vy / umag, 1.0\);)B
8424 8070(while \(umag > dash_left\) {)B
8592 7910(here.hx += unit.vx * dash_left;)B
8592 7750(here.hy += unit.vy * dash_left;)B
8592 7590(\(*\(marking ? LineTo : MoveTo\)\) \(new, here\);)B
8592 7430(if \(!marking\))B
8760 7270(last_dash = new->last;)B
8592 7110(marking = !marking;)B
8592 6950(umag -= dash_left;)B
8592 6790(if \(++index == gstate->dash_length\))B
8760 6630(index = 0;)B
8592 6470(dash_left = gstate->dash_array [index];)B
8424 6310(})B
8424 6150(if \(p->ptype == ELine\) {)B
8592 5990(dash_left -= umag;)B
8592 5830(if \(marking\))B
8760 5670(VOID LineTo \(new, next\);)B
8424 5510(} else {)B
8592 5350(if \(marking\) {)B
8760 5190(if \(start_marking\))B
8928 5030(if \(last_dash == last_move\))B
9096 4870(ClosePath \(new\);)B
8928 4710(else {)B
9096 4550(/*)B
672(LineTo \(new, move\);)X
420(*/)X
9096 4390(MoveChunk \(last_move,last_dash,new->last\);)B
EndPage
HfDict begin ep end
%%Page: ? 65
HfDict begin bp end
StartPage
Landscape
()(stroke.c)[(89/04/06)(12:11:23)](2)Gaudy
0 F
1368 14470(} else)B
1536 14310(VOID LineTo \(new, move\);)B
1032 14150(})B
864 13990(})B
864 13830(here = next;)B
864 13670(break;)B
696 13350(default:)B
864 13190(Panic \("Dash: unknown Path Element type"\);)B
696 13030(})B
528 12870(PathFree \(gstate->path\);)B
528 12710(gstate->path = new;)B
528 12550(gstate->cp = new->next->pe.point;)B
360 12390(})B
360 12070(MoveChunk \(dest, begin, end\))B
780 11910(Path dest, begin, end;)B
360 11750({)B
528 11590(dest->ptype = ELine;)B
528 11430(end->next->last = begin->last;)B
528 11270(begin->last->next = end->next;)B
528 11110(dest->last->next = begin;)B
528 10790(end->next = dest;)B
528 10630(begin->last = dest->last;)B
528 10470(dest->last = end;)B
360 10310(})B
360 9990(/*)B
444 9830(* is 'b' to the left of 'a' ? if 'a' carries into 'b' ?)B
444 9670(*)B
444 9510(*)B
2100(/)X
444 9350(*)B
2016(/)X
444 9190(*)B
1932(b)X
444 9030(*)B
1848(/)X
444 8870(*)B
1764(/)X
444 8710(* --------- a -------o)B
444 8550(* )B
444 8390(*/)B
360 8070(leftof \(a, b\))B
780 7910(float a, b;)B
360 7750({)B
528 7590(return Normalise \(b - a\) > 0;)B
360 7430(})B
360 7110(#define leftof\(a, b\) Normalise \(b - a\) > 0)B
360 6790(Miter \(new, last_angle, angle, width\))B
780 6630(Path new;)B
780 6470(float last_angle, angle, width;)B
360 6310({)B
528 6150(Matrix old;)B
528 5990(float diff;)B
528 5670(old = gstate->CTM;)B
528 5510(if \(leftof \(last_angle, angle\)\) {)B
696 5350(diff = angle - last_angle;)B
696 5190(VOID MoveTo \(new, ExtToInt \(NewUserPoint \(0.0, 0.0\)\)\);)B
696 5030(gstate->CTM = Rotate \(gstate->CTM, -diff\);)B
696 4870(VOID LineTo \(new, ExtToInt \(NewUserPoint \(0.0, -width / 2\)\)\);)B
696 4710(gstate->CTM = Rotate \(gstate->CTM, diff / 2\);)B
696 4550(VOID LineTo \(new, ExtToInt \(NewUserPoint \(0.0, -\(width / 2\) / cos \(diff / 2\)\)\)\);)B
696 4390(gstate->CTM = old;)B
8256 14470(VOID LineTo \(new, ExtToInt \(NewUserPoint \(0.0, -width / 2\)\)\);)B
8088 14310(} else {)B
8256 14150(diff = last_angle - angle;)B
8256 13990(VOID MoveTo \(new, ExtToInt \(NewUserPoint \(0.0, 0.0\)\)\);)B
8256 13830(VOID LineTo \(new, ExtToInt \(NewUserPoint \(0.0, width / 2\)\)\);)B
8256 13670(gstate->CTM = Rotate \(gstate->CTM, diff / 2\);)B
8256 13510(VOID LineTo \(new, ExtToInt \(NewUserPoint \(0.0, \(width / 2\) / cos \(diff / 2\)\)\)\);)B
8256 13350(gstate->CTM = Rotate \(gstate->CTM, diff / 2\);)B
8256 13190(VOID LineTo \(new, ExtToInt \(NewUserPoint \(0.0, width / 2\)\)\);)B
8256 13030(gstate->CTM = old;)B
8088 12870(})B
8088 12710(ClosePath \(new\);)B
7920 12550(})B
7920 12230(Bevel \(new, last_angle, angle, width\))B
8340 12070(Path new;)B
8340 11910(float last_angle, angle, width;)B
7920 11750({)B
8088 11590(HardPoint P1;)B
8088 11430(Matrix *mp;)B
8088 11270(float diff,ca,sa,x,y;)B
8088 10950(mp = &gstate->CTM;)B
8088 10790(width /= 2;)B
8088 10630(diff = last_angle - angle;)B
8088 10470(x = mp->tx;   y = mp->ty;)B
8088 10310(P1.hx = x;    P1.hy = y;)B
8088 10150(VOID MoveTo \(new, P1\);)B
8088 9830(ca = cos\(diff\);   sa = sin\(diff\);)B
8088 9510(if \(leftof \(last_angle, angle\)\) {)B
8256 9350(P1.hx = -width * \(mp->C*ca - mp->A*sa\) + x;)B
8256 9190(P1.hy = -width * \(mp->D*ca - mp->B*sa\) + y;)B
8256 9030(VOID LineTo \(new, P1\);)B
8256 8710(P1.hx = -width*mp->C + x;)B
8256 8550(P1.hy = -width*mp->D + y;)B
8256 8390(VOID LineTo \(new, P1\);)B
8088 8230(} else {)B
8256 8070(P1.hx = width*mp->C + x;)B
8256 7910(P1.hy = width*mp->D + y;)B
8256 7750(VOID LineTo \(new, P1\);)B
8256 7430(P1.hx = width * \(mp->C*ca - mp->A*sa\) + x;)B
8256 7270(P1.hy = width * \(mp->D*ca - mp->B*sa\) + y;)B
8256 7110(VOID LineTo \(new, P1\);)B
8088 6950(})B
8088 6790(ClosePath \(new\);)B
7920 6630(})B
7920 6310(BeginCap \(new, width\))B
8340 6150(Path new;)B
8340 5990(float width;)B
7920 5830({)B
8088 5670(Path add;)B
8088 5510(HardPoint P1,P2,P3;)B
8088 5350(Matrix *mp;)B
8088 5190(float x,y,t2,w2,wa,wb,wc,wd;)B
8088 4870(switch \(gstate->line_cap\) {)B
8088 4710(case CBUTT:)B
8256 4550(break;)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(stroke.c)[(89/04/06)(12:11:23)](3)Gaudy
0 F
528 14470(case CSQUARE:)B
696 14310(mp = &gstate->CTM;  w2 = width/2; wc = w2*mp->C; wd = w2*mp->D;)B
696 14150(P1.hx = -wc + mp->tx;  P1.hy = -wd + mp->ty;  VOID MoveTo \(new, P1\);)B
696 13990(wc *= 2;  wd *= 2;)B
696 13830(P1.hx += wc;           P1.hy += wd;           VOID LineTo \(new, P1\);)B
696 13670(P1.hx -= w2*mp->A;     P1.hy -= w2*mp->B;     VOID LineTo \(new, P1\);)B
696 13510(P1.hx += wc;           P1.hy += wd;           VOID LineTo \(new, P1\);)B
696 13350(ClosePath \(new\);)B
696 13190(break;)B
528 12870(case CROUND:)B
696 12710(mp = &gstate->CTM;  w2 = width/2;)B
696 12550(P1.hx = w2*mp->C + mp->tx;   P1.hy = w2*mp->D + mp->ty;)B
696 12390(VOID MoveTo \(new, P1\);)B
696 12070(/* Arc \(new, 1, P1, w2, PI / 2, 3 * PI / 2\); */)B
696 11910(wa = w2*gstate->CTM.C;  wb = w2*gstate->CTM.D;)B
696 11750(wc = -w2*gstate->CTM.A; wd = -w2*gstate->CTM.B;)B
696 11590(x = gstate->CTM.tx;     y = gstate->CTM.ty;)B
696 11430(t2 = \(\(float\) .5522847\);  /* \(4/3\)*\(sqrt\(2\) - 1\) */)B
696 11110(P1.hx = x + wa + t2*wc; P1.hy = y + wb + t2*wd;)B
696 10950(P3.hx = x + wc;         P3.hy = y + wd;)B
696 10790(P2.hx = P3.hx + t2*wa;  P2.hy = P3.hy + t2*wb;)B
696 10630(NewElem \(ECurve, add\);)B
696 10470(add->pe.curve.x0 = P1;)B
504(add->pe.curve.x1 = P2;)X
168(add->pe.curve.x2 = P3;)X
696 10310(gstate->cp = P3; PathInsert \(new, add\);)B
696 9990(P1.hx = x + wc - t2*wa; P1.hy = y + wd - t2*wb;)B
696 9830(P3.hx = x - wa;         P3.hy = y - wb;)B
696 9670(P2.hx = P3.hx + t2*wc;  P2.hy = P3.hy + t2*wd;)B
696 9510(NewElem \(ECurve, add\);)B
696 9350(add->pe.curve.x0 = P1;)B
504(add->pe.curve.x1 = P2;)X
168(add->pe.curve.x2 = P3;)X
696 9190(gstate->cp = P3; PathInsert \(new, add\);)B
696 8870(ClosePath \(new\);)B
696 8710(break;)B
528 8390(default:)B
696 8230(Panic \("BeginCap  - unknown line cap encountered"\);)B
528 8070(})B
360 7910(})B
360 7590(LineJoin \(new, width, last_angle, angle\))B
780 7430(Path new;)B
780 7270(float width, last_angle, angle;)B
360 7110({)B
528 6950(float ang, sa;)B
528 6630(switch \(gstate->line_join\) {)B
528 6470(case JMITRE:)B
696 6310(ang = Normalise \(leftof \(last_angle, angle\) ? angle - last_angle : last_angle - angle)B
696 6150(ang = ang < 0 ? -ang : ang;)B
696 5990(ang = ang > PI / 2 ? PI - ang : ang;)B
696 5830(sa = sin \(ang / 2\);)B
696 5670(if \(sa != 0 && 1 / sa <= gstate->miter_limit &&)B
1956 5510(1 / sa >= -gstate->miter_limit\))B
864 5350(Miter \(new, last_angle, angle, width\);)B
696 5190(else)B
864 5030(Bevel \(new, last_angle, angle, width\);)B
696 4710(break;)B
528 4390(case JROUND:)B
8256 14470(VOID MoveTo \(new, ExtToInt \(NewUserPoint \(width / 2, 0.0\)\)\);)B
8256 14310(Arc \(new, 1, NewUserPoint \(0.0, 0.0\), width / 2, 0.0, 2 * PI\);)B
8256 14150(ClosePath \(new\);)B
8256 13990(break;)B
8088 13670(case JBEVEL:)B
8256 13510(Bevel \(new, last_angle, angle, width\);)B
8256 13350(break;)B
8088 13030(default:)B
8256 12870(Panic \("LineJoin  - unknown line join encountered"\);)B
8088 12710(})B
7920 12550(})B
7920 12230(EndCap \(new, width, length\))B
8340 12070(Path new;)B
8340 11910(float width, length;)B
7920 11750({)B
8088 11590(Path add;)B
8088 11430(HardPoint P1,P2,P3;)B
8088 11270(Matrix *mp;)B
8088 11110(float x,y,t2,w2,wa,wb,wc,wd;)B
8088 10790(switch \(gstate->line_cap\) {)B
8256 10630(case CBUTT:)B
8424 10470(break;)B
8256 10150(case CSQUARE:)B
8424 9990(mp = &gstate->CTM;  w2 = width/2;  wa = w2*mp->A;  wb = w2*mp->B;)B
8424 9830(P1.hx = length*mp->A + w2*mp->C + mp->tx;)B
8424 9670(P1.hy = length*mp->B + w2*mp->D + mp->ty;    VOID MoveTo \(new, P1\);)B
8424 9510(P1.hx += wa;          P1.hy += wb;           VOID LineTo \(new, P1\);)B
8424 9350(P1.hx += width*mp->C; P1.hy += width*mp->D;  VOID LineTo \(new, P1\);)B
8424 9190(P1.hx -= wa;          P1.hy -= wb;           VOID LineTo \(new, P1\);)B
8424 9030(ClosePath \(new\);)B
8424 8870(break;)B
8256 8550(case CROUND:)B
8424 8390(mp = &gstate->CTM;  w2 = width/2;)B
8424 8230(P1.hx = length*mp->A - w2*mp->C + mp->tx;)B
8424 8070(P1.hy = length*mp->B - w2*mp->D + mp->ty;)B
8424 7750(VOID MoveTo \(new, P1\);)B
8424 7430(/* Arc \(new, 1, P1, w2, -PI / 2, PI / 2\); */)B
8424 7270(wa = -w2*gstate->CTM.C; wb = -w2*gstate->CTM.D;)B
8424 7110(wc = w2*gstate->CTM.A;  wd = w2*gstate->CTM.B;)B
8424 6950(x = gstate->CTM.tx;     y = gstate->CTM.ty;)B
8424 6790(t2 = \(\(float\) .5522847\);  /* \(4/3\)*\(sqrt\(2\) - 1\) */)B
8424 6470(P1.hx = x + wa + t2*wc; P1.hy = y + wb + t2*wd;)B
8424 6310(P3.hx = x + wc;         P3.hy = y + wd;)B
8424 6150(P2.hx = P3.hx + t2*wa;  P2.hy = P3.hy + t2*wb;)B
8424 5990(NewElem \(ECurve, add\);)B
8424 5830(add->pe.curve.x0 = P1;)B
336(add->pe.curve.x1 = P2;)X
168(add->pe.curve.x2 = P3;)X
8424 5670(gstate->cp = P3; PathInsert \(new, add\);)B
8424 5350(P1.hx = x + wc - t2*wa; P1.hy = y + wd - t2*wb;)B
8424 5190(P3.hx = x - wa;         P3.hy = y - wb;)B
8424 5030(P2.hx = P3.hx + t2*wc;  P2.hy = P3.hy + t2*wd;)B
8424 4870(NewElem \(ECurve, add\);)B
8424 4710(add->pe.curve.x0 = P1;)B
336(add->pe.curve.x1 = P2;)X
168(add->pe.curve.x2 = P3;)X
8424 4550(gstate->cp = P3; PathInsert \(new, add\);)B
EndPage
HfDict begin ep end
%%Page: ? 66
HfDict begin bp end
StartPage
Landscape
()(stroke.c)[(89/04/06)(12:11:23)](4)Gaudy
0 F
864 14470(ClosePath \(new\);)B
864 14310(break;)B
696 13990(default:)B
864 13830(Panic \("StrokeLineEnd  - unknown line cap encountered"\);)B
528 13670(})B
360 13510(})B
360 13190(static float move_angle;)B
360 13030(static Matrix move_matrix;)B
360 12710(float LineSegment \(p, new, ehere, enow, width, last_angle, last_type\))B
780 12550(Path p, new;)B
780 12390(UserPoint ehere, enow;)B
780 12230(float width, last_angle;)B
780 12070(enum pelem_type last_type;)B
360 11910({)B
528 11750(HardPoint P1;)B
528 11590(float angle,length,ca,sa;)B
528 11430(Matrix old,m;)B
528 11110(/* Compute angle, length, sin\(angle\) and cos\(angle\) of line segment */)B
528 10950(sa = enow.y - ehere.y;   ca = enow.x - ehere.x;)B
528 10630(angle = atan2 \(sa,ca\);   length = sqrt \(sa*sa + ca*ca\);)B
528 10470(if\(length > \(float\) 0.0\) {  sa /= length;   ca /= length; })B
528 10310(else {                      sa = 0;         ca = 1; })B
528 9990(/* Translate CTM by ehere and rotate by angle */)B
528 9830(old = gstate->CTM;)B
528 9670(m.A  = ca * old.A + sa * old.C;  m.B  = ca * old.B + sa * old.D;)B
528 9510(m.C  = ca * old.C - sa * old.A;  m.D  = ca * old.D - sa * old.B;)B
528 9350(m.tx = ehere.x * old.A + ehere.y * old.C + old.tx;)B
528 9190(m.ty = ehere.x * old.B + ehere.y * old.D + old.ty;)B
528 9030(gstate->CTM = m;)B
528 8710(/* Create a path for the outline of the line segment */)B
528 8550(sa = -width/2;)B
528 8390(P1.hx = sa*m.C + m.tx; P1.hy = sa*m.D + m.ty; VOID MoveTo \(new, P1\);)B
528 8230(P1.hx += length*m.A;   P1.hy += length*m.B;   VOID LineTo \(new, P1\);)B
528 8070(P1.hx += width*m.C;    P1.hy += width*m.D;    VOID LineTo \(new, P1\);)B
528 7910(P1.hx -= length*m.A;   P1.hy -= length*m.B;   VOID LineTo \(new, P1\);)B
528 7750(ClosePath \(new\);)B
528 7430(if \(last_type == EMove\) {)B
696 7270(move_angle = angle;)B
696 7110(move_matrix = gstate->CTM;)B
528 6950(})B
528 6790(else if \(last_type == ELine\))B
696 6630(LineJoin \(new, width, last_angle, angle\);)B
528 6310(if \(p->ptype == EClose\) {)B
696 6150(if \(last_type == ELine\) {)B
864 5990(gstate->CTM = move_matrix;)B
864 5830(LineJoin \(new, width, angle, move_angle\);)B
696 5670(})B
528 5510(})B
528 5350(else if \(p->next->ptype == EMove || p->next->ptype == EHeader\) {)B
696 5190(EndCap \(new, width, length\);)B
696 5030(gstate->CTM = move_matrix;)B
696 4870(BeginCap \(new, width\);)B
528 4710(})B
528 4390(gstate->CTM = old;)B
8088 14470(return angle;)B
7920 14310(})B
7920 13990(int PStrokePath \(\))B
7920 13830({)B
8088 13670(Path p, new;)B
8088 13510(HardPoint prev, here, move;)B
8088 13350(enum pelem_type last_type = EHeader;)B
8088 13190(float angle, last_angle, width = gstate->line_width;)B
8088 12870(NewElem\(EHeader,new\);)B
8088 12710(new->next = new->last = new;)B
8088 12390(PFlattenPath \(\);)B
8088 12230(if \(gstate->dash_length != 0\))B
8256 12070(Dash \(\);)B
8088 11910(for \(p = gstate->path->next; p != gstate->path; last_type = p->ptype, p = p->next\) {)B
8256 11750(switch \(p->ptype\) {)B
8256 11590(case EMove:)B
8424 11430(prev = here;)B
8424 11270(move = here = p->pe.point;)B
8424 11110(break;)B
8256 10790(case EClose:)B
8424 10630(if \(last_type == EMove\))B
8592 10470(break;)B
8424 10310(angle = LineSegment \(p, new, IntToExt \(here\), IntToExt \(move\), width, last_angle, l)B
8424 10150(prev = here;)B
8424 9990(here = move;)B
8424 9830(last_type = EHeader;)B
8424 9670(break;)B
8256 9350(case ELine:)B
8424 9190(angle = LineSegment \(p, new, IntToExt \(here\), IntToExt \(p->pe.point\), width, last_a)B
8424 9030(prev = here;)B
8424 8870(here = p->pe.point;)B
8424 8710(break;)B
8256 8390(default:)B
8424 8230(Panic \("unknown path element type in StrokePath"\);)B
8256 8070(})B
8256 7910(last_type = p->ptype;)B
8256 7750(last_angle = angle;)B
8088 7590(})B
8088 7430(PathFree \(gstate->path\);)B
8088 7270(gstate->path = new;)B
8088 7110(return TRUE;)B
7920 6950(})B
7920 6630(int ThinStroke \(\))B
7920 6470({)B
8088 6310(Path p;)B
8088 6150(Vector v;)B
8088 5990(HardPoint here, prev;)B
8088 5670(if \(stroke_method != STROKE_THIN\))B
8256 5510(return FALSE; /* not used - get better results with area fill */)B
8088 5350(v = Transform \(NewVector \(gstate->line_width, gstate->line_width, 0.0\), gstate->CTM\);)B
8088 5190(if \(fabs \(v.vx\) > 1.1 || fabs \(v.vy\) > 1.1\))B
8256 5030(return FALSE;)B
8088 4870(if \(gstate->dash_length != 0\))B
8256 4710(Dash \(\);)B
8088 4550(for \(p = gstate->path->next; p != gstate->path; p = p->next\))B
8256 4390(switch \(p->ptype\) {)B
EndPage
HfDict begin hp end
StartPage
Landscape
()(stroke.c)[(89/04/06)(12:11:23)](5)Gaudy
0 F
696 14470(case EMove:)B
864 14310(here = prev = p->pe.point;)B
864 14150(break;)B
696 13830(case ELine:)B
864 13670(DevicePaintLine \(gstate->device, prev, p->pe.point, gstate->colour\);)B
864 13510(prev = p->pe.point;)B
864 13350(break;)B
696 13030(case EClose:)B
864 12870(DevicePaintLine \(gstate->device, prev, here, gstate->colour\);)B
864 12710(prev = here;)B
864 12550(break;)B
696 12230(default:)B
864 12070(Panic \("unknown path element type in ThinStroke"\);)B
696 11910(})B
528 11750(VOID PNewPath \(\);)B
528 11430(return TRUE;)B
360 11270(})B
EndPage
HfDict begin ep end
%%Page: ? 67
HfDict begin bp end
StartPage
Landscape
()(unix.c)[(89/04/02)(22:56:34)](1)Gaudy
0 F
360 14470(/*)B
444 14310(* Copyright \(C\) Rutherford Appleton Laboratory 1987)B
444 14150(* )B
444 13990(* This source may be copied, distributed, altered or used, but not)B
444 13830(* sold for profit or incorporated into a product except under licence)B
444 13670(* from the author.)B
444 13510(* It is not in the public domain.)B
444 13350(* This notice should remain in the source unaltered, and any changes)B
444 13190(* to the source made by persons other than the author should be)B
444 13030(* marked as such.)B
444 12870(* )B
444 12710(*)B
504(Crispin Goswell @ Rutherford Appleton Laboratory caag@uk.ac.rl.vd)X
444 12550(*/)B
360 12390(#include "main.h")B
360 12230(#ifndef MACINTOSH)B
360 12070(#include <signal.h>)B
360 11750(static int Chdir \(\), Fork \(\), Execv \(\), Wait \(\), Exit \(\), System \(\);)B
360 11590(static int Signal \(\), Kill \(\);)B
360 11270(InitUnix \(\))B
360 11110({)B
528 10950(InstallOp \("chdir",)B
252(Chdir,)X
168(1, 1, 0, 0, String\);)X
528 10790(InstallOp \("fork",)B
336(Fork,)X
252(0, 1, 0, 0\);)X
528 10630(InstallOp \("wait",)B
336(Wait,)X
252(0, 5, 0, 0\);)X
528 10470(InstallOp \("uexit",)B
252(Exit,)X
252(1, 0, 0, 0, Integer\);)X
528 10310(InstallOp \("execv",)B
252(Execv,)X
168(2, 0, 0, 0, Array, String\);)X
528 10150(InstallOp \("system",)B
168(System,)X
84(1, 1, 0, 0, String\);)X
528 9990(InstallOp \("signal", )B
84(Signal, 2, 1, 0, 0, Integer, Integer\);)X
528 9830(InstallOp \("kill",)B
336(Kill,)X
252(2, 1, 0, 0, Integer, Integer\);)X
360 9670(})B
360 9350(static int Chdir \(dir\))B
780 9190(Object dir;)B
360 9030({)B
528 8870(char buffer [BUFSIZE];)B
528 8710(int l = lengthString \(dir\);)B
528 8390(VOID strncpy \(buffer, BodyString \(dir\), l\);)B
528 8230(buffer [l] = '\\0';)B
528 7910(return Push \(OpStack, MakeBool \(!chdir \(buffer\)\)\);)B
360 7750(})B
360 7430(static int Fork \(\))B
360 7270({)B
528 7110(return Push \(OpStack, MakeInteger \(fork \(\)\)\);)B
360 6950(})B
360 6630(static int Exit \(status\))B
780 6470(Object status;)B
360 6310({)B
528 6150(exit \(BodyInteger \(status\)\);)B
528 5830(return TRUE; /* shuts lint up */)B
360 5670(})B
360 5350(static int Wait \(\))B
360 5190({)B
528 5030(int pid, status;)B
528 4710(if \(\(pid = wait \(&status\)\) < 0\))B
696 4550(return Push \(OpStack, False\);)B
528 4390(return Push \(OpStack, MakeBool \(status & 0200\)\))B
8256 14470(&& Push \(OpStack, MakeInteger \(status & 0177\)\))B
8424 14310(&& Push \(OpStack, MakeInteger \(status >> 8\)\))B
8592 14150(&& Push \(OpStack, MakeInteger \(pid\)\))B
8760 13990(&& Push \(OpStack, True\);)B
7920 13830(})B
7920 13510(static int Execv \(args, name\))B
8340 13350(Object args, name;)B
7920 13190({)B
8088 13030(int i, nl, l = lengthArray \(args\);)B
8088 12870(char **av = \(char **\) Malloc \(\(unsigned\) \(l+1\) * sizeof \(char *\)\);)B
8088 12710(char buffer [BUFSIZE];)B
8088 12390(for \(i = 0; i < l; i++\) {)B
8256 12230(Object elem;)B
8256 11910(elem = getArray \(args, i\);)B
8256 11750(if \(TypeOf \(elem\) != String\))B
8424 11590(return Error \(PTypeCheck\);)B
8256 11430(else {)B
8424 11270(int l = lengthString \(elem\);)B
8424 10950(av[i] = Malloc \(\(unsigned\) l + 1\);)B
8424 10790(VOID strncpy \(av[i], BodyString \(elem\), l\);)B
8424 10630(av[i][l] = '\\0';)B
8256 10470(})B
8088 10310(})B
8088 10150(av[l] = NULL;)B
8088 9830(nl = lengthString \(name\);)B
8088 9670(VOID strncpy \(buffer, BodyString \(name\), nl\);)B
8088 9510(buffer [nl] = '\\0';)B
8088 9190(if \(execv \(buffer, av\) == -1\) {)B
8256 9030(for \(i = 0; i < l; i++\))B
8424 8870(Free \(av[i]\);)B
8256 8710(Free \(\(char *\) av\);)B
8256 8390(return Error \(PInvFileAccess\);)B
8088 8230(})B
8088 8070(return TRUE;)B
7920 7910(})B
7920 7590(static int System \(s\))B
8340 7430(Object s;)B
7920 7270({)B
8088 7110(char buffer [BUFSIZE];)B
8088 6950(int l = lengthString \(s\);)B
8088 6630(VOID strncpy \(buffer, BodyString \(s\), l\);)B
8088 6470(buffer [l] = '\\0';)B
8088 6310(return Push \(OpStack, MakeInteger \(system \(buffer\)\)\);)B
7920 6150(})B
7920 5830(static int Signal \(n, s\))B
8340 5670(Object n, s;)B
7920 5510({)B
8088 5350(int sn = BodyInteger \(n\);)B
8088 5030(if \(sn < 1 || sn > NSIG\))B
8256 4870(return Error \(PRangeCheck\);)B
8088 4710(return Push \(OpStack, MakeInteger \(signal \(sn, BodyInteger \(s\)\)\)\);)B
7920 4550(})B
EndPage
HfDict begin hp end
StartPage
Landscape
()(unix.c)[(89/04/02)(22:56:34)](2)Gaudy
0 F
360 14470(static int Kill \(n, s\))B
780 14310(Object n, s;)B
360 14150({)B
528 13990(return Push \(OpStack, MakeBool \(0 == kill \(BodyInteger \(n\), BodyInteger \(s\)\)\)\);)B
360 13830(})B
360 13670(#else)B
360 13510(InitUnix \(\))B
360 13350({)B
360 13190(})B
360 13030(#endif)B
EndPage
HfDict begin ep end
%%Trailer
%%Pages: 67
EndEnscriptDoc
EnscriptJob restore
